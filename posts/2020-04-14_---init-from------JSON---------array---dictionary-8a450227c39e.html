<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>透過 init(from:) 解析 JSON 裡包裝成字串的 array 或 dictionary</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">透過 init(from:) 解析 JSON 裡包裝成字串的 array 或 dictionary</h1>
</header>
<section data-field="subtitle" class="p-summary">
透過 JSONDecoder，我們可以將 JSON 資料變成自訂的型別。不過當 JSON 裡 array 或 dictionary 被包裝成字串時，解析上將麻煩許多。例如以下英國 COVID-19 API 的 JSON。
</section>
<section data-field="body" class="e-content">
<section name="7b59" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="cf73" id="cf73" class="graf graf--h3 graf--leading graf--title">透過 init(from:) 解析 JSON 裡包裝成字串的 array 或 dictionary</h3><figure name="e627" id="e627" class="graf graf--figure graf-after--h3"><img class="graf-image" data-image-id="1*A1Zz9EmCEFUb07dX0zb1vQ.jpeg" data-width="2068" data-height="602" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*A1Zz9EmCEFUb07dX0zb1vQ.jpeg"></figure><p name="2507" id="2507" class="graf graf--p graf-after--figure">透過 JSONDecoder，我們可以將 JSON 資料變成自訂的型別。不過當 JSON 裡 array 或 dictionary 被包裝成字串時，解析上將麻煩許多。例如以下英國 COVID-19 API 的 JSON。</p><pre name="3800" id="3800" class="graf graf--pre graf-after--p">https://api.covid19uk.live</pre><div name="b3fa" id="b3fa" class="graf graf--mixtapeEmbed graf-after--pre"><a href="https://github.com/isjeffcom/coronvirusFigureUK" data-href="https://github.com/isjeffcom/coronvirusFigureUK" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://github.com/isjeffcom/coronvirusFigureUK"><strong class="markup--strong markup--mixtapeEmbed-strong">isjeffcom/coronvirusFigureUK</strong><br><em class="markup--em markup--mixtapeEmbed-em">A live COVID-19 data scraper API provide function with current status, history, and confirmed cases…</em>github.com</a><a href="https://github.com/isjeffcom/coronvirusFigureUK" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="7d8491d87970960c092712a716ae6d70" data-thumbnail-img-id="0*74b0Rsgovc9GpMwj" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*74b0Rsgovc9GpMwj);"></a></div><p name="20c2" id="20c2" class="graf graf--p graf-after--mixtapeEmbed">COVID-19 API 的 JSON 初看似乎滿單純的，第一層是物件，key 是 status &amp; data，data 的資料是 array，array 裡的物件有著 key source，confirmed，death 等。</p><figure name="e982" id="e982" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*dIrtTl2xVqRJLKI1DMDnZg.jpeg" data-width="2170" data-height="626" src="https://cdn-images-1.medium.com/max/800/1*dIrtTl2xVqRJLKI1DMDnZg.jpeg"></figure><p name="7147" id="7147" class="graf graf--p graf-after--figure">但麻煩的在後頭。key area 的內容應該是 array，包含英國各地區的人數，但是它卻被包裝成字串，[] 出現在 &quot; &quot; 裡，因此 array 裡的字串還以 <code class="markup--code markup--p-code">\&quot;</code> 做特別處理。</p><figure name="0c4c" id="0c4c" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*A1Zz9EmCEFUb07dX0zb1vQ.jpeg" data-width="2068" data-height="602" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*A1Zz9EmCEFUb07dX0zb1vQ.jpeg"></figure><p name="27e1" id="27e1" class="graf graf--p graf-after--figure">有沒有可能 JSONDecoder 很聰明，明白 area 以字串包裝的內容其實是 array 呢 ? 讓我們試試將 area 的型別宣告成 [Area]。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="671c" id="671c" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">CovidResponse</span>: <span class="hljs-title class_">Codable</span> {<br />    <span class="hljs-keyword">let</span> status: <span class="hljs-type">Bool</span><br />    <span class="hljs-keyword">let</span> data: [<span class="hljs-type">CovidData</span>]<br />}<br /><br /><span class="hljs-keyword">struct</span> <span class="hljs-title class_">CovidData</span>: <span class="hljs-title class_">Codable</span> {<br />    <span class="hljs-keyword">let</span> confirmed: <span class="hljs-type">Int</span><br />    <span class="hljs-keyword">let</span> area: [<span class="hljs-type">Area</span>]<br />}<br /><br /><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Area</span>: <span class="hljs-title class_">Codable</span> {<br />    <span class="hljs-keyword">let</span> location: <span class="hljs-type">String</span><br />    <span class="hljs-keyword">let</span> number: <span class="hljs-type">Int</span><br />}<br /><br /><span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">&quot;https://api.covid19uk.live&quot;</span>) {<br />    <span class="hljs-type">URLSession</span>.shared.dataTask(with: url) { data, response, error <span class="hljs-keyword">in</span><br />        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> data {<br />            <span class="hljs-keyword">do</span> {<br />                <span class="hljs-keyword">let</span> covidData <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-type">JSONDecoder</span>().decode(<span class="hljs-type">CovidData</span>.<span class="hljs-keyword">self</span>, from: data)<br />                <span class="hljs-built_in">print</span>(covidData.data.first<span class="hljs-operator">?</span>.confirmed)<br />                <span class="hljs-built_in">print</span>(covidData.data.first<span class="hljs-operator">?</span>.area.first<span class="hljs-operator">?</span>.location)<br />            } <span class="hljs-keyword">catch</span>  {<br />                <span class="hljs-built_in">print</span>(error)<br />            }<br />        }<br />    }.resume()<br />}</span></pre><p name="561b" id="561b" class="graf graf--p graf-after--pre">很遺憾的，我們失敗了，JSONDecoder 沒那麼聰明，它只看出 area 的內容是字串，不明白字串的內容其實是 array。</p><p name="5edf" id="5edf" class="graf graf--p graf-after--p">錯誤訊息如下，提到在解析 area 時 Expected to decode Array&lt;Any&gt; but found a string/data instead。</p><pre name="c918" id="c918" class="graf graf--pre graf-after--p">typeMismatch(Swift.Array&lt;Any&gt;, Swift.DecodingError.Context(codingPath: [CodingKeys(stringValue: &quot;data&quot;, intValue: nil), _JSONKey(stringValue: &quot;Index 0&quot;, intValue: 0), CodingKeys(stringValue: &quot;<strong class="markup--strong markup--pre-strong">area</strong>&quot;, intValue: nil)], debugDescription: &quot;<strong class="markup--strong markup--pre-strong">Expected to decode Array&lt;Any&gt; but found a string/data instead</strong>.&quot;, underlyingError: nil))</pre><p name="87fd" id="87fd" class="graf graf--p graf-after--pre">因此我們得另外寫程式幫忙 JSONDecoder 解析 JSON，程式如下:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="swift" name="43c1" id="43c1" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">CovidResponse</span>: <span class="hljs-title class_">Codable</span> {<br />    <span class="hljs-keyword">let</span> status: <span class="hljs-type">Bool</span><br />    <span class="hljs-keyword">let</span> data: [<span class="hljs-type">CovidData</span>]<br />}<br /><br /><span class="hljs-keyword">struct</span> <span class="hljs-title class_">CovidData</span>: <span class="hljs-title class_">Codable</span> {<br />    <br />    <span class="hljs-keyword">let</span> confirmed: <span class="hljs-type">Int</span><br />    <span class="hljs-keyword">let</span> area: [<span class="hljs-type">Area</span>]<br />    <br />    <span class="hljs-keyword">init</span>(<span class="hljs-params">from</span> <span class="hljs-params">decoder</span>: <span class="hljs-type">Decoder</span>) <span class="hljs-keyword">throws</span> {<br />        <span class="hljs-keyword">let</span> container <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> decoder.container(keyedBy: <span class="hljs-type">CodingKeys</span>.<span class="hljs-keyword">self</span>)<br />        confirmed <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> container.decode(<span class="hljs-type">Int</span>.<span class="hljs-keyword">self</span>, forKey: .confirmed)<br />        <span class="hljs-keyword">let</span> areaString <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> container.decode(<span class="hljs-type">String</span>.<span class="hljs-keyword">self</span>, forKey: .area)<br />        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> areaData <span class="hljs-operator">=</span> areaString.data(using: .utf8),<br />           <span class="hljs-keyword">let</span> area <span class="hljs-operator">=</span> <span class="hljs-keyword">try?</span> <span class="hljs-type">JSONDecoder</span>().decode([<span class="hljs-type">Area</span>].<span class="hljs-keyword">self</span>, from: areaData) {<br />            <span class="hljs-keyword">self</span>.area <span class="hljs-operator">=</span> area<br />        } <span class="hljs-keyword">else</span> {<br />            <span class="hljs-keyword">throw</span> <span class="hljs-type">DecodingError</span>.dataCorruptedError(forKey: .area, in: container, debugDescription: <span class="hljs-string">&quot;area error&quot;</span>)<br />        }<br />    }<br />}<br /><br /><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Area</span>: <span class="hljs-title class_">Codable</span> {<br />    <span class="hljs-keyword">let</span> location: <span class="hljs-type">String</span><br />    <span class="hljs-keyword">let</span> number: <span class="hljs-type">Int</span><br />}</span></pre><p name="c851" id="c851" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">說明</strong></p><p name="ee21" id="ee21" class="graf graf--p graf-after--p">解析的關鍵在於我們須在 struct Data 裡定義<code class="markup--code markup--p-code"> init(from:)</code>，自己撰寫將 JSON 資料變成自訂型別的程式，相關說明可參考以下連結。</p><div name="b9da" id="b9da" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E8%87%AA%E8%A8%82-init-from-decoder-%E8%A7%A3%E6%9E%90-json-f9c8d420cda4" data-href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E8%87%AA%E8%A8%82-init-from-decoder-%E8%A7%A3%E6%9E%90-json-f9c8d420cda4" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E8%87%AA%E8%A8%82-init-from-decoder-%E8%A7%A3%E6%9E%90-json-f9c8d420cda4"><strong class="markup--strong markup--mixtapeEmbed-strong">定義 Decodable 的 init(from:) 解析 JSON</strong><br><em class="markup--em markup--mixtapeEmbed-em">透過 JSONDecoder，我們可以方便地將 JSON 資料變成遵從 protocol Decodable 的自訂型別，而且大部分的時候我們只要宣告型別裡的 property，不用自己撰寫解析 JSON 的 init(from…</em>medium.com</a><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E8%87%AA%E8%A8%82-init-from-decoder-%E8%A7%A3%E6%9E%90-json-f9c8d420cda4" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="f2f0a35aa460b7489fcc5705881cd7d1" data-thumbnail-img-id="1*rvyZe7kQUWeREkieUQqrug.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*rvyZe7kQUWeREkieUQqrug.png);"></a></div><p name="76b0" id="76b0" class="graf graf--p graf-after--mixtapeEmbed"><code class="markup--code markup--p-code">init(from:) </code>是型別遵從 protocol Decodable 時需定義的 init，原本我們不用定義是因為 Xcode 的 compiler 很聰明，它能依據我們在自訂型別裡宣告的 property 名稱和型別自動生成 <code class="markup--code markup--p-code">init(from:)</code>的程式。</p><p name="ffb4" id="ffb4" class="graf graf--p graf-after--p">但現在 area 的內容是字串，我們想將它變成 array，這已經超出 Xcode compiler 的能力範圍，只有靠聰明的人類才能寫出轉換的程式。我們在型別 Data 裡定義的<code class="markup--code markup--p-code">init(from:)</code>如下:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="8f37" id="8f37" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">init</span>(<span class="hljs-params">from</span> <span class="hljs-params">decoder</span>: <span class="hljs-type">Decoder</span>) <span class="hljs-keyword">throws</span> {<br />    <span class="hljs-keyword">let</span> container <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> decoder.container(keyedBy: <span class="hljs-type">CodingKeys</span>.<span class="hljs-keyword">self</span>) <br />    confirmed <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> container.decode(<span class="hljs-type">Int</span>.<span class="hljs-keyword">self</span>, forKey: .confirmed)<br />    <span class="hljs-keyword">let</span> areaString <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> container.decode(<span class="hljs-type">String</span>.<span class="hljs-keyword">self</span>, forKey: .area)<br />    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> areaData <span class="hljs-operator">=</span> areaString.data(using: .utf8), <br />       <span class="hljs-keyword">let</span> area <span class="hljs-operator">=</span> <span class="hljs-keyword">try?</span> <span class="hljs-type">JSONDecoder</span>().decode([<span class="hljs-type">Area</span>].<span class="hljs-keyword">self</span>, from: areaData) {<br />         <span class="hljs-keyword">self</span>.area <span class="hljs-operator">=</span> area<br />    } <span class="hljs-keyword">else</span> {<br />         <span class="hljs-keyword">self</span>.area <span class="hljs-operator">=</span> []<br />    }<br />}</span></pre><ul class="postList"><li name="ca11" id="ca11" class="graf graf--li graf-after--pre"><strong class="markup--strong markup--li-strong">let container = try decoder.container(keyedBy: CodingKeys.self)</strong></li></ul><p name="2546" id="2546" class="graf graf--p graf-after--li">從 decoder 呼叫 container(keyedBy:)，取得包含 JSON 資料的 container。之後我們可利用 key 讀取 container 的內容。</p><ul class="postList"><li name="a6c0" id="a6c0" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">confirmed = try container.decode(Int.self, forKey: .confirmed)</strong></li></ul><p name="6b81" id="6b81" class="graf graf--p graf-after--li">呼叫 decode(_:forKey:)，將 key confirmed 對應的內容解析成整數，存入 property confirmed。</p><p name="90fc" id="90fc" class="graf graf--p graf-after--p">function decode(_:forKey:) 是我們手動解析 JSON 的關鍵，透過它的第一個參數指定解析的型別，第二個參數指定 key，如此即可將 JSON 內容一個個讀取出來，變成我們想要的型別。</p><ul class="postList"><li name="a565" id="a565" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">let areaString = try container.decode(String.self, forKey: .area)</strong></li></ul><p name="1591" id="1591" class="graf graf--p graf-after--li">key area 的內容是字串，因此我們先將它解析成字串，存入常數 areaString。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="704a" id="704a" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> areaData <span class="hljs-operator">=</span> areaString.data(using: .utf8), <br />   <span class="hljs-keyword">let</span> area <span class="hljs-operator">=</span> <span class="hljs-keyword">try?</span> <span class="hljs-type">JSONDecoder</span>().decode([<span class="hljs-type">Area</span>].<span class="hljs-keyword">self</span>, from: areaData) {<br />    <span class="hljs-keyword">self</span>.area <span class="hljs-operator">=</span> area<br />} <span class="hljs-keyword">else</span> {<br />    <span class="hljs-keyword">self</span>.area <span class="hljs-operator">=</span> []<br />}</span></pre><figure name="dd31" id="dd31" class="graf graf--figure graf-after--pre"><img class="graf-image" data-image-id="1*BilzDtiylrcV9A1WRGHvow.jpeg" data-width="1288" data-height="370" src="https://cdn-images-1.medium.com/max/800/1*BilzDtiylrcV9A1WRGHvow.jpeg"></figure><p name="5b8e" id="5b8e" class="graf graf--p graf-after--figure">我們的最終目標是將 areaString 變成 array，存在 Data 的 property area。因此我們先將 areaString 變成 areaData，然後再用 JSONDecoder 將它變成 [Area]，若是不幸失敗則讓 area 成為空陣列。</p><p name="a9d7" id="a9d7" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">結果</strong></p><p name="7649" id="7649" class="graf graf--p graf-after--p">成功將 JSON 解析成 CovidData，原本內容是字串的 area 也變成了 [Area]。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="4177" id="4177" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">&quot;https://api.covid19uk.live&quot;</span>) {<br />    <span class="hljs-type">URLSession</span>.shared.dataTask(with: url) { data, response, error <span class="hljs-keyword">in</span><br />        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> data {<br />            <span class="hljs-keyword">do</span> {<br />                <span class="hljs-keyword">let</span> covidData <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-type">JSONDecoder</span>().decode(<span class="hljs-type">CovidData</span>.<span class="hljs-keyword">self</span>, from: data)<br />                <span class="hljs-built_in">print</span>(covidData.data.first<span class="hljs-operator">?</span>.confirmed <span class="hljs-operator">??</span> <span class="hljs-number">0</span>)<br />                 <br />            <span class="hljs-built_in">print</span>(covidData.data.first<span class="hljs-operator">?</span>.area.first<span class="hljs-operator">?</span>.location <span class="hljs-operator">??</span> <span class="hljs-string">&quot;&quot;</span>)<br />            } <span class="hljs-keyword">catch</span>  {<br />                <span class="hljs-built_in">print</span>(error)<br />            }<br />        }<br />    }.resume()<br />}</span></pre><figure name="5b25" id="5b25" class="graf graf--figure graf-after--pre graf--trailing"><img class="graf-image" data-image-id="1*0ERBRRvLzwXif-2Q2azG2A.jpeg" data-width="364" data-height="204" src="https://cdn-images-1.medium.com/max/800/1*0ERBRRvLzwXif-2Q2azG2A.jpeg"></figure></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@apppeterpan" class="p-author h-card">彼得潘的 iOS App Neverland</a> on <a href="https://medium.com/p/8a450227c39e"><time class="dt-published" datetime="2020-04-14T07:41:14.808Z">April 14, 2020</time></a>.</p><p><a href="https://medium.com/@apppeterpan/%E9%80%8F%E9%81%8E-init-from-%E8%A7%A3%E6%9E%90-json-%E8%A3%A1%E5%8C%85%E8%A3%9D%E6%88%90%E5%AD%97%E4%B8%B2%E7%9A%84-array-%E6%88%96-dictionary-8a450227c39e" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on September 17, 2025.</p></footer></article></body></html>