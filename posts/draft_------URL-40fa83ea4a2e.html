<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>找出可連的 URL</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">找出可連的 URL</h1>
</header>
<section data-field="subtitle" class="p-summary">
completion handler
</section>
<section data-field="body" class="e-content">
<section name="c644" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="cd00" id="cd00" class="graf graf--h3 graf--leading graf--title">找出可連的 URL</h3><p name="3aae" id="3aae" class="graf graf--p graf-after--h3">completion handler </p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="swift" name="3580" id="3580" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-comment">//</span><br /><span class="hljs-comment">//  ViewController.swift</span><br /><span class="hljs-comment">//  Demo</span><br /><span class="hljs-comment">//</span><br /><span class="hljs-comment">//  Created by SHIH-YING PAN on 2024/8/28.</span><br /><span class="hljs-comment">//</span><br /><br /><span class="hljs-keyword">import</span> UIKit<br /><br /><span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewController</span>: <span class="hljs-title class_">UIViewController</span> {<br />    <br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">attemptConnection</span>(<span class="hljs-params">to</span> <span class="hljs-params">ip</span>: <span class="hljs-type">String</span>, <span class="hljs-params">attempt</span>: <span class="hljs-type">Int</span>, <span class="hljs-params">maxAttempts</span>: <span class="hljs-type">Int</span>, <span class="hljs-params">request</span>: <span class="hljs-type">URLRequest</span>, <span class="hljs-params">session</span>: <span class="hljs-type">URLSession</span>, <span class="hljs-params">completion</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">Bool</span>) -&gt; <span class="hljs-type">Void</span>) {<br />        session.dataTask(with: request) { <span class="hljs-keyword">_</span>, response, error <span class="hljs-keyword">in</span><br />            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> httpResponse <span class="hljs-operator">=</span> response <span class="hljs-keyword">as?</span> <span class="hljs-type">HTTPURLResponse</span>,<br />               (<span class="hljs-number">200</span><span class="hljs-operator">...</span><span class="hljs-number">299</span>).contains(httpResponse.statusCode) {<br />                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;成功連接到 <span class="hljs-subst">\(ip)</span> (嘗試 #<span class="hljs-subst">\(attempt)</span>)&quot;</span>)<br />                completion(<span class="hljs-literal">true</span>)<br />            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> attempt <span class="hljs-operator">&lt;</span> maxAttempts {<br />                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;連接到 <span class="hljs-subst">\(ip)</span> 失敗 (嘗試 #<span class="hljs-subst">\(attempt)</span>): <span class="hljs-subst">\(error<span class="hljs-operator">?</span>.localizedDescription <span class="hljs-operator">??</span> <span class="hljs-string">&quot;未知錯誤&quot;</span>)</span>&quot;</span>)<br />                <span class="hljs-keyword">self</span>.attemptConnection(to: ip, attempt: attempt <span class="hljs-operator">+</span> <span class="hljs-number">1</span>, maxAttempts: maxAttempts, request: request, session: session, completion: completion)<br />            } <span class="hljs-keyword">else</span> {<br />                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;無法連接到 <span class="hljs-subst">\(ip)</span> 經過 <span class="hljs-subst">\(maxAttempts)</span> 次嘗試&quot;</span>)<br />                completion(<span class="hljs-literal">false</span>)<br />            }<br />        }.resume()<br />    }<br />    <br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">testConnection</span>(<span class="hljs-params">to</span> <span class="hljs-params">ip</span>: <span class="hljs-type">String</span>, <span class="hljs-params">retryCount</span>: <span class="hljs-type">Int</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>, <span class="hljs-params">completion</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">Bool</span>) -&gt; <span class="hljs-type">Void</span>) {<br />        <span class="hljs-keyword">let</span> urlString <span class="hljs-operator">=</span> <span class="hljs-string">&quot;https://<span class="hljs-subst">\(ip)</span>&quot;</span><br />        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: urlString) <span class="hljs-keyword">else</span> {<br />            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;無效的 URL: <span class="hljs-subst">\(urlString)</span>&quot;</span>)<br />            completion(<span class="hljs-literal">false</span>)<br />            <span class="hljs-keyword">return</span><br />        }<br />        <span class="hljs-keyword">var</span> request <span class="hljs-operator">=</span> <span class="hljs-type">URLRequest</span>(url: url)<br />        request.timeoutInterval <span class="hljs-operator">=</span> <span class="hljs-number">3</span><br />        <span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">URLSession</span>.shared<br />        <br />        attemptConnection(to: ip, attempt: <span class="hljs-number">1</span>, maxAttempts: retryCount, request: request, session: session, completion: completion)<br />    }<br />    <br />    <span class="hljs-comment">// 主要的查找函數</span><br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">findConnectableIP</span>(<span class="hljs-params">from</span> <span class="hljs-params">ipLists</span>: [[<span class="hljs-type">String</span>]], <span class="hljs-params">completion</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">String</span>?) -&gt; <span class="hljs-type">Void</span>) {<br />        <span class="hljs-keyword">func</span> <span class="hljs-title function_">checkNextIP</span>(<span class="hljs-params">listIndex</span>: <span class="hljs-type">Int</span>, <span class="hljs-params">ipIndex</span>: <span class="hljs-type">Int</span>) {<br />            <span class="hljs-keyword">guard</span> listIndex <span class="hljs-operator">&lt;</span> ipLists.count <span class="hljs-keyword">else</span> {<br />                completion(<span class="hljs-literal">nil</span>)<br />                <span class="hljs-keyword">return</span><br />            }<br />            <br />            <span class="hljs-keyword">let</span> currentList <span class="hljs-operator">=</span> ipLists[listIndex]<br />            <span class="hljs-keyword">guard</span> ipIndex <span class="hljs-operator">&lt;</span> currentList.count <span class="hljs-keyword">else</span> {<br />                checkNextIP(listIndex: listIndex <span class="hljs-operator">+</span> <span class="hljs-number">1</span>, ipIndex: <span class="hljs-number">0</span>)<br />                <span class="hljs-keyword">return</span><br />            }<br />            <br />            <span class="hljs-keyword">let</span> ip <span class="hljs-operator">=</span> currentList[ipIndex]<br />            testConnection(to: ip) { success <span class="hljs-keyword">in</span><br />                <span class="hljs-keyword">if</span> success {<br />                    completion(ip)<br />                } <span class="hljs-keyword">else</span> {<br />                    checkNextIP(listIndex: listIndex, ipIndex: ipIndex <span class="hljs-operator">+</span> <span class="hljs-number">1</span>)<br />                }<br />            }<br />        }<br />        <br />        checkNextIP(listIndex: <span class="hljs-number">0</span>, ipIndex: <span class="hljs-number">0</span>)<br />    }<br />    <br />    <br />    <br />    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {<br />        <span class="hljs-keyword">super</span>.viewDidLoad()<br />        <span class="hljs-comment">// Do any additional setup after loading the view.</span><br />        <br />        <span class="hljs-keyword">let</span> ipList1 <span class="hljs-operator">=</span> [<span class="hljs-string">&quot;203.0.113.1&quot;</span>, <span class="hljs-string">&quot;203.0.113.2&quot;</span>]<br />        <span class="hljs-keyword">let</span> ipList2 <span class="hljs-operator">=</span> [<span class="hljs-string">&quot;204.0.113.1&quot;</span>, <span class="hljs-string">&quot;204.0.113.2&quot;</span>]<br />        <span class="hljs-keyword">let</span> ipList3 <span class="hljs-operator">=</span> [<span class="hljs-string">&quot;www.apple.com&quot;</span>]<br />        <span class="hljs-keyword">let</span> ipList4 <span class="hljs-operator">=</span> [<span class="hljs-string">&quot;205.0.113.1&quot;</span>, <span class="hljs-string">&quot;205.0.113.2&quot;</span>]<br />        <br />        <span class="hljs-keyword">let</span> allLists <span class="hljs-operator">=</span> [ipList1, ipList2, ipList3, ipList4]<br />        findConnectableIP(from: allLists) { connectedIP <span class="hljs-keyword">in</span><br />            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> ip <span class="hljs-operator">=</span> connectedIP {<br />                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;成功連接到 IP: <span class="hljs-subst">\(ip)</span>&quot;</span>)<br />            } <span class="hljs-keyword">else</span> {<br />                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;無法連接到任何 IP&quot;</span>)<br />            }<br />        }<br />        <br />        <br />    }<br />    <br />    <br />}<br /><br /><br /></span></pre><p name="33a2" id="33a2" class="graf graf--p graf-after--pre">async </p><p name="3f12" id="3f12" class="graf graf--p graf--empty graf-after--p"><br></p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="swift" name="a3b8" id="a3b8" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">import</span> Foundation<br /><br /><span class="hljs-keyword">func</span> <span class="hljs-title function_">testConnection</span>(<span class="hljs-params">to</span> <span class="hljs-params">ip</span>: <span class="hljs-type">String</span>, <span class="hljs-params">retryCount</span>: <span class="hljs-type">Int</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>) <span class="hljs-keyword">async</span> -&gt; <span class="hljs-type">Bool</span> {<br />    <span class="hljs-keyword">let</span> urlString <span class="hljs-operator">=</span> <span class="hljs-string">&quot;https://<span class="hljs-subst">\(ip)</span>&quot;</span><br />    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: urlString) <span class="hljs-keyword">else</span> {<br />        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;無效的 URL: <span class="hljs-subst">\(urlString)</span>&quot;</span>)<br />        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br />    }<br />    <span class="hljs-keyword">var</span> request <span class="hljs-operator">=</span> <span class="hljs-type">URLRequest</span>(url: url)<br />    request.timeoutInterval <span class="hljs-operator">=</span> <span class="hljs-number">3</span><br />    <span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">URLSession</span>.shared<br />    <br />    <span class="hljs-keyword">for</span> attempt <span class="hljs-keyword">in</span> <span class="hljs-number">1</span><span class="hljs-operator">...</span>retryCount {<br />        <span class="hljs-keyword">do</span> {<br />            <span class="hljs-keyword">let</span> (<span class="hljs-keyword">_</span>, response) <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> session.data(for: request)<br />            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> httpResponse <span class="hljs-operator">=</span> response <span class="hljs-keyword">as?</span> <span class="hljs-type">HTTPURLResponse</span>,<br />               (<span class="hljs-number">200</span><span class="hljs-operator">...</span><span class="hljs-number">299</span>).contains(httpResponse.statusCode) {<br />                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;成功連接到 <span class="hljs-subst">\(ip)</span> (嘗試 #<span class="hljs-subst">\(attempt)</span>)&quot;</span>)<br />                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br />            }<br />        } <span class="hljs-keyword">catch</span> {<br />            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;連接到 <span class="hljs-subst">\(ip)</span> 失敗 (嘗試 #<span class="hljs-subst">\(attempt)</span>): <span class="hljs-subst">\(error.localizedDescription)</span>&quot;</span>)<br />        }<br />    }<br />    <br />    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;無法連接到 <span class="hljs-subst">\(ip)</span> 經過 <span class="hljs-subst">\(retryCount)</span> 次嘗試&quot;</span>)<br />    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br />}<br /><br /><span class="hljs-comment">// 主要的查找函數</span><br /><span class="hljs-keyword">func</span> <span class="hljs-title function_">findConnectableIP</span>(<span class="hljs-params">from</span> <span class="hljs-params">ipLists</span>: [[<span class="hljs-type">String</span>]]) <span class="hljs-keyword">async</span> -&gt; <span class="hljs-type">String</span>? {<br />    <span class="hljs-keyword">for</span> ipList <span class="hljs-keyword">in</span> ipLists {<br />        <span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> ipList {<br />            <span class="hljs-keyword">if</span> <span class="hljs-keyword">await</span> testConnection(to: ip) {<br />                <span class="hljs-keyword">return</span> ip<br />            }<br />        }<br />    }<br />    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br />}<br /><br /><span class="hljs-comment">// 使用範例</span><br /><span class="hljs-keyword">let</span> ipList1 <span class="hljs-operator">=</span> [<span class="hljs-string">&quot;203.0.113.1&quot;</span>, <span class="hljs-string">&quot;203.0.113.2&quot;</span>]<br /><span class="hljs-keyword">let</span> ipList2 <span class="hljs-operator">=</span> [<span class="hljs-string">&quot;204.0.113.1&quot;</span>, <span class="hljs-string">&quot;204.0.113.2&quot;</span>]<br /><span class="hljs-keyword">let</span> ipList3 <span class="hljs-operator">=</span> [<span class="hljs-string">&quot;www.apple.com&quot;</span>]<br /><span class="hljs-keyword">let</span> ipList4 <span class="hljs-operator">=</span> [<span class="hljs-string">&quot;205.0.113.1&quot;</span>, <span class="hljs-string">&quot;205.0.113.2&quot;</span>]<br /><br /><br /><span class="hljs-keyword">let</span> allLists <span class="hljs-operator">=</span> [ipList1, ipList2, ipList3, ipList4]<br /><br /><br /><span class="hljs-type">Task</span> {<br />    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> connectedIP <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> findConnectableIP(from: allLists) {<br />        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;成功連接到 IP: <span class="hljs-subst">\(connectedIP)</span>&quot;</span>)<br />    } <span class="hljs-keyword">else</span> {<br />        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;無法連接到任何 IP&quot;</span>)<br />    }<br />}<br /><br /><br /></span></pre><p name="c288" id="c288" class="graf graf--p graf--empty graf-after--pre graf--trailing"><br></p></div></div></section>
</section>
<footer><p><a href="https://medium.com/p/40fa83ea4a2e">View original.</a></p><p>Exported from <a href="https://medium.com">Medium</a> on September 17, 2025.</p></footer></article></body></html>