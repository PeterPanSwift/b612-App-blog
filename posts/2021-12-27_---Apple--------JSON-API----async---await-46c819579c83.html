<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>模仿 Apple 官方範例串接 JSON API，使用 async &amp; await</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">模仿 Apple 官方範例串接 JSON API，使用 async &amp; await</h1>
</header>
<section data-field="subtitle" class="p-summary">
Apple 的 Develop in Swift Data Collections 第二章 Guided Project: Restaurant 介紹適合初學者參考的 JSON API 串接寫法，接下來就讓我們一步步介紹如何模仿抄襲 Apple 大大的範例吧。
</section>
<section data-field="body" class="e-content">
<section name="aec3" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="7618" id="7618" class="graf graf--h3 graf--leading graf--title">模仿 Apple 官方範例串接 JSON API，使用 async &amp; await</h3><figure name="6371" id="6371" class="graf graf--figure graf-after--h3"><img class="graf-image" data-image-id="1*5HeCnveD9NPyVxbJQO32dg.png" data-width="1958" data-height="1466" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*5HeCnveD9NPyVxbJQO32dg.png"></figure><p name="628e" id="628e" class="graf graf--p graf-after--figure">Apple 的 <code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">Develop in Swift Data Collections</strong></code><strong class="markup--strong markup--p-strong"> </strong>第二章 <code class="markup--code markup--p-code u-paddingRight0 u-marginRight0"><strong class="markup--strong markup--p-strong">Guided Project: Restaurant</strong> </code>介紹適合初學者參考的 JSON API 串接寫法，接下來就讓我們一步步介紹如何模仿抄襲 Apple 大大的範例吧。</p><figure name="9bb3" id="9bb3" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*73f3zJB2m3ZW7Ymm739hDQ.png" data-width="2718" data-height="1636" src="https://cdn-images-1.medium.com/max/800/1*73f3zJB2m3ZW7Ymm739hDQ.png"></figure><h3 name="0698" id="0698" class="graf graf--h3 graf-after--figure">下載 Develop in Swift Data Collections Teacher Guide</h3><p name="aa92" id="aa92" class="graf graf--p graf-after--h3">待會我們將參考 <code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">Develop in Swift Data Collections</strong></code> 裡提供的程式範例。</p><div name="4b2a" id="4b2a" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://books.apple.com/tw/book/develop-in-swift-data-collections-teacher-guide/id6468968795?l=en-GB" data-href="https://books.apple.com/tw/book/develop-in-swift-data-collections-teacher-guide/id6468968795?l=en-GB" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://books.apple.com/tw/book/develop-in-swift-data-collections-teacher-guide/id6468968795?l=en-GB"><strong class="markup--strong markup--mixtapeEmbed-strong">‎Develop in Swift Data Collections Teacher Guide</strong><br><em class="markup--em markup--mixtapeEmbed-em">This Teacher Guide provides tools to deepen engagement with aspiring app developers, whether you have experience…</em>books.apple.com</a><a href="https://books.apple.com/tw/book/develop-in-swift-data-collections-teacher-guide/id6468968795?l=en-GB" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="12e380bd440cce3c1a5b06e6886da039" data-thumbnail-img-id="0*nzu6RB2tf-riu_8l" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*nzu6RB2tf-riu_8l);"></a></div><h3 name="8095" id="8095" class="graf graf--h3 graf-after--mixtapeEmbed">點選 Download teacher materials 下載範例程式</h3><p name="0d9c" id="0d9c" class="graf graf--p graf-after--h3">從第 9 頁點選 Download teacher materials。</p><figure name="814f" id="814f" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*j0zm9q_0RmlKIjQPafFSXQ.png" data-width="1106" data-height="704" src="https://cdn-images-1.medium.com/max/800/1*j0zm9q_0RmlKIjQPafFSXQ.png"></figure><h3 name="93d6" id="93d6" class="graf graf--h3 graf-after--figure">啟動 server 程式 Open Restaurant</h3><p name="6497" id="6497" class="graf graf--p graf-after--h3">Apple 的範例需要從 server 抓取資料，因此我們必須先啟動 server 程式。Apple 已經幫我們將 server 程式寫好了，請從下載的範例資料夾找到 <code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">Open Restaurant</strong></code>。(2 — Working With the Web &gt; Guided Project — Restaurant &gt; resources &gt; Open Restaurant )</p><figure name="9053" id="9053" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*owHFgRbOq2EJUZeF9D--OA.png" data-width="2448" data-height="776" src="https://cdn-images-1.medium.com/max/800/1*owHFgRbOq2EJUZeF9D--OA.png"></figure><p name="d1a7" id="d1a7" class="graf graf--p graf-after--figure">雙擊 Open Restaurant 啟動 server。</p><figure name="a0d5" id="a0d5" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*n48TycWUC4M925V6rDqObA.png" data-width="960" data-height="476" src="https://cdn-images-1.medium.com/max/800/1*n48TycWUC4M925V6rDqObA.png"></figure><p name="7d9e" id="7d9e" class="graf graf--p graf-after--figure">從 Server App 的視窗畫面可進行後台資料的編輯，比方編輯 categories，menu items &amp; 圖片。點選右下角的 Start 啟動後台，讓 App 可以連線抓取資料。</p><figure name="e410" id="e410" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*tQfQ-9S0PfQ6YNN3-MLksA.png" data-width="958" data-height="462" src="https://cdn-images-1.medium.com/max/800/1*tQfQ-9S0PfQ6YNN3-MLksA.png"></figure><h3 name="3b5e" id="3b5e" class="graf graf--h3 graf-after--figure">打開專案執行 App</h3><p name="4a0b" id="4a0b" class="graf graf--p graf-after--h3">切換到下載的範例資料夾，找到 OrderApp.xcodeproj。(2 — Working With the Web &gt; Guided Project — Restaurant &gt; resources &gt; OrderApp &gt; OrderApp.xcodeproj)</p><figure name="aff6" id="aff6" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*O94R5uHGy4vcT8x_Q4LcAQ.png" data-width="2464" data-height="490" src="https://cdn-images-1.medium.com/max/800/1*O94R5uHGy4vcT8x_Q4LcAQ.png"></figure><p name="ce8d" id="ce8d" class="graf graf--p graf-after--figure">雙擊 OrderApp.xcodeproj 打開專案。</p><figure name="4d01" id="4d01" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*UF3QDN0V9hbCCiEkeXfWmg.png" data-width="488" data-height="158" src="https://cdn-images-1.medium.com/max/800/1*UF3QDN0V9hbCCiEkeXfWmg.png"></figure><figure name="7b79" id="7b79" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*gjzjqk6JZSN1t4L5ykF_Mw.png" data-width="2412" data-height="1512" src="https://cdn-images-1.medium.com/max/800/1*gjzjqk6JZSN1t4L5ykF_Mw.png"></figure><h3 name="43fe" id="43fe" class="graf graf--h3 graf-after--figure">執行 App</h3><p name="6155" id="6155" class="graf graf--p graf-after--h3">我們可從 Server 抓取 Restaurant 的相關資料並訂購想買的商品。(ps: 別緊張，只是假的購買，不會花到錢)</p><figure name="053d" id="053d" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*Lf3gz7RWVQHQ-yITRgKGag.png" data-width="1616" data-height="1124" src="https://cdn-images-1.medium.com/max/800/1*Lf3gz7RWVQHQ-yITRgKGag.png"></figure><h3 name="41ce" id="41ce" class="graf graf--h3 graf-after--figure">Apple 範例程式解析</h3><h4 name="ff15" id="ff15" class="graf graf--h4 graf-after--h3"><strong class="markup--strong markup--h4-strong">串接網路的程式統一定義在一個檔案</strong></h4><p name="5293" id="5293" class="graf graf--p graf-after--h4">範例程式將跟後台溝通的相關程式統一定義在類別 MenuController 裡，方便 App 的各個畫面使用，比方將抓取商品類別的 API 定義成 function fetchCategories，上傳訂單的 API 定義成 function submitOrder。</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="swift" name="5076" id="5076" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchCategories</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; [<span class="hljs-type">String</span>]<br /><span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchMenuItems</span>(<span class="hljs-params">forCategory</span> <span class="hljs-params">categoryName</span>: <span class="hljs-type">String</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; [<span class="hljs-type">MenuItem</span>]<br /><span class="hljs-keyword">func</span> <span class="hljs-title function_">submitOrder</span>(<span class="hljs-params">forMenuIDs</span> <span class="hljs-params">menuIDs</span>: [<span class="hljs-type">Int</span>]) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">MinutesToPrepare</span><br /><span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchImage</span>(<span class="hljs-params">from</span> <span class="hljs-params">url</span>: <span class="hljs-type">URL</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">UIImage</span></span></pre><h4 name="e8ac" id="e8ac" class="graf graf--h4 graf-after--pre">使用 baseURL，URLComponents &amp; URLQueryItem 產生 URL</h4><p name="b372" id="b372" class="graf graf--p graf-after--h4">baseURL 的宣告如下。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="0b5f" id="0b5f" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">let</span> baseURL <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">&quot;http://localhost:8080/&quot;</span>)<span class="hljs-operator">!</span></span></pre><p name="af7c" id="af7c" class="graf graf--p graf-after--pre">比方在 fetchMenuItems 裡利用 baseURL，URLComponents &amp; URLQueryItem 產生 URL。</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="swift" name="4bc5" id="4bc5" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchMenuItems</span>(<span class="hljs-params">forCategory</span> <span class="hljs-params">categoryName</span>: <span class="hljs-type">String</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; [<span class="hljs-type">MenuItem</span>] {<br />     <span class="hljs-keyword">let</span> baseMenuURL <span class="hljs-operator">=</span> baseURL.appendingPathComponent(<span class="hljs-string">&quot;menu&quot;</span>)<br />     <span class="hljs-keyword">var</span> components <span class="hljs-operator">=</span> <span class="hljs-type">URLComponents</span>(url: baseMenuURL, resolvingAgainstBaseURL: <span class="hljs-literal">true</span>)<span class="hljs-operator">!</span><br />     components.queryItems <span class="hljs-operator">=</span> [<span class="hljs-type">URLQueryItem</span>(name: <span class="hljs-string">&quot;category&quot;</span>, value: categoryName)]<br />     <span class="hljs-keyword">let</span> menuURL <span class="hljs-operator">=</span> components.url<span class="hljs-operator">!</span></span></pre><p name="57e0" id="57e0" class="graf graf--p graf-after--pre">相關說明可參考以下連結。</p><div name="4503" id="4503" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E4%BD%BF%E7%94%A8-baseurl-urlcomponents-urlqueryitem-%E7%94%A2%E7%94%9F-url-1e4539a33a89" data-href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E4%BD%BF%E7%94%A8-baseurl-urlcomponents-urlqueryitem-%E7%94%A2%E7%94%9F-url-1e4539a33a89" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E4%BD%BF%E7%94%A8-baseurl-urlcomponents-urlqueryitem-%E7%94%A2%E7%94%9F-url-1e4539a33a89"><strong class="markup--strong markup--mixtapeEmbed-strong">使用 baseURL，URLComponents &amp; URLQueryItem 產生 URL</strong><br><em class="markup--em markup--mixtapeEmbed-em">開發 iOS App 時，我們時常串接後台的 API。通常 API 前面的網址是固定的，只有後面的 path 跟 query 參數會變動，比方以下 iTunes API 的例子:</em>medium.com</a><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E4%BD%BF%E7%94%A8-baseurl-urlcomponents-urlqueryitem-%E7%94%A2%E7%94%9F-url-1e4539a33a89" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="04704c889d06333ce25e878df77f2bb3" data-thumbnail-img-id="1*MKgXFUnTKLcu5TUVfiAPhg.jpeg" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*MKgXFUnTKLcu5TUVfiAPhg.jpeg);"></a></div><h4 name="0704" id="0704" class="graf graf--h4 graf-after--mixtapeEmbed">串接 API 的 function 加上 async &amp; throws，成功時回傳抓到的資料，失敗時丟出錯誤，使用 try <strong class="markup--strong markup--h4-strong">await 呼叫 </strong>URLSession.shared.data</h4><p name="925f" id="925f" class="graf graf--p graf-after--h4">以 function fetchMenuItems 為例。</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="swift" name="74b4" id="74b4" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchMenuItems</span>(<span class="hljs-params">forCategory</span> <span class="hljs-params">categoryName</span>: <span class="hljs-type">String</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; [<span class="hljs-type">MenuItem</span>] {<br />     <span class="hljs-keyword">let</span> baseMenuURL <span class="hljs-operator">=</span> baseURL.appendingPathComponent(<span class="hljs-string">&quot;menu&quot;</span>)<br />     <span class="hljs-keyword">var</span> components <span class="hljs-operator">=</span> <span class="hljs-type">URLComponents</span>(url: baseMenuURL, resolvingAgainstBaseURL: <span class="hljs-literal">true</span>)<span class="hljs-operator">!</span><br />     components.queryItems <span class="hljs-operator">=</span> [<span class="hljs-type">URLQueryItem</span>(name: <span class="hljs-string">&quot;category&quot;</span>, value: categoryName)]<br />     <span class="hljs-keyword">let</span> menuURL <span class="hljs-operator">=</span> components.url<span class="hljs-operator">!</span><br />     <span class="hljs-keyword">let</span> (data, response) <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">URLSession</span>.shared.data(from: menuURL)<br />        <br />     <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> httpResponse <span class="hljs-operator">=</span> response <span class="hljs-keyword">as?</span> <span class="hljs-type">HTTPURLResponse</span>, httpResponse.statusCode <span class="hljs-operator">==</span> <span class="hljs-number">200</span> <span class="hljs-keyword">else</span> {<br />         <span class="hljs-keyword">throw</span> <span class="hljs-type">MenuControllerError</span>.menuItemsNotFound<br />     }<br />        <br />     <span class="hljs-keyword">let</span> decoder <span class="hljs-operator">=</span> <span class="hljs-type">JSONDecoder</span>()<br />     <span class="hljs-keyword">let</span> menuResponse <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> decoder.decode(<span class="hljs-type">MenuResponse</span>.<span class="hljs-keyword">self</span>, from: data)<br />     <span class="hljs-keyword">return</span> menuResponse.items<br />}</span></pre><p name="bc4f" id="bc4f" class="graf graf--p graf-after--pre">說明</p><ul class="postList"><li name="08f6" id="08f6" class="graf graf--li graf-after--p">function 加上 async，表示它是一個非同步 function。</li><li name="6a22" id="6a22" class="graf graf--li graf-after--li">function 加上 throws，表示它有可能丟出錯誤。</li><li name="8398" id="8398" class="graf graf--li graf-after--li">因為是非同步 function，所以可以回傳抓到的資料，-&gt; [MenuItem]表示回傳的資料型別是 [MenuItem]。</li><li name="aa7b" id="aa7b" class="graf graf--li graf-after--li">使用 try await 呼叫 URLSession.shared.data(from:)，從 function data(from:) 回傳的 (data, response) 取得抓到的資料。</li><li name="03f3" id="03f3" class="graf graf--li graf-after--li">URLSession.shared.data(from:) 失敗，http status code 不是 200，或是 decode JSON 失敗時會丟出錯誤。</li></ul><h4 name="1ead" id="1ead" class="graf graf--h4 graf-after--li">自訂錯誤的型別</h4><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="0bab" id="0bab" class="graf graf--pre graf-after--h4 graf--preV2"><span class="pre--content"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">MenuControllerError</span>: <span class="hljs-title class_">Error</span>, <span class="hljs-title class_">LocalizedError</span> {<br />    <span class="hljs-keyword">case</span> categoriesNotFound<br />    <span class="hljs-keyword">case</span> menuItemsNotFound<br />    <span class="hljs-keyword">case</span> orderRequestFailed<br />    <span class="hljs-keyword">case</span> imageDataMissing<br />}</span></pre><h4 name="3baf" id="3baf" class="graf graf--h4 graf-after--pre"><strong class="markup--strong markup--h4-strong">透過 static 定義的 shared 常數呼叫串接 API 的 function，呼叫時搭配 await &amp; Task，從 catch 抓取錯誤</strong></h4><p name="4af4" id="4af4" class="graf graf--p graf-after--h4">App 各個畫面的 view controller 可透過 MenuController.shared 呼叫 function，串接後台的 API。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="3c7c" id="3c7c" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MenuController</span> {<br />    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> shared <span class="hljs-operator">=</span> <span class="hljs-type">MenuController</span>()</span></pre><figure name="9570" id="9570" class="graf graf--figure graf-after--pre"><img class="graf-image" data-image-id="1*82Urqass728FXfqGAKo9QQ.png" data-width="1058" data-height="1482" src="https://cdn-images-1.medium.com/max/800/1*82Urqass728FXfqGAKo9QQ.png"></figure><p name="b8ea" id="b8ea" class="graf graf--p graf-after--figure">比方以下程式利用 MenuController.shared.fetchMenuItems 取得 MenuItem 的 array。</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="swift" name="d70b" id="d70b" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {<br />    <span class="hljs-keyword">super</span>.viewDidLoad()<br />    title <span class="hljs-operator">=</span> category.capitalized<br />    <span class="hljs-type">Task</span> {<br />        <span class="hljs-keyword">do</span> {<br />            <span class="hljs-keyword">let</span> menuItems <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">MenuController</span>.shared.fetchMenuItems(forCategory: category)<br />            updateUI(with: menuItems)<br />        } <span class="hljs-keyword">catch</span> {<br />            displayError(error, title: <span class="hljs-string">&quot;Failed to Fetch Menu Items for <span class="hljs-subst">\(<span class="hljs-keyword">self</span>.category)</span>&quot;</span>)<br />        }<br />    }<br />}</span></pre><p name="526a" id="526a" class="graf graf--p graf-after--pre">說明</p><ul class="postList"><li name="36ec" id="36ec" class="graf graf--li graf-after--p">fetchMenuItems 是 async function，因此呼叫時要加上 await，而且寫在 Task.init 的 { } 裡。</li><li name="2b2e" id="2b2e" class="graf graf--li graf-after--li">fetchMenuItems 失敗丟出錯誤時將執行 catch { } 的程式，利用另外定義的 function displayError 顯示錯誤的 alert。</li></ul><h4 name="1a83" id="1a83" class="graf graf--h4 graf-after--li">在 view controller 加上 @MainActor</h4><p name="e942" id="e942" class="graf graf--p graf-after--h4">為了確保 view controller 呼叫 API 抓資料後能在 main thread 更新 UI，在 view controller 的 class 前加上 @MainActor。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="5c80" id="5c80" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-meta">@MainActor</span><br /><span class="hljs-keyword">class</span> <span class="hljs-title class_">MenuTableViewController</span>: <span class="hljs-title class_">UITableViewController</span> {</span></pre><p name="4e11" id="4e11" class="graf graf--p graf-after--pre">ps: 由於 UIViewController &amp; UITableViewController 都有加上 @MainActor，所以繼承它們的 controller 其實也可以不加 @MainActor。</p><figure name="aa2a" id="aa2a" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*zxHiSZDcBPfJolAWr3X3rg.png" data-width="1140" data-height="704" src="https://cdn-images-1.medium.com/max/800/1*zxHiSZDcBPfJolAWr3X3rg.png"></figure><figure name="dd06" id="dd06" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*s9KxHiQc4b2PEMvYRmNXbw.png" data-width="1118" data-height="712" src="https://cdn-images-1.medium.com/max/800/1*s9KxHiQc4b2PEMvYRmNXbw.png"></figure><h4 name="ee9e" id="ee9e" class="graf graf--h4 graf-after--figure"><strong class="markup--strong markup--h4-strong">JSON 對應的資料型別名字以 Response 結尾</strong></h4><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="b921" id="b921" class="graf graf--pre graf-after--h4 graf--preV2"><span class="pre--content"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MenuResponse</span>: <span class="hljs-title class_">Codable</span> {<br />    <span class="hljs-keyword">let</span> items: [<span class="hljs-type">MenuItem</span>]<br />}<br /><span class="hljs-keyword">struct</span> <span class="hljs-title class_">CategoriesResponse</span>: <span class="hljs-title class_">Codable</span> {<br />    <span class="hljs-keyword">let</span> categories: [<span class="hljs-type">String</span>]<br />}<br /><span class="hljs-keyword">struct</span> <span class="hljs-title class_">OrderResponse</span>: <span class="hljs-title class_">Codable</span> {<br />    <span class="hljs-keyword">let</span> prepTime: <span class="hljs-type">Int</span><br />    <span class="hljs-keyword">enum</span> <span class="hljs-title class_">CodingKeys</span>: <span class="hljs-title class_">String</span>, <span class="hljs-title class_">CodingKey</span> {<br />        <span class="hljs-keyword">case</span> prepTime <span class="hljs-operator">=</span> <span class="hljs-string">&quot;preparation_time&quot;</span><br />    }<br />}</span></pre><h4 name="e9a7" id="e9a7" class="graf graf--h4 graf-after--pre"><strong class="markup--strong markup--h4-strong">在 App 啟動時增加 URLCache 的 cache size</strong></h4><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="swift" name="6405" id="6405" class="graf graf--pre graf-after--h4 graf--preV2"><span class="pre--content"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AppDelegate</span>: <span class="hljs-title class_">UIResponder</span>, <span class="hljs-title class_">UIApplicationDelegate</span> {<br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">application</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>, <span class="hljs-params">didFinishLaunchingWithOptions</span> <span class="hljs-params">launchOptions</span>: [<span class="hljs-type">UIApplication</span>.<span class="hljs-params">LaunchOptionsKey</span>: <span class="hljs-keyword">Any</span>]<span class="hljs-operator">?</span>) -&gt; <span class="hljs-type">Bool</span> {<br />        <span class="hljs-keyword">let</span> temporaryDirectory <span class="hljs-operator">=</span> <span class="hljs-type">NSTemporaryDirectory</span>()<br />        <span class="hljs-keyword">let</span> urlCache <span class="hljs-operator">=</span> <span class="hljs-type">URLCache</span>(memoryCapacity: <span class="hljs-number">25_000_000</span>, diskCapacity: <span class="hljs-number">50_000_000</span>, diskPath: temporaryDirectory)<br />        <span class="hljs-type">URLCache</span>.shared <span class="hljs-operator">=</span> urlCache<br />        <br />        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br />    }</span></pre><h4 name="6ab4" id="6ab4" class="graf graf--h4 graf-after--pre">利用 viewIfLoaded?.window 檢查是否該顯示 alert</h4><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="swift" name="f76c" id="f76c" class="graf graf--pre graf-after--h4 graf--preV2"><span class="pre--content"><span class="hljs-keyword">func</span> <span class="hljs-title function_">displayError</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">error</span>: <span class="hljs-type">Error</span>, <span class="hljs-params">title</span>: <span class="hljs-type">String</span>) {<br />    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">_</span> <span class="hljs-operator">=</span> viewIfLoaded<span class="hljs-operator">?</span>.window <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }<br />    <span class="hljs-keyword">let</span> alert <span class="hljs-operator">=</span> <span class="hljs-type">UIAlertController</span>(title: title, message: error.localizedDescription, preferredStyle: .alert)<br />    alert.addAction(<span class="hljs-type">UIAlertAction</span>(title: <span class="hljs-string">&quot;Dismiss&quot;</span>, style: .default, handler: <span class="hljs-literal">nil</span>))<br />    <span class="hljs-keyword">self</span>.present(alert, animated: <span class="hljs-literal">true</span>, completion: <span class="hljs-literal">nil</span>)<br />}</span></pre><div name="5928" id="5928" class="graf graf--mixtapeEmbed graf-after--pre"><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E9%A1%AF%E7%A4%BA-alert-%E5%89%8D%E6%AA%A2%E6%9F%A5%E5%87%BA%E5%95%8F%E9%A1%8C%E7%9A%84%E9%A0%81%E9%9D%A2%E6%98%AF%E5%90%A6%E6%AD%A3%E9%A1%AF%E7%A4%BA%E8%91%97-6981f3b746f4" data-href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E9%A1%AF%E7%A4%BA-alert-%E5%89%8D%E6%AA%A2%E6%9F%A5%E5%87%BA%E5%95%8F%E9%A1%8C%E7%9A%84%E9%A0%81%E9%9D%A2%E6%98%AF%E5%90%A6%E6%AD%A3%E9%A1%AF%E7%A4%BA%E8%91%97-6981f3b746f4" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E9%A1%AF%E7%A4%BA-alert-%E5%89%8D%E6%AA%A2%E6%9F%A5%E5%87%BA%E5%95%8F%E9%A1%8C%E7%9A%84%E9%A0%81%E9%9D%A2%E6%98%AF%E5%90%A6%E6%AD%A3%E9%A1%AF%E7%A4%BA%E8%91%97-6981f3b746f4"><strong class="markup--strong markup--mixtapeEmbed-strong">顯示 alert 前檢查出問題的頁面是否正顯示著，利用 viewIfLoaded?.window &amp; presentedViewController</strong><br><em class="markup--em markup--mixtapeEmbed-em">開發 iOS App 時，我們時常使用 alert 顯示錯誤訊息，比方網路資料抓不到時顯示 alert 告訴使用者網路連線有問題。</em>medium.com</a><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E9%A1%AF%E7%A4%BA-alert-%E5%89%8D%E6%AA%A2%E6%9F%A5%E5%87%BA%E5%95%8F%E9%A1%8C%E7%9A%84%E9%A0%81%E9%9D%A2%E6%98%AF%E5%90%A6%E6%AD%A3%E9%A1%AF%E7%A4%BA%E8%91%97-6981f3b746f4" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="d5b03d323abe7fb2c925a4b72d3abdce" data-thumbnail-img-id="1*_sv5jeNhoaucu9hjpEzvVQ.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*_sv5jeNhoaucu9hjpEzvVQ.png);"></a></div><h4 name="2c00" id="2c00" class="graf graf--h4 graf-after--mixtapeEmbed">利用 indexPath &amp; tableView(_:didEndDisplaying:forRowAt:) 確保 cell 顯示正確的圖片，不需要圖片時將抓圖的 task cancel</h4><p name="a3ae" id="a3ae" class="graf graf--p graf-after--h4">因為 cell 重覆利用的特性，我們必須做一些處理確保 cell 顯示正確的圖片。</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="swift" name="4384" id="4384" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-meta">@MainActor</span><br /><span class="hljs-keyword">class</span> <span class="hljs-title class_">MenuTableViewController</span>: <span class="hljs-title class_">UITableViewController</span> {<br />   <br />    <span class="hljs-keyword">var</span> imageLoadTasks: [<span class="hljs-type">IndexPath</span>: <span class="hljs-type">Task</span>&lt;<span class="hljs-type">Void</span>, <span class="hljs-type">Never</span>&gt;] <span class="hljs-operator">=</span> [:]<br />    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidDisappear</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">animated</span>: <span class="hljs-type">Bool</span>) {<br />        <span class="hljs-keyword">super</span>.viewDidDisappear(animated)<br />        <br />        <span class="hljs-comment">// cancel the image fetching tasks that are no longer needed</span><br />        imageLoadTasks.forEach { key, value <span class="hljs-keyword">in</span>     <br />             value.cancel() <br />        }<br />    }<br />    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">tableView</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">tableView</span>: <span class="hljs-type">UITableView</span>, <span class="hljs-params">cellForRowAt</span> <span class="hljs-params">indexPath</span>: <span class="hljs-type">IndexPath</span>) -&gt; <span class="hljs-type">UITableViewCell</span> {<br />        <span class="hljs-keyword">let</span> cell <span class="hljs-operator">=</span> tableView.dequeueReusableCell(withIdentifier: <span class="hljs-string">&quot;MenuItem&quot;</span>, for: indexPath)<br />        configure(cell, forItemAt: indexPath)<br />        <span class="hljs-keyword">return</span> cell<br />    }<br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">configure</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">cell</span>: <span class="hljs-type">UITableViewCell</span>, <span class="hljs-params">forItemAt</span> <span class="hljs-params">indexPath</span>: <span class="hljs-type">IndexPath</span>) {<br />        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> cell <span class="hljs-operator">=</span> cell <span class="hljs-keyword">as?</span> <span class="hljs-type">MenuItemCell</span> <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }<br />        <br />        <span class="hljs-keyword">let</span> menuItem <span class="hljs-operator">=</span> menuItems[indexPath.row]<br />        <br />        cell.itemName <span class="hljs-operator">=</span> menuItem.name<br />        cell.price <span class="hljs-operator">=</span> menuItem.price<br />        cell.image <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span><br />        imageLoadTasks[indexPath] <span class="hljs-operator">=</span> <span class="hljs-type">Task</span>.<span class="hljs-keyword">init</span> {<br />            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> image <span class="hljs-operator">=</span> <span class="hljs-keyword">try?</span> <span class="hljs-keyword">await</span> <span class="hljs-type">MenuController</span>.shared.fetchImage(from: menuItem.imageURL) {<br />                <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> currentIndexPath <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.tableView.indexPath(for: cell),<br />                    currentIndexPath <span class="hljs-operator">==</span> indexPath {<br />                    cell.image <span class="hljs-operator">=</span> image<br />                }<br />            }<br />            imageLoadTasks[indexPath] <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span><br />        }<br />    }<br />    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">tableView</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">tableView</span>: <span class="hljs-type">UITableView</span>, <span class="hljs-params">didEndDisplaying</span> <span class="hljs-params">cell</span>: <span class="hljs-type">UITableViewCell</span>, <span class="hljs-params">forRowAt</span> <span class="hljs-params">indexPath</span>: <span class="hljs-type">IndexPath</span>) {<br />        <span class="hljs-comment">// cancel the image fetching task if we no longer need it</span><br />        imageLoadTasks[indexPath]<span class="hljs-operator">?</span>.cancel()<br />    }</span></pre><p name="d2f2" id="d2f2" class="graf graf--p graf-after--pre">說明</p><ul class="postList"><li name="e4af" id="e4af" class="graf graf--li graf-after--p">將抓圖的 task 儲存在property imageLoadTasks。</li><li name="7736" id="7736" class="graf graf--li graf-after--li">抓到圖時檢查 cell 目前的 index path，判斷 cell 還是原來的 indexPath 時才更新圖片。</li><li name="b715" id="b715" class="graf graf--li graf-after--li">在 tableView(_:didEndDisplaying:forRowAt:) 時，cell 已經不在畫面上，因此取消它的抓圖 task。</li><li name="b7f8" id="b7f8" class="graf graf--li graf-after--li">在 viewDidDisappear 時整個頁面都看不到了，因此取消全部的抓圖 task。</li></ul><p name="9966" id="9966" class="graf graf--p graf-after--li">關於 collection view &amp; table view 的網路圖片顯示問題，也可進一步參考以下說明。</p><div name="68b5" id="68b5" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/collection-view-table-view-%E7%9A%84%E7%B6%B2%E8%B7%AF%E5%9C%96%E7%89%87%E9%A1%AF%E7%A4%BA%E5%95%8F%E9%A1%8C-e83c5ca487c8" data-href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/collection-view-table-view-%E7%9A%84%E7%B6%B2%E8%B7%AF%E5%9C%96%E7%89%87%E9%A1%AF%E7%A4%BA%E5%95%8F%E9%A1%8C-e83c5ca487c8" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/collection-view-table-view-%E7%9A%84%E7%B6%B2%E8%B7%AF%E5%9C%96%E7%89%87%E9%A1%AF%E7%A4%BA%E5%95%8F%E9%A1%8C-e83c5ca487c8"><strong class="markup--strong markup--mixtapeEmbed-strong">collection view &amp; table view 的網路圖片顯示問題</strong><br><em class="markup--em markup--mixtapeEmbed-em">開發 iOS App 時，我們時常在 collection view &amp; table view 的 cell 顯示網路抓取的圖片，然而撰寫這部分程式時卻有一些要注意的小地方，接下來就讓我們以抓取 Placeholder.com…</em>medium.com</a><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/collection-view-table-view-%E7%9A%84%E7%B6%B2%E8%B7%AF%E5%9C%96%E7%89%87%E9%A1%AF%E7%A4%BA%E5%95%8F%E9%A1%8C-e83c5ca487c8" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="3d5b7622b6d2c5389816c802773ef1b9" data-thumbnail-img-id="1*-dWwCVvfRbvv2PgGLPwN3Q.jpeg" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*-dWwCVvfRbvv2PgGLPwN3Q.jpeg);"></a></div><h4 name="681b" id="681b" class="graf graf--h4 graf-after--mixtapeEmbed">宣告方便整個 App 存取的 property，property 改變時使用 NotificationCenter 通知畫面更新</h4><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="b63d" id="b63d" class="graf graf--pre graf-after--h4 graf--preV2"><span class="pre--content"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MenuController</span> {<br />   <br />    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> orderUpdatedNotification <span class="hljs-operator">=</span> <span class="hljs-type">Notification</span>.<span class="hljs-type">Name</span>(<span class="hljs-string">&quot;MenuController.orderUpdated&quot;</span>)<br />       <br />    <span class="hljs-keyword">var</span> order <span class="hljs-operator">=</span> <span class="hljs-type">Order</span>() {<br />        <span class="hljs-keyword">didSet</span> {<br />            <span class="hljs-type">NotificationCenter</span>.default.post(name: <span class="hljs-type">MenuController</span>.orderUpdatedNotification, object: <span class="hljs-literal">nil</span>)<br />        }<br />    }</span></pre><p name="1fe7" id="1fe7" class="graf graf--p graf-after--pre">App 的任何地方都可利用 MenuController.shared.order 存取 order，例如 MenuItemDetailViewController 利用以下程式增加訂購的 menuItem。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="daa9" id="daa9" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-type">MenuController</span>.shared.order.menuItems.append(menuItem)</span></pre><h4 name="0b97" id="0b97" class="graf graf--h4 graf-after--pre"><strong class="markup--strong markup--h4-strong">MenuController 的完整程式</strong></h4><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="swift" name="9665" id="9665" class="graf graf--pre graf-after--h4 graf--preV2"><span class="pre--content"><span class="hljs-keyword">import</span> Foundation<br /><span class="hljs-keyword">import</span> UIKit<br /><br /><span class="hljs-keyword">class</span> <span class="hljs-title class_">MenuController</span> {<br />    <span class="hljs-keyword">enum</span> <span class="hljs-title class_">MenuControllerError</span>: <span class="hljs-title class_">Error</span>, <span class="hljs-title class_">LocalizedError</span> {<br />        <span class="hljs-keyword">case</span> categoriesNotFound<br />        <span class="hljs-keyword">case</span> menuItemsNotFound<br />        <span class="hljs-keyword">case</span> orderRequestFailed<br />        <span class="hljs-keyword">case</span> imageDataMissing<br />    }<br />    <br />    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> orderUpdatedNotification <span class="hljs-operator">=</span> <span class="hljs-type">Notification</span>.<span class="hljs-type">Name</span>(<span class="hljs-string">&quot;MenuController.orderUpdated&quot;</span>)<br />    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> shared <span class="hljs-operator">=</span> <span class="hljs-type">MenuController</span>()<br />    <br />    <span class="hljs-keyword">let</span> baseURL <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">&quot;http://localhost:8080/&quot;</span>)<span class="hljs-operator">!</span><br />    <br />    <span class="hljs-keyword">var</span> order <span class="hljs-operator">=</span> <span class="hljs-type">Order</span>() {<br />        <span class="hljs-keyword">didSet</span> {<br />            <span class="hljs-type">NotificationCenter</span>.default.post(name: <span class="hljs-type">MenuController</span>.orderUpdatedNotification, object: <span class="hljs-literal">nil</span>)<br />        }<br />    }<br />    <br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchCategories</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; [<span class="hljs-type">String</span>] {<br />        <span class="hljs-keyword">let</span> categoriesURL <span class="hljs-operator">=</span> baseURL.appendingPathComponent(<span class="hljs-string">&quot;categories&quot;</span>)<br />        <br />        <span class="hljs-keyword">let</span> (data, response) <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">URLSession</span>.shared.data(from: categoriesURL)<br />        <br />        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> httpResponse <span class="hljs-operator">=</span> response <span class="hljs-keyword">as?</span> <span class="hljs-type">HTTPURLResponse</span>, httpResponse.statusCode <span class="hljs-operator">==</span> <span class="hljs-number">200</span> <span class="hljs-keyword">else</span> {<br />            <span class="hljs-keyword">throw</span> <span class="hljs-type">MenuControllerError</span>.categoriesNotFound<br />        }<br />        <br />        <span class="hljs-keyword">let</span> decoder <span class="hljs-operator">=</span> <span class="hljs-type">JSONDecoder</span>()<br />        <span class="hljs-keyword">let</span> categoriesResponse <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> decoder.decode(<span class="hljs-type">CategoriesResponse</span>.<span class="hljs-keyword">self</span>, from: data)<br />        <span class="hljs-keyword">return</span> categoriesResponse.categories<br />    }<br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchMenuItems</span>(<span class="hljs-params">forCategory</span> <span class="hljs-params">categoryName</span>: <span class="hljs-type">String</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; [<span class="hljs-type">MenuItem</span>] {<br />        <span class="hljs-keyword">let</span> baseMenuURL <span class="hljs-operator">=</span> baseURL.appendingPathComponent(<span class="hljs-string">&quot;menu&quot;</span>)<br />        <span class="hljs-keyword">var</span> components <span class="hljs-operator">=</span> <span class="hljs-type">URLComponents</span>(url: baseMenuURL, resolvingAgainstBaseURL: <span class="hljs-literal">true</span>)<span class="hljs-operator">!</span><br />        components.queryItems <span class="hljs-operator">=</span> [<span class="hljs-type">URLQueryItem</span>(name: <span class="hljs-string">&quot;category&quot;</span>, value: categoryName)]<br />        <span class="hljs-keyword">let</span> menuURL <span class="hljs-operator">=</span> components.url<span class="hljs-operator">!</span><br />        <span class="hljs-keyword">let</span> (data, response) <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">URLSession</span>.shared.data(from: menuURL)<br />        <br />        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> httpResponse <span class="hljs-operator">=</span> response <span class="hljs-keyword">as?</span> <span class="hljs-type">HTTPURLResponse</span>, httpResponse.statusCode <span class="hljs-operator">==</span> <span class="hljs-number">200</span> <span class="hljs-keyword">else</span> {<br />            <span class="hljs-keyword">throw</span> <span class="hljs-type">MenuControllerError</span>.menuItemsNotFound<br />        }<br />        <br />        <span class="hljs-keyword">let</span> decoder <span class="hljs-operator">=</span> <span class="hljs-type">JSONDecoder</span>()<br />        <span class="hljs-keyword">let</span> menuResponse <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> decoder.decode(<span class="hljs-type">MenuResponse</span>.<span class="hljs-keyword">self</span>, from: data)<br />        <span class="hljs-keyword">return</span> menuResponse.items<br />    }<br />    <br />    <span class="hljs-keyword">typealias</span> <span class="hljs-type">MinutesToPrepare</span> <span class="hljs-operator">=</span> <span class="hljs-type">Int</span><br />    <br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">submitOrder</span>(<span class="hljs-params">forMenuIDs</span> <span class="hljs-params">menuIDs</span>: [<span class="hljs-type">Int</span>]) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">MinutesToPrepare</span> {<br />        <span class="hljs-keyword">let</span> orderURL <span class="hljs-operator">=</span> baseURL.appendingPathComponent(<span class="hljs-string">&quot;order&quot;</span>)<br />        <span class="hljs-keyword">var</span> request <span class="hljs-operator">=</span> <span class="hljs-type">URLRequest</span>(url: orderURL)<br />        request.httpMethod <span class="hljs-operator">=</span> <span class="hljs-string">&quot;POST&quot;</span><br />        request.setValue(<span class="hljs-string">&quot;application/json&quot;</span>, forHTTPHeaderField: <span class="hljs-string">&quot;Content-Type&quot;</span>)<br />        <br />        <span class="hljs-keyword">let</span> menuIdsDict <span class="hljs-operator">=</span> [<span class="hljs-string">&quot;menuIds&quot;</span>: menuIDs]<br />        <span class="hljs-keyword">let</span> jsonEncoder <span class="hljs-operator">=</span> <span class="hljs-type">JSONEncoder</span>()<br />        <span class="hljs-keyword">let</span> jsonData <span class="hljs-operator">=</span> <span class="hljs-keyword">try?</span> jsonEncoder.encode(menuIdsDict)<br />        request.httpBody <span class="hljs-operator">=</span> jsonData<br />        <br />        <span class="hljs-keyword">let</span> (data, response) <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">URLSession</span>.shared.data(for: request)<br />        <br />        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> httpResponse <span class="hljs-operator">=</span> response <span class="hljs-keyword">as?</span> <span class="hljs-type">HTTPURLResponse</span>, httpResponse.statusCode <span class="hljs-operator">==</span> <span class="hljs-number">200</span> <span class="hljs-keyword">else</span> {<br />            <span class="hljs-keyword">throw</span> <span class="hljs-type">MenuControllerError</span>.orderRequestFailed<br />        }<br />        <br />        <span class="hljs-keyword">let</span> decoder <span class="hljs-operator">=</span> <span class="hljs-type">JSONDecoder</span>()<br />        <span class="hljs-keyword">let</span> orderResponse <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> decoder.decode(<span class="hljs-type">OrderResponse</span>.<span class="hljs-keyword">self</span>, from: data)<br />        <span class="hljs-keyword">return</span> orderResponse.prepTime<br />    }<br />    <br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchImage</span>(<span class="hljs-params">from</span> <span class="hljs-params">url</span>: <span class="hljs-type">URL</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">UIImage</span> {<br />        <span class="hljs-keyword">let</span> (data, response) <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">URLSession</span>.shared.data(from: url)<br />        <br />        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> httpResponse <span class="hljs-operator">=</span> response <span class="hljs-keyword">as?</span> <span class="hljs-type">HTTPURLResponse</span>, httpResponse.statusCode <span class="hljs-operator">==</span> <span class="hljs-number">200</span> <span class="hljs-keyword">else</span> {<br />            <span class="hljs-keyword">throw</span> <span class="hljs-type">MenuControllerError</span>.imageDataMissing<br />        }<br />        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> image <span class="hljs-operator">=</span> <span class="hljs-type">UIImage</span>(data: data) <span class="hljs-keyword">else</span> {<br />            <span class="hljs-keyword">throw</span> <span class="hljs-type">MenuControllerError</span>.imageDataMissing<br />        }<br />        <br />        <span class="hljs-keyword">return</span> image<br />    }<br />}</span></pre><h3 name="99d6" id="99d6" class="graf graf--h3 graf-after--pre">模仿 Apple 的範例串接 API</h3><p name="3cc0" id="3cc0" class="graf graf--p graf-after--h3">初學者撰寫串接後台的程式時可模仿範例的寫法，將跟後台溝通的相關程式統一定義在某個檔案，比方串接 TMBD API 開發電影 App 時，將相關的 API 定義成 NetworkController 或 MovieController 的 function，然後利用 static 宣告的變數 shared 得到物件，呼叫 async function 取得 API 回傳的資料。</p><div name="858b" id="858b" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://www.themoviedb.org/documentation/api?language=en-US" data-href="https://www.themoviedb.org/documentation/api?language=en-US" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://www.themoviedb.org/documentation/api?language=en-US"><strong class="markup--strong markup--mixtapeEmbed-strong">API Overview - The Movie Database (TMDB)</strong><br><em class="markup--em markup--mixtapeEmbed-em">Our API is available for everyone to use. A TMDB user account is required to request an API key. Professional users are…</em>www.themoviedb.org</a><a href="https://www.themoviedb.org/documentation/api?language=en-US" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="f638a6c945a79b10bf01aef89204a43d"></a></div><p name="d051" id="d051" class="graf graf--p graf-after--mixtapeEmbed">定義抓資料物件的型別名稱時，不一定要以 controller 結尾，以下幾種都是常見的結尾:</p><ul class="postList"><li name="8c52" id="8c52" class="graf graf--li graf-after--p">Controller</li><li name="e3d3" id="e3d3" class="graf graf--li graf-after--li">Service</li><li name="8b81" id="8b81" class="graf graf--li graf-after--li">Client</li><li name="7174" id="7174" class="graf graf--li graf-after--li">Manager</li><li name="c970" id="c970" class="graf graf--li graf-after--li">Fetcher</li></ul><h3 name="30e4" id="30e4" class="graf graf--h3 graf-after--li">串接 REST API，練習 http get，post，delete，put，以 Reqres API 為例</h3><p name="cab0" id="cab0" class="graf graf--p graf-after--h3">剛剛 Apple 的範例已經很完整，不過常見的 REST API 通常包含了 HTTP get，post，delete &amp; put，因此接下來讓我們以 Reqres API 為例，試試串接 REST API。</p><div name="042a" id="042a" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E4%BD%BF%E7%94%A8-urlsession-%E4%B8%B2%E6%8E%A5-http-get-post-delete-put-api-%E4%BB%A5-reqres-api-%E7%82%BA%E4%BE%8B-f977ec876c33" data-href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E4%BD%BF%E7%94%A8-urlsession-%E4%B8%B2%E6%8E%A5-http-get-post-delete-put-api-%E4%BB%A5-reqres-api-%E7%82%BA%E4%BE%8B-f977ec876c33" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E4%BD%BF%E7%94%A8-urlsession-%E4%B8%B2%E6%8E%A5-http-get-post-delete-put-api-%E4%BB%A5-reqres-api-%E7%82%BA%E4%BE%8B-f977ec876c33"><strong class="markup--strong markup--mixtapeEmbed-strong">使用 URLSession 串接 REST API，練習 http get，post，delete，put，以 Reqres API 為例</strong><br><em class="markup--em markup--mixtapeEmbed-em">開發 iOS App 時，我們時常需要跟網路上的後台(server) 溝通。如下圖所示，我們的 App 是 client，它會發送 request 給 server，然後 server 再回傳 response，比方將 JSON…</em>medium.com</a><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E4%BD%BF%E7%94%A8-urlsession-%E4%B8%B2%E6%8E%A5-http-get-post-delete-put-api-%E4%BB%A5-reqres-api-%E7%82%BA%E4%BE%8B-f977ec876c33" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="c08866f764f6d1421d0b51ece79be944" data-thumbnail-img-id="1*EgbnqUQogcCH136xyvdbbQ.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*EgbnqUQogcCH136xyvdbbQ.png);"></a></div><h4 name="b91b" id="b91b" class="graf graf--h4 graf-after--mixtapeEmbed"><strong class="markup--strong markup--h4-strong">model 資料型別</strong></h4><p name="3905" id="3905" class="graf graf--p graf-after--h4">型別名 Response 結尾表示回傳的資料，型別名 Body 結尾表示上傳的資料。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="2510" id="2510" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">UsersResponse</span>: <span class="hljs-title class_">Decodable</span> {<br />    <span class="hljs-keyword">let</span> page: <span class="hljs-type">Int</span><br />    <span class="hljs-keyword">let</span> perPage: <span class="hljs-type">Int</span><br />    <span class="hljs-keyword">let</span> total: <span class="hljs-type">Int</span><br />    <span class="hljs-keyword">let</span> totalPages: <span class="hljs-type">Int</span><br />    <span class="hljs-keyword">let</span> data: [<span class="hljs-type">User</span>]<br />}<br /><span class="hljs-keyword">struct</span> <span class="hljs-title class_">User</span>: <span class="hljs-title class_">Decodable</span> {<br />    <span class="hljs-keyword">let</span> id: <span class="hljs-type">Int</span><br />    <span class="hljs-keyword">let</span> email: <span class="hljs-type">String</span><br />    <span class="hljs-keyword">let</span> firstName: <span class="hljs-type">String</span><br />    <span class="hljs-keyword">let</span> lastName: <span class="hljs-type">String</span><br />    <span class="hljs-keyword">let</span> avatar: <span class="hljs-type">URL</span><br />}<br /><span class="hljs-keyword">struct</span> <span class="hljs-title class_">CreateUserResponse</span>: <span class="hljs-title class_">Decodable</span> {<br />    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span><br />    <span class="hljs-keyword">let</span> job: <span class="hljs-type">String</span><br />    <span class="hljs-keyword">let</span> id: <span class="hljs-type">String</span><br />}<br /><span class="hljs-keyword">struct</span> <span class="hljs-title class_">UpdateUserResponse</span>: <span class="hljs-title class_">Decodable</span> {<br />    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span><br />    <span class="hljs-keyword">let</span> job: <span class="hljs-type">String</span><br />}<br /><span class="hljs-keyword">struct</span> <span class="hljs-title class_">CreateUserBody</span>: <span class="hljs-title class_">Encodable</span> {<br />    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span><br />    <span class="hljs-keyword">let</span> job: <span class="hljs-type">String</span><br />}<br /><span class="hljs-keyword">struct</span> <span class="hljs-title class_">UpdateUserBody</span>: <span class="hljs-title class_">Encodable</span> {<br />    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span><br />    <span class="hljs-keyword">let</span> job: <span class="hljs-type">String</span><br />}</span></pre><h4 name="a784" id="a784" class="graf graf--h4 graf-after--pre"><strong class="markup--strong markup--h4-strong">定義設定網址參數的 URL extension</strong></h4><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="swift" name="7e46" id="7e46" class="graf graf--pre graf-after--h4 graf--preV2"><span class="pre--content"><span class="hljs-keyword">extension</span> <span class="hljs-title class_">URL</span> {<br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">withQueries</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">queries</span>: [<span class="hljs-params">String</span>: <span class="hljs-type">String</span>]) -&gt; <span class="hljs-type">URL</span>? {<br />        <span class="hljs-keyword">var</span> components <span class="hljs-operator">=</span> <span class="hljs-type">URLComponents</span>(url: <span class="hljs-keyword">self</span>, resolvingAgainstBaseURL: <span class="hljs-literal">true</span>)<br />        components<span class="hljs-operator">?</span>.queryItems <span class="hljs-operator">=</span> queries.map {<br />            <span class="hljs-type">URLQueryItem</span>(name: <span class="hljs-variable">$0</span>.key, value: <span class="hljs-variable">$0</span>.value)<br />        }<br />        <span class="hljs-keyword">return</span> components<span class="hljs-operator">?</span>.url<br />    }<br />}</span></pre><h4 name="0927" id="0927" class="graf graf--h4 graf-after--pre"><strong class="markup--strong markup--h4-strong">定義錯誤型別 NetworkError</strong></h4><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="c3b1" id="c3b1" class="graf graf--pre graf-after--h4 graf--preV2"><span class="pre--content"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">NetworkError</span>: <span class="hljs-title class_">Error</span> {<br />    <span class="hljs-keyword">case</span> invalidURL<br />    <span class="hljs-keyword">case</span> getUsersFailed<br />    <span class="hljs-keyword">case</span> createUserFailed<br />    <span class="hljs-keyword">case</span> deleteUserFailed<br />    <span class="hljs-keyword">case</span> updateUserFailed<br />}</span></pre><h3 name="224d" id="224d" class="graf graf--h3 graf-after--pre"><strong class="markup--strong markup--h3-strong">串接 API 的 NetworkController</strong></h3><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="swift" name="74dd" id="74dd" class="graf graf--pre graf-after--h3 graf--preV2"><span class="pre--content"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkController</span> {<br />    <br />    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> shared <span class="hljs-operator">=</span> <span class="hljs-type">NetworkController</span>()<br />    <br />    <span class="hljs-keyword">let</span> baseURL <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">&quot;https://reqres.in/api&quot;</span>)<span class="hljs-operator">!</span><br />    <br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">getUsers</span>(<span class="hljs-params">page</span>: <span class="hljs-type">Int</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">UsersResponse</span> {<br />        <span class="hljs-keyword">let</span> queries <span class="hljs-operator">=</span> [<span class="hljs-string">&quot;page&quot;</span>: <span class="hljs-string">&quot;<span class="hljs-subst">\(page)</span>&quot;</span>]<br />        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> baseURL.appendingPathComponent(<span class="hljs-string">&quot;users&quot;</span>).withQueries(queries) <span class="hljs-keyword">else</span> {<br />            <span class="hljs-keyword">throw</span> <span class="hljs-type">NetworkError</span>.invalidURL<br />        }<br />        <br />        <span class="hljs-keyword">let</span> (data, response) <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">URLSession</span>.shared.data(from: url)<br />        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> httpResponse <span class="hljs-operator">=</span> response <span class="hljs-keyword">as?</span> <span class="hljs-type">HTTPURLResponse</span>,<br />              httpResponse.statusCode <span class="hljs-operator">==</span> <span class="hljs-number">200</span> <span class="hljs-keyword">else</span> {<br />            <span class="hljs-keyword">throw</span> <span class="hljs-type">NetworkError</span>.getUsersFailed<br />        }<br />        <span class="hljs-keyword">let</span> decoder <span class="hljs-operator">=</span> <span class="hljs-type">JSONDecoder</span>()<br />        decoder.keyDecodingStrategy <span class="hljs-operator">=</span> .convertFromSnakeCase<br />        <span class="hljs-keyword">let</span> usersResponse <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> decoder.decode(<span class="hljs-type">UsersResponse</span>.<span class="hljs-keyword">self</span>, from: data)<br />        <span class="hljs-keyword">return</span> usersResponse<br />    }<br />    <br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">user</span>: <span class="hljs-type">CreateUserBody</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">CreateUserResponse</span> {<br />        <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> baseURL.appendingPathComponent(<span class="hljs-string">&quot;users&quot;</span>)<br />        <span class="hljs-keyword">var</span> request <span class="hljs-operator">=</span> <span class="hljs-type">URLRequest</span>(url: url)<br />        request.httpMethod <span class="hljs-operator">=</span> <span class="hljs-string">&quot;POST&quot;</span><br />        request.setValue(<span class="hljs-string">&quot;application/json&quot;</span>, forHTTPHeaderField: <span class="hljs-string">&quot;Content-Type&quot;</span>)<br />        <span class="hljs-keyword">let</span> encoder <span class="hljs-operator">=</span> <span class="hljs-type">JSONEncoder</span>()<br />        <span class="hljs-keyword">let</span> httpBody <span class="hljs-operator">=</span> <span class="hljs-keyword">try?</span> encoder.encode(user)<br />        request.httpBody <span class="hljs-operator">=</span> httpBody<br />        <br />        <span class="hljs-keyword">let</span> (data, response) <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">URLSession</span>.shared.data(for: request)<br />        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> httpResponse <span class="hljs-operator">=</span> response <span class="hljs-keyword">as?</span> <span class="hljs-type">HTTPURLResponse</span>,<br />              httpResponse.statusCode <span class="hljs-operator">==</span> <span class="hljs-number">201</span> <span class="hljs-keyword">else</span> {<br />            <span class="hljs-keyword">throw</span> <span class="hljs-type">NetworkError</span>.createUserFailed<br />        }<br />        <span class="hljs-keyword">let</span> decoder <span class="hljs-operator">=</span> <span class="hljs-type">JSONDecoder</span>()<br />        <span class="hljs-keyword">let</span> createUserResponse <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> decoder.decode(<span class="hljs-type">CreateUserResponse</span>.<span class="hljs-keyword">self</span>, from: data)<br />        <span class="hljs-keyword">return</span> createUserResponse<br />    }<br />    <br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">deleteUser</span>(<span class="hljs-params">userId</span>: <span class="hljs-type">Int</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">String</span> {<br />        <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> baseURL.appendingPathComponent(<span class="hljs-string">&quot;users/<span class="hljs-subst">\(userId)</span>&quot;</span>)<br />        <span class="hljs-keyword">var</span> request <span class="hljs-operator">=</span> <span class="hljs-type">URLRequest</span>(url: url)<br />        request.httpMethod <span class="hljs-operator">=</span> <span class="hljs-string">&quot;DELETE&quot;</span><br />        <br />        <span class="hljs-keyword">let</span> (<span class="hljs-keyword">_</span>, response) <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">URLSession</span>.shared.data(for: request)<br />        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> httpResponse <span class="hljs-operator">=</span> response <span class="hljs-keyword">as?</span> <span class="hljs-type">HTTPURLResponse</span>,<br />              httpResponse.statusCode <span class="hljs-operator">==</span> <span class="hljs-number">204</span> <span class="hljs-keyword">else</span> {<br />            <span class="hljs-keyword">throw</span> <span class="hljs-type">NetworkError</span>.deleteUserFailed<br />        }<br />        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ok&quot;</span><br />    }<br />    <br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">updateUser</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">user</span>: <span class="hljs-type">UpdateUserBody</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">UpdateUserResponse</span> {<br />        <br />        <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> baseURL.appendingPathComponent(<span class="hljs-string">&quot;users&quot;</span>)<br />        <span class="hljs-keyword">var</span> request <span class="hljs-operator">=</span> <span class="hljs-type">URLRequest</span>(url: url)<br />        request.httpMethod <span class="hljs-operator">=</span> <span class="hljs-string">&quot;PUT&quot;</span><br />        request.setValue(<span class="hljs-string">&quot;application/json&quot;</span>, forHTTPHeaderField: <span class="hljs-string">&quot;Content-Type&quot;</span>)<br />        <br />        <span class="hljs-keyword">let</span> encoder <span class="hljs-operator">=</span> <span class="hljs-type">JSONEncoder</span>()<br />        <span class="hljs-keyword">let</span> httpBody <span class="hljs-operator">=</span> <span class="hljs-keyword">try?</span> encoder.encode(user)<br />        request.httpBody <span class="hljs-operator">=</span> httpBody<br />        <br />        <span class="hljs-keyword">let</span> (data, response) <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">URLSession</span>.shared.data(for: request)<br />        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> httpResponse <span class="hljs-operator">=</span> response <span class="hljs-keyword">as?</span> <span class="hljs-type">HTTPURLResponse</span>,<br />              httpResponse.statusCode <span class="hljs-operator">==</span> <span class="hljs-number">200</span> <span class="hljs-keyword">else</span> {<br />            <span class="hljs-keyword">throw</span> <span class="hljs-type">NetworkError</span>.updateUserFailed<br />        }<br />        <span class="hljs-keyword">let</span> decoder <span class="hljs-operator">=</span> <span class="hljs-type">JSONDecoder</span>()<br />        <span class="hljs-keyword">let</span> updateUserResponse <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> decoder.decode(<span class="hljs-type">UpdateUserResponse</span>.<span class="hljs-keyword">self</span>, from: data)<br />        <span class="hljs-keyword">return</span> updateUserResponse<br />    }<br />}</span></pre><h4 name="6822" id="6822" class="graf graf--h4 graf-after--pre"><strong class="markup--strong markup--h4-strong">呼叫 NetworkController 的 function 串接 API</strong></h4><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="swift" name="7195" id="7195" class="graf graf--pre graf-after--h4 graf--preV2"><span class="pre--content"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewController</span>: <span class="hljs-title class_">UIViewController</span> {<br />    <br />    <span class="hljs-keyword">@IBAction</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">get</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">sender</span>: <span class="hljs-keyword">Any</span>) {<br />        <br />        <span class="hljs-type">Task</span> {<br />            <span class="hljs-keyword">do</span> {<br />                <span class="hljs-keyword">let</span> usersResponse <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">NetworkController</span>.shared.getUsers(page: <span class="hljs-number">1</span>)<br />                <span class="hljs-built_in">print</span>(usersResponse)<br />            } <span class="hljs-keyword">catch</span> {<br />                <span class="hljs-built_in">print</span>(error)<br />            }<br />        }<br />    }<br />    <br />    <span class="hljs-keyword">@IBAction</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">post</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">sender</span>: <span class="hljs-keyword">Any</span>) {<br />        <span class="hljs-keyword">let</span> createUserBody <span class="hljs-operator">=</span> <span class="hljs-type">CreateUserBody</span>(name: <span class="hljs-string">&quot;Peter&quot;</span>, job: <span class="hljs-string">&quot;Writer&quot;</span>)<br />        <span class="hljs-type">Task</span> {<br />            <span class="hljs-keyword">do</span> {<br />                <span class="hljs-keyword">let</span> createUserResponse <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">NetworkController</span>.shared.createUser(createUserBody)<br />                <span class="hljs-built_in">print</span>(createUserResponse)<br />            } <span class="hljs-keyword">catch</span> {<br />                <span class="hljs-built_in">print</span>(error)<br />            }<br />        }<br />    }<br />    <br />    <br />    <span class="hljs-keyword">@IBAction</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">remove</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">sender</span>: <span class="hljs-keyword">Any</span>) {<br />        <span class="hljs-type">Task</span> {<br />            <span class="hljs-keyword">do</span> {<br />                <span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">NetworkController</span>.shared.deleteUser(userId: <span class="hljs-number">2</span>)<br />                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;delete ok&quot;</span>, result)<br />            } <span class="hljs-keyword">catch</span> {<br />                <span class="hljs-built_in">print</span>(error)<br />            }<br />        }<br />    }<br />    <br />    <span class="hljs-keyword">@IBAction</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">put</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">sender</span>: <span class="hljs-keyword">Any</span>) {<br />        <span class="hljs-keyword">let</span> updateUserBody <span class="hljs-operator">=</span> <span class="hljs-type">UpdateUserBody</span>(name: <span class="hljs-string">&quot;Peter&quot;</span>, job: <span class="hljs-string">&quot;情歌王子&quot;</span>)<br />        <span class="hljs-type">Task</span> {<br />            <span class="hljs-keyword">do</span> {<br />                <span class="hljs-keyword">let</span> updateUserResponse <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">NetworkController</span>.shared.updateUser(updateUserBody)<br />                <span class="hljs-built_in">print</span>(updateUserResponse)<br />            } <span class="hljs-keyword">catch</span> {<br />                <span class="hljs-built_in">print</span>(error)<br />            }<br />        }<br />    }    <br />}</span></pre><h3 name="b4a3" id="b4a3" class="graf graf--h3 graf-after--pre">其它 API 串接範例</h3><h4 name="6791" id="6791" class="graf graf--h4 graf-after--h3">iTunes API</h4><p name="eca5" id="eca5" class="graf graf--p graf-after--h4">Apple 的 2.6 Lab iTunes Search — Develop in Swift Data Collections</p><div name="e87c" id="e87c" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://books.apple.com/tw/book/develop-in-swift-data-collections/id6468968766?l=en-GB" data-href="https://books.apple.com/tw/book/develop-in-swift-data-collections/id6468968766?l=en-GB" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://books.apple.com/tw/book/develop-in-swift-data-collections/id6468968766?l=en-GB"><strong class="markup--strong markup--mixtapeEmbed-strong">‎Develop in Swift Data Collections</strong><br><em class="markup--em markup--mixtapeEmbed-em">Download and read the ebook version of Develop in Swift Data Collections by Apple Education on Apple Books. Students…</em>books.apple.com</a><a href="https://books.apple.com/tw/book/develop-in-swift-data-collections/id6468968766?l=en-GB" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="78d885ca96cb34318cb082ba9b854d8f" data-thumbnail-img-id="0*pu_lUPqD66QUASDa" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*pu_lUPqD66QUASDa);"></a></div><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="swift" name="b03b" id="b03b" class="graf graf--pre graf-after--mixtapeEmbed graf--preV2"><span class="pre--content"><span class="hljs-keyword">import</span> Foundation<br /><span class="hljs-keyword">import</span> UIKit<br /><br /><span class="hljs-keyword">class</span> <span class="hljs-title class_">StoreItemController</span> {<br />    <span class="hljs-keyword">enum</span> <span class="hljs-title class_">StoreItemError</span>: <span class="hljs-title class_">Error</span>, <span class="hljs-title class_">LocalizedError</span> {<br />        <span class="hljs-keyword">case</span> itemsNotFound<br />        <span class="hljs-keyword">case</span> imageDataMissing<br />    }<br />    <br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchItems</span>(<span class="hljs-params">matching</span> <span class="hljs-params">query</span>: [<span class="hljs-params">String</span>: <span class="hljs-type">String</span>]) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; [<span class="hljs-type">StoreItem</span>] {<br />        <span class="hljs-keyword">var</span> urlComponents <span class="hljs-operator">=</span> <span class="hljs-type">URLComponents</span>(string: <span class="hljs-string">&quot;https://itunes.apple.com/search&quot;</span>)<span class="hljs-operator">!</span><br />        urlComponents.queryItems <span class="hljs-operator">=</span> query.map { <span class="hljs-type">URLQueryItem</span>(name: <span class="hljs-variable">$0</span>.key, value: <span class="hljs-variable">$0</span>.value) }<br />        <span class="hljs-keyword">let</span> (data, response) <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">URLSession</span>.shared.data(from: urlComponents.url<span class="hljs-operator">!</span>)<br />        <br />        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> httpResponse <span class="hljs-operator">=</span> response <span class="hljs-keyword">as?</span> <span class="hljs-type">HTTPURLResponse</span>, httpResponse.statusCode <span class="hljs-operator">==</span> <span class="hljs-number">200</span> <span class="hljs-keyword">else</span> {<br />            <span class="hljs-keyword">throw</span> <span class="hljs-type">StoreItemError</span>.itemsNotFound<br />        }<br />        <br />        <span class="hljs-keyword">let</span> decoder <span class="hljs-operator">=</span> <span class="hljs-type">JSONDecoder</span>()<br />        <span class="hljs-keyword">let</span> searchResponse <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> decoder.decode(<span class="hljs-type">SearchResponse</span>.<span class="hljs-keyword">self</span>, from: data)<br />        <span class="hljs-keyword">return</span> searchResponse.results<br />    }<br />    <br />    <br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchImage</span>(<span class="hljs-params">from</span> <span class="hljs-params">url</span>: <span class="hljs-type">URL</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">UIImage</span> {<br />        <span class="hljs-keyword">let</span> (data, response) <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">URLSession</span>.shared.data(from: url)<br />        <br />        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> httpResponse <span class="hljs-operator">=</span> response <span class="hljs-keyword">as?</span> <span class="hljs-type">HTTPURLResponse</span>, httpResponse.statusCode <span class="hljs-operator">==</span> <span class="hljs-number">200</span> <span class="hljs-keyword">else</span> {<br />            <span class="hljs-keyword">throw</span> <span class="hljs-type">StoreItemError</span>.imageDataMissing<br />        }<br />        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> image <span class="hljs-operator">=</span> <span class="hljs-type">UIImage</span>(data: data) <span class="hljs-keyword">else</span> {<br />            <span class="hljs-keyword">throw</span> <span class="hljs-type">StoreItemError</span>.imageDataMissing<br />        }<br />        <br />        <span class="hljs-keyword">return</span> image<br />    }<br />}</span></pre><h4 name="769b" id="769b" class="graf graf--h4 graf-after--pre">GitHub API</h4><p name="a72a" id="a72a" class="graf graf--p graf-after--h4">Sean Allen 的 iOS Dev Job Interview Practice — Take Home Project</p><div name="702f" id="702f" class="graf graf--mixtapeEmbed graf-after--p graf--trailing"><a href="https://seanallen.teachable.com/p/take-home" data-href="https://seanallen.teachable.com/p/take-home" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://seanallen.teachable.com/p/take-home"><strong class="markup--strong markup--mixtapeEmbed-strong">Take Home Project</strong><br><em class="markup--em markup--mixtapeEmbed-em">What will I learn in this course? You will learn the fundamentals required to get your first iOS developer job. If you…</em>seanallen.teachable.com</a><a href="https://seanallen.teachable.com/p/take-home" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="e492aa8697106fdd0d383e5cc0efef98" data-thumbnail-img-id="0*ThVC1fSqR8oMmxRL" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*ThVC1fSqR8oMmxRL);"></a></div></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@apppeterpan" class="p-author h-card">彼得潘的 iOS App Neverland</a> on <a href="https://medium.com/p/46c819579c83"><time class="dt-published" datetime="2021-12-27T08:22:12.477Z">December 27, 2021</time></a>.</p><p><a href="https://medium.com/@apppeterpan/%E6%A8%A1%E4%BB%BF-apple-%E5%AE%98%E6%96%B9%E7%AF%84%E4%BE%8B%E4%B8%B2%E6%8E%A5-json-api-%E4%BD%BF%E7%94%A8-async-await-46c819579c83" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on November 16, 2025.</p></footer></article></body></html>