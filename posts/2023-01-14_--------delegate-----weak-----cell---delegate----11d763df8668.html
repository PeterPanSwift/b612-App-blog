<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>為何時常看到  delegate 宣告為 weak ? 以 cell 的 delegate 為例</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">為何時常看到  delegate 宣告為 weak ? 以 cell 的 delegate 為例</h1>
</header>
<section data-field="subtitle" class="p-summary">
開發 iOS App 時，我們時常利用 delegate 的技巧讓不同元件溝通。
</section>
<section data-field="body" class="e-content">
<section name="8725" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="93c3" id="93c3" class="graf graf--h3 graf--leading graf--title">為何時常看到 delegate 被宣告為 weak ? 以 cell 的 delegate 為例</h3><p name="d209" id="d209" class="graf graf--p graf-after--h3">開發 iOS App 時，我們時常利用 delegate 的技巧讓不同元件溝通，比方利用 delegate 將資料回傳到上一頁。</p><div name="1255" id="1255" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%88%A9%E7%94%A8-delegate-%E8%AE%93%E4%B8%8D%E5%90%8C%E5%85%83%E4%BB%B6%E6%BA%9D%E9%80%9A-%E4%BB%A5%E8%B3%87%E6%96%99%E5%9B%9E%E5%82%B3%E5%88%B0%E5%89%8D%E4%B8%80%E9%A0%81-controller-%E7%82%BA%E4%BE%8B-ba215f3d2596" data-href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%88%A9%E7%94%A8-delegate-%E8%AE%93%E4%B8%8D%E5%90%8C%E5%85%83%E4%BB%B6%E6%BA%9D%E9%80%9A-%E4%BB%A5%E8%B3%87%E6%96%99%E5%9B%9E%E5%82%B3%E5%88%B0%E5%89%8D%E4%B8%80%E9%A0%81-controller-%E7%82%BA%E4%BE%8B-ba215f3d2596" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%88%A9%E7%94%A8-delegate-%E8%AE%93%E4%B8%8D%E5%90%8C%E5%85%83%E4%BB%B6%E6%BA%9D%E9%80%9A-%E4%BB%A5%E8%B3%87%E6%96%99%E5%9B%9E%E5%82%B3%E5%88%B0%E5%89%8D%E4%B8%80%E9%A0%81-controller-%E7%82%BA%E4%BE%8B-ba215f3d2596"><strong class="markup--strong markup--mixtapeEmbed-strong">利用 delegate 讓不同元件溝通，以資料回傳到前一頁 controller 為例</strong><br><em class="markup--em markup--mixtapeEmbed-em">開發 iOS App 時，我們時常利用 delegate 的技巧讓不同元件溝通。它可以運用在很多地方，比方將資料回傳到前一頁的 controller 是最常見的例子。</em>medium.com</a><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%88%A9%E7%94%A8-delegate-%E8%AE%93%E4%B8%8D%E5%90%8C%E5%85%83%E4%BB%B6%E6%BA%9D%E9%80%9A-%E4%BB%A5%E8%B3%87%E6%96%99%E5%9B%9E%E5%82%B3%E5%88%B0%E5%89%8D%E4%B8%80%E9%A0%81-controller-%E7%82%BA%E4%BE%8B-ba215f3d2596" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="1971cb80006c6df2cca3675149721bdd" data-thumbnail-img-id="1*pX-xGgvPlUBCcn3aYpzSCw.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*pX-xGgvPlUBCcn3aYpzSCw.png);"></a></div><p name="08e9" id="08e9" class="graf graf--p graf-after--mixtapeEmbed">宣告 property delegate 時，我們時常看到 delegate 被宣告為 weak，就像下圖 table view 的 delegate。</p><figure name="6be7" id="6be7" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*E7vKK-w5Ot76ga9xXCfT_Q.png" data-width="1334" data-height="616" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*E7vKK-w5Ot76ga9xXCfT_Q.png"></figure><p name="9114" id="9114" class="graf graf--p graf-after--figure">將 delegate 宣告為 weak 主要是為了避免 memory leak。以下我們實際看一個造成 memory leak 的 delegate 例子。我們將在 cell 類別宣告 delegate，然後將 view controller 設為 cell 的 delegate。</p><h3 name="67ed" id="67ed" class="graf graf--h3 graf-after--p">下載 Apple 的 To Do App 範例</h3><p name="00f6" id="00f6" class="graf graf--p graf-after--h3">從 ‎Develop in Swift Data Collections Teacher Guide 下載範例研究。</p><div name="bc87" id="bc87" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://books.apple.com/tw/book/develop-in-swift-data-collections-teacher-guide/id6468968795?l=en-GB" data-href="https://books.apple.com/tw/book/develop-in-swift-data-collections-teacher-guide/id6468968795?l=en-GB" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://books.apple.com/tw/book/develop-in-swift-data-collections-teacher-guide/id6468968795?l=en-GB"><strong class="markup--strong markup--mixtapeEmbed-strong">‎Develop in Swift Data Collections Teacher Guide</strong><br><em class="markup--em markup--mixtapeEmbed-em">This Teacher Guide provides tools to deepen engagement with aspiring app developers, whether you have experience…</em>books.apple.com</a><a href="https://books.apple.com/tw/book/develop-in-swift-data-collections-teacher-guide/id6468968795?l=en-GB" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="12e380bd440cce3c1a5b06e6886da039" data-thumbnail-img-id="0*mwr9pqIp04xVDAjS" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*mwr9pqIp04xVDAjS);"></a></div><h3 name="b255" id="b255" class="graf graf--h3 graf-after--mixtapeEmbed">開啟 ToDoList 專案</h3><p name="0051" id="0051" class="graf graf--p graf-after--h3">ToDoList 專案的路徑如下。</p><pre data-code-block-mode="0" spellcheck="false" name="6ba0" id="6ba0" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">1 - Tables and Persistence/Guided Project - List/resources/ToDoList/ToDoList.xcodeproj</span></pre><figure name="edda" id="edda" class="graf graf--figure graf-after--pre"><img class="graf-image" data-image-id="1*qJH6zUy1f3uQ2YjxFitLzQ.png" data-width="2300" data-height="498" src="https://cdn-images-1.medium.com/max/800/1*qJH6zUy1f3uQ2YjxFitLzQ.png"></figure><h3 name="ad29" id="ad29" class="graf graf--h3 graf-after--figure">執行 App</h3><p name="efe9" id="efe9" class="graf graf--p graf-after--h3">點選 Todo 項目 cell 上的圈圈可設定項目是否已完成，讓它打勾或取消打勾。</p><figure name="f9c7" id="f9c7" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*oPuTJ0cKur3R722VUk93Ng.png" data-width="1339" data-height="2716" src="https://cdn-images-1.medium.com/max/800/1*oPuTJ0cKur3R722VUk93Ng.png"></figure><h3 name="eb6c" id="eb6c" class="graf graf--h3 graf-after--figure">cell &amp; controller 使用 delegate 的技巧溝通</h3><p name="223b" id="223b" class="graf graf--p graf-after--h3">使用者點擊 cell 的圈圈按鈕時，將呼叫 cell 的 IBAction function。為了能通知 controller 使用者點擊了圈圈，範例利用 delegate 的技巧溝通，將 controller 設為 cell 的 delegate。</p><ul class="postList"><li name="3c94" id="3c94" class="graf graf--li graf-after--p">ToDoCell.swift</li></ul><p name="59a1" id="59a1" class="graf graf--p graf-after--li">cell 的類別為 ToDoCell，在 ToDoCell.swift 可看到 protocol ToDoCellDelegate &amp; 宣告為 ToDoCellDelegate 型別的 delegate。</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="swift" name="2fd5" id="2fd5" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">ToDoCellDelegate</span>: <span class="hljs-title class_">AnyObject</span> {<br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">checkmarkTapped</span>(<span class="hljs-params">sender</span>: <span class="hljs-type">ToDoCell</span>)<br />}<br /><br /><span class="hljs-keyword">class</span> <span class="hljs-title class_">ToDoCell</span>: <span class="hljs-title class_">UITableViewCell</span> {<br />    <br />    <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> delegate: <span class="hljs-type">ToDoCellDelegate</span>?</span></pre><p name="f2cc" id="f2cc" class="graf graf--p graf-after--pre">使用者點擊 cell 的圈圈按鈕時，呼叫 delegate 的 checkmarkTapped，checkmarkTapped 的程式將在 controller 定義。</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="swift" name="c59f" id="c59f" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"> <span class="hljs-keyword">@IBAction</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">completeButtonTapped</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">sender</span>: <span class="hljs-type">UIButton</span>) {<br />        <br />     delegate<span class="hljs-operator">?</span>.checkmarkTapped(sender: <span class="hljs-keyword">self</span>)<br /> }</span></pre><ul class="postList"><li name="a206" id="a206" class="graf graf--li graf-after--pre">ToDoTableViewController.swift</li></ul><p name="c6c3" id="c6c3" class="graf graf--p graf-after--li">view controller 的類別為 ToDoTableViewController。在 tableView(_:cellForRowAt:) 用 <code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">cell.delegate = self</strong></code> 將 view controller 設為 cell 的 delegate。</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="swift" name="ac34" id="ac34" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">tableView</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">tableView</span>: <span class="hljs-type">UITableView</span>, <span class="hljs-params">cellForRowAt</span> <span class="hljs-params">indexPath</span>: <span class="hljs-type">IndexPath</span>) -&gt; <span class="hljs-type">UITableViewCell</span> {<br />    <span class="hljs-keyword">let</span> cell <span class="hljs-operator">=</span> tableView.dequeueReusableCell(withIdentifier: <span class="hljs-string">&quot;ToDoCellIdentifier&quot;</span>, for: indexPath) <span class="hljs-keyword">as!</span> <span class="hljs-type">ToDoCell</span><br /><br />    <span class="hljs-keyword">let</span> toDo <span class="hljs-operator">=</span> toDos[indexPath.row]<br />    cell.titleLabel<span class="hljs-operator">?</span>.text <span class="hljs-operator">=</span> toDo.title<br />    cell.isCompleteButton.isSelected <span class="hljs-operator">=</span> toDo.isComplete<br />    cell.delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span><br />        <br />    <span class="hljs-keyword">return</span> cell<br />}</span></pre><p name="93a2" id="93a2" class="graf graf--p graf-after--pre">定義 protocol ToDoCellDelegate 的 function checkmarkTapped，使用者點擊 cell 的圈圈按鈕時將執行以下程式，實現以下功能。</p><ul class="postList"><li name="3a01" id="3a01" class="graf graf--li graf-after--p">更新 Todo 項目資料的 array。</li><li name="3516" id="3516" class="graf graf--li graf-after--li">更新表格畫面。</li><li name="96c3" id="96c3" class="graf graf--li graf-after--li">儲存 Todo 項目資料的 array。</li></ul><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="5bb9" id="5bb9" class="graf graf--pre graf-after--li graf--preV2"><span class="pre--content"><span class="hljs-keyword">func</span> <span class="hljs-title function_">checkmarkTapped</span>(<span class="hljs-params">sender</span>: <span class="hljs-type">ToDoCell</span>) {<br />    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> indexPath <span class="hljs-operator">=</span> tableView.indexPath(for: sender) {<br />        <span class="hljs-keyword">var</span> toDo <span class="hljs-operator">=</span> toDos[indexPath.row]<br />        toDo.isComplete.toggle()<br />        toDos[indexPath.row] <span class="hljs-operator">=</span> toDo<br />        tableView.reloadRows(at: [indexPath], with: .automatic)<br />        <span class="hljs-type">ToDo</span>.saveToDos(toDos)<br />    }<br />}</span></pre><h3 name="e0d7" id="e0d7" class="graf graf--h3 graf-after--pre">修改程式讓 delegate 造成 memory leak</h3><p name="3ee3" id="3ee3" class="graf graf--p graf-after--h3">Apple 原本的範例是完全正確的。為了說明 delegate 造成的 memory leak，我們進行以下修改，故意改成有問題的寫法。</p><ul class="postList"><li name="0de6" id="0de6" class="graf graf--li graf-after--p">ToDoCell.swift。</li></ul><p name="64ba" id="64ba" class="graf graf--p graf-after--li">拿掉 delegate 的 weak。由於沒有 weak，protocol 冒號後的 AnyObject 也可以拿掉。</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="swift" name="9bb7" id="9bb7" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">ToDoCellDelegate</span> {<br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">checkmarkTapped</span>(<span class="hljs-params">sender</span>: <span class="hljs-type">ToDoCell</span>)<br />}<br /><br /><span class="hljs-keyword">class</span> <span class="hljs-title class_">ToDoCell</span>: <span class="hljs-title class_">UITableViewCell</span> {<br />    <br />    <span class="hljs-keyword">var</span> delegate: <span class="hljs-type">ToDoCellDelegate</span>?</span></pre><ul class="postList"><li name="6905" id="6905" class="graf graf--li graf-after--pre">ToDoTableViewController.swift。</li></ul><p name="ee43" id="ee43" class="graf graf--p graf-after--li">定義物件死掉時觸發的 deinit。待會我們將看到 delegate 造成 controller 無法死掉，因此不會觸發 deinit。</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="swift" name="6e6f" id="6e6f" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">deinit</span> {<br />    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ToDoTableViewController deinit&quot;</span>)<br />}</span></pre><ul class="postList"><li name="d521" id="d521" class="graf graf--li graf-after--pre">Main.storyboard。</li></ul><p name="4256" id="4256" class="graf graf--p graf-after--li">在 navigation controller 前加上 view controller。點選 view controller 的 button 將以 present modally 的方式顯示 ToDo 清單。</p><figure name="4c4d" id="4c4d" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*U6tVruhgaYb9DTmSfWN6rw.png" data-width="1238" data-height="726" src="https://cdn-images-1.medium.com/max/800/1*U6tVruhgaYb9DTmSfWN6rw.png"></figure><h3 name="5a1d" id="5a1d" class="graf graf--h3 graf-after--figure">執行 App 見證記憶體問題</h3><p name="7693" id="7693" class="graf graf--p graf-after--h3">當我們點擊 button 切換到 ToDo 清單，然後再返回首頁時，將發現 Console 沒有印出<code class="markup--code markup--p-code"> ToDoTableViewController deinit</code>，因此問題果然大條了，ToDoTableViewController 沒有死掉，它還佔著寶貴的記憶體。</p><figure name="1e13" id="1e13" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*8S9-OBwtDejik_h5LgTSVg.png" data-width="1282" data-height="1246" src="https://cdn-images-1.medium.com/max/800/1*8S9-OBwtDejik_h5LgTSVg.png"></figure><h3 name="0b9a" id="0b9a" class="graf graf--h3 graf-after--figure">為什麼 delegate 會造成 memory leak</h3><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="8f51" id="8f51" class="graf graf--pre graf-after--h3 graf--preV2"><span class="pre--content"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ToDoCell</span>: <span class="hljs-title class_">UITableViewCell</span> {<br />    <br />    <span class="hljs-keyword">var</span> delegate: <span class="hljs-type">ToDoCellDelegate</span>?</span></pre><p name="f303" id="f303" class="graf graf--p graf-after--pre">cell 的 delegate 為 ToDoTableViewController，當 delegate 沒有 weak 時，delegate 會增加 controller 的 reference count。而 controller 在 reference count 歸零時才會死掉，所以要等 cell 死掉，cell 的 property delegate 不再指到 controller 時，controller 的 reference count 才能歸零。</p><p name="8dc4" id="8dc4" class="graf graf--p graf-after--p">但是 cell 也無法死掉呀，因為 controller 沒死，controller 顯示的 table view &amp; cell 都會繼續活著。</p><p name="50dd" id="50dd" class="graf graf--p graf-after--p">所以可怕的 memory leak 就發生了。雖然 ToDo 清單的畫面已經關掉了，controller，table view &amp; cell 都還是活著，佔據著珍貴的記憶體。</p><h3 name="483a" id="483a" class="graf graf--h3 graf-after--p">利用 Debug Memory Graph 觀察 memory leak</h3><p name="59ce" id="59ce" class="graf graf--p graf-after--h3">剛剛的 memory leak，我們也可透過以下方法觀察。</p><p name="7d7a" id="7d7a" class="graf graf--p graf-after--p">點選 button 切換到 ToDo 清單，然後再返回首頁後，點選下圖的 Debug Memory Graph。</p><figure name="2086" id="2086" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*HyiJ7mH4d0j3fBYq2GJcEw.png" data-width="766" data-height="128" src="https://cdn-images-1.medium.com/max/800/1*HyiJ7mH4d0j3fBYq2GJcEw.png"></figure><p name="472e" id="472e" class="graf graf--p graf-after--figure">下圖可看到 ToDoTableViewController 還活著。</p><figure name="fe8d" id="fe8d" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*2zaoj9XZ9TLAabr93w-GBA.png" data-width="1912" data-height="1046" src="https://cdn-images-1.medium.com/max/800/1*2zaoj9XZ9TLAabr93w-GBA.png"></figure><p name="d862" id="d862" class="graf graf--p graf-after--figure">下圖顯示 cell 的 delegate 還指著 ToDoTableViewController。</p><figure name="e926" id="e926" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*9aUZ2t7mmGeKumRdZoOqzw.png" data-width="1684" data-height="420" src="https://cdn-images-1.medium.com/max/800/1*9aUZ2t7mmGeKumRdZoOqzw.png"></figure><h3 name="10fd" id="10fd" class="graf graf--h3 graf-after--figure">將 delegate 宣告為 weak，解決 memory leak</h3><p name="0af6" id="0af6" class="graf graf--p graf-after--h3">解決 memory leak 的方法很簡單，只要將 delegate 宣告為 weak。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="f74e" id="f74e" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ToDoCell</span>: <span class="hljs-title class_">UITableViewCell</span> {<br />    <br />    <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> delegate: <span class="hljs-type">ToDoCellDelegate</span>?</span></pre><p name="c264" id="c264" class="graf graf--p graf-after--pre">加了 weak 後會先出現以下錯誤。</p><figure name="954f" id="954f" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*qt_KvE49IFB40A8qvOkQ8g.png" data-width="1666" data-height="292" src="https://cdn-images-1.medium.com/max/800/1*qt_KvE49IFB40A8qvOkQ8g.png"></figure><p name="77f1" id="77f1" class="graf graf--p graf-after--figure">weak 只能作用在 class 型別的資料，因此我們必須在 protocol 加上 AnyObject，限制只有 class 能遵從 protocol。</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="swift" name="7b6d" id="7b6d" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">ToDoCellDelegate</span>: <span class="hljs-title class_">AnyObject</span> {<br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">checkmarkTapped</span>(<span class="hljs-params">sender</span>: <span class="hljs-type">ToDoCell</span>)<br />}</span></pre><p name="25c7" id="25c7" class="graf graf--p graf-after--pre">cell 的 delegate 宣告為 weak 後，它不會再增加 controller 的 reference count，因此當我們從 ToDo 清單返回首頁後，ToDoTableViewController 的 reference count 可以歸零，ToDoTableViewController 終於能順利死掉，Console 印出 <code class="markup--code markup--p-code">ToDoTableViewController deinit</code><strong class="markup--strong markup--p-strong">。</strong></p><p name="8aef" id="8aef" class="graf graf--p graf-after--p">透過以下 cell 的 delegate 例子，我們明白了為何時常看到 delegate 宣告為 weak。因此若要避免 memory leak，最好將 delegate 宣告為 weak。</p><h3 name="be42" id="be42" class="graf graf--h3 graf-after--p">One more thing，有些情況不加 weak 的 delegate 也不會造成 memory leak</h3><p name="2bbc" id="2bbc" class="graf graf--p graf-after--h3">比方以下 App 將 EditEventTableViewController 設為 SelectFrequencyTableViewController 的 delegate，SelectFrequencyTableViewController 返回上一頁時以 delegate 通知 EditEventTableViewController 選擇的頻率。此時 delegate 不加 weak 也不會有記憶體問題，因為返回上一頁時 SelectFrequencyTableViewController 會死掉，它的 property delegate 不再指到 EditEventTableViewController，所以 EditEventTableViewController 的 reference count 可以正常地被扣除。</p><figure name="3953" id="3953" class="graf graf--figure graf-after--p graf--trailing"><img class="graf-image" data-image-id="0*_GjUUsgNsk1cb6M7.jpeg" data-width="1400" data-height="980" src="https://cdn-images-1.medium.com/max/800/0*_GjUUsgNsk1cb6M7.jpeg"></figure></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@apppeterpan" class="p-author h-card">彼得潘的 iOS App Neverland</a> on <a href="https://medium.com/p/11d763df8668"><time class="dt-published" datetime="2023-01-14T10:08:33.495Z">January 14, 2023</time></a>.</p><p><a href="https://medium.com/@apppeterpan/%E7%82%BA%E4%BD%95%E6%99%82%E5%B8%B8%E7%9C%8B%E5%88%B0-delegate-%E5%AE%A3%E5%91%8A%E7%82%BA-weak-%E4%BB%A5-cell-%E7%9A%84-delegate-%E7%82%BA%E4%BE%8B-11d763df8668" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on November 16, 2025.</p></footer></article></body></html>