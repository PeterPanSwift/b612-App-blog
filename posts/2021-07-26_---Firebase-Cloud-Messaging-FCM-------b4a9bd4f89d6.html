<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>利用 Firebase Cloud Messaging(FCM) 發送推播</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">利用 Firebase Cloud Messaging(FCM) 發送推播</h1>
</header>
<section data-field="subtitle" class="p-summary">
在 iOS App 開發推播功能時，我們必須搭配一個負責發送推播的 provider(後台)，由它通知 Apple 的 APNs server 發送推播。
</section>
<section data-field="body" class="e-content">
<section name="df48" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="c90f" id="c90f" class="graf graf--h3 graf--leading graf--title">利用 Firebase Cloud Messaging(FCM) 發送推播</h3><p name="7366" id="7366" class="graf graf--p graf-after--h3">在 iOS App 開發推播功能時，我們必須搭配一個負責發送推播的 provider(後台)，由它通知 Apple 的 APNs server 發送推播。</p><figure name="e71e" id="e71e" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*xXLKsnhRGBEoK53yN89xBw.png" data-width="1724" data-height="724" src="https://cdn-images-1.medium.com/max/800/1*xXLKsnhRGBEoK53yN89xBw.png"></figure><p name="bd90" id="bd90" class="graf graf--p graf-after--figure">有的公司會請後台工程師撰寫 Provider 通知 APNs server 的程式，有的則會使用 Firebase Cloud Messaging(FCM) 當 provider。接下來我們將說明如何不靠後台工程師，透過 Firebase Cloud Messaging(FCM) 搭配 APNs Key(p8) 發送推播。</p><h3 name="a9ad" id="a9ad" class="graf graf--h3 graf-after--p">加入 FCM 前的準備: 讓 iOS App 能收到 APNs 發送的推播</h3><p name="b75b" id="b75b" class="graf graf--p graf-after--h3">為了讓 iOS App 能收到 APNs 發送的推播，我們必須先進行相關的設定和程式撰寫。</p><div name="64e8" id="64e8" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://www.appcoda.com.tw/push-notification/" data-href="https://www.appcoda.com.tw/push-notification/" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://www.appcoda.com.tw/push-notification/"><strong class="markup--strong markup--mixtapeEmbed-strong">傳送告白推播的 Push Notification</strong><br><em class="markup--em markup--mixtapeEmbed-em">iOS App 有著各式各樣的功能，但這當中如果要投票選一個讓人又愛又恨的功能，絕對非推播莫屬。 如上圖所示，每天我們會收到來自不同 App…</em>www.appcoda.com.tw</a><a href="https://www.appcoda.com.tw/push-notification/" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="c4ad65fac0b62767b2467a1c735a667a" data-thumbnail-img-id="0*0GNzWVrF5m8R43pd" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*0GNzWVrF5m8R43pd);"></a></div><p name="da00" id="da00" class="graf graf--p graf-after--mixtapeEmbed">參考以上文章的說明完成以下部分:</p><h4 name="32e2" id="32e2" class="graf graf--h4 graf-after--p">下載發送推播需要的 APNs key(p8)</h4><figure name="6045" id="6045" class="graf graf--figure graf-after--h4"><img class="graf-image" data-image-id="1*RrZCkVqzYPAXX8t2uQDrFw.png" data-width="1400" data-height="352" src="https://cdn-images-1.medium.com/max/800/1*RrZCkVqzYPAXX8t2uQDrFw.png"></figure><div name="e2bf" id="e2bf" class="graf graf--mixtapeEmbed graf-after--figure"><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E7%94%A2%E7%94%9F%E7%99%BC%E9%80%81%E6%8E%A8%E6%92%AD%E9%9C%80%E8%A6%81%E7%9A%84-apns-key-p8-b3ffbb1d7b42" data-href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E7%94%A2%E7%94%9F%E7%99%BC%E9%80%81%E6%8E%A8%E6%92%AD%E9%9C%80%E8%A6%81%E7%9A%84-apns-key-p8-b3ffbb1d7b42" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E7%94%A2%E7%94%9F%E7%99%BC%E9%80%81%E6%8E%A8%E6%92%AD%E9%9C%80%E8%A6%81%E7%9A%84-apns-key-p8-b3ffbb1d7b42"><strong class="markup--strong markup--mixtapeEmbed-strong">產生發送推播需要的 APNs key(p8)</strong><br><em class="markup--em markup--mixtapeEmbed-em">登入 Apple 開發網站</em>medium.com</a><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E7%94%A2%E7%94%9F%E7%99%BC%E9%80%81%E6%8E%A8%E6%92%AD%E9%9C%80%E8%A6%81%E7%9A%84-apns-key-p8-b3ffbb1d7b42" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="cd593e263b0cfd64b9329de54dcee5f4" data-thumbnail-img-id="1*_ecHZibG6FSmWOxLCeVC4A.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*_ecHZibG6FSmWOxLCeVC4A.png);"></a></div><h4 name="c365" id="c365" class="graf graf--h4 graf-after--mixtapeEmbed">Team 欄位設定付費開發帳號，Capability 加入 Push Notifications</h4><figure name="f4da" id="f4da" class="graf graf--figure graf-after--h4"><img class="graf-image" data-image-id="1*_W6_ld4bG-aWSwQPkq8vKg.png" data-width="2092" data-height="778" src="https://cdn-images-1.medium.com/max/800/1*_W6_ld4bG-aWSwQPkq8vKg.png"></figure><h4 name="3789" id="3789" class="graf graf--h4 graf-after--figure"><strong class="markup--strong markup--h4-strong">在 AppDelegate.swift 加入以下程式</strong></h4><p name="11ab" id="11ab" class="graf graf--p graf-after--h4">若是以 SwiftUI 開發，記得先新增 AppDelegate.swift。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="9556" id="9556" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">import</span> UIKit<br /><span class="hljs-keyword">import</span> UserNotifications<br /><br /><span class="hljs-keyword">@main</span><br /><span class="hljs-keyword">class</span> <span class="hljs-title class_">AppDelegate</span>: <span class="hljs-title class_">UIResponder</span>, <span class="hljs-title class_">UIApplicationDelegate</span> {<br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">application</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>, <span class="hljs-params">didFinishLaunchingWithOptions</span> <span class="hljs-params">launchOptions</span>: [<span class="hljs-type">UIApplication</span>.<span class="hljs-params">LaunchOptionsKey</span>: <span class="hljs-keyword">Any</span>]<span class="hljs-operator">?</span>) -&gt; <span class="hljs-type">Bool</span> {<br />        <span class="hljs-comment">// Override point for customization after application launch.</span><br />        <span class="hljs-type">UNUserNotificationCenter</span>.current().delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span><br />        <span class="hljs-type">UNUserNotificationCenter</span>.current().requestAuthorization(options: [.alert, .badge, .sound]) { granted, error <span class="hljs-keyword">in</span><br />            <br />        }<br />         <br />       <span class="hljs-type">UIApplication</span>.shared.registerForRemoteNotifications()<br />        <br />        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br />    }<br />   <span class="hljs-comment">// MARK: UISceneSession Lifecycle</span><br />   <span class="hljs-keyword">func</span> <span class="hljs-title function_">application</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>, <span class="hljs-params">configurationForConnecting</span> <span class="hljs-params">connectingSceneSession</span>: <span class="hljs-type">UISceneSession</span>, <span class="hljs-params">options</span>: <span class="hljs-type">UIScene</span>.<span class="hljs-type">ConnectionOptions</span>) -&gt; <span class="hljs-type">UISceneConfiguration</span> {<br />        <span class="hljs-comment">// Called when a new scene session is being created.</span><br />        <span class="hljs-comment">// Use this method to select a configuration to create the new scene with.</span><br />        <span class="hljs-keyword">return</span> <span class="hljs-type">UISceneConfiguration</span>(name: <span class="hljs-string">&quot;Default Configuration&quot;</span>, sessionRole: connectingSceneSession.role)<br />    }<br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">application</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>, <span class="hljs-params">didDiscardSceneSessions</span> <span class="hljs-params">sceneSessions</span>: <span class="hljs-type">Set</span>&lt;<span class="hljs-type">UISceneSession</span>&gt;) {<br />        <span class="hljs-comment">// Called when the user discards a scene session.</span><br />        <span class="hljs-comment">// If any sessions were discarded while the application was not running, this will be called shortly after application:didFinishLaunchingWithOptions.</span><br />        <span class="hljs-comment">// Use this method to release any resources that were specific to the discarded scenes, as they will not return.</span><br />    }<br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">application</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>, <span class="hljs-params">didRegisterForRemoteNotificationsWithDeviceToken</span> <span class="hljs-params">deviceToken</span>: <span class="hljs-type">Data</span>) {<br />        <br />        <span class="hljs-keyword">let</span> deviceTokenString <span class="hljs-operator">=</span> deviceToken.reduce(<span class="hljs-string">&quot;&quot;</span>) {<br />            <span class="hljs-variable">$0</span> <span class="hljs-operator">+</span> <span class="hljs-type">String</span>(format: <span class="hljs-string">&quot;%02x&quot;</span>, <span class="hljs-variable">$1</span>)<br />        }<br />        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;deviceToken&quot;</span>, deviceTokenString)<br />    }<br />}<br /><br /><span class="hljs-keyword">extension</span> <span class="hljs-title class_">AppDelegate</span>: <span class="hljs-title class_">UNUserNotificationCenterDelegate</span> {<br />    <span class="hljs-comment">// 使用者點選推播時觸發</span><br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">userNotificationCenter</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">center</span>: <span class="hljs-type">UNUserNotificationCenter</span>, <span class="hljs-params">didReceive</span> <span class="hljs-params">response</span>: <span class="hljs-type">UNNotificationResponse</span>, <span class="hljs-params">withCompletionHandler</span> <span class="hljs-params">completionHandler</span>: <span class="hljs-keyword">@escaping</span> () -&gt; <span class="hljs-type">Void</span>) {<br />        <span class="hljs-built_in">print</span>(<span class="hljs-keyword">#function</span>)<br />        <span class="hljs-keyword">let</span> content <span class="hljs-operator">=</span> response.notification.request.content<br />        <span class="hljs-built_in">print</span>(content.userInfo)<br />        completionHandler()<br />    }<br />    <br />    <span class="hljs-comment">// 讓 App 在前景也能顯示推播</span><br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">userNotificationCenter</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">center</span>: <span class="hljs-type">UNUserNotificationCenter</span>, <span class="hljs-params">willPresent</span> <span class="hljs-params">notification</span>: <span class="hljs-type">UNNotification</span>, <span class="hljs-params">withCompletionHandler</span> <span class="hljs-params">completionHandler</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">UNNotificationPresentationOptions</span>) -&gt; <span class="hljs-type">Void</span>) {<br />        completionHandler([.banner])<br />    }<br />}</span></pre><h3 name="b35d" id="b35d" class="graf graf--h3 graf-after--pre">利用 UIApplicationDelegateAdaptor 加入 AppDelegate (SwiftUI App)</h3><p name="1c88" id="1c88" class="graf graf--p graf-after--h3">如果開發的是 SwiftUI App，記得在遵從 protocol App 的型別裡加入以下程式，它將讓 SwiftUI 生成 AppDelegate，讓 AppDelegate 的 function 在某些事件發生時被觸發。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="a32b" id="a32b" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-meta">@UIApplicationDelegateAdaptor</span>(<span class="hljs-type">AppDelegate</span>.<span class="hljs-keyword">self</span>) <span class="hljs-keyword">var</span> delegate</span></pre><div name="4221" id="4221" class="graf graf--mixtapeEmbed graf-after--pre"><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/swiftui-%E5%A6%82%E4%BD%95%E6%90%AD%E9%85%8D-appdelegate-%E5%88%A9%E7%94%A8-uiapplicationdelegateadaptor-96446be3e17" data-href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/swiftui-%E5%A6%82%E4%BD%95%E6%90%AD%E9%85%8D-appdelegate-%E5%88%A9%E7%94%A8-uiapplicationdelegateadaptor-96446be3e17" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/swiftui-%E5%A6%82%E4%BD%95%E6%90%AD%E9%85%8D-appdelegate-%E5%88%A9%E7%94%A8-uiapplicationdelegateadaptor-96446be3e17"><strong class="markup--strong markup--mixtapeEmbed-strong">SwiftUI 如何搭配 AppDelegate — 利用 UIApplicationDelegateAdaptor</strong><br><em class="markup--em markup--mixtapeEmbed-em">從 Xcode 12 開始，我們開發 SwiftUI App 時 Life Cycle 可以選擇 SwiftUI App。</em>medium.com</a><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/swiftui-%E5%A6%82%E4%BD%95%E6%90%AD%E9%85%8D-appdelegate-%E5%88%A9%E7%94%A8-uiapplicationdelegateadaptor-96446be3e17" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="01fdf92ed813d72ee778d83765aec958" data-thumbnail-img-id="1*1B6Mofvhc2dgPT2r1BVCFQ.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*1B6Mofvhc2dgPT2r1BVCFQ.png);"></a></div><h3 name="ab18" id="ab18" class="graf graf--h3 graf-after--mixtapeEmbed">測試模擬器是否能收到推播</h3><p name="d941" id="d941" class="graf graf--p graf-after--h3">完成剛剛的步驟後，我們的 iOS App 已經能收到來自 APNs 的推播。為了方便測試，我們先試試從模擬器接收假的推播。</p><div name="dd2f" id="dd2f" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%BE%9E%E6%A8%A1%E6%93%AC%E5%99%A8%E6%B8%AC%E8%A9%A6%E6%8E%A8%E6%92%AD-push-notification-c040f1c4d360" data-href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%BE%9E%E6%A8%A1%E6%93%AC%E5%99%A8%E6%B8%AC%E8%A9%A6%E6%8E%A8%E6%92%AD-push-notification-c040f1c4d360" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%BE%9E%E6%A8%A1%E6%93%AC%E5%99%A8%E6%B8%AC%E8%A9%A6%E6%8E%A8%E6%92%AD-push-notification-c040f1c4d360"><strong class="markup--strong markup--mixtapeEmbed-strong">從模擬器測試推播(push notification)</strong><br><em class="markup--em markup--mixtapeEmbed-em">從 Xcode 11.4 開始，透過包含推播內容的 apns 檔，我們可以在模擬器(simulator)測試推播 !</em>medium.com</a><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%BE%9E%E6%A8%A1%E6%93%AC%E5%99%A8%E6%B8%AC%E8%A9%A6%E6%8E%A8%E6%92%AD-push-notification-c040f1c4d360" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="55c6f1a49bf03021b9ff138eb7d479ef" data-thumbnail-img-id="1*pRNfEs78125c2W0qgHTQ2g.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*pRNfEs78125c2W0qgHTQ2g.png);"></a></div><h3 name="a3ba" id="a3ba" class="graf graf--h3 graf-after--mixtapeEmbed">測試實機是否能收到推播</h3><p name="2c10" id="2c10" class="graf graf--p graf-after--h3">接著讓我們玩真的，從 iPhone 接收來自 APNs 的推播。</p><ul class="postList"><li name="573b" id="573b" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">方法 1: 使用 Apple 的 Push Notifications Console 發送推播。</strong></li></ul><div name="51a2" id="51a2" class="graf graf--mixtapeEmbed graf-after--li"><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%BE%9E-apple-%E7%9A%84-push-notifications-console-%E6%B8%AC%E8%A9%A6%E6%8E%A8%E6%92%AD%E5%8A%9F%E8%83%BD-b1c9390e0f64" data-href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%BE%9E-apple-%E7%9A%84-push-notifications-console-%E6%B8%AC%E8%A9%A6%E6%8E%A8%E6%92%AD%E5%8A%9F%E8%83%BD-b1c9390e0f64" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%BE%9E-apple-%E7%9A%84-push-notifications-console-%E6%B8%AC%E8%A9%A6%E6%8E%A8%E6%92%AD%E5%8A%9F%E8%83%BD-b1c9390e0f64"><strong class="markup--strong markup--mixtapeEmbed-strong">從 Apple 的 Push Notifications Console 測試推播功能</strong><br><em class="markup--em markup--mixtapeEmbed-em">Apple 在 2023 推出了 Push Notifications Console，現在我們有更方便的方法測試實機是否能收到推播了。</em>medium.com</a><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%BE%9E-apple-%E7%9A%84-push-notifications-console-%E6%B8%AC%E8%A9%A6%E6%8E%A8%E6%92%AD%E5%8A%9F%E8%83%BD-b1c9390e0f64" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="790b6006baa65ebb312d3db27b7337c7" data-thumbnail-img-id="1*MorUQQ5Tjtk81iXjo9qCcQ.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*MorUQQ5Tjtk81iXjo9qCcQ.png);"></a></div><ul class="postList"><li name="0d2b" id="0d2b" class="graf graf--li graf-after--mixtapeEmbed"><strong class="markup--strong markup--li-strong">方法 2: 使用 Push Notifications App 測試推播發送。</strong></li></ul><div name="43b2" id="43b2" class="graf graf--mixtapeEmbed graf-after--li"><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E4%BD%BF%E7%94%A8-push-notifications-app-%E6%B8%AC%E8%A9%A6%E6%8E%A8%E6%92%AD%E7%99%BC%E9%80%81-bc402338862a" data-href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E4%BD%BF%E7%94%A8-push-notifications-app-%E6%B8%AC%E8%A9%A6%E6%8E%A8%E6%92%AD%E7%99%BC%E9%80%81-bc402338862a" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E4%BD%BF%E7%94%A8-push-notifications-app-%E6%B8%AC%E8%A9%A6%E6%8E%A8%E6%92%AD%E7%99%BC%E9%80%81-bc402338862a"><strong class="markup--strong markup--mixtapeEmbed-strong">使用 Push Notifications App 測試推播發送</strong><br><em class="markup--em markup--mixtapeEmbed-em">在 iOS App 開發推播功能時，我們必須搭配一個負責發送推播的 provider(後台)，由它通知 Apple 的 APNs server 發送推播給使用者。</em>medium.com</a><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E4%BD%BF%E7%94%A8-push-notifications-app-%E6%B8%AC%E8%A9%A6%E6%8E%A8%E6%92%AD%E7%99%BC%E9%80%81-bc402338862a" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="69f60a32f7e48e236baa4f356a6bade3" data-thumbnail-img-id="1*6RYNHsD-4nvDEkN4x4Za2Q.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*6RYNHsD-4nvDEkN4x4Za2Q.png);"></a></div><p name="c143" id="c143" class="graf graf--p graf-after--mixtapeEmbed graf--trailing">測試 ok 後，終於可以開始進行本篇文章的重點了，使用 FCM 當 provider 發送推播。</p></div></div></section><section name="9485" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="d1e1" id="d1e1" class="graf graf--h3 graf--leading">建立 Firebase 專案</h3><div name="59f0" id="59f0" class="graf graf--mixtapeEmbed graf-after--h3"><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%BB%BA%E7%AB%8B-firebase-%E5%B0%88%E6%A1%88-fbd6d19808c3" data-href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%BB%BA%E7%AB%8B-firebase-%E5%B0%88%E6%A1%88-fbd6d19808c3" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%BB%BA%E7%AB%8B-firebase-%E5%B0%88%E6%A1%88-fbd6d19808c3"><strong class="markup--strong markup--mixtapeEmbed-strong">建立 Firebase 專案</strong><br><em class="markup--em markup--mixtapeEmbed-em">1 連到 Firebase 網站。</em>medium.com</a><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%BB%BA%E7%AB%8B-firebase-%E5%B0%88%E6%A1%88-fbd6d19808c3" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="d4346ccd2dd984dcba53c9f4acce4a4f" data-thumbnail-img-id="1*bmkc-Seir7MAzj6eb_08uw.jpeg" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*bmkc-Seir7MAzj6eb_08uw.jpeg);"></a></div><h3 name="4029" id="4029" class="graf graf--h3 graf-after--mixtapeEmbed">設定 iOS App 的 Firebase 功能和安裝套件 FirebaseMessaging</h3><p name="942c" id="942c" class="graf graf--p graf-after--h3">參考以下連結設定 iOS App 的 Firebase 功能和安裝套件，使用 FCM 需要安裝的套件是 FirebaseMessaging。</p><div name="a277" id="a277" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E8%A8%AD%E5%AE%9A-ios-app-%E7%9A%84-firebase-%E5%8A%9F%E8%83%BD-afcaaabe00f2" data-href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E8%A8%AD%E5%AE%9A-ios-app-%E7%9A%84-firebase-%E5%8A%9F%E8%83%BD-afcaaabe00f2" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E8%A8%AD%E5%AE%9A-ios-app-%E7%9A%84-firebase-%E5%8A%9F%E8%83%BD-afcaaabe00f2"><strong class="markup--strong markup--mixtapeEmbed-strong">設定 iOS App 的 Firebase 功能和安裝 Firebase 套件</strong><br><em class="markup--em markup--mixtapeEmbed-em">1 連到 Firebase 的專案頁面。</em>medium.com</a><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E8%A8%AD%E5%AE%9A-ios-app-%E7%9A%84-firebase-%E5%8A%9F%E8%83%BD-afcaaabe00f2" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="a6897cb16e9940b46d6b5a890c3f21df" data-thumbnail-img-id="1*sU1Rl7a-oTLvzzBRtKBW4A.jpeg" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*sU1Rl7a-oTLvzzBRtKBW4A.jpeg);"></a></div><figure name="8553" id="8553" class="graf graf--figure graf-after--mixtapeEmbed"><img class="graf-image" data-image-id="1*ernHvJwQm68YcossjgDiBg.png" data-width="1302" data-height="594" src="https://cdn-images-1.medium.com/max/800/1*ernHvJwQm68YcossjgDiBg.png"></figure><figure name="c46d" id="c46d" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*syhD9WwuZu_l0cw3O6gjwQ.png" data-width="1700" data-height="1290" src="https://cdn-images-1.medium.com/max/800/1*syhD9WwuZu_l0cw3O6gjwQ.png"></figure><p name="4c2b" id="4c2b" class="graf graf--p graf-after--figure">AppDelegate.swift 的更新如下，加入 import Firebase &amp; FirebaseApp.configure()。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="4f13" id="4f13" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">import</span> UIKit<br /><span class="hljs-keyword">import</span> UserNotifications<br /><span class="hljs-keyword">import</span> Firebase<br /><br /><span class="hljs-keyword">@main</span><br /><span class="hljs-keyword">class</span> <span class="hljs-title class_">AppDelegate</span>: <span class="hljs-title class_">UIResponder</span>, <span class="hljs-title class_">UIApplicationDelegate</span> {<br /><br />   <span class="hljs-keyword">func</span> <span class="hljs-title function_">application</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>, <span class="hljs-params">didFinishLaunchingWithOptions</span> <span class="hljs-params">launchOptions</span>: [<span class="hljs-type">UIApplication</span>.<span class="hljs-params">LaunchOptionsKey</span>: <span class="hljs-keyword">Any</span>]<span class="hljs-operator">?</span>) -&gt; <span class="hljs-type">Bool</span> {<br />        <span class="hljs-comment">// Override point for customization after application launch.</span><br />        <span class="hljs-type">UNUserNotificationCenter</span>.current().delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span><br />        <span class="hljs-type">UNUserNotificationCenter</span>.current().requestAuthorization(options: [.alert, .badge, .sound]) { granted, error <span class="hljs-keyword">in</span><br />            <br />        }<br />        <span class="hljs-type">UIApplication</span>.shared.registerForRemoteNotifications()<br />        <br />        <span class="hljs-type">FirebaseApp</span>.configure()<br />        <br />        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br />    }</span></pre><p name="1783" id="1783" class="graf graf--p graf-after--pre">完成以上修改後，我們的 iOS App 已經可以收到 FCM 當 provider 發送的推播，不過通常我們會再加入取得 FCM registration token 的程式。</p><h3 name="807a" id="807a" class="graf graf--h3 graf-after--p">取得 FCM 的 registration token</h3><p name="aa50" id="aa50" class="graf graf--p graf-after--h3">透過剛剛的程式，App 將在啟動時上傳 registration token 到 FCM。FCM 發送推播時將利用 registration token 找到發送的目標，因此若有十個人安裝 App，FCM 將儲存十個人的 registration token，之後可發送推播給他們。</p><p name="73ef" id="73ef" class="graf graf--p graf-after--p">不過推播的應用不只是發送給所有人，也可能是發送給某個使用者，實現類似 LINE 聊天的推播功能。此時我們須在後台儲存使用者對應的 registration token，如此後台才能通知 FCM 發送推播給使用者。</p><p name="cf49" id="cf49" class="graf graf--p graf-after--p">讓我們用下圖說明當 Wendy 傳送好想你給 peter 時，推播訊息是如何送達 Peter iPhone 的 iOS App。</p><figure name="9c07" id="9c07" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*e6q6yWWxbcHI0XaVMsdDxQ.png" data-width="2016" data-height="650" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*e6q6yWWxbcHI0XaVMsdDxQ.png"></figure><ul class="postList"><li name="5e50" id="5e50" class="graf graf--li graf-after--figure">Wendy 從 App 傳送訊息好想你給 Peter，傳送 POST API 給後台。</li><li name="b90f" id="b90f" class="graf graf--li graf-after--li">後台找到 Peter 對應的 FCM registration token，傳送 registration token 給 FCM provider</li><li name="8174" id="8174" class="graf graf--li graf-after--li">FCM provider 由 registration token 找到對應的 APNs device token，傳送 device token給 APNs server</li><li name="d2ad" id="d2ad" class="graf graf--li graf-after--li">APNs server 由 device token 找到 Peter iPhone 的 App，發送推播給它。</li></ul><p name="c60f" id="c60f" class="graf graf--p graf-after--li">ps: 我們也可以不使用 FCM，由後台擔任 provider 的角色，此時變成後台要儲存使用者 peter 對應的 device token。</p><figure name="7b69" id="7b69" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*mY3-z9hQHbT6kAd0HiK17w.png" data-width="2012" data-height="660" src="https://cdn-images-1.medium.com/max/800/1*mY3-z9hQHbT6kAd0HiK17w.png"></figure><p name="504d" id="504d" class="graf graf--p graf-after--figure">為了實現透過 FCM 發送推播給某個使用者的功能，我們在 AppDelegate.swift 加入以下程式 。</p><ul class="postList"><li name="3662" id="3662" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">設定 Messaging.messaging().delegate = self</strong></li></ul><p name="173b" id="173b" class="graf graf--p graf-after--li">取得 registration token 時會呼叫 Message delegate 的 function，因此我們將 AppDelegate 設為 Message 的 delegate。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="6e4b" id="6e4b" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">func</span> <span class="hljs-title function_">application</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>, <span class="hljs-params">didFinishLaunchingWithOptions</span> <span class="hljs-params">launchOptions</span>: [<span class="hljs-type">UIApplication</span>.<span class="hljs-params">LaunchOptionsKey</span>: <span class="hljs-keyword">Any</span>]<span class="hljs-operator">?</span>) -&gt; <span class="hljs-type">Bool</span> {<br />    <span class="hljs-comment">// Override point for customization after application launch.</span><br />    <span class="hljs-type">UNUserNotificationCenter</span>.current().delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span><br />    <span class="hljs-type">UNUserNotificationCenter</span>.current().requestAuthorization(options: [.alert, .badge, .sound]) { granted, error <span class="hljs-keyword">in</span><br />            <br />    }<br />    <span class="hljs-type">UIApplication</span>.shared.registerForRemoteNotifications()<br />        <br />    <span class="hljs-type">FirebaseApp</span>.configure()<br />    <span class="hljs-type">Messaging</span>.messaging().delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span><br />    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br />}</span></pre><ul class="postList"><li name="326d" id="326d" class="graf graf--li graf-after--pre"><strong class="markup--strong markup--li-strong">取得 registration token 時觸發 function messaging(_:didReceiveRegistrationToken:)</strong></li></ul><p name="05e0" id="05e0" class="graf graf--p graf-after--li">我們可在此將 token 傳送給後台。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="debf" id="debf" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">extension</span> <span class="hljs-title class_">AppDelegate</span>: <span class="hljs-title class_">MessagingDelegate</span> {<br />   <br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">messaging</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">messaging</span>: <span class="hljs-type">Messaging</span>, <span class="hljs-params">didReceiveRegistrationToken</span> <span class="hljs-params">fcmToken</span>: <span class="hljs-type">String</span>?) {<br />        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;fcm Token&quot;</span>, fcmToken <span class="hljs-operator">??</span> <span class="hljs-string">&quot;&quot;</span>)<br />        <span class="hljs-comment">// 將 fcm token 傳送給後台</span><br />    }<br />}</span></pre><p name="46c6" id="46c6" class="graf graf--p graf-after--pre">修改後完整的 AppDelegate.swift 程式如下，此時可將 App 裝到手機，方便等下測試推播。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="5278" id="5278" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">import</span> UIKit<br /><span class="hljs-keyword">import</span> UserNotifications<br /><span class="hljs-keyword">import</span> Firebase<br /><br /><span class="hljs-keyword">@main</span><br /><span class="hljs-keyword">class</span> <span class="hljs-title class_">AppDelegate</span>: <span class="hljs-title class_">UIResponder</span>, <span class="hljs-title class_">UIApplicationDelegate</span> {<br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">application</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>, <span class="hljs-params">didFinishLaunchingWithOptions</span> <span class="hljs-params">launchOptions</span>: [<span class="hljs-type">UIApplication</span>.<span class="hljs-params">LaunchOptionsKey</span>: <span class="hljs-keyword">Any</span>]<span class="hljs-operator">?</span>) -&gt; <span class="hljs-type">Bool</span> {<br />        <span class="hljs-comment">// Override point for customization after application launch.</span><br />        <span class="hljs-type">UNUserNotificationCenter</span>.current().delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span><br />        <span class="hljs-type">UNUserNotificationCenter</span>.current().requestAuthorization(options: [.alert, .badge, .sound]) { granted, error <span class="hljs-keyword">in</span><br />            <br />        }<br />            <br />       <span class="hljs-type">UIApplication</span>.shared.registerForRemoteNotifications()<br />        <br />        <span class="hljs-type">FirebaseApp</span>.configure()<br />        <span class="hljs-type">Messaging</span>.messaging().delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span><br />        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br />    }<br />    <span class="hljs-comment">// MARK: UISceneSession Lifecycle</span><br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">application</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>, <span class="hljs-params">configurationForConnecting</span> <span class="hljs-params">connectingSceneSession</span>: <span class="hljs-type">UISceneSession</span>, <span class="hljs-params">options</span>: <span class="hljs-type">UIScene</span>.<span class="hljs-type">ConnectionOptions</span>) -&gt; <span class="hljs-type">UISceneConfiguration</span> {<br />        <span class="hljs-comment">// Called when a new scene session is being created.</span><br />        <span class="hljs-comment">// Use this method to select a configuration to create the new scene with.</span><br />        <span class="hljs-keyword">return</span> <span class="hljs-type">UISceneConfiguration</span>(name: <span class="hljs-string">&quot;Default Configuration&quot;</span>, sessionRole: connectingSceneSession.role)<br />    }<br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">application</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>, <span class="hljs-params">didDiscardSceneSessions</span> <span class="hljs-params">sceneSessions</span>: <span class="hljs-type">Set</span>&lt;<span class="hljs-type">UISceneSession</span>&gt;) {<br />        <span class="hljs-comment">// Called when the user discards a scene session.</span><br />        <span class="hljs-comment">// If any sessions were discarded while the application was not running, this will be called shortly after application:didFinishLaunchingWithOptions.</span><br />        <span class="hljs-comment">// Use this method to release any resources that were specific to the discarded scenes, as they will not return.</span><br />    }<br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">application</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>, <span class="hljs-params">didRegisterForRemoteNotificationsWithDeviceToken</span> <span class="hljs-params">deviceToken</span>: <span class="hljs-type">Data</span>) {<br />        <br />        <span class="hljs-keyword">let</span> deviceTokenString <span class="hljs-operator">=</span> deviceToken.reduce(<span class="hljs-string">&quot;&quot;</span>) {<br />            <span class="hljs-variable">$0</span> <span class="hljs-operator">+</span> <span class="hljs-type">String</span>(format: <span class="hljs-string">&quot;%02x&quot;</span>, <span class="hljs-variable">$1</span>)<br />        }<br />        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;deviceToken&quot;</span>, deviceTokenString)<br />    }<br />}<br /><br /><span class="hljs-keyword">extension</span> <span class="hljs-title class_">AppDelegate</span>: <span class="hljs-title class_">UNUserNotificationCenterDelegate</span> {<br />    <span class="hljs-comment">// 使用者點選推播時觸發</span><br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">userNotificationCenter</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">center</span>: <span class="hljs-type">UNUserNotificationCenter</span>, <span class="hljs-params">didReceive</span> <span class="hljs-params">response</span>: <span class="hljs-type">UNNotificationResponse</span>, <span class="hljs-params">withCompletionHandler</span> <span class="hljs-params">completionHandler</span>: <span class="hljs-keyword">@escaping</span> () -&gt; <span class="hljs-type">Void</span>) {<br />        <span class="hljs-built_in">print</span>(<span class="hljs-keyword">#function</span>)<br />        <span class="hljs-keyword">let</span> content <span class="hljs-operator">=</span> response.notification.request.content<br />        <span class="hljs-built_in">print</span>(content.userInfo)<br />        completionHandler()<br />    }<br />    <br />    <span class="hljs-comment">// 讓 App 在前景也能顯示推播</span><br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">userNotificationCenter</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">center</span>: <span class="hljs-type">UNUserNotificationCenter</span>, <span class="hljs-params">willPresent</span> <span class="hljs-params">notification</span>: <span class="hljs-type">UNNotification</span>, <span class="hljs-params">withCompletionHandler</span> <span class="hljs-params">completionHandler</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">UNNotificationPresentationOptions</span>) -&gt; <span class="hljs-type">Void</span>) {<br />        completionHandler([.banner])<br />    }<br />}<br /><br /><span class="hljs-keyword">extension</span> <span class="hljs-title class_">AppDelegate</span>: <span class="hljs-title class_">MessagingDelegate</span> {<br />   <br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">messaging</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">messaging</span>: <span class="hljs-type">Messaging</span>, <span class="hljs-params">didReceiveRegistrationToken</span> <span class="hljs-params">fcmToken</span>: <span class="hljs-type">String</span>?) {<br />        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;fcm Token&quot;</span>, fcmToken <span class="hljs-operator">??</span> <span class="hljs-string">&quot;&quot;</span>)<br />        <span class="hljs-comment">// 將 fcm token 傳送給後台</span><br />    }<br />}</span></pre><p name="7491" id="7491" class="graf graf--p graf-after--pre">ps: FCM 發送推播時將依據 registration token 找到發送的目標，而不是 APNs 的 device token，因此我們也可以將 AppDelegate.swift 裡的application(_:didRegisterForRemoteNotificationsWithDeviceToken:) 移除。</p><h3 name="8fff" id="8fff" class="graf graf--h3 graf-after--p">在 Firebase 專案設定 token 認證需要的 APNs Authentication Key(p8)</h3><p name="3782" id="3782" class="graf graf--p graf-after--h3">當我們想發送推播時，必須通知 APNs server。為了安全性的考量，provider 跟 APNs server 之間的溝通必須經過一些認證(authentication)機制的處理。</p><figure name="cd35" id="cd35" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*xXLKsnhRGBEoK53yN89xBw.png" data-width="1724" data-height="724" src="https://cdn-images-1.medium.com/max/800/1*xXLKsnhRGBEoK53yN89xBw.png"></figure><p name="9d01" id="9d01" class="graf graf--p graf-after--figure">iOS 有 Certificate &amp; Token 兩種認證機制，FCM 兩種都支援，接下來我們將示範目前比較建議採用的 token 機制。</p><h4 name="f872" id="f872" class="graf graf--h4 graf-after--p">連到 Firebase 的專案頁面，點選齒輪，然後點選 Project settings</h4><figure name="abec" id="abec" class="graf graf--figure graf-after--h4"><img class="graf-image" data-image-id="1*qyzYGt-VsiPn6aB79JAh7A.png" data-width="870" data-height="296" src="https://cdn-images-1.medium.com/max/800/1*qyzYGt-VsiPn6aB79JAh7A.png"></figure><h4 name="bab2" id="bab2" class="graf graf--h4 graf-after--figure">切換到 Cloud Messaging 分頁</h4><figure name="8d1b" id="8d1b" class="graf graf--figure graf-after--h4"><img class="graf-image" data-image-id="1*33b-JIx1sgaZOB-YZECSog.png" data-width="1076" data-height="258" src="https://cdn-images-1.medium.com/max/800/1*33b-JIx1sgaZOB-YZECSog.png"></figure><h4 name="4e3c" id="4e3c" class="graf graf--h4 graf-after--figure">找到 iOS App configuration 區塊，點選 APNs Authentication Key 下的 Upload。</h4><figure name="0019" id="0019" class="graf graf--figure graf-after--h4"><img class="graf-image" data-image-id="1*8gPiMEkOCHz3eYkzr30GiQ.png" data-width="1618" data-height="634" src="https://cdn-images-1.medium.com/max/800/1*8gPiMEkOCHz3eYkzr30GiQ.png"></figure><p name="acde" id="acde" class="graf graf--p graf-after--figure">token 認證需要 APNs Authentication Key(p8)，key id &amp; team id，因此我們必須上傳 p8 檔，輸入 key ID &amp; team ID。</p><figure name="5a8a" id="5a8a" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*h9fJiN4YCRBuGnDZgqtZRw.png" data-width="928" data-height="1086" src="https://cdn-images-1.medium.com/max/800/1*h9fJiN4YCRBuGnDZgqtZRw.png"></figure><figure name="9b64" id="9b64" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*tIFS1NDFnyFMjYzXGHMogQ.png" data-width="1656" data-height="616" src="https://cdn-images-1.medium.com/max/800/1*tIFS1NDFnyFMjYzXGHMogQ.png"></figure><h3 name="3331" id="3331" class="graf graf--h3 graf-after--figure">從 Firebase console 發送推播</h3><p name="f03b" id="f03b" class="graf graf--p graf-after--h3">現在萬事具備，連東風也不欠了。接下來讓我們從 Firebase console 發送推播吧。</p><div name="3620" id="3620" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%BE%9E-firebase-console-%E7%99%BC%E9%80%81%E6%8E%A8%E6%92%AD-adaf8b123901" data-href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%BE%9E-firebase-console-%E7%99%BC%E9%80%81%E6%8E%A8%E6%92%AD-adaf8b123901" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%BE%9E-firebase-console-%E7%99%BC%E9%80%81%E6%8E%A8%E6%92%AD-adaf8b123901"><strong class="markup--strong markup--mixtapeEmbed-strong">從 Firebase console 發送推播</strong><br><em class="markup--em markup--mixtapeEmbed-em">發送推播給安裝 App 的所有使用者</em>medium.com</a><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%BE%9E-firebase-console-%E7%99%BC%E9%80%81%E6%8E%A8%E6%92%AD-adaf8b123901" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="e7db25ada69ac59c9e764d6585be217e" data-thumbnail-img-id="1*12flDcKOPbRs4BLYZWSELQ.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*12flDcKOPbRs4BLYZWSELQ.png);"></a></div><p name="d38b" id="d38b" class="graf graf--p graf-after--mixtapeEmbed">ps: 一般真正上架的 App 會從後台(server)通知 FCM 發送推播，相關說明可參考以下連結。</p><div name="c94e" id="c94e" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://firebase.google.com/docs/cloud-messaging/server" data-href="https://firebase.google.com/docs/cloud-messaging/server" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://firebase.google.com/docs/cloud-messaging/server"><strong class="markup--strong markup--mixtapeEmbed-strong">Your server environment and FCM | Firebase</strong><br><em class="markup--em markup--mixtapeEmbed-em">The server side of Firebase Cloud Messaging consists of two components: The FCM backend provided by Google. Your app…</em>firebase.google.com</a><a href="https://firebase.google.com/docs/cloud-messaging/server" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="2752cfd3271723a593e8698f9ffcd7b7" data-thumbnail-img-id="0*XP_vmBnft3a_gqmm" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*XP_vmBnft3a_gqmm);"></a></div><h3 name="efbe" id="efbe" class="graf graf--h3 graf-after--mixtapeEmbed">參考連結</h3><div name="ef8f" id="ef8f" class="graf graf--mixtapeEmbed graf-after--h3"><a href="https://firebase.google.com/docs/cloud-messaging/ios/client" data-href="https://firebase.google.com/docs/cloud-messaging/ios/client" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://firebase.google.com/docs/cloud-messaging/ios/client"><strong class="markup--strong markup--mixtapeEmbed-strong">Set up a Firebase Cloud Messaging client app on iOS</strong><br><em class="markup--em markup--mixtapeEmbed-em">For iOS client apps, you can receive notification and data payloads up to 4000 bytes over the Firebase Cloud Messaging…</em>firebase.google.com</a><a href="https://firebase.google.com/docs/cloud-messaging/ios/client" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="859babe4bc35c6bd35bd378b545a2631" data-thumbnail-img-id="0*Br3XU32LXCQSHfh9" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*Br3XU32LXCQSHfh9);"></a></div><figure name="8c56" id="8c56" class="graf graf--figure graf-after--mixtapeEmbed graf--trailing"><img class="graf-image" data-image-id="1*34gkrdfbh2LNdpnVP1msbA.png" data-width="2312" data-height="1310" src="https://cdn-images-1.medium.com/max/800/1*34gkrdfbh2LNdpnVP1msbA.png"></figure></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@apppeterpan" class="p-author h-card">彼得潘的 iOS App Neverland</a> on <a href="https://medium.com/p/b4a9bd4f89d6"><time class="dt-published" datetime="2021-07-26T07:54:54.694Z">July 26, 2021</time></a>.</p><p><a href="https://medium.com/@apppeterpan/%E5%88%A9%E7%94%A8-firebase-cloud-messaging-fcm-%E7%99%BC%E9%80%81%E6%8E%A8%E6%92%AD-b4a9bd4f89d6" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on September 17, 2025.</p></footer></article></body></html>