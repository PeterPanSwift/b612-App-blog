<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>collection view &amp; table view 的網路圖片顯示問題</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">collection view &amp; table view 的網路圖片顯示問題</h1>
</header>
<section data-field="subtitle" class="p-summary">
開發 iOS App 時，我們時常在 collection view &amp; table view 的 cell 顯示網路抓取的圖片，然而撰寫這部分程式時卻有一些要注意的小地方，接下來就讓我們以抓取 Placeholder.com 的彩色圖片為例說明吧。
</section>
<section data-field="body" class="e-content">
<section name="d20d" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="5ace" id="5ace" class="graf graf--h3 graf--leading graf--title">collection view &amp; table view 的網路圖片顯示問題</h3><p name="889c" id="889c" class="graf graf--p graf-after--h3">開發 iOS App 時，我們時常在 collection view &amp; table view 的 cell 顯示網路抓取的圖片，然而撰寫這部分程式時卻有一些要注意的小地方，接下來就讓我們以抓取 <code class="markup--code markup--p-code">Placeholder.com</code> 的彩色圖片為例說明吧。</p><div name="069a" id="069a" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://placeholder.com" data-href="https://placeholder.com" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://placeholder.com"><strong class="markup--strong markup--mixtapeEmbed-strong">Placeholder.com: Placeholder.com - The Free Image Placeholder Service Favoured By Designers</strong><br><em class="markup--em markup--mixtapeEmbed-em">Disclosure: Your support helps keep the site running! We earn a referral fee for some of the services we recommend on…</em>placeholder.com</a><a href="https://placeholder.com" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="e4588933d3f83c700c32701f82cd2fcf" data-thumbnail-img-id="0*bxIPEZyV9xr5vytJ" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*bxIPEZyV9xr5vytJ);"></a></div><h3 name="9abf" id="9abf" class="graf graf--h3 graf-after--mixtapeEmbed">設計 storyboard 的畫面，以 collection view 呈現彩色圖片</h3><p name="9b1e" id="9b1e" class="graf graf--p graf-after--h3">在 storyboard 加入 collection view controller，依下圖設計顯示的畫面。</p><figure name="8d29" id="8d29" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*IChRdVmzpmlQR9Qqgz2O2Q.jpeg" data-width="1008" data-height="808" src="https://cdn-images-1.medium.com/max/800/1*IChRdVmzpmlQR9Qqgz2O2Q.jpeg"></figure><p name="4177" id="4177" class="graf graf--p graf-after--figure">完成以下設定。</p><ul class="postList"><li name="399e" id="399e" class="graf graf--li graf-after--p">將 controller 類別設為繼承 UICollectionViewController 的 PhotoCollectionViewController。</li><li name="1902" id="1902" class="graf graf--li graf-after--li">將 cell 類別設為繼承 UICollectionViewCell 的 PhotoCollectionViewCell。</li><li name="3afc" id="3afc" class="graf graf--li graf-after--li">將 cell id 設為 PhotoCollectionViewCell。</li><li name="3a00" id="3a00" class="graf graf--li graf-after--li">從 collection view 設定 cell size 180 * 180，Estimate Size 設為 None。</li></ul><figure name="a63d" id="a63d" class="graf graf--figure graf-after--li"><img class="graf-image" data-image-id="1*bqGPFafK_wp1g5t7Qe3TPQ.png" data-width="522" data-height="256" src="https://cdn-images-1.medium.com/max/800/1*bqGPFafK_wp1g5t7Qe3TPQ.png"></figure><h3 name="7e52" id="7e52" class="graf graf--h3 graf-after--figure">定義資料的型別 Photo</h3><p name="5a77" id="5a77" class="graf graf--p graf-after--h3">url 儲存圖片網址，rgb 儲存顏色的十六進位字串，比方 FFA3FF。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="cc53" id="cc53" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Photo</span> {<br />    <span class="hljs-keyword">let</span> rgb: <span class="hljs-type">String</span><br />    <span class="hljs-keyword">let</span> url: <span class="hljs-type">URL</span><br />}</span></pre><h3 name="67db" id="67db" class="graf graf--h3 graf-after--pre">定義 cell 的型別 PhotoCollectionViewCell</h3><p name="046b" id="046b" class="graf graf--p graf-after--h3">在 PhotoCollectionViewCell 裡宣告儲存資料的 property photo，方便之後 controller 呼叫 cell 的 function update 設定 cell。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="1611" id="1611" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PhotoCollectionViewCell</span>: <span class="hljs-title class_">UICollectionViewCell</span> {<br />    <br />    <span class="hljs-keyword">var</span> photo: <span class="hljs-type">Photo</span>!<br />    <span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> label: <span class="hljs-type">UILabel</span>!<br />    <span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> imageView: <span class="hljs-type">UIImageView</span>!<br />    <br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchImage</span>(<span class="hljs-params">url</span>: <span class="hljs-type">URL</span>, <span class="hljs-params">completion</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">UIImage</span>?) -&gt; <span class="hljs-type">Void</span>) {<br />        <span class="hljs-type">URLSession</span>.shared.dataTask(with: url) { data, response, error <span class="hljs-keyword">in</span><br />            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> data, <br />               <span class="hljs-keyword">let</span> image <span class="hljs-operator">=</span> <span class="hljs-type">UIImage</span>(data: data) {<br />                completion(image)<br />            } <span class="hljs-keyword">else</span> {<br />                completion(<span class="hljs-literal">nil</span>)<br />            }<br />        }.resume()<br />    }<br />    <br />    <br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">update</span>() {<br />        label.text <span class="hljs-operator">=</span> photo.rgb<br />        fetchImage(url: photo.url) { image <span class="hljs-keyword">in</span><br />            <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> image <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }<br />            <span class="hljs-type">DispatchQueue</span>.main.async {<br />                <span class="hljs-keyword">self</span>.imageView.image <span class="hljs-operator">=</span> image<br />            }<br />        }<br />    }<br />}</span></pre><h3 name="88c9" id="88c9" class="graf graf--h3 graf-after--pre">定義 controller 的型別 PhotoCollectionViewController</h3><p name="9f9a" id="9f9a" class="graf graf--p graf-after--h3">從 Placeholder.com 抓圖時圖片的網址有固定的格式，我們可指定圖片的大小跟顏色，比方 <code class="markup--code markup--p-code"><a href="https://via.placeholder.com/200/FF0000" data-href="https://via.placeholder.com/200/FF0000" class="markup--anchor markup--p-anchor" rel="nofollow noopener noopener" target="_blank">https://via.placeholder.com/200/FF0000</a></code> 將抓取寬高 200 pixel 的紅色圖片。</p><p name="027b" id="027b" class="graf graf--p graf-after--p">因此我們以亂數產生 1000 個顏色的字串，生成 1000 個 Photo 存在 array 裡，然後讓 collection view 顯示這 1000 張圖片。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="df5f" id="df5f" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PhotoCollectionViewController</span>: <span class="hljs-title class_">UICollectionViewController</span> {<br />   <span class="hljs-keyword">let</span> photos <span class="hljs-operator">=</span> (<span class="hljs-number">1</span><span class="hljs-operator">...</span><span class="hljs-number">1000</span>).map { <span class="hljs-keyword">_</span> -&gt; <span class="hljs-type">Photo</span> <span class="hljs-keyword">in</span><br />        <span class="hljs-keyword">let</span> rgb <span class="hljs-operator">=</span> (<span class="hljs-number">1</span><span class="hljs-operator">...</span><span class="hljs-number">3</span>).reduce(<span class="hljs-string">&quot;&quot;</span>) { result, <span class="hljs-keyword">_</span>  <span class="hljs-keyword">in</span><br />            result.appending(<span class="hljs-type">String</span>(<span class="hljs-type">Int</span>.random(in: <span class="hljs-number">0</span><span class="hljs-operator">...</span><span class="hljs-number">255</span>), radix: <span class="hljs-number">16</span>, uppercase: <span class="hljs-literal">true</span>))<br />        }<br />        <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">&quot;https://via.placeholder.com/200/<span class="hljs-subst">\(rgb)</span>&quot;</span>)<span class="hljs-operator">!</span><br />        <span class="hljs-keyword">return</span> <span class="hljs-type">Photo</span>(rgb: rgb, url: url)<br />    }<br /><br />    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {<br />        <span class="hljs-keyword">super</span>.viewDidLoad()<br />    }<br />    <br />    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">collectionView</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">collectionView</span>: <span class="hljs-type">UICollectionView</span>, <span class="hljs-params">numberOfItemsInSection</span> <span class="hljs-params">section</span>: <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Int</span> {<br />        <span class="hljs-keyword">return</span> photos.count<br />    }<br />    <br />    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">collectionView</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">collectionView</span>: <span class="hljs-type">UICollectionView</span>, <span class="hljs-params">cellForItemAt</span> <span class="hljs-params">indexPath</span>: <span class="hljs-type">IndexPath</span>) -&gt; <span class="hljs-type">UICollectionViewCell</span> {<br />        <span class="hljs-keyword">let</span> cell <span class="hljs-operator">=</span> collectionView.dequeueReusableCell(withReuseIdentifier: <span class="hljs-string">&quot;<span class="hljs-subst">\(PhotoCollectionViewCell.<span class="hljs-keyword">self</span>)</span>&quot;</span>, for: indexPath) <span class="hljs-keyword">as!</span> <span class="hljs-type">PhotoCollectionViewCell</span><br />        <br />        cell.photo <span class="hljs-operator">=</span> photos[indexPath.item]<br />        cell.update()<br />        <br />        <span class="hljs-keyword">return</span> cell<br />    }<br />}</span></pre><h3 name="b313" id="b313" class="graf graf--h3 graf-after--pre">問題</h3><p name="b7ef" id="b7ef" class="graf graf--p graf-after--h3">當我們滑動畫面時，從以下兩張 App 畫面可發現一些問題。左邊的畫面跟右邊的畫面大概相隔 2 秒，左邊是圖片還沒抓完，右邊是圖片已抓完的畫面。</p><ul class="postList"><li name="94db" id="94db" class="graf graf--li graf-after--p">當圖片還沒抓到時，cell 將顯示空白區塊。</li><li name="4481" id="4481" class="graf graf--li graf-after--li">由於 cell 重覆利用的特性，使用者將看到 cell 先顯示之前 image view 的圖片，然後才更新成正確的圖片。</li></div><div class="section-inner sectionLayout--outsetRow" data-paragraph-count="2"></ul><figure name="d174" id="d174" class="graf graf--figure graf--layoutOutsetRow is-partialWidth graf-after--li" style="width: 50%;"><img class="graf-image" data-image-id="1*-XLptBGHH1s019Bnru2yGA.png" data-width="828" data-height="1792" src="https://cdn-images-1.medium.com/max/600/1*-XLptBGHH1s019Bnru2yGA.png"></figure><figure name="5628" id="5628" class="graf graf--figure graf--layoutOutsetRowContinue is-partialWidth graf-after--figure" style="width: 50%;"><img class="graf-image" data-image-id="1*xqGesQaXFVbPwsxjH0zOvg.png" data-width="828" data-height="1792" src="https://cdn-images-1.medium.com/max/600/1*xqGesQaXFVbPwsxjH0zOvg.png"></figure></div><div class="section-inner sectionLayout--insetColumn"><h3 name="0bb1" id="0bb1" class="graf graf--h3 graf-after--figure">解法: 抓取圖片前將 image view 設為預設圖片</h3><p name="3da1" id="3da1" class="graf graf--p graf-after--h3">當圖片還沒抓到時先顯示預設圖片，當 cell 重覆利用時，它也會先顯示預設圖片，不會顯示之前的圖片。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="2763" id="2763" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">func</span> <span class="hljs-title function_">update</span>() {<br />        label.text <span class="hljs-operator">=</span> photo.rgb<br />        imageView.image <span class="hljs-operator">=</span> <span class="hljs-type">UIImage</span>(systemName: <span class="hljs-string">&quot;questionmark.circle&quot;</span>)<br />        fetchImage(url: photo.url) { (image) <span class="hljs-keyword">in</span><br />            <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> image <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }<br />            <span class="hljs-type">DispatchQueue</span>.main.async {<br />                <span class="hljs-keyword">self</span>.imageView.image <span class="hljs-operator">=</span> image<br />            }<br />        }<br />}</span></pre></div><div class="section-inner sectionLayout--outsetRow" data-paragraph-count="2"><figure name="1198" id="1198" class="graf graf--figure graf--layoutOutsetRow is-partialWidth graf-after--pre" style="width: 50%;"><img class="graf-image" data-image-id="1*pkvhwoCpH78S7YVmSBuqSw.png" data-width="828" data-height="1792" src="https://cdn-images-1.medium.com/max/600/1*pkvhwoCpH78S7YVmSBuqSw.png"></figure><figure name="6c7e" id="6c7e" class="graf graf--figure graf--layoutOutsetRowContinue is-partialWidth graf-after--figure" style="width: 50%;"><img class="graf-image" data-image-id="1*bJ88eaeLREkoUQJikWt-WQ.png" data-width="828" data-height="1792" src="https://cdn-images-1.medium.com/max/600/1*bJ88eaeLREkoUQJikWt-WQ.png"></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="9482" id="9482" class="graf graf--p graf-after--figure">ps: 我們也可以在 prepareForReuse 裡設定預設圖片，關於防止重覆利用的 cell 顯示之前的照片，有興趣的朋友可進一步參考以下連結。</p><div name="9525" id="9525" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E9%98%B2%E6%AD%A2%E9%87%8D%E8%A6%86%E5%88%A9%E7%94%A8%E7%9A%84-cell-%E9%A1%AF%E7%A4%BA%E4%B9%8B%E5%89%8D%E7%9A%84%E7%85%A7%E7%89%87-e2671b1a120b" data-href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E9%98%B2%E6%AD%A2%E9%87%8D%E8%A6%86%E5%88%A9%E7%94%A8%E7%9A%84-cell-%E9%A1%AF%E7%A4%BA%E4%B9%8B%E5%89%8D%E7%9A%84%E7%85%A7%E7%89%87-e2671b1a120b" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E9%98%B2%E6%AD%A2%E9%87%8D%E8%A6%86%E5%88%A9%E7%94%A8%E7%9A%84-cell-%E9%A1%AF%E7%A4%BA%E4%B9%8B%E5%89%8D%E7%9A%84%E7%85%A7%E7%89%87-e2671b1a120b"><strong class="markup--strong markup--mixtapeEmbed-strong">防止重覆利用的 cell 顯示之前的照片</strong><br><em class="markup--em markup--mixtapeEmbed-em">當我們使用 table view 或 collection view 時，cell 重覆利用的特性可以帶給更好的效能。不過當 cell 上顯示的照片是非同步抓取，比方從網路抓取，或是利用 PHCachingImageManager…</em>medium.com</a><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E9%98%B2%E6%AD%A2%E9%87%8D%E8%A6%86%E5%88%A9%E7%94%A8%E7%9A%84-cell-%E9%A1%AF%E7%A4%BA%E4%B9%8B%E5%89%8D%E7%9A%84%E7%85%A7%E7%89%87-e2671b1a120b" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="f2bbd3b4aeb5417fd13b0954068dc609"></a></div><h3 name="2818" id="2818" class="graf graf--h3 graf-after--mixtapeEmbed">問題: cell 顯示錯誤的圖片</h3><p name="a184" id="a184" class="graf graf--p graf-after--h3">以上的寫法已可解決大部分的問題，不過有時我們卻會遇到 cell 顯示錯誤圖片的問題。</p><p name="650d" id="650d" class="graf graf--p graf-after--p">為了容易重現這個問題，我們故意將 array 裡第一張圖的網址改成尺寸超大的可愛貓咪圖，讓它抓取的時間比較久。(ps: 圖片網址若失效，測試時請改成其它圖片網址)</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="3851" id="3851" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PhotoCollectionViewController</span>: <span class="hljs-title class_">UICollectionViewController</span> {<br /><br />   <span class="hljs-keyword">let</span> photos <span class="hljs-operator">=</span> (<span class="hljs-number">1</span><span class="hljs-operator">...</span><span class="hljs-number">1000</span>).map { number <span class="hljs-keyword">in</span><br />        <span class="hljs-keyword">let</span> rgb <span class="hljs-operator">=</span> (<span class="hljs-number">1</span><span class="hljs-operator">...</span><span class="hljs-number">3</span>).reduce(<span class="hljs-string">&quot;&quot;</span>) { result, <span class="hljs-keyword">_</span>  <span class="hljs-keyword">in</span><br />            result.appending(<span class="hljs-type">String</span>(<span class="hljs-type">Int</span>.random(in: <span class="hljs-number">0</span><span class="hljs-operator">...</span><span class="hljs-number">255</span>), radix: <span class="hljs-number">16</span>, uppercase: <span class="hljs-literal">true</span>))<br />        }<br />        <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">&quot;https://via.placeholder.com/200/<span class="hljs-subst">\(rgb)</span>&quot;</span>)<span class="hljs-operator">!</span><br />        <span class="hljs-keyword">if</span> number <span class="hljs-operator">==</span> <span class="hljs-number">1</span> {<br />            <span class="hljs-keyword">return</span> <span class="hljs-type">Photo</span>(rgb: <span class="hljs-string">&quot;xxx&quot;</span>, url: <span class="hljs-type">URL</span>(string: <span class="hljs-string">&quot;https://unsplash.com/photos/9SWHIgu8A8k/download?force=true&quot;</span>)<span class="hljs-operator">!</span>)<br />         } <span class="hljs-keyword">else</span> {<br />            <span class="hljs-keyword">return</span> <span class="hljs-type">Photo</span>(rgb: rgb, url: url)<br />         }<br />    }</span></pre><figure name="548c" id="548c" class="graf graf--figure graf-after--pre"><img class="graf-image" data-image-id="1*Df7tPDybVbQExv6fcfql7A.jpeg" data-width="660" data-height="990" src="https://cdn-images-1.medium.com/max/800/1*Df7tPDybVbQExv6fcfql7A.jpeg"></figure><p name="1e06" id="1e06" class="graf graf--p graf-after--figure">如下圖所示，可愛貓咪應該出現在第一個 cell，但牠卻出現在別的 cell 了。怎麼會這樣呢 ?</p><p name="18a9" id="18a9" class="graf graf--p graf-after--p">當我們滑動表格後，顯示的第 n 個 cell 其實是當初的第一個 cell(因為 cell 的重覆利用)。由於第 n 個 cell 對應的圖較小，所以它的圖將先抓到，cell 上的圖片先被設為某個顏色的圖片。接著當尺寸超大的貓咪圖抓到時，它將第 n 個 cell (原本是第一個 cell)的圖換成貓咪圖，因此造成 cell 顯示了錯誤的圖片。</p><figure name="b2c3" id="b2c3" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*Jaybrz79njSd5--KyL7w0Q.jpeg" data-width="894" data-height="1556" src="https://cdn-images-1.medium.com/max/800/1*Jaybrz79njSd5--KyL7w0Q.jpeg"></figure><figure name="428f" id="428f" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*-dWwCVvfRbvv2PgGLPwN3Q.jpeg" data-width="1314" data-height="834" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*-dWwCVvfRbvv2PgGLPwN3Q.jpeg"></figure><h3 name="2975" id="2975" class="graf graf--h3 graf-after--figure">解法</h3><p name="57d9" id="57d9" class="graf graf--p graf-after--h3">以下我們介紹 5 種解法。</p><ul class="postList"><li name="6b72" id="6b72" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">解法 1 : 圖片抓到時，檢查 cell 應該顯示的圖是否還是當初抓的圖，比方比對資料的 id 或圖片的 URL。</strong></li><li name="1322" id="1322" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">解法 2: 在 cell 裡儲存抓圖的 task，在 prepareForReuse 取消抓圖的task</strong></li><li name="1caa" id="1caa" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">解法 3: 在 cell 裡儲存抓圖的 task，當 cell 從畫面消失，從 collection view 或 table view 移除時取消抓圖的task (定義 fucntion didEndDisplaying cell )</strong></li><li name="3984" id="3984" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">解法 4: 圖片抓到時，檢查 cell 的 indexPath 是否已經改變。(ps: 此方法在 iOS 15 測試正常，印象中在舊版有問題）</strong></li><li name="8e52" id="8e52" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">解法 5: 使用套件。</strong></li></ul><h4 name="6f69" id="6f69" class="graf graf--h4 graf-after--li"><strong class="markup--strong markup--h4-strong">解法 1 : 圖片抓到時，檢查 cell 應該顯示的圖是否還是當初抓的圖，比方比對資料的 id 或圖片的 URL</strong></h4><p name="8167" id="8167" class="graf graf--p graf-after--h4">為了避免 cell 顯示錯誤的圖片，抓到圖後我們應檢查 cell 是否已變了心，變成別的位置的 cell。在剛剛的例子，cell 顯示的圖片跟 Photo 的 rgb 有關，因此我們可用 rgb 判斷。在抓圖前先將 photo.rgb 存在常數 rgb 裡，抓到圖後再判斷 <code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">rgb &amp; self.photo.rgb </strong></code>是否相等<strong class="markup--strong markup--p-strong">。</strong>若 cell 已經因為重覆利用變成別的位置的 cell，它儲存的 photo 資料也會不一樣，因此我們可用 photo.rgb 跟當初的 rgb 比較。</p><p name="f711" id="f711" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">PhotoCollectionViewCell</strong></p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="b171" id="b171" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">func</span> <span class="hljs-title function_">update</span>() {<br />        <span class="hljs-keyword">let</span> rgb <span class="hljs-operator">=</span> photo.rgb<br />        label.text <span class="hljs-operator">=</span> rgb<br />        imageView.image <span class="hljs-operator">=</span> <span class="hljs-type">UIImage</span>(systemName: <span class="hljs-string">&quot;questionmark.circle&quot;</span>)<br />        fetchImage(url: photo.url) { image <span class="hljs-keyword">in</span><br />            <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> image <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }<br />            <br />            <span class="hljs-type">DispatchQueue</span>.main.async {<br />                <span class="hljs-keyword">if</span> rgb <span class="hljs-operator">==</span> <span class="hljs-keyword">self</span>.photo.rgb {<br />                    <span class="hljs-keyword">self</span>.imageView.image <span class="hljs-operator">=</span> image<br />                }<br />            }            <br />        }<br />}</span></pre><p name="3c9a" id="3c9a" class="graf graf--p graf-after--pre">此方法的重點在於檢查 cell 對應的資料是否還是當初抓圖時的資料，因此判斷的方法將因資料而異，比方資料的 id，名字或圖片網址都可以當成判斷的欄位。</p><h4 name="8313" id="8313" class="graf graf--h4 graf-after--p"><strong class="markup--strong markup--h4-strong">解法 2: 在 cell 裡儲存抓圖的 task，在 prepareForReuse 取消抓圖的task</strong></h4><p name="6877" id="6877" class="graf graf--p graf-after--h4">抓圖時我們將產生的 task 存起來，當 cell 因為重覆利用準備變成另一個位置的 cell 時，將觸發 function prepareForReuse，我們在 prepareForReuse 呼叫 task?.cancel()，取消抓圖的任務，因為此時 cell 變成了新的位置，要顯示的是別筆資料的圖片，不是之前抓的圖片。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="167f" id="167f" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PhotoCollectionViewCell</span>: <span class="hljs-title class_">UICollectionViewCell</span> {<br />    <br />    <span class="hljs-keyword">var</span> photo: <span class="hljs-type">Photo</span>!<br />    <span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> label: <span class="hljs-type">UILabel</span>!<br />    <span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> imageView: <span class="hljs-type">UIImageView</span>!<br />    <span class="hljs-keyword">var</span> task: <span class="hljs-type">URLSessionDataTask</span>?<br />    <br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchImage</span>(<span class="hljs-params">url</span>: <span class="hljs-type">URL</span>, <span class="hljs-params">completion</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">UIImage</span>?) -&gt; <span class="hljs-type">Void</span>) {<br />        task <span class="hljs-operator">=</span> <span class="hljs-type">URLSession</span>.shared.dataTask(with: url) { data, response, error <span class="hljs-keyword">in</span><br />            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> data,<br />               <span class="hljs-keyword">let</span> image <span class="hljs-operator">=</span> <span class="hljs-type">UIImage</span>(data: data) {<br />                completion(image)<br />                <br />            } <span class="hljs-keyword">else</span> {<br />                completion(<span class="hljs-literal">nil</span>)<br />            }<br />            <span class="hljs-keyword">self</span>.task <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span><br />        }<br />        task<span class="hljs-operator">?</span>.resume()<br />    }<br />    <br />    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">prepareForReuse</span>() {<br />        <span class="hljs-keyword">super</span>.prepareForReuse()<br />        task<span class="hljs-operator">?</span>.cancel()<br />        task <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span><br />    }</span></pre><h4 name="543a" id="543a" class="graf graf--h4 graf-after--pre"><strong class="markup--strong markup--h4-strong">解法 3: 在 cell 裡儲存抓圖的 task，當 cell 從畫面消失，從 collection view 或 table view 移除時取消抓圖的task (定義 fucntion </strong>didEndDisplaying cell )</h4><p name="2985" id="2985" class="graf graf--p graf-after--h4">抓圖時我們將產生的 task 存起來。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="ac83" id="ac83" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PhotoCollectionViewCell</span>: <span class="hljs-title class_">UICollectionViewCell</span> {<br />    <br />    <span class="hljs-keyword">var</span> photo: <span class="hljs-type">Photo</span>!<br />    <span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> label: <span class="hljs-type">UILabel</span>!<br />    <span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> imageView: <span class="hljs-type">UIImageView</span>!<br />    <span class="hljs-keyword">var</span> task: <span class="hljs-type">URLSessionDataTask</span>?<br />    <br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchImage</span>(<span class="hljs-params">url</span>: <span class="hljs-type">URL</span>, <span class="hljs-params">completion</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">UIImage</span>?) -&gt; <span class="hljs-type">Void</span>) {<br />        task <span class="hljs-operator">=</span> <span class="hljs-type">URLSession</span>.shared.dataTask(with: url) { data, response, error <span class="hljs-keyword">in</span><br />            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> data,<br />               <span class="hljs-keyword">let</span> image <span class="hljs-operator">=</span> <span class="hljs-type">UIImage</span>(data: data) {<br />                completion(image)<br />                <br />            } <span class="hljs-keyword">else</span> {<br />                completion(<span class="hljs-literal">nil</span>)<br />            }<br />            <span class="hljs-keyword">self</span>.task <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span><br />        }<br />        task<span class="hljs-operator">?</span>.resume()<br />    }</span></pre><p name="d4f9" id="d4f9" class="graf graf--p graf-after--pre">當 cell 從畫面消失，從 collection view 或 table view 移除時取消抓圖的task。(ps: 若是 table view，可定義 function tableView(_:didEndDisplaying:forRowAt:) )</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="70ff" id="70ff" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PhotoCollectionViewController</span>: <span class="hljs-title class_">UICollectionViewController</span> {<br /><br />   <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">collectionView</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">collectionView</span>: <span class="hljs-type">UICollectionView</span>, <span class="hljs-params">didEndDisplaying</span> <span class="hljs-params">cell</span>: <span class="hljs-type">UICollectionViewCell</span>, <span class="hljs-params">forItemAt</span> <span class="hljs-params">indexPath</span>: <span class="hljs-type">IndexPath</span>) {<br />      <span class="hljs-keyword">let</span> cell <span class="hljs-operator">=</span> cell <span class="hljs-keyword">as?</span> <span class="hljs-type">PhotoCollectionViewCell</span><br />      cell<span class="hljs-operator">?</span>.task<span class="hljs-operator">?</span>.cancel()<br />      cell<span class="hljs-operator">?</span>.task <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span><br />   }</span></pre><h4 name="23e6" id="23e6" class="graf graf--h4 graf-after--pre"><strong class="markup--strong markup--h4-strong">解法 4: 圖片抓到時，檢查 cell 的 indexPath 是否已經改變</strong></h4><p name="f465" id="f465" class="graf graf--p graf-after--h4">圖片抓到時，檢查 cell 的 indexPath 是否已經改變。若是 cell 的 indexPath 已經改變，表示之前抓的圖不該在 cell 顯示。(ps: 此方法在 iOS 15 測試正常，印象中在舊版有問題）</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="dc10" id="dc10" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PhotoCollectionViewController</span>: <span class="hljs-title class_">UICollectionViewController</span> {<br /><br />   <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">collectionView</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">collectionView</span>: <span class="hljs-type">UICollectionView</span>, <span class="hljs-params">cellForItemAt</span> <span class="hljs-params">indexPath</span>: <span class="hljs-type">IndexPath</span>) -&gt; <span class="hljs-type">UICollectionViewCell</span> {<br />      <span class="hljs-keyword">let</span> cell <span class="hljs-operator">=</span> collectionView.dequeueReusableCell(withReuseIdentifier: <span class="hljs-string">&quot;<span class="hljs-subst">\(PhotoCollectionViewCell.<span class="hljs-keyword">self</span>)</span>&quot;</span>, for: indexPath) <span class="hljs-keyword">as!</span> <span class="hljs-type">PhotoCollectionViewCell</span><br />      <span class="hljs-keyword">let</span> photo <span class="hljs-operator">=</span> photos[indexPath.item]<br />      cell.label.text <span class="hljs-operator">=</span> photo.rgb<br />      cell.imageView.image <span class="hljs-operator">=</span> <span class="hljs-type">UIImage</span>(systemName: <span class="hljs-string">&quot;questionmark.circle&quot;</span>)<br />      cell.fetchImage(url: photo.url) { image <span class="hljs-keyword">in</span><br />         <span class="hljs-type">DispatchQueue</span>.main.async {<br />            <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> image,<br />                  indexPath <span class="hljs-operator">==</span> collectionView.indexPath(for: cell) <span class="hljs-keyword">else</span> {<br />                <span class="hljs-keyword">return</span> cell<br />            }<br />            cell.imageView.image <span class="hljs-operator">=</span> image<br />         }<br />      }<br />      <span class="hljs-keyword">return</span> cell<br />   }</span></pre><h4 name="f632" id="f632" class="graf graf--h4 graf-after--pre">解法 5: 使用套件 Kingfisher</h4><p name="a2c5" id="a2c5" class="graf graf--p graf-after--h4">網路上有很多第三方抓圖的套件，所以想偷懶的朋友也可以直接使用套件，省去花時間處理網路圖片的顯示問題，比方 <br>Kingfisher 就是不錯的選擇。</p><div name="a089" id="a089" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://github.com/onevcat/Kingfisher" data-href="https://github.com/onevcat/Kingfisher" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://github.com/onevcat/Kingfisher"><strong class="markup--strong markup--mixtapeEmbed-strong">onevcat/Kingfisher</strong><br><em class="markup--em markup--mixtapeEmbed-em">Kingfisher is a powerful, pure-Swift library for downloading and caching images from the web. It provides you a chance…</em>github.com</a><a href="https://github.com/onevcat/Kingfisher" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="ac7df29d878719cf1e60deab10917239" data-thumbnail-img-id="0*EoRBRIAhJzAjPdvp" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*EoRBRIAhJzAjPdvp);"></a></div><p name="8081" id="8081" class="graf graf--p graf-after--mixtapeEmbed">仔細研究 Kingfisher 的程式後，可發現它在抓到圖時檢查 image view 是否應該顯示抓到的圖，有興趣的朋友可研究 ImageView+Kingfisher.swift 133 行的 <code class="markup--code markup--p-code">guard issuedIdentifier == self.taskIdentifier else</code>。</p><figure name="8816" id="8816" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*pr4lq5clJ5L4hh1xqC5srg.jpeg" data-width="1998" data-height="964" src="https://cdn-images-1.medium.com/max/800/1*pr4lq5clJ5L4hh1xqC5srg.jpeg"></figure><h3 name="73e3" id="73e3" class="graf graf--h3 graf-after--figure">利用 NSCache 暫存網路圖片</h3><p name="8627" id="8627" class="graf graf--p graf-after--h3">若想讓圖片顯示的效果更好，也可利用 NSCache 暫存網路圖片，這樣抓過的圖片將可暫存在 App 裡，滑到已抓過圖片的 cell 時圖片將立即顯示，不用再重新抓圖。</p><div name="6000" id="6000" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%88%A9%E7%94%A8-nscache-%E6%9A%AB%E5%AD%98%E7%B6%B2%E8%B7%AF%E5%9C%96%E7%89%87-70983260ceff" data-href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%88%A9%E7%94%A8-nscache-%E6%9A%AB%E5%AD%98%E7%B6%B2%E8%B7%AF%E5%9C%96%E7%89%87-70983260ceff" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%88%A9%E7%94%A8-nscache-%E6%9A%AB%E5%AD%98%E7%B6%B2%E8%B7%AF%E5%9C%96%E7%89%87-70983260ceff"><strong class="markup--strong markup--mixtapeEmbed-strong">利用 NSCache 暫存網路圖片</strong><br><em class="markup--em markup--mixtapeEmbed-em">開發 iOS App 時，我們時常從網路上抓圖，定義類似以下的抓圖 function。</em>medium.com</a><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%88%A9%E7%94%A8-nscache-%E6%9A%AB%E5%AD%98%E7%B6%B2%E8%B7%AF%E5%9C%96%E7%89%87-70983260ceff" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="d2e192d23eb72a59c549ffdfd9b3d30d" data-thumbnail-img-id="1*cKbq8UQav4vr8voEFP0MIA.jpeg" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*cKbq8UQav4vr8voEFP0MIA.jpeg);"></a></div><div name="6dd3" id="6dd3" class="graf graf--mixtapeEmbed graf-after--mixtapeEmbed graf--trailing"><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/swift-ios-app-%E4%B8%8B%E8%BC%89%E5%9C%96%E7%89%87%E7%9A%84%E5%B9%BE%E7%A8%AE%E6%96%B9%E6%B3%95-c8f3592db66f" data-href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/swift-ios-app-%E4%B8%8B%E8%BC%89%E5%9C%96%E7%89%87%E7%9A%84%E5%B9%BE%E7%A8%AE%E6%96%B9%E6%B3%95-c8f3592db66f" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/swift-ios-app-%E4%B8%8B%E8%BC%89%E5%9C%96%E7%89%87%E7%9A%84%E5%B9%BE%E7%A8%AE%E6%96%B9%E6%B3%95-c8f3592db66f"><strong class="markup--strong markup--mixtapeEmbed-strong">Swift iOS App 下載圖片的幾種方法</strong><br><em class="markup--em markup--mixtapeEmbed-em">開發 iOS App 時，我們時常需要撰寫下載圖片的程式，常見的抓圖程式是利用我們熟悉的 URLSessionDataTask，例如以下點選 button 下載圖片的例子:</em>medium.com</a><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/swift-ios-app-%E4%B8%8B%E8%BC%89%E5%9C%96%E7%89%87%E7%9A%84%E5%B9%BE%E7%A8%AE%E6%96%B9%E6%B3%95-c8f3592db66f" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="fb46fde630cd5b3d453224f0571875ea" data-thumbnail-img-id="1*lfK9G4QGMRIc8V2gXKmpHw.jpeg" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*lfK9G4QGMRIc8V2gXKmpHw.jpeg);"></a></div></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@apppeterpan" class="p-author h-card">彼得潘的 iOS App Neverland</a> on <a href="https://medium.com/p/e83c5ca487c8"><time class="dt-published" datetime="2020-09-28T14:22:48.252Z">September 28, 2020</time></a>.</p><p><a href="https://medium.com/@apppeterpan/collection-view-table-view-%E7%9A%84%E7%B6%B2%E8%B7%AF%E5%9C%96%E7%89%87%E9%A1%AF%E7%A4%BA%E5%95%8F%E9%A1%8C-e83c5ca487c8" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on November 16, 2025.</p></footer></article></body></html>