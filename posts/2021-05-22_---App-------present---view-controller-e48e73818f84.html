<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>取得 App 最後一個被 present 的 view controller</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">取得 App 最後一個被 present 的 view controller</h1>
</header>
<section data-field="subtitle" class="p-summary">
present 多個 view controller 的問題
</section>
<section data-field="body" class="e-content">
<section name="9098" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="b8ed" id="b8ed" class="graf graf--h3 graf--leading graf--title">取得 App 最後一個被 present 的 view controller</h3><h3 name="85e6" id="85e6" class="graf graf--h3 graf-after--h3">present 多個 view controller 的問題</h3><p name="7910" id="7910" class="graf graf--p graf-after--h3">開發 iOS App 時，我們時常利用 present 顯示新的頁面，不過 present 卻有一個特別的限制，讓我們看看以下的例子。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="86a1" id="86a1" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FirstViewController</span>: <span class="hljs-title class_">UIViewController</span> {<br /><br />   <span class="hljs-keyword">@IBAction</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">tap</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">sender</span>: <span class="hljs-keyword">Any</span>) {        <br />        present(<span class="hljs-type">SecondViewController</span>(), animated: <span class="hljs-literal">true</span>, completion: <span class="hljs-literal">nil</span>)<br />        <span class="hljs-type">DispatchQueue</span>.main.asyncAfter(deadline: .now() <span class="hljs-operator">+</span> <span class="hljs-number">3</span>) {<br />            <span class="hljs-keyword">self</span>.present(<span class="hljs-type">SecondViewController</span>(), animated: <span class="hljs-literal">true</span>)<br />        }<br />    }<br />}</span></pre><p name="f8a9" id="f8a9" class="graf graf--p graf-after--pre">當 button 按下時，FirstViewController 將 present SecondViewController，顯示 SecondViewController 的畫面。然後過了三秒後再 present 另一個 SecondViewController，此時將失敗，印出以下錯誤訊息。</p><pre name="a70a" id="a70a" class="graf graf--pre graf-after--p">2021-05-22 22:48:15.537957+0800 Demo[1703:37746] [Presentation] Attempt to present &lt;Demo.SecondViewController: 0x7fa05ac10bf0&gt; on &lt;Demo.FirstViewController: 0x7fa05ae055f0&gt; (from &lt;Demo.FirstViewController: 0x7fa05ae055f0&gt;) which is already presenting &lt;Demo.SecondViewController: 0x7fa05d2100d0&gt;.</pre><p name="9243" id="9243" class="graf graf--p graf-after--pre">換句話說，當 controller A present 了 controller B 後，A 就不能再 present 別人。此時畫面已經變成 B，B 才是老大，所以只有 B 才能 present 新的 controller。</p><p name="b7cc" id="b7cc" class="graf graf--p graf-after--p">因此，為了讓 present 可以正常運作，我們有時必須找出 App 目前最後一個被 present 的 view controller，然後用它來 present 新的 controller。</p><h3 name="8649" id="8649" class="graf graf--h3 graf-after--p">找出最後一個被 present 的 view controller</h3><p name="753a" id="753a" class="graf graf--p graf-after--h3">定義 function getLastPresentedViewController 取得最後一個被 present 的 view controller。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="a777" id="a777" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">import</span> UIKit <br /><br /><span class="hljs-keyword">extension</span> <span class="hljs-title class_">UIViewController</span> {<br /><br />    <span class="hljs-keyword">static</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">getLastPresentedViewController</span>() -&gt; <span class="hljs-type">UIViewController</span>? {<br />        <span class="hljs-keyword">let</span> scene <span class="hljs-operator">=</span> <span class="hljs-type">UIApplication</span>.shared.connectedScenes<br />            .filter { <span class="hljs-variable">$0</span>.activationState <span class="hljs-operator">==</span> .foregroundActive }<br />            .first { <span class="hljs-variable">$0</span> <span class="hljs-keyword">is</span> <span class="hljs-type">UIWindowScene</span> } <span class="hljs-keyword">as?</span> <span class="hljs-type">UIWindowScene</span><br />        <span class="hljs-keyword">let</span> window <span class="hljs-operator">=</span> scene<span class="hljs-operator">?</span>.windows.first { <span class="hljs-variable">$0</span>.isKeyWindow }<br />        <span class="hljs-keyword">var</span> presentedViewController <span class="hljs-operator">=</span> window<span class="hljs-operator">?</span>.rootViewController<br />        <span class="hljs-keyword">while</span> presentedViewController<span class="hljs-operator">?</span>.presentedViewController <span class="hljs-operator">!=</span> <span class="hljs-literal">nil</span> {<br />            presentedViewController <span class="hljs-operator">=</span> presentedViewController<span class="hljs-operator">?</span>.presentedViewController<br />        }<br />        <span class="hljs-keyword">return</span> presentedViewController<br />    }<br />}</span></pre><p name="8e71" id="8e71" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">說明</strong></p><p name="b560" id="b560" class="graf graf--p graf-after--p">先找出 window，然後從 window 的 rootViewController 開始，利用 property presentedViewController 判斷它是否有 present 另一個 controller( presentedViewController 表示被它 present 的 controller)，如此即可找出最後一個被 present 的 view controller。如果沒有 controller 被 present 過，則會回傳 rootViewController。</p><p name="8626" id="8626" class="graf graf--p graf-after--p">ps: 若要支援舊版的 iOS 12，請改用以下寫法取得 window。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="3c38" id="3c38" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">let</span> window <span class="hljs-operator">=</span> <span class="hljs-type">UIApplication</span>.shared.windows.first {<br />    <span class="hljs-variable">$0</span>.isKeyWindow<br />}</span></pre><h3 name="8eca" id="8eca" class="graf graf--h3 graf-after--pre">實驗</h3><p name="c1a0" id="c1a0" class="graf graf--p graf-after--h3">以下圖為例，執行 App 後，我們一路點選 button，顯示到最後一個藍色 controller 時，最後一個被 present 的是綠色 bar 的 navigation controller。(ps: 值得注意的，當畫面顯示最後一個藍色 controller 時，此時負責 present 新 controller 的人會是 navigation controller，而非藍色 controller )</p><figure name="6741" id="6741" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*OO9J7lAoKNXUAU2wnTjbMw.png" data-width="1660" data-height="980" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*OO9J7lAoKNXUAU2wnTjbMw.png"></figure><p name="7e17" id="7e17" class="graf graf--p graf-after--figure">為了證明 function getLastPresentedViewController 成功取得最後一個被 present 的 view controller，我們將綠色 bar 的 navigation controller 的 title 設為 greenBar，然後設定最後一個藍色 controller 的 button action。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="deac" id="deac" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">@IBAction</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">tap</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">sender</span>: <span class="hljs-keyword">Any</span>) {<br />           <br />    <span class="hljs-built_in">print</span>(<span class="hljs-type">UIViewController</span>.getLastPresentedViewController()<span class="hljs-operator">?</span>.title)<br />}</span></pre><p name="9879" id="9879" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">結果</strong></p><p name="92b8" id="92b8" class="graf graf--p graf-after--p">印出 Optional(&quot;greenBar&quot;)，表示它成功找到綠色 bar 的 navigation controller。</p><h3 name="084c" id="084c" class="graf graf--h3 graf-after--p">應用</h3><h4 name="849f" id="849f" class="graf graf--h4 graf-after--h3">顯示 alert</h4><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="249d" id="249d" class="graf graf--pre graf-after--h4 graf--preV2"><span class="pre--content"><span class="hljs-keyword">extension</span> <span class="hljs-title class_">UIAlertController</span> {<br />    <span class="hljs-keyword">static</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">showAlert</span>(<span class="hljs-params">title</span>: <span class="hljs-type">String</span>?, <span class="hljs-params">message</span>: <span class="hljs-type">String</span>?) {<br />        <span class="hljs-keyword">let</span> alertController <span class="hljs-operator">=</span> <span class="hljs-type">UIAlertController</span>(title: title, message: message, preferredStyle: .alert)<br />        alertController.addAction(<span class="hljs-type">UIAlertAction</span>(title: <span class="hljs-string">&quot;OK&quot;</span>, style: .default, handler: <span class="hljs-literal">nil</span>))<br />        <span class="hljs-keyword">let</span> controller <span class="hljs-operator">=</span> <span class="hljs-type">UIViewController</span>.getLastPresentedViewController()<br />        controller<span class="hljs-operator">?</span>.present(alertController, animated: <span class="hljs-literal">true</span>, completion: <span class="hljs-literal">nil</span>)<br />    }<br />}</span></pre><p name="38e4" id="38e4" class="graf graf--p graf-after--pre">ps: 顯示 alert 還要特別注意它是否會顯示在錯誤的頁面，相關說明可參考以下連結。</p><div name="6988" id="6988" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E9%A1%AF%E7%A4%BA-alert-%E5%89%8D%E6%AA%A2%E6%9F%A5%E5%87%BA%E5%95%8F%E9%A1%8C%E7%9A%84%E9%A0%81%E9%9D%A2%E6%98%AF%E5%90%A6%E6%AD%A3%E9%A1%AF%E7%A4%BA%E8%91%97-6981f3b746f4" data-href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E9%A1%AF%E7%A4%BA-alert-%E5%89%8D%E6%AA%A2%E6%9F%A5%E5%87%BA%E5%95%8F%E9%A1%8C%E7%9A%84%E9%A0%81%E9%9D%A2%E6%98%AF%E5%90%A6%E6%AD%A3%E9%A1%AF%E7%A4%BA%E8%91%97-6981f3b746f4" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E9%A1%AF%E7%A4%BA-alert-%E5%89%8D%E6%AA%A2%E6%9F%A5%E5%87%BA%E5%95%8F%E9%A1%8C%E7%9A%84%E9%A0%81%E9%9D%A2%E6%98%AF%E5%90%A6%E6%AD%A3%E9%A1%AF%E7%A4%BA%E8%91%97-6981f3b746f4"><strong class="markup--strong markup--mixtapeEmbed-strong">顯示 alert 前檢查出問題的頁面是否正顯示著</strong><br><em class="markup--em markup--mixtapeEmbed-em">開發 iOS App 時，我們時常使用 alert 顯示錯誤訊息，比方網路資料抓不到時顯示 alert 告訴使用者網路連線有問題。</em>medium.com</a><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E9%A1%AF%E7%A4%BA-alert-%E5%89%8D%E6%AA%A2%E6%9F%A5%E5%87%BA%E5%95%8F%E9%A1%8C%E7%9A%84%E9%A0%81%E9%9D%A2%E6%98%AF%E5%90%A6%E6%AD%A3%E9%A1%AF%E7%A4%BA%E8%91%97-6981f3b746f4" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="d5b03d323abe7fb2c925a4b72d3abdce" data-thumbnail-img-id="1*_sv5jeNhoaucu9hjpEzvVQ.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*_sv5jeNhoaucu9hjpEzvVQ.png);"></a></div><h4 name="3618" id="3618" class="graf graf--h4 graf-after--mixtapeEmbed">搭配第三方套件</h4><p name="072b" id="072b" class="graf graf--p graf-after--h4">當我們使用第三方套件時，有些 function 必須傳入最後一個被 present 的 view controller，如此它才能 present 新的頁面。</p><p name="2c92" id="2c92" class="graf graf--p graf-after--p graf--trailing">比方顯示 Google AdMob 的全螢幕廣告時，我們必須從 GADInterstitialAd 呼叫 present(fromRootViewController:)，參數 fromRootViewController 即可利用剛剛定義的 UIViewController.getLastPresentedViewController() 傳入。</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@apppeterpan" class="p-author h-card">彼得潘的 iOS App Neverland</a> on <a href="https://medium.com/p/e48e73818f84"><time class="dt-published" datetime="2021-05-22T15:33:43.958Z">May 22, 2021</time></a>.</p><p><a href="https://medium.com/@apppeterpan/%E5%8F%96%E5%BE%97-app-%E6%9C%80%E5%BE%8C%E4%B8%80%E5%80%8B%E8%A2%AB-present-%E7%9A%84-view-controller-e48e73818f84" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on November 16, 2025.</p></footer></article></body></html>