<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>利用 debounce 優化 search 時發送的 request</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">利用 debounce 優化 search 時發送的 request</h1>
</header>
<section data-field="subtitle" class="p-summary">
當我們在 iOS App 搜尋資料時，常見的設計是每打一個字就更新搜尋的結果，比方下圖的 TV App。
</section>
<section data-field="body" class="e-content">
<section name="d314" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="2474" id="2474" class="graf graf--h3 graf--leading graf--title">利用 debounce 優化 search 時發送的 request</h3><p name="aab3" id="aab3" class="graf graf--p graf-after--h3">當我們在 iOS App 搜尋資料時，常見的設計是每打一個字就更新搜尋的結果，比方下圖的 TV App。</p><figure name="70ab" id="70ab" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*dY1a5Z-fDcoW5y338dS9tQ.png" data-width="1125" data-height="2436" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*dY1a5Z-fDcoW5y338dS9tQ.png"></figure><p name="3cf8" id="3cf8" class="graf graf--p graf-after--figure">這樣的 search 功能一般可透過 UISearchController 實現。當使用者在 search bar 輸入文字時，將觸發 function updateSearchResults，因此我們可在其中發送 request 抓取新的資料。</p><pre name="fd60" id="fd60" class="graf graf--pre graf-after--p">class ItemTableViewController: UITableViewController {<br>    let searchController = UISearchController()<br>    var items = [StoreItem]()<br>    <br>    func fetchItems(term: String) {<br>        let urlStr = &quot;<a href="https://itunes.apple.com/search?term=%5C%28term%29&amp;media=music" data-href="https://itunes.apple.com/search?term=\(term)&amp;media=music" class="markup--anchor markup--pre-anchor" rel="nofollow noopener" target="_blank">https://itunes.apple.com/search?term=\(term)&amp;media=music</a>&quot;<br>        if let url = URL(string: urlStr) {<br>            URLSession.shared.dataTask(with: url) { data, response , error in<br>                if let data = data {<br>                    let decoder = JSONDecoder()<br>                    do {<br>                        let searchResponse = try decoder.decode(SearchResponse.self, from: data)<br>                        self.items = searchResponse.results<br>                        DispatchQueue.main.async {<br>                            self.tableView.reloadData()<br>                        }<br>                    } catch {<br>                        print(error)<br>                    }<br>                }<br>            }.resume()<br>        }<br>    }<br>    <br>    <br>    override func viewDidLoad() {<br>        super.viewDidLoad()<br>        <br>        searchController.searchResultsUpdater = self<br>        navigationItem.searchController = searchController<br>    }<br>        <br>    // MARK: - Table view data source<br>    <br>    <br>    override func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -&gt; Int {<br>        return items.count<br>    }<br>    <br>    <br>    override func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -&gt; UITableViewCell {<br>        let cell = tableView.dequeueReusableCell(withIdentifier: &quot;ItemCell&quot;, for: indexPath)<br>        let item = items[indexPath.row]<br>        cell.textLabel?.text = item.trackName<br>        return cell<br>    }<br>    <br>    <br>    <br>}</pre><pre name="7689" id="7689" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">extension ItemTableViewController: UISearchResultsUpdating {<br>    <br>    func updateSearchResults(for searchController: UISearchController) {<br>        if let searchText = searchController.searchBar.text,<br>           searchText.isEmpty == false {<br>            fetchItems(term: searchText)<br>        }<br>    }    <br>}</strong></pre></div><div class="section-inner sectionLayout--outsetRow" data-paragraph-count="2"><figure name="b6b7" id="b6b7" class="graf graf--figure graf--layoutOutsetRow is-partialWidth graf-after--pre" style="width: 50%;"><img class="graf-image" data-image-id="1*2xX-UCt4FwSrtZ-GWOh0ZA.png" data-width="1170" data-height="2532" src="https://cdn-images-1.medium.com/max/600/1*2xX-UCt4FwSrtZ-GWOh0ZA.png"></figure><figure name="d89c" id="d89c" class="graf graf--figure graf--layoutOutsetRowContinue is-partialWidth graf-after--figure" style="width: 50%;"><img class="graf-image" data-image-id="1*a-BrYH6XAEbsH1tgOPKBUw.png" data-width="1170" data-height="2532" src="https://cdn-images-1.medium.com/max/600/1*a-BrYH6XAEbsH1tgOPKBUw.png"></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="6174" id="6174" class="graf graf--p graf-after--figure">不過當使用者有一指神功，打字飛快時，此做法卻會有小小的缺點。</p><p name="5dcf" id="5dcf" class="graf graf--p graf-after--p">當使用者在短時間輸入文字，比方輸入 Lov 時，我們將發送三個 request，依序抓取 L，Lo，Lov 的歌單。如果不想發送那麼多 request，可以考慮採用 debounce 技巧進行優化。</p><h3 name="8acf" id="8acf" class="graf graf--h3 graf-after--p">什麼是 debounce</h3><p name="c94c" id="c94c" class="graf graf--p graf-after--h3">它指的是某事件發生時，觸發的程式將等待一段時間才執行。比方按紐按下時，經過 0.3 秒才觸發程式執行。若在 0.3 秒內再度按下按紐，則會重新計算時間，取消之前預計觸發的程式。</p><p name="9934" id="9934" class="graf graf--p graf-after--p">剛剛 search 發送大量 request 的問題可運用 debounce 技巧修正。讓我們用以下例子說明。</p><figure name="1a69" id="1a69" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*JtwiLVP3T2Lg0DgKpfqLZQ.png" data-width="1098" data-height="716" src="https://cdn-images-1.medium.com/max/800/1*JtwiLVP3T2Lg0DgKpfqLZQ.png"></figure><ul class="postList"><li name="f75c" id="f75c" class="graf graf--li graf-after--figure">假設等待時間為 0.3 秒，當使用者在 8:0:0 秒輸入 L 時，預計 8:0:0.3 秒發送 request，查詢 L 的歌單。</li><li name="c2d5" id="c2d5" class="graf graf--li graf-after--li">使用者在 8:0:0.1 秒輸入 o，之前查詢 L 歌單的 request 被取消，預計 8:0:0.4 秒發送 request，查詢 Lo 的歌單。</li><li name="003a" id="003a" class="graf graf--li graf-after--li">使用者在 8:0:0.2 秒輸入 v，之前查詢 Lo 歌單的 request 被取消，預計 8:0:0.5 秒發送 request，查詢 Lov 的歌單。</li><li name="3c7f" id="3c7f" class="graf graf--li graf-after--li">使用者在 8:0:0.6 秒輸入 e，預計 8:0:0.9 秒發送 request，查詢 Love 的歌單。</li></ul><p name="3c6a" id="3c6a" class="graf graf--p graf-after--li">運用 debounce 的技巧，我們大幅減少發送的 request。使用者輸入了 love 四個字，我們卻只須發送 2 個 request。</p><p name="30f3" id="30f3" class="graf graf--p graf-after--p">Swift 實現 debounce 的方法很多，Combine framework 裡就內建了 debounce 相關的 function。不過就算沒有 Combine，我們還是可以透過以下兩個方法實現 debounce。</p><h3 name="49b7" id="49b7" class="graf graf--h3 graf-after--p">使用 function cancelPreviousPerformRequests &amp; perform 實現 debounce</h3><p name="df87" id="df87" class="graf graf--p graf-after--h3">呼叫 cancelPreviousPerformRequests 移除之前 perform(_:with:afterDelay:) 預約觸發的 function，然後呼叫 perform(_:with:afterDelay:)，在 0.3 秒後觸發 search。</p><pre name="f942" id="f942" class="graf graf--pre graf-after--p">extension ItemTableViewController: UISearchResultsUpdating {<br>    <br>    func updateSearchResults(for searchController: UISearchController) {<br>        if let searchText = searchController.searchBar.text,<br>           searchText.isEmpty == false {            <br>　　　　　　　<strong class="markup--strong markup--pre-strong">NSObject.cancelPreviousPerformRequests(withTarget: self)<br>            perform(#selector(search), with: nil, afterDelay: 0.3)</strong><br>        }<br>    }<br>}</pre><pre name="23d6" id="23d6" class="graf graf--pre graf-after--pre">class ItemTableViewController: UITableViewController {<br>    let searchController = UISearchController()<br>    var items = [StoreItem]()<br>    <br>    <a href="http://twitter.com/objc" data-href="http://twitter.com/objc" class="markup--anchor markup--pre-anchor" title="Twitter profile for @objc" rel="noopener" target="_blank">@objc</a> func search() {<br>        fetchItems(term: searchController.searchBar.text ?? &quot;&quot;)<br>    }</pre><p name="d54e" id="d54e" class="graf graf--p graf-after--pre">結果:</p><p name="a257" id="a257" class="graf graf--p graf-after--p">參考下圖輸入 Love，最後只會發出 2 個 request 的請求。</p><figure name="21d1" id="21d1" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*JtwiLVP3T2Lg0DgKpfqLZQ.png" data-width="1098" data-height="716" src="https://cdn-images-1.medium.com/max/800/1*JtwiLVP3T2Lg0DgKpfqLZQ.png"></figure><figure name="fa9d" id="fa9d" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*CI9tOCK6A-4Y7nztc25E9Q.png" data-width="1492" data-height="494" src="https://cdn-images-1.medium.com/max/800/1*CI9tOCK6A-4Y7nztc25E9Q.png"></figure><p name="16ca" id="16ca" class="graf graf--p graf-after--figure">ps: 移除時也可呼叫 cancelPreviousPerformRequests(withTarget:selector:object:)，此 function 可指定要移除的對象，相關說明可參考以下連結。</p><div name="6e49" id="6e49" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://developer.apple.com/documentation/objectivec/nsobject/1410849-cancelpreviousperformrequests" data-href="https://developer.apple.com/documentation/objectivec/nsobject/1410849-cancelpreviousperformrequests" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://developer.apple.com/documentation/objectivec/nsobject/1410849-cancelpreviousperformrequests"><strong class="markup--strong markup--mixtapeEmbed-strong">Apple Developer Documentation</strong><br><em class="markup--em markup--mixtapeEmbed-em">Edit description</em>developer.apple.com</a><a href="https://developer.apple.com/documentation/objectivec/nsobject/1410849-cancelpreviousperformrequests" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="73e0bb3814ca834bfef8db105154200f"></a></div><h3 name="6f26" id="6f26" class="graf graf--h3 graf-after--mixtapeEmbed">使用 Timer 實現 debounce</h3><p name="daf0" id="daf0" class="graf graf--p graf-after--h3">呼叫 timer 的 invalidate 移除之前預約觸發的 timer，然後呼叫 scheduledTimer，在 0.3 秒後觸發 timer。</p><pre name="d363" id="d363" class="graf graf--pre graf-after--p">extension ItemTableViewController: UISearchResultsUpdating {<br>    <br>    func updateSearchResults(for searchController: UISearchController) {<br>        if let searchText = searchController.searchBar.text,<br>           searchText.isEmpty == false {<br>            <strong class="markup--strong markup--pre-strong">timer?.invalidate()<br>            timer = nil<br>            timer = Timer.scheduledTimer(withTimeInterval: 0.3, repeats: false) {[weak self] _ in<br>                guard let self = self else { return }<br>                self.fetchItems(term: searchText)<br>            }</strong><br>        }<br>    }<br>}</pre><pre name="ceed" id="ceed" class="graf graf--pre graf-after--pre graf--trailing">class ItemTableViewController: UITableViewController {<br>    var timer: Timer?</pre></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@apppeterpan" class="p-author h-card">彼得潘的 iOS App Neverland</a> on <a href="https://medium.com/p/783dc4261f27"><time class="dt-published" datetime="2021-08-20T09:53:43.007Z">August 20, 2021</time></a>.</p><p><a href="https://medium.com/@apppeterpan/%E5%88%A9%E7%94%A8-debounce-%E5%84%AA%E5%8C%96-search-%E6%99%82%E7%99%BC%E9%80%81%E7%9A%84-request-783dc4261f27" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on November 16, 2025.</p></footer></article></body></html>