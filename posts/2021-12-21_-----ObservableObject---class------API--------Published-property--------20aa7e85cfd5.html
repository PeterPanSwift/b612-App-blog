<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>定義遵從 ObservableObject 的 class 串接網路 API 抓資料，利用 Published property 觸發畫面更新</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">定義遵從 ObservableObject 的 class 串接網路 API 抓資料，利用 Published property 觸發畫面更新</h1>
</header>
<section data-field="subtitle" class="p-summary">
開發 SwiftUI App 時，串接網路 API 抓資料然後更新 UI 畫面有很多寫法。接下來彼得潘將模仿 Apple 範例 Meme Creator 的寫法串接 iTunes Search API。
</section>
<section data-field="body" class="e-content">
<section name="9db7" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="aa7f" id="aa7f" class="graf graf--h3 graf--leading graf--title">定義遵從 ObservableObject 的 class 串接網路 API 抓資料，利用 Published property 觸發畫面更新</h3><p name="0c54" id="0c54" class="graf graf--p graf-after--h3">開發 SwiftUI App 時，串接網路 API 抓資料然後更新 UI 畫面有很多寫法。接下來彼得潘將模仿 Apple 範例 Meme Creator 的寫法串接 iTunes Search API。</p><p name="0f77" id="0f77" class="graf graf--p graf-after--p">Apple 的範例主要有以下兩個重點:</p><ul class="postList"><li name="633b" id="633b" class="graf graf--li graf-after--p">定義遵從 ObservableObject 的 class 抓資料，利用 Published property 觸發畫面更新。</li><li name="95f8" id="95f8" class="graf graf--li graf-after--li">宣告 EnvironmentObject 儲存 ObservableObject，當 ObservableObject 裡的 Published property 改變時觸發畫面更新 。</li></ul><h3 name="8fd9" id="8fd9" class="graf graf--h3 graf-after--li">模仿 Apple 範例串接 iTunes Search API</h3><ul class="postList"><li name="3e13" id="3e13" class="graf graf--li graf-after--h3"><strong class="markup--strong markup--li-strong">定義 JSON 對應的資料型別。</strong></li></ul><p name="452a" id="452a" class="graf graf--p graf-after--li">StoreItem.swift</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="3579" id="3579" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">import</span> Foundation<br /><br /><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SearchResponse</span>: <span class="hljs-title class_">Codable</span> {<br />    <span class="hljs-keyword">let</span> results: [<span class="hljs-type">StoreItem</span>]<br />}<br /><br /><span class="hljs-keyword">struct</span> <span class="hljs-title class_">StoreItem</span>: <span class="hljs-title class_">Codable</span>, <span class="hljs-title class_">Identifiable</span> {<br />    <span class="hljs-keyword">var</span> id: <span class="hljs-type">Int</span> { trackId }<br />    <span class="hljs-keyword">let</span> trackId: <span class="hljs-type">Int</span><br />    <span class="hljs-keyword">let</span> trackName: <span class="hljs-type">String</span><br />    <span class="hljs-keyword">let</span> artistName: <span class="hljs-type">String</span><br />}</span></pre><ul class="postList"><li name="41a7" id="41a7" class="graf graf--li graf-after--pre"><strong class="markup--strong markup--li-strong">定義顯示歌曲的 row。</strong></li></ul><p name="6b5e" id="6b5e" class="graf graf--p graf-after--li">ItemRow.swift</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="2556" id="2556" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">import</span> SwiftUI<br /><br /><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ItemRow</span>: <span class="hljs-title class_">View</span> {<br />    <span class="hljs-keyword">let</span> item: <span class="hljs-type">StoreItem</span><br />    <br />    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {<br />        <span class="hljs-type">VStack</span>(alignment: .leading) {<br />            <span class="hljs-type">Text</span>(item.trackName)<br />            <span class="hljs-type">Text</span>(item.artistName)<br />        }<br />    }<br />}<br /><br /><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ItemRow_Previews</span>: <span class="hljs-title class_">PreviewProvider</span> {<br />    <span class="hljs-keyword">static</span> <span class="hljs-keyword">var</span> previews: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {<br />        <span class="hljs-type">ItemRow</span>(item: <span class="hljs-type">StoreItem</span>(trackId: <span class="hljs-number">100</span>, trackName: <span class="hljs-string">&quot;有一天我會&quot;</span>, artistName: <span class="hljs-string">&quot;蔡淳佳&quot;</span>))<br />    }<br />}</span></pre><ul class="postList"><li name="6447" id="6447" class="graf graf--li graf-after--pre"><strong class="markup--strong markup--li-strong">定義遵從 ObservableObject 的 class 抓資料，利用 Published property 觸發畫面更新。</strong></li></ul><p name="052e" id="052e" class="graf graf--p graf-after--li">以下分成 await/async &amp; completion handler 兩種做法。</p><p name="d3c1" id="d3c1" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">1 使用 await/async (iOS 15 以上)。</strong></p><p name="3925" id="3925" class="graf graf--p graf-after--p">ItunesDataFetcher.swift</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="748e" id="748e" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">import</span> Foundation<br /><br /><span class="hljs-keyword">class</span> <span class="hljs-title class_">ItunesDataFetcher</span>: <span class="hljs-title class_">ObservableObject</span> {<br />    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> items <span class="hljs-operator">=</span> [<span class="hljs-type">StoreItem</span>]()<br />    <br />    <span class="hljs-keyword">enum</span> <span class="hljs-title class_">FetchError</span>: <span class="hljs-title class_">Error</span> {<br />        <span class="hljs-keyword">case</span> invalidURL<br />        <span class="hljs-keyword">case</span> badRequest<br />    }<br />    <br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params">term</span>: <span class="hljs-type">String</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> {<br />        <span class="hljs-keyword">let</span> urlString <span class="hljs-operator">=</span> <span class="hljs-string">&quot;https://itunes.apple.com/search?term=<span class="hljs-subst">\(term)</span>&amp;media=music&amp;country=tw&quot;</span><br />        <br />        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> urlString <span class="hljs-operator">=</span> urlString.addingPercentEncoding(withAllowedCharacters: .urlQueryAllowed),<br />              <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: urlString) <span class="hljs-keyword">else</span> {<br />                  <span class="hljs-keyword">throw</span> <span class="hljs-type">FetchError</span>.invalidURL<br />        }<br />        <span class="hljs-keyword">let</span> (data, response) <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">URLSession</span>.shared.data(from: url)<br />        <span class="hljs-keyword">guard</span> (response <span class="hljs-keyword">as?</span> <span class="hljs-type">HTTPURLResponse</span>)<span class="hljs-operator">?</span>.statusCode <span class="hljs-operator">==</span> <span class="hljs-number">200</span> <span class="hljs-keyword">else</span> { <span class="hljs-keyword">throw</span> <span class="hljs-type">FetchError</span>.badRequest }<br />        <span class="hljs-keyword">let</span> searchResponse <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-type">JSONDecoder</span>().decode(<span class="hljs-type">SearchResponse</span>.<span class="hljs-keyword">self</span>, from: data)<br />        <span class="hljs-type">Task</span> { <span class="hljs-meta">@MainActor</span> <span class="hljs-keyword">in</span><br />            items <span class="hljs-operator">=</span> searchResponse.results<br />        }<br />    }<br />}</span></pre><p name="77eb" id="77eb" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">說明</strong></p><p name="6270" id="6270" class="graf graf--p graf-after--p">定義遵從 ObservableObject 的 class ItunesDataFetcher 抓資料。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="2f01" id="2f01" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ItunesDataFetcher</span>: <span class="hljs-title class_">ObservableObject</span></span></pre><p name="1782" id="1782" class="graf graf--p graf-after--pre">定義 function fetchData 抓資料，搭配 async，抓資料失敗時會丟出錯誤。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="1989" id="1989" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params">term</span>: <span class="hljs-type">String</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span></span></pre><p name="225e" id="225e" class="graf graf--p graf-after--pre">fetchData 抓到資料後存入 @Published property，觸發 UI 畫面更新。值得注意的，更新 UI 畫面必須在 main thread 執行，而 URLSession.shared.data 會在背景抓到資料，因此我們利用 Task 的 closure 加上 @MainActor，確保程式在 main thread 發佈 items 的改變和更新 UI。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="ef37" id="ef37" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-type">Task</span> { <span class="hljs-meta">@MainActor</span> <span class="hljs-keyword">in</span><br />   items <span class="hljs-operator">=</span> searchResponse.results<br />}</span></pre><p name="d0d7" id="d0d7" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">2 使用 completion handler (iOS 15 之前的版本)。</strong></p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="fe8d" id="fe8d" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">import</span> Foundation<br /><br /><span class="hljs-keyword">class</span> <span class="hljs-title class_">ItunesDataFetcher</span>: <span class="hljs-title class_">ObservableObject</span> {<br />    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> items <span class="hljs-operator">=</span> [<span class="hljs-type">StoreItem</span>]()<br />    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> showError <span class="hljs-operator">=</span> <span class="hljs-literal">false</span><br /><br />    <span class="hljs-keyword">var</span> error: <span class="hljs-type">Error</span>? {<br />        <span class="hljs-keyword">willSet</span> {<br />            <span class="hljs-type">DispatchQueue</span>.main.async {<br />                <span class="hljs-keyword">self</span>.showError <span class="hljs-operator">=</span> newValue <span class="hljs-operator">!=</span> <span class="hljs-literal">nil</span><br />            }<br />        }<br />    }<br /><br />    <span class="hljs-keyword">enum</span> <span class="hljs-title class_">FetchError</span>: <span class="hljs-title class_">Error</span> {<br />        <span class="hljs-keyword">case</span> invalidURL<br />    }<br />    <br />    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params">term</span>: <span class="hljs-type">String</span>) {<br />        <span class="hljs-keyword">let</span> urlString <span class="hljs-operator">=</span> <span class="hljs-string">&quot;https://itunes.apple.com/search?term=<span class="hljs-subst">\(term)</span>&amp;media=music&amp;country=tw&quot;</span><br />        <br />        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> urlString <span class="hljs-operator">=</span> urlString.addingPercentEncoding(withAllowedCharacters: .urlQueryAllowed),<br />              <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: urlString) <span class="hljs-keyword">else</span> {<br />                  error <span class="hljs-operator">=</span> <span class="hljs-type">FetchError</span>.invalidURL<br />                  <span class="hljs-keyword">return</span><br />        }<br />        <br />        <span class="hljs-type">URLSession</span>.shared.dataTask(with: url) { data, response, error  <span class="hljs-keyword">in</span><br />            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> data {<br />                <span class="hljs-keyword">do</span> {<br />                    <span class="hljs-keyword">let</span> searchResponse <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-type">JSONDecoder</span>().decode(<span class="hljs-type">SearchResponse</span>.<span class="hljs-keyword">self</span>, from: data)<br />                    <span class="hljs-type">DispatchQueue</span>.main.async {<br />                        <span class="hljs-keyword">self</span>.items <span class="hljs-operator">=</span> searchResponse.results<br />                        <span class="hljs-keyword">self</span>.error <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span><br />                    }<br />                } <span class="hljs-keyword">catch</span>  {<br />                    <span class="hljs-keyword">self</span>.error <span class="hljs-operator">=</span> error<br />                }<br />            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> error {<br />                <span class="hljs-keyword">self</span>.error <span class="hljs-operator">=</span> error<br />            }<br />        }.resume()<br />        <br />    }<br />}</span></pre><p name="7ff0" id="7ff0" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">說明</strong></p><p name="c0cc" id="c0cc" class="graf graf--p graf-after--p">定義遵從 ObservableObject 的 class ItunesDataFetcher 抓資料。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="d2f7" id="d2f7" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ItunesDataFetcher</span>: <span class="hljs-title class_">ObservableObject</span></span></pre><p name="8fc8" id="8fc8" class="graf graf--p graf-after--pre">定義 function fetchData 抓資料。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="4ec6" id="4ec6" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params">term</span>: <span class="hljs-type">String</span>)</span></pre><p name="2a05" id="2a05" class="graf graf--p graf-after--pre">fetchData 抓到資料後存入 @Published property，觸發 UI 畫面更新。值得注意的，更新 UI 畫面必須在 main thread 執行，而 URLSession.shared.dataTask 會在背景抓到資料，因此我們利用 <code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">DispatchQueue.main.async</strong></code> 確保程式在 main thread 發佈 items 的改變和更新 UI。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="59a3" id="59a3" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-type">DispatchQueue</span>.main.async {<br />    <span class="hljs-keyword">self</span>.items <span class="hljs-operator">=</span> searchResponse.results<br />    <span class="hljs-keyword">self</span>.error <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span><br />}</span></pre><p name="d60d" id="d60d" class="graf graf--p graf-after--pre">fetchData 抓資料失敗時將錯誤存入 error，並將 showError 設為 true，觸發 UI 畫面顯示錯誤。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="7423" id="7423" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">var</span> error: <span class="hljs-type">Error</span>? {<br />        <span class="hljs-keyword">willSet</span> {<br />            <span class="hljs-type">DispatchQueue</span>.main.async {<br />                <span class="hljs-keyword">self</span>.showError <span class="hljs-operator">=</span> newValue <span class="hljs-operator">!=</span> <span class="hljs-literal">nil</span><br />            }<br />        }<br />}</span></pre><ul class="postList"><li name="0ff8" id="0ff8" class="graf graf--li graf-after--pre"><strong class="markup--strong markup--li-strong">呼叫 environmentObject 儲存 ObservableObject fetcher。</strong></li></ul><p name="9083" id="9083" class="graf graf--p graf-after--li">在 struct App 裡產生 fetcher，儲存於 <a href="http://twitter.com/StateObject" data-href="http://twitter.com/StateObject" class="markup--anchor markup--p-anchor" title="Twitter profile for @StateObject" rel="noopener" target="_blank">@</a>StateObject property， 然後呼叫 modifier environmentObject 儲存 fetcher。ItemList 是待會我們即將定義的歌單頁面。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="177a" id="177a" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">import</span> SwiftUI<br /><br /><span class="hljs-keyword">@main</span><br /><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ItunesApiAsyncApp</span>: <span class="hljs-title class_">App</span> {<br />    <span class="hljs-meta">@StateObject</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> fetcher <span class="hljs-operator">=</span> <span class="hljs-type">ItunesDataFetcher</span>()<br /><br />    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">Scene</span> {<br />        <span class="hljs-type">WindowGroup</span> {<br />            <span class="hljs-type">ItemList</span>()<br />                .environmentObject(fetcher)<br />        }<br />    }<br />}</span></pre><ul class="postList"><li name="0a33" id="0a33" class="graf graf--li graf-after--pre"><strong class="markup--strong markup--li-strong">宣告 EnvironmentObject 存取 ObservableObject，當 ObservableObject 的 Published property 改變時觸發畫面更新。</strong></li></ul><p name="62b9" id="62b9" class="graf graf--p graf-after--li">以下分成 await/async &amp; completion handler 兩種做法。</p><p name="34ff" id="34ff" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">1 使用 await/async (iOS 15 以上)。</strong></p><p name="fb77" id="fb77" class="graf graf--p graf-after--p">ItemList.swift</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="bf00" id="bf00" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">import</span> SwiftUI<br /><br /><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ItemList</span>: <span class="hljs-title class_">View</span> {<br />    <span class="hljs-meta">@EnvironmentObject</span> <span class="hljs-keyword">var</span> fetcher: <span class="hljs-type">ItunesDataFetcher</span><br />    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> showError <span class="hljs-operator">=</span> <span class="hljs-literal">false</span><br />    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> error: <span class="hljs-type">Error</span>?<br /><br />    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {<br />        <span class="hljs-type">List</span> {<br />            <span class="hljs-type">ForEach</span>(fetcher.items) { item <span class="hljs-keyword">in</span><br />                <span class="hljs-type">ItemRow</span>(item: item)<br />            }<br />        }<br />        .task {<br />            <span class="hljs-keyword">if</span> fetcher.items.isEmpty {<br />                <span class="hljs-keyword">do</span> {<br />                    <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> fetcher.fetchData(term: <span class="hljs-string">&quot;張智霖&quot;</span>)<br />                } <span class="hljs-keyword">catch</span> {<br />                    <span class="hljs-keyword">self</span>.error <span class="hljs-operator">=</span> error<br />                    showError <span class="hljs-operator">=</span> <span class="hljs-literal">true</span><br />                }<br />            }<br />        }<br />        .alert(error<span class="hljs-operator">?</span>.localizedDescription <span class="hljs-operator">??</span> <span class="hljs-string">&quot;&quot;</span>, isPresented: <span class="hljs-variable">$showError</span>, actions: {<br />        })<br />    }<br />}</span></pre><p name="c178" id="c178" class="graf graf--p graf-after--pre">說明</p><p name="4fd2" id="4fd2" class="graf graf--p graf-after--p">將抓資料的物件宣告為 @EnvironmentObject property fetcher。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="6af6" id="6af6" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-meta">@EnvironmentObject</span> <span class="hljs-keyword">var</span> fetcher: <span class="hljs-type">ItunesDataFetcher</span></span></pre><p name="fcd5" id="fcd5" class="graf graf--p graf-after--pre">在畫面出現時呼叫 fetchData 抓資料。modifier task 參數的 closure 程式將在畫面出現時執行。由於使用 await 呼叫 fetchData，因此我們必須將程式寫在 task { } 裡。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="1bd3" id="1bd3" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">.task {<br />    <span class="hljs-keyword">if</span> fetcher.items.isEmpty {<br />       <span class="hljs-keyword">do</span> {<br />          <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> fetcher.fetchData(term: <span class="hljs-string">&quot;張智霖&quot;</span>)<br />       } <span class="hljs-keyword">catch</span> {<br />          <span class="hljs-keyword">self</span>.error <span class="hljs-operator">=</span> error<br />          showError <span class="hljs-operator">=</span> <span class="hljs-literal">true</span><br />       }<br />    }<br />}</span></pre><p name="50a6" id="50a6" class="graf graf--p graf-after--pre">抓資料失敗時顯示 alert。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="c7b3" id="c7b3" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">.alert(error<span class="hljs-operator">?</span>.localizedDescription <span class="hljs-operator">??</span> <span class="hljs-string">&quot;&quot;</span>, isPresented: <span class="hljs-variable">$showError</span>, actions: {<br />})</span></pre><p name="7c93" id="7c93" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">2 使用 completion handler (iOS 15 之前的版本)。</strong></p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="eaa3" id="eaa3" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">import</span> SwiftUI<br /><br /><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ItemList</span>: <span class="hljs-title class_">View</span> {<br />    <span class="hljs-meta">@EnvironmentObject</span> <span class="hljs-keyword">var</span> fetcher: <span class="hljs-type">ItunesDataFetcher</span><br />    <br />    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {<br />        <span class="hljs-type">List</span> {<br />            <span class="hljs-type">ForEach</span>(fetcher.items) { item <span class="hljs-keyword">in</span><br />                <span class="hljs-type">ItemRow</span>(item: item)<br />            }<br />        }<br />        .alert(fetcher.error<span class="hljs-operator">?</span>.localizedDescription <span class="hljs-operator">??</span> <span class="hljs-string">&quot;&quot;</span>, isPresented: <span class="hljs-variable">$fetcher</span>.showError, actions: {<br />        })<br />        .onAppear {<br />            <span class="hljs-keyword">if</span> fetcher.items.isEmpty {<br />                fetcher.fetchData(term: <span class="hljs-string">&quot;張智霖&quot;</span>)<br />            }<br />        }<br />    }<br />}</span></pre><p name="9097" id="9097" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">說明</strong></p><p name="44c1" id="44c1" class="graf graf--p graf-after--p">將抓資料的物件宣告為 @EnvironmentObject property fetcher。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="3fa0" id="3fa0" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-meta">@EnvironmentObject</span> <span class="hljs-keyword">var</span> fetcher: <span class="hljs-type">ItunesDataFetcher</span></span></pre><p name="4121" id="4121" class="graf graf--p graf-after--pre">在畫面出現時呼叫 fetchData 抓資料。modifier onAppear 參數的 closure 程式將在畫面出現時執行。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="7951" id="7951" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">.onAppear {<br />     <span class="hljs-keyword">if</span> fetcher.items.isEmpty {<br />         fetcher.fetchData(term: <span class="hljs-string">&quot;張智霖&quot;</span>)<br />     }<br />}</span></pre><h3 name="873a" id="873a" class="graf graf--h3 graf-after--pre">抓到資料前顯示資料下載中</h3><p name="7728" id="7728" class="graf graf--p graf-after--h3">使用 ProgressView。</p><h3 name="ca23" id="ca23" class="graf graf--h3 graf-after--p">範例下載連結</h3><ul class="postList"><li name="3dd1" id="3dd1" class="graf graf--li graf-after--h3">iTunes API (async/await, iOS 15 以上)</li></ul><div name="5a90" id="5a90" class="graf graf--mixtapeEmbed graf-after--li"><a href="https://github.com/AppPeterPan/ItunesApiAsync" data-href="https://github.com/AppPeterPan/ItunesApiAsync" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://github.com/AppPeterPan/ItunesApiAsync"><strong class="markup--strong markup--mixtapeEmbed-strong">GitHub - AppPeterPan/ItunesApiAsync</strong><br><em class="markup--em markup--mixtapeEmbed-em">You can&#39;t perform that action at this time. You signed in with another tab or window. You signed out in another tab or…</em>github.com</a><a href="https://github.com/AppPeterPan/ItunesApiAsync" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="f35e0be1f817e1630e7e74e93097711a" data-thumbnail-img-id="0*gQkNT-0ES55UV9ZE" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*gQkNT-0ES55UV9ZE);"></a></div><ul class="postList"><li name="82be" id="82be" class="graf graf--li graf-after--mixtapeEmbed">iTunes API (completion handler, iOS 15 以上)</li></ul><div name="39ea" id="39ea" class="graf graf--mixtapeEmbed graf-after--li"><a href="https://github.com/AppPeterPan/ItunesApiCompletionHandler" data-href="https://github.com/AppPeterPan/ItunesApiCompletionHandler" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://github.com/AppPeterPan/ItunesApiCompletionHandler"><strong class="markup--strong markup--mixtapeEmbed-strong">GitHub - AppPeterPan/ItunesApiCompletionHandler</strong><br><em class="markup--em markup--mixtapeEmbed-em">You can&#39;t perform that action at this time. You signed in with another tab or window. You signed out in another tab or…</em>github.com</a><a href="https://github.com/AppPeterPan/ItunesApiCompletionHandler" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="431d0370ea7b8777809a795322f78cf7" data-thumbnail-img-id="0*ylgSxd127zDtQiRN" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*ylgSxd127zDtQiRN);"></a></div><ul class="postList"><li name="9e9c" id="9e9c" class="graf graf--li graf-after--mixtapeEmbed">iTunes API (completion handler, iOS 14)</li></ul><div name="fc8c" id="fc8c" class="graf graf--mixtapeEmbed graf-after--li"><a href="https://github.com/AppPeterPan/ItunesApiCompletionHandlerForiOS14" data-href="https://github.com/AppPeterPan/ItunesApiCompletionHandlerForiOS14" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://github.com/AppPeterPan/ItunesApiCompletionHandlerForiOS14"><strong class="markup--strong markup--mixtapeEmbed-strong">GitHub - AppPeterPan/ItunesApiCompletionHandlerForiOS14</strong><br><em class="markup--em markup--mixtapeEmbed-em">You can&#39;t perform that action at this time. You signed in with another tab or window. You signed out in another tab or…</em>github.com</a><a href="https://github.com/AppPeterPan/ItunesApiCompletionHandlerForiOS14" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="673c5cd6d59626c7d4d89e53660f750f" data-thumbnail-img-id="0*hyr9Jx_iI05x4zih" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*hyr9Jx_iI05x4zih);"></a></div><h3 name="c454" id="c454" class="graf graf--h3 graf-after--mixtapeEmbed">參考連結</h3><p name="5c7a" id="5c7a" class="graf graf--p graf-after--h3">Apple 官方範例: Meme Creator。</p><div name="3bfe" id="3bfe" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://developer.apple.com/tutorials/sample-apps/memecreator" data-href="https://developer.apple.com/tutorials/sample-apps/memecreator" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://developer.apple.com/tutorials/sample-apps/memecreator"><strong class="markup--strong markup--mixtapeEmbed-strong">Apple Developer Documentation</strong><br><em class="markup--em markup--mixtapeEmbed-em">Edit description</em>developer.apple.com</a><a href="https://developer.apple.com/tutorials/sample-apps/memecreator" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="618671ac07b6baa2c8595ddabec0f5ae"></a></div><figure name="2f48" id="2f48" class="graf graf--figure graf-after--mixtapeEmbed"><img class="graf-image" data-image-id="1*SETQEG6SR-tuSddaGzWg3g.png" data-width="1254" data-height="1308" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*SETQEG6SR-tuSddaGzWg3g.png"></figure><p name="4de3" id="4de3" class="graf graf--p graf-after--figure">Apple 範例採用 async/await ，若想參考 completion handler 的寫法，可參考以下連結。</p><div name="5c96" id="5c96" class="graf graf--mixtapeEmbed graf-after--p graf--trailing"><a href="https://github.com/AppPeterPan/Meme-Creator-completion-handler-.swiftpm" data-href="https://github.com/AppPeterPan/Meme-Creator-completion-handler-.swiftpm" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://github.com/AppPeterPan/Meme-Creator-completion-handler-.swiftpm"><strong class="markup--strong markup--mixtapeEmbed-strong">GitHub - AppPeterPan/Meme-Creator-completion-handler-.swiftpm</strong><br><em class="markup--em markup--mixtapeEmbed-em">Fetch structured data from a server asynchronously. Welcome to the Meme Creator app, where you&#39;ll learn to fetch data…</em>github.com</a><a href="https://github.com/AppPeterPan/Meme-Creator-completion-handler-.swiftpm" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="c417c5ab9fe29546daa11f3368b69d32" data-thumbnail-img-id="0*m3EDJNphLD0fVUU_" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*m3EDJNphLD0fVUU_);"></a></div></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@apppeterpan" class="p-author h-card">彼得潘的 iOS App Neverland</a> on <a href="https://medium.com/p/20aa7e85cfd5"><time class="dt-published" datetime="2021-12-21T17:08:40.474Z">December 21, 2021</time></a>.</p><p><a href="https://medium.com/@apppeterpan/%E5%AE%9A%E7%BE%A9%E9%81%B5%E5%BE%9E-observableobject-%E7%9A%84-class-%E4%B8%B2%E6%8E%A5%E7%B6%B2%E8%B7%AF-api-%E6%8A%93%E8%B3%87%E6%96%99-%E5%88%A9%E7%94%A8-published-property-%E8%A7%B8%E7%99%BC%E7%95%AB%E9%9D%A2%E6%9B%B4%E6%96%B0-20aa7e85cfd5" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on September 17, 2025.</p></footer></article></body></html>