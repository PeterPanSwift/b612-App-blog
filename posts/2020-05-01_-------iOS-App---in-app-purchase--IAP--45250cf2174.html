<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>從零開始開發 iOS App 的 in app purchase (IAP)</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">從零開始開發 iOS App 的 in app purchase (IAP)</h1>
</header>
<section data-field="subtitle" class="p-summary">
in app purchase(IAP) 是 iOS App 一個很重要的功能，尤其當我們想靠 App 賺錢時，先用免費 App 吸引使用者下載，再讓他愛上 App 後瘋狂地透過 IAP 消費是許多熱門 App 賺錢的手段，就像為了傳可愛的 LINE…
</section>
<section data-field="body" class="e-content">
<section name="2b06" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="6a89" id="6a89" class="graf graf--h3 graf--leading graf--title">從零開始開發 iOS App 的 in app purchase (IAP)</h3><p name="a01d" id="a01d" class="graf graf--p graf-after--h3">in app purchase(IAP) 是 iOS App 一個很重要的功能，尤其當我們想靠 App 賺錢時，先用免費 App 吸引使用者下載，再讓他愛上 App 後瘋狂地透過 IAP 消費是許多熱門 App 賺錢的手段，就像為了傳可愛的 LINE 貼圖給暗戀的女生，我們時常花錢買 LINE 虛擬金幣。</p></div><div class="section-inner sectionLayout--outsetRow" data-paragraph-count="3"><figure name="ccbf" id="ccbf" class="graf graf--figure graf--layoutOutsetRow is-partialWidth graf-after--p" style="width: 33.333%;"><img class="graf-image" data-image-id="1*f0RnjXQ-GB_vlGjjZxmpZg.png" data-width="1125" data-height="2436" src="https://cdn-images-1.medium.com/max/400/1*f0RnjXQ-GB_vlGjjZxmpZg.png"></figure><figure name="2569" id="2569" class="graf graf--figure graf--layoutOutsetRowContinue is-partialWidth graf-after--figure" style="width: 33.333%;"><img class="graf-image" data-image-id="1*L4A0CariiUH1NaGwiPv2ig.png" data-width="1125" data-height="2436" src="https://cdn-images-1.medium.com/max/400/1*L4A0CariiUH1NaGwiPv2ig.png"></figure><figure name="bb5f" id="bb5f" class="graf graf--figure graf--layoutOutsetRowContinue is-partialWidth graf-after--figure" style="width: 33.333%;"><img class="graf-image" data-image-id="1*yHRY3UiwzaPHPW2iUfJ2hw.png" data-width="1125" data-height="2436" src="https://cdn-images-1.medium.com/max/400/1*yHRY3UiwzaPHPW2iUfJ2hw.png"></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="4b54" id="4b54" class="graf graf--p graf-after--figure">接下來我們將從零開始，一步步打造具有 IAP 功能的 App，包含寫程式前的準備 &amp; 程式撰寫兩個階段。</p><figure name="de06" id="de06" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*KwHnIWwBhg0CUkanV5xGgQ.jpeg" data-width="1400" data-height="1078" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*KwHnIWwBhg0CUkanV5xGgQ.jpeg"></figure><p name="340a" id="340a" class="graf graf--p graf-after--figure"><a href="https://help.apple.com/app-store-connect/#/devb57be10e7" data-href="https://help.apple.com/app-store-connect/#/devb57be10e7" class="markup--anchor markup--p-anchor" rel="nofollow noopener noopener" target="_blank">https://help.apple.com/app-store-connect/#/devb57be10e7</a></p><p name="ae3a" id="ae3a" class="graf graf--p graf-after--p">既然是寫 Swift 程式，就讓我們販售 Taylor Swift 好聽的音樂吧，我們希望能販售以下三種商品，使用者可購買單曲 love story &amp; only the young，也可以購買一小時聆聽任何音樂的時間。</p><figure name="a5df" id="a5df" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*U5Ko3fubINhRqfFyl3nceA.jpeg" data-width="1194" data-height="374" src="https://cdn-images-1.medium.com/max/800/1*U5Ko3fubINhRqfFyl3nceA.jpeg"></figure><h3 name="5a0f" id="5a0f" class="graf graf--h3 graf-after--figure">寫程式前的準備</h3><h3 name="78d9" id="78d9" class="graf graf--h3 graf-after--h3">設定 App 的<strong class="markup--strong markup--h3-strong">銀行帳戶資訊(</strong>bank info)</h3><p name="86ad" id="86ad" class="graf graf--p graf-after--h3">選擇 <strong class="markup--strong markup--p-strong">Agreements, Tax, and Banking</strong>。</p><figure name="1b31" id="1b31" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*NXqbXSVBDEOryTH-P8FpLw.jpeg" data-width="2202" data-height="1222" src="https://cdn-images-1.medium.com/max/800/1*NXqbXSVBDEOryTH-P8FpLw.jpeg"></figure><p name="c21e" id="c21e" class="graf graf--p graf-after--figure">讓 Paid Apps 的狀態是 <strong class="markup--strong markup--p-strong">Active</strong>。</p><figure name="3473" id="3473" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*kk5lwP5_Sq8jmZy-H1BHFw.jpeg" data-width="2174" data-height="660" src="https://cdn-images-1.medium.com/max/800/1*kk5lwP5_Sq8jmZy-H1BHFw.jpeg"></figure><div name="369e" id="369e" class="graf graf--mixtapeEmbed graf-after--figure"><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E4%B8%8A%E6%9E%B6%E4%BB%98%E8%B2%BB-ios-app-%E9%9C%80%E8%A6%81%E7%9A%84%E9%8A%80%E8%A1%8C%E5%B8%B3%E6%88%B6%E8%A8%AD%E5%AE%9A-1e88e9ab85b8" data-href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E4%B8%8A%E6%9E%B6%E4%BB%98%E8%B2%BB-ios-app-%E9%9C%80%E8%A6%81%E7%9A%84%E9%8A%80%E8%A1%8C%E5%B8%B3%E6%88%B6%E8%A8%AD%E5%AE%9A-1e88e9ab85b8" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E4%B8%8A%E6%9E%B6%E4%BB%98%E8%B2%BB-ios-app-%E9%9C%80%E8%A6%81%E7%9A%84%E9%8A%80%E8%A1%8C%E5%B8%B3%E6%88%B6%E8%A8%AD%E5%AE%9A-1e88e9ab85b8"><strong class="markup--strong markup--mixtapeEmbed-strong">上架付費 iOS App 需要的銀行帳戶設定</strong><br><em class="markup--em markup--mixtapeEmbed-em">想銷售付費 App，記得要到 App Store Connect 的協議、稅務與銀行業務頁面，設定銀行帳戶，如此未來 App 賺了大錢，Apple 才能將錢匯到我們的銀行帳戶，實現 30 歲退休的夢想。</em>medium.com</a><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E4%B8%8A%E6%9E%B6%E4%BB%98%E8%B2%BB-ios-app-%E9%9C%80%E8%A6%81%E7%9A%84%E9%8A%80%E8%A1%8C%E5%B8%B3%E6%88%B6%E8%A8%AD%E5%AE%9A-1e88e9ab85b8" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="9b5d6a60483e70389f742b404f4dab3b" data-thumbnail-img-id="1*8v14iC2OAIF9y9Hq9XSZKA.jpeg" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*8v14iC2OAIF9y9Hq9XSZKA.jpeg);"></a></div><h3 name="5dfa" id="5dfa" class="graf graf--h3 graf-after--mixtapeEmbed">建立專案，切換到專案的 Signing &amp; Capabilties 頁面</h3><figure name="e001" id="e001" class="graf graf--figure graf-after--h3"><img class="graf-image" data-image-id="1*D6MMpltWTxOCGTp47Tm1WQ.jpeg" data-width="1412" data-height="394" src="https://cdn-images-1.medium.com/max/800/1*D6MMpltWTxOCGTp47Tm1WQ.jpeg"></figure><h3 name="94b0" id="94b0" class="graf graf--h3 graf-after--figure">在 Team 欄位選擇付費的 App 開發帳號</h3><p name="88f4" id="88f4" class="graf graf--p graf-after--h3">只有付費的 App 開發帳號可以開發 IAP 功能。</p><figure name="fe0a" id="fe0a" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*ywq9qUpchxn3njR-hkswZQ.jpeg" data-width="1170" data-height="546" src="https://cdn-images-1.medium.com/max/800/1*ywq9qUpchxn3njR-hkswZQ.jpeg"></figure><h3 name="389e" id="389e" class="graf graf--h3 graf-after--figure">點選 + Capability</h3><figure name="7b90" id="7b90" class="graf graf--figure graf-after--h3"><img class="graf-image" data-image-id="1*HZ2INfPMorW6T_IF0kYoqw.jpeg" data-width="1412" data-height="394" src="https://cdn-images-1.medium.com/max/800/1*HZ2INfPMorW6T_IF0kYoqw.jpeg"></figure><h3 name="fefc" id="fefc" class="graf graf--h3 graf-after--figure">加入 In-App Purchase</h3><figure name="806e" id="806e" class="graf graf--figure graf-after--h3"><img class="graf-image" data-image-id="1*iUPoq-Q5v2hbQfiLuF3qUg.jpeg" data-width="1718" data-height="678" src="https://cdn-images-1.medium.com/max/800/1*iUPoq-Q5v2hbQfiLuF3qUg.jpeg"></figure><figure name="a34f" id="a34f" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*1eXhIjDK89QuFaPEGE8YWA.jpeg" data-width="2010" data-height="680" src="https://cdn-images-1.medium.com/max/800/1*1eXhIjDK89QuFaPEGE8YWA.jpeg"></figure><p name="20c2" id="20c2" class="graf graf--p graf-after--figure">此時 Xcode 將自動幫我們生成包含 IAP 功能的 App ID。點選 Provisioning Profile 旁的 i 可看到 App ID 為 com.peter.IAPDemo。</p><figure name="48ca" id="48ca" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*m_cRbIbAn52tn9i661rw6w.jpeg" data-width="1362" data-height="788" src="https://cdn-images-1.medium.com/max/800/1*m_cRbIbAn52tn9i661rw6w.jpeg"></figure><p name="d520" id="d520" class="graf graf--p graf-after--figure">從 Apple 開發網站的 Certificates, Identifiers &amp; Profiles 頁面也可看到剛剛生成的 App ID。</p><div name="2adf" id="2adf" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://developer.apple.com" data-href="https://developer.apple.com" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://developer.apple.com"><strong class="markup--strong markup--mixtapeEmbed-strong">Apple Developer</strong><br><em class="markup--em markup--mixtapeEmbed-em">There&#39;s never been a better time to develop for Apple Platforms.</em>developer.apple.com</a><a href="https://developer.apple.com" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="a2d2c6f008dee64f2192a54470d41ba4" data-thumbnail-img-id="0*15eA1h6Fb6y-yViJ" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*15eA1h6Fb6y-yViJ);"></a></div><figure name="bc1c" id="bc1c" class="graf graf--figure graf-after--mixtapeEmbed"><img class="graf-image" data-image-id="1*4ITJSDulUlbWl4inbLacSg.jpeg" data-width="1770" data-height="1162" src="https://cdn-images-1.medium.com/max/800/1*4ITJSDulUlbWl4inbLacSg.jpeg"></figure><h3 name="78b9" id="78b9" class="graf graf--h3 graf-after--figure">在 App Store Connect 建立 App</h3><p name="3bc9" id="3bc9" class="graf graf--p graf-after--h3"><a href="https://appstoreconnect.apple.com" data-href="https://appstoreconnect.apple.com" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://appstoreconnect.apple.com</a></p><p name="82cf" id="82cf" class="graf graf--p graf-after--p">點選 My Apps。</p><figure name="8cfe" id="8cfe" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*1ARiwtxfZ13edh6pJdHy0A.jpeg" data-width="1742" data-height="1244" src="https://cdn-images-1.medium.com/max/800/1*1ARiwtxfZ13edh6pJdHy0A.jpeg"></figure><p name="e072" id="e072" class="graf graf--p graf-after--figure">點選 + &gt; New App 建立 App。</p><figure name="c001" id="c001" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*cx0v172FkR-DprZAwTlI_A.jpeg" data-width="600" data-height="400" src="https://cdn-images-1.medium.com/max/800/1*cx0v172FkR-DprZAwTlI_A.jpeg"></figure><p name="e92c" id="e92c" class="graf graf--p graf-after--figure">設定 App 資訊，Bundle ID 選擇剛剛 Xcode 專案的 Bundle ID。</p><figure name="967a" id="967a" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*yDbh7C8OOX-RU3LHXZIGmg.jpeg" data-width="1090" data-height="1138" src="https://cdn-images-1.medium.com/max/800/1*yDbh7C8OOX-RU3LHXZIGmg.jpeg"></figure><h3 name="ef05" id="ef05" class="graf graf--h3 graf-after--figure">建立 App 後，切換到 Features 頁面</h3><figure name="273b" id="273b" class="graf graf--figure graf-after--h3"><img class="graf-image" data-image-id="1*MdVIR9izifl4JLFdhxvOwg.jpeg" data-width="2508" data-height="1166" src="https://cdn-images-1.medium.com/max/800/1*MdVIR9izifl4JLFdhxvOwg.jpeg"></figure><h3 name="ff13" id="ff13" class="graf graf--h3 graf-after--figure">點選 + 新增 IAP 販售的商品</h3><figure name="af29" id="af29" class="graf graf--figure graf-after--h3"><img class="graf-image" data-image-id="1*kBx-0eyyOBzh_z3kzG_8Ig.jpeg" data-width="2004" data-height="916" src="https://cdn-images-1.medium.com/max/800/1*kBx-0eyyOBzh_z3kzG_8Ig.jpeg"></figure><h3 name="0c51" id="0c51" class="graf graf--h3 graf-after--figure">IAP 可販售的四種商品</h3><figure name="86bf" id="86bf" class="graf graf--figure graf-after--h3"><img class="graf-image" data-image-id="1*jKgAcBZiBNqM3RqYLlS8Pg.jpeg" data-width="1398" data-height="1160" src="https://cdn-images-1.medium.com/max/800/1*jKgAcBZiBNqM3RqYLlS8Pg.jpeg"></figure><ul class="postList"><li name="4a0c" id="4a0c" class="graf graf--li graf-after--figure"><strong class="markup--strong markup--li-strong">Consumable(消耗的)</strong></li></ul><p name="8c3e" id="8c3e" class="graf graf--p graf-after--li">可重覆購買的項目，比方 LINE 的虛擬金幣，養魚 App 的魚飼料等。</p><ul class="postList"><li name="9462" id="9462" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">Non-Consumable(不可消耗的)</strong></li></ul><p name="bfd3" id="bfd3" class="graf graf--p graf-after--li">不可重覆購買的項目，比方購買 Taylor Swift 的單曲 love story。買一次就可終生享用，之後交新女友換新 iPhone 時可免費下載 love story，不用再買一次。</p><ul class="postList"><li name="31c8" id="31c8" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">Auto-Renewable Subscription(自動訂閱)</strong></li></ul><p name="1d30" id="1d30" class="graf graf--p graf-after--li">依時間收費，比方每個月 $90，下個月到期時會自動續約扣款。(不過使用者自己也可另外取消自動訂閱)</p></div><div class="section-inner sectionLayout--outsetRow" data-paragraph-count="2"><figure name="0f46" id="0f46" class="graf graf--figure graf--layoutOutsetRow is-partialWidth graf-after--p" style="width: 50%;"><img class="graf-image" data-image-id="1*-WVjBlW_vHWXKi7DDDHlNg.png" data-width="1125" data-height="2436" src="https://cdn-images-1.medium.com/max/600/1*-WVjBlW_vHWXKi7DDDHlNg.png"></figure><figure name="1c18" id="1c18" class="graf graf--figure graf--layoutOutsetRowContinue is-partialWidth graf-after--figure" style="width: 50%;"><img class="graf-image" data-image-id="1*iu4N0tV6P16dDMeK8Qvwww.png" data-width="1125" data-height="2436" src="https://cdn-images-1.medium.com/max/600/1*iu4N0tV6P16dDMeK8Qvwww.png"></figure></div><div class="section-inner sectionLayout--insetColumn"><ul class="postList"><li name="e94f" id="e94f" class="graf graf--li graf-after--figure"><strong class="markup--strong markup--li-strong">Non-Renewing Subscription(非自動訂閱)</strong></li></ul><p name="c916" id="c916" class="graf graf--p graf-after--li">依時間收費，跟 Auto-Renewable Subscription 的差別在於它不會自動訂閱。</p><p name="f2c8" id="f2c8" class="graf graf--p graf-after--p">前面提到我們的 App 想要販售以下商品:</p><ul class="postList"><li name="ccd3" id="ccd3" class="graf graf--li graf-after--p">2 首 Taylor Swift 的歌，屬於 Non-Consumable 商品。</li><li name="c148" id="c148" class="graf graf--li graf-after--li">聆聽任何音樂一小時，屬於 Consumable 商品。</li></ul><h3 name="c04a" id="c04a" class="graf graf--h3 graf-after--li">點選 Non-Consumable</h3><p name="3844" id="3844" class="graf graf--p graf-after--h3">點選 Non-Consumable 新增 Taylor Swift 的 love story。</p><figure name="3dc0" id="3dc0" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*O-Y_QA8P_u6v4x-IL0OAaA.jpeg" data-width="1408" data-height="1152" src="https://cdn-images-1.medium.com/max/800/1*O-Y_QA8P_u6v4x-IL0OAaA.jpeg"></figure><figure name="d003" id="d003" class="graf graf--figure graf--iframe graf-after--figure"><iframe src="https://www.youtube.com/embed/8xg3vE8Ie_E?feature=oembed" width="700" height="393" frameborder="0" scrolling="no"></iframe></figure><h3 name="65f2" id="65f2" class="graf graf--h3 graf-after--figure">輸入商品資訊</h3><p name="7c0e" id="7c0e" class="graf graf--p graf-after--h3">輸入 love story 的相關資訊，最重要的是 Product ID，到時候我們的程式將以此 ID 連到 Apple 後台取得商品資訊。</p><figure name="9c62" id="9c62" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*9Zoz3hVBZXyCWJHx8r7x5A.jpeg" data-width="2034" data-height="940" src="https://cdn-images-1.medium.com/max/800/1*9Zoz3hVBZXyCWJHx8r7x5A.jpeg"></figure><p name="4a93" id="4a93" class="graf graf--p graf-after--figure">App Store Information 欄位填寫的是使用者看到的資訊。</p><figure name="f55f" id="f55f" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*aAw-3tSTNnryrGwlbQCUGQ.jpeg" data-width="2008" data-height="652" src="https://cdn-images-1.medium.com/max/800/1*aAw-3tSTNnryrGwlbQCUGQ.jpeg"></figure><p name="9e8e" id="9e8e" class="graf graf--p graf-after--figure">比方下圖使用者購買時，Apple 的購買視窗顯示我們設定的 Display Name 愛的故事。</p><figure name="fc63" id="fc63" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*xvYsTYQyNgJ4flHUiPU6Og.png" data-width="1125" data-height="2436" src="https://cdn-images-1.medium.com/max/800/1*xvYsTYQyNgJ4flHUiPU6Og.png"></figure><p name="5723" id="5723" class="graf graf--p graf-after--figure">我們也可點選 <strong class="markup--strong markup--p-strong">Localizations</strong> 旁的 + 新增英文，日文，法文等其它語言，吸引外國的消費者購買。</p><figure name="b746" id="b746" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*IQ2TBafErZCgDHRLyTLKZw.jpeg" data-width="572" data-height="582" src="https://cdn-images-1.medium.com/max/800/1*IQ2TBafErZCgDHRLyTLKZw.jpeg"></figure><p name="19d3" id="19d3" class="graf graf--p graf-after--figure">最下方的 <strong class="markup--strong markup--p-strong">Review Information</strong> 可等之後 App 準備上架或給 TestFlight 使用者測試時再填寫，它不影響我們待會開發和測試 IAP 功能。</p><figure name="09a2" id="09a2" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*wk9tP7snED4HdC5-G4n2JQ.jpeg" data-width="2000" data-height="632" src="https://cdn-images-1.medium.com/max/800/1*wk9tP7snED4HdC5-G4n2JQ.jpeg"></figure><p name="7529" id="7529" class="graf graf--p graf-after--figure">點選右上角的 Save 後，love story 成功出現在 IAP 的商品列表。</p><figure name="a780" id="a780" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*px8tw1nS5SAJnz0GC2ff1Q.jpeg" data-width="2006" data-height="150" src="https://cdn-images-1.medium.com/max/800/1*px8tw1nS5SAJnz0GC2ff1Q.jpeg"></figure><figure name="ee20" id="ee20" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*gst6e6YuFdUDkW9Bz3OFqw.jpeg" data-width="2016" data-height="868" src="https://cdn-images-1.medium.com/max/800/1*gst6e6YuFdUDkW9Bz3OFqw.jpeg"></figure><p name="aadd" id="aadd" class="graf graf--p graf-after--figure">新增 Taylor Swift 另一首歌 only the young 的 IAP，選擇 Non-Consumable。</p><figure name="fe24" id="fe24" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*mOADB9ZNjQH0WV7w7GUHZw.jpeg" data-width="2044" data-height="916" src="https://cdn-images-1.medium.com/max/800/1*mOADB9ZNjQH0WV7w7GUHZw.jpeg"></figure><figure name="a6a4" id="a6a4" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*ptCT-fxHOHbpTrNO2ltkUA.jpeg" data-width="1988" data-height="652" src="https://cdn-images-1.medium.com/max/800/1*ptCT-fxHOHbpTrNO2ltkUA.jpeg"></figure><figure name="6af7" id="6af7" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*wAelA5eZELrQWJcYYINBQA.jpeg" data-width="1996" data-height="912" src="https://cdn-images-1.medium.com/max/800/1*wAelA5eZELrQWJcYYINBQA.jpeg"></figure><h3 name="5818" id="5818" class="graf graf--h3 graf-after--figure">點選 Consumable</h3><p name="b72c" id="b72c" class="graf graf--p graf-after--h3">點選 Consumable， 新增可聆聽任何音樂一小時的商品。</p><figure name="869a" id="869a" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*CtYTki9U5bqSXFQGk7d99A.jpeg" data-width="1384" data-height="1140" src="https://cdn-images-1.medium.com/max/800/1*CtYTki9U5bqSXFQGk7d99A.jpeg"></figure><figure name="95bb" id="95bb" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*akFvLTKVYN_eQgFuxQK9gA.jpeg" data-width="2028" data-height="974" src="https://cdn-images-1.medium.com/max/800/1*akFvLTKVYN_eQgFuxQK9gA.jpeg"></figure><figure name="60b8" id="60b8" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*J7BD2EM1NE-w5Sn2Sxh6Ag.jpeg" data-width="2002" data-height="538" src="https://cdn-images-1.medium.com/max/800/1*J7BD2EM1NE-w5Sn2Sxh6Ag.jpeg"></figure><p name="4fae" id="4fae" class="graf graf--p graf-after--figure">成功建立後，目前我們的 IAP 有三個商品。</p><figure name="1ddf" id="1ddf" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*OJDQmy5jt_PVh-dSbG_G5Q.jpeg" data-width="2026" data-height="488" src="https://cdn-images-1.medium.com/max/800/1*OJDQmy5jt_PVh-dSbG_G5Q.jpeg"></figure><h3 name="9a3a" id="9a3a" class="graf graf--h3 graf-after--figure">新增 Sandbox 的 test user</h3><p name="972a" id="972a" class="graf graf--p graf-after--h3">為了免費測試 IAP，不用真的花錢，我們有以下兩種方法:</p><ul class="postList"><li name="8877" id="8877" class="graf graf--li graf-after--p">TestFlight 的測試者可搭配正式的 Apple ID 免費購買。</li><li name="49fe" id="49fe" class="graf graf--li graf-after--li">從 Xcode 安裝 App 到手機，然後搭配 Sandbox 的 test user 測試。</li></ul><p name="f46a" id="f46a" class="graf graf--p graf-after--li">測試的第一步通常是從 Xcode 安裝 App 到手機，所以我們先在 App Store Connect 網站建立 Sandbox 的 test user，方便待會測試。</p><div name="281a" id="281a" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E6%96%B0%E5%A2%9E-sandbox-%E7%9A%84-test-user-%E6%B8%AC%E8%A9%A6-in-app-purchase-689c097e451e" data-href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E6%96%B0%E5%A2%9E-sandbox-%E7%9A%84-test-user-%E6%B8%AC%E8%A9%A6-in-app-purchase-689c097e451e" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E6%96%B0%E5%A2%9E-sandbox-%E7%9A%84-test-user-%E6%B8%AC%E8%A9%A6-in-app-purchase-689c097e451e"><strong class="markup--strong markup--mixtapeEmbed-strong">新增 Sandbox 的 test user 測試 in app purchase</strong><br><em class="markup--em markup--mixtapeEmbed-em">開發 iOS App 的 in app purchase (IAP)功能時，我們希望能白吃白喝，測試 App 時不用真的付錢買東西。</em>medium.com</a><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E6%96%B0%E5%A2%9E-sandbox-%E7%9A%84-test-user-%E6%B8%AC%E8%A9%A6-in-app-purchase-689c097e451e" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="389843aa90173019970613a1201e01d6" data-thumbnail-img-id="1*pmeDnICQVGUHr1YGOhI20A.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*pmeDnICQVGUHr1YGOhI20A.png);"></a></div><p name="7382" id="7382" class="graf graf--p graf-after--mixtapeEmbed">值得注意的，test user 的國家最好選美國，選其它國家可能在測試 IAP 功能時會出現錯誤訊息 <code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">Cannot connect to iTunes Store</strong></code>。</p><figure name="72c7" id="72c7" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*hwjlDZCrnynirKPT5pzxdA.jpeg" data-width="1400" data-height="529" src="https://cdn-images-1.medium.com/max/800/1*hwjlDZCrnynirKPT5pzxdA.jpeg"></figure><h3 name="ce50" id="ce50" class="graf graf--h3 graf-after--figure">從 Settings App 登入測試帳號</h3><p name="7737" id="7737" class="graf graf--p graf-after--h3">測試 IAP 只能從實機測試，無法從模擬器。因此請先從實機的 Settings App 登入測試帳號，點選 Settings App 的 iTunes &amp; App Store &gt; SANDBOX ACCOUNT 下的 Sign In。</p><figure name="57bb" id="57bb" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*36xBYjAvrxG73JcQrXtGLA.png" data-width="1125" data-height="2436" src="https://cdn-images-1.medium.com/max/800/1*36xBYjAvrxG73JcQrXtGLA.png"></figure><figure name="b76d" id="b76d" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*h5Yrf174gAXoJm93r03Kbg.png" data-width="1125" data-height="2436" src="https://cdn-images-1.medium.com/max/800/1*h5Yrf174gAXoJm93r03Kbg.png"></figure><p name="3c1d" id="3c1d" class="graf graf--p graf-after--figure">測試帳號只影響 IAP 的測試，當我們在 iPhone 的正式 App 操作時，iOS 會聰明地使用我們正式的 Apple ID。</p><figure name="252c" id="252c" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*gIMEe0UtYjwgTeWsZ0bq-w.png" data-width="1125" data-height="2436" src="https://cdn-images-1.medium.com/max/800/1*gIMEe0UtYjwgTeWsZ0bq-w.png"></figure><p name="6beb" id="6beb" class="graf graf--p graf-after--figure">若之後想登入其它的測試帳號，也要從 Settings App 登出才能登入另一個帳號。</p><figure name="aa3e" id="aa3e" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*bqPJc1lH86WdCT87A73hlg.png" data-width="1125" data-height="2436" src="https://cdn-images-1.medium.com/max/800/1*bqPJc1lH86WdCT87A73hlg.png"></figure><h3 name="3d45" id="3d45" class="graf graf--h3 graf-after--figure">開始寫程式</h3><p name="7162" id="7162" class="graf graf--p graf-after--h3">經過有點漫長的準備後，終於可以進入我們比較喜歡的寫程式階段了。</p><div name="e75d" id="e75d" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://developer.apple.com/documentation/storekit/in-app_purchase" data-href="https://developer.apple.com/documentation/storekit/in-app_purchase" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://developer.apple.com/documentation/storekit/in-app_purchase"><strong class="markup--strong markup--mixtapeEmbed-strong">In-App Purchase</strong><br><em class="markup--em markup--mixtapeEmbed-em">In-App Purchase allows you to offer users the opportunity to purchase in-app content and features. Customers can make…</em>developer.apple.com</a><a href="https://developer.apple.com/documentation/storekit/in-app_purchase" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="266c318d40ef360f25200daa67c9fca8"></a></div><p name="d700" id="d700" class="graf graf--p graf-after--mixtapeEmbed">開發 IAP 功能的程式時，主要分為五個階段，以下我們將逐一介紹。</p><ul class="postList"><li name="cfcb" id="cfcb" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">取得商品的 product ID。</strong></li><li name="b424" id="b424" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">利用 product ID 連到 Apple 後台抓取商品資訊。</strong></li><li name="fccb" id="fccb" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">產生代表交易的 SKPayment 進行購買。</strong></li><li name="e819" id="e819" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">從 SKPaymentTransactionObserver 的 function 判斷交易的結果。</strong></li><li name="effb" id="effb" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">若交易成功則提供商品給使用者。</strong></li></ul><h3 name="241e" id="241e" class="graf graf--h3 graf-after--li">取得商品的 product ID</h3><div name="6af6" id="6af6" class="graf graf--mixtapeEmbed graf-after--h3"><a href="https://developer.apple.com/documentation/storekit/in-app_purchase/loading_in-app_product_identifiers" data-href="https://developer.apple.com/documentation/storekit/in-app_purchase/loading_in-app_product_identifiers" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://developer.apple.com/documentation/storekit/in-app_purchase/loading_in-app_product_identifiers"><strong class="markup--strong markup--mixtapeEmbed-strong">Loading In-App Product Identifiers</strong><br><em class="markup--em markup--mixtapeEmbed-em">Implementing an in-app purchase flow can be divided into three stages. In the first stage of the purchase process, your…</em>developer.apple.com</a><a href="https://developer.apple.com/documentation/storekit/in-app_purchase/loading_in-app_product_identifiers" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="e5ec5769b07d6b8f5c5446772c7522c8"></a></div><p name="f4f2" id="f4f2" class="graf graf--p graf-after--mixtapeEmbed">為了販賣商品，我們必須連到 Apple 的後台抓取商品清單。不過 Apple 只認得我們在 App Store Connect 網站設定的 Product ID，因此我們得用剛剛設定的三個 Product ID <code class="markup--code markup--p-code">com.peter.IAPDemo.lovestory，com.peter.IAPDemo.onlytheyoung，com.peter.IAPDemo.listenonehour </code>來跟 Apple 取得商品清單。</p><p name="9161" id="9161" class="graf graf--p graf-after--p">App 程式取得 Product ID 的方法有以下兩種:</p><ul class="postList"><li name="acf2" id="acf2" class="graf graf--li graf-after--p">讀取 App bundle 資料夾的檔案(比方 plist 檔)或寫死在程式裡。</li><li name="a0cb" id="a0cb" class="graf graf--li graf-after--li">連到自己的後台抓取包含 Product ID 的 JSON。</li></ul><p name="a2c5" id="a2c5" class="graf graf--p graf-after--li">待會為了方便測試，我們採用方法一，直接將 Product ID 存在 array。</p><pre name="200e" id="200e" class="graf graf--pre graf-after--p">func getProductIDs() -&gt; [String] {<br>        [&quot;com.peter.IAPDemo.lovestory&quot;, &quot;com.peter.IAPDemo.onlytheyoung&quot;, &quot;com.peter.IAPDemo.listenonehour&quot;]<br>}</pre><p name="3e69" id="3e69" class="graf graf--p graf-after--pre">不過此做法其實有缺點。因為之後 App 上架後，我們可從 App Store Connect 網站新增 IAP 商品，但此時程式的 Product ID 也要更新，才能抓取新的商品資訊。</p><p name="c709" id="c709" class="graf graf--p graf-after--p">因此較好的做法會是連到自己的後台，從後台抓取 JSON 取得 Product ID，這樣未來有新的商品要銷售時只要從 App Store Connect 網站新增 IAP 商品，App 完全不用做任何修改。</p><h3 name="1f4f" id="1f4f" class="graf graf--h3 graf-after--p">連到 Apple 後台抓取商品資訊</h3><div name="6447" id="6447" class="graf graf--mixtapeEmbed graf-after--h3"><a href="https://developer.apple.com/documentation/storekit/in-app_purchase/fetching_product_information_from_the_app_store" data-href="https://developer.apple.com/documentation/storekit/in-app_purchase/fetching_product_information_from_the_app_store" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://developer.apple.com/documentation/storekit/in-app_purchase/fetching_product_information_from_the_app_store"><strong class="markup--strong markup--mixtapeEmbed-strong">Fetching Product Information from the App Store</strong><br><em class="markup--em markup--mixtapeEmbed-em">To make sure your users see only products that are actually available for them to purchase, query the App Store before…</em>developer.apple.com</a><a href="https://developer.apple.com/documentation/storekit/in-app_purchase/fetching_product_information_from_the_app_store" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="8e14172c31ae8635a10dbd1793d10833"></a></div><pre name="7bfa" id="7bfa" class="graf graf--pre graf-after--mixtapeEmbed">import StoreKit</pre><pre name="8052" id="8052" class="graf graf--pre graf-after--pre">class IAPManager: NSObject {<br>    <br>    static let shared = IAPManager()<br>    var products = [SKProduct]()<br><strong class="markup--strong markup--pre-strong">    fileprivate var productRequest: SKProductsRequest!</strong></pre><pre name="c239" id="c239" class="graf graf--pre graf-after--pre">func getProductIDs() -&gt; [String] {<br>        [&quot;com.peter.IAPDemo.lovestory&quot;, &quot;com.peter.IAPDemo.onlytheyoung&quot;, &quot;com.peter.IAPDemo.listenonehour&quot;]<br>    }<br>    <br>    func <strong class="markup--strong markup--pre-strong">getProducts</strong>() {<br>        let productIds = getProductIDs()<br>        let productIdsSet = Set(productIds)<br>        productRequest = SKProductsRequest(productIdentifiers: productIdsSet)</pre><pre name="1953" id="1953" class="graf graf--pre graf-after--pre">        productRequest.delegate = self<br>        productRequest.start()<br>    }</pre><pre name="86b1" id="86b1" class="graf graf--pre graf-after--pre">}</pre><pre name="842f" id="842f" class="graf graf--pre graf-after--pre">extension IAPManager: SKProductsRequestDelegate {<br>    func productsRequest(_ request: SKProductsRequest, didReceive response: SKProductsResponse) {<br>        response.products.forEach {<br>            print($0.localizedTitle, $0.price, $0.localizedDescription)<br>        }<br>        self.products = response.products</pre><pre name="915f" id="915f" class="graf graf--pre graf-after--pre">    }<br>    <br>}</pre><p name="2ab1" id="2ab1" class="graf graf--p graf-after--pre">說明</p><pre name="abf1" id="abf1" class="graf graf--pre graf-after--p">import StoreKit</pre><p name="93ed" id="93ed" class="graf graf--p graf-after--pre">開發 IAP 功能須 import StoreKit。</p><pre name="5e41" id="5e41" class="graf graf--pre graf-after--p">class IAPManager: NSObject {</pre><p name="bf26" id="bf26" class="graf graf--p graf-after--pre">定義 IAPManager 實現 IAP 的相關功能。 由於取得商品資訊時會觸發 SKProductsRequestDelegate 的 function，因此 IAPManager 要遵從 protocol SKProductsRequestDelegate。不過我們還要繼承 NSObject，因為 SKProductsRequestDelegate 繼承 NSObjectProtocol，繼承 NSObject 可幫我們定義 NSObjectProtocol 的相關 function。</p><pre name="f9fc" id="f9fc" class="graf graf--pre graf-after--p">func getProducts() {<br>        let productIds = getProductIDs()<br>        let productIdsSet = Set(productIds)<br>        productRequest = SKProductsRequest(productIdentifiers: productIdsSet)<br>        productRequest.delegate = self<br>        productRequest.start()<br>}</pre><p name="2a23" id="2a23" class="graf graf--p graf-after--pre">利用 SKProductsRequest 連到 Apple 後台詢問商品資訊，將 IAPManager 自己設為 request 的 delegate，到時候得到商品資訊將觸發 delegate 的 function。以上程式有兩個值得注意的地方:</p><ul class="postList"><li name="8219" id="8219" class="graf graf--li graf-after--p">productRequest 宣告為 IAPManager 的 property，因為 Apple 提到系統可能在抓到商品資料前將 request 清掉，所以我們將它存在 IAPManager 的 property 比較保儉。</li></ul><pre name="40b4" id="40b4" class="graf graf--pre graf-after--li">Be sure to keep a strong reference to the products request object; the system may release it before the request completes.</pre><ul class="postList"><li name="e2ef" id="e2ef" class="graf graf--li graf-after--pre">參數 productIdentifiers 的型別是 Set，因此我們要將 array 變成 Set。</li></ul><figure name="923e" id="923e" class="graf graf--figure graf-after--li"><img class="graf-image" data-image-id="1*IVpLYS7m0KuAeqrNo1nOvg.jpeg" data-width="1462" data-height="130" src="https://cdn-images-1.medium.com/max/800/1*IVpLYS7m0KuAeqrNo1nOvg.jpeg"></figure><pre name="4ebc" id="4ebc" class="graf graf--pre graf-after--figure">extension IAPManager: SKProductsRequestDelegate {</pre><pre name="113a" id="113a" class="graf graf--pre graf-after--pre">    func productsRequest(_ request: SKProductsRequest, didReceive response: SKProductsResponse) {<br>        response.products.forEach {<br>            print($0.localizedTitle, $0.price, $0.localizedDescription)<br>        }<br>        self.products = response.products</pre><pre name="c5a0" id="c5a0" class="graf graf--pre graf-after--pre">    }<br>    <br>}</pre><p name="91d2" id="91d2" class="graf graf--p graf-after--pre">得到商品資訊時將觸發 productsRequest(_:didReceive:)，我們可從參數 response 的 products 取得商品的 array。array 裡的商品型別是 SKProduct，我們可從它的 property 讀取商品的相關資訊。</p><div name="06ac" id="06ac" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://developer.apple.com/documentation/storekit/skproduct" data-href="https://developer.apple.com/documentation/storekit/skproduct" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://developer.apple.com/documentation/storekit/skproduct"><strong class="markup--strong markup--mixtapeEmbed-strong">SKProduct</strong><br><em class="markup--em markup--mixtapeEmbed-em">Information about a product previously registered in App Store Connect.</em>developer.apple.com</a><a href="https://developer.apple.com/documentation/storekit/skproduct" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="89540c81564c7ea8be7cbc0a453c1df1"></a></div><p name="10b5" id="10b5" class="graf graf--p graf-after--mixtapeEmbed">抓取商品資訊也有可能失敗，我們可從 response 的 invalidProductIdentifiers 取得有問題的 id。</p><pre name="880e" id="880e" class="graf graf--pre graf-after--p">response.invalidProductIdentifiers</pre><p name="a98f" id="a98f" class="graf graf--p graf-after--pre">有興趣的朋友可進一步參考以下連結的說明。</p><div name="9e18" id="9e18" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://developer.apple.com/documentation/storekit/skproductsresponse/1505985-invalidproductidentifiers" data-href="https://developer.apple.com/documentation/storekit/skproductsresponse/1505985-invalidproductidentifiers" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://developer.apple.com/documentation/storekit/skproductsresponse/1505985-invalidproductidentifiers"><strong class="markup--strong markup--mixtapeEmbed-strong">invalidProductIdentifiers</strong><br><em class="markup--em markup--mixtapeEmbed-em">The App Store may not recognize your product identifiers unless you have met the following criteria, as applicable…</em>developer.apple.com</a><a href="https://developer.apple.com/documentation/storekit/skproductsresponse/1505985-invalidproductidentifiers" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="d3e3198897b50be0c918aeff80f70e8b"></a></div><h3 name="21d6" id="21d6" class="graf graf--h3 graf-after--mixtapeEmbed">測試 App: 取得商品資訊</h3><p name="119f" id="119f" class="graf graf--p graf-after--h3">利用以下程式取得商品資訊，測試 App 在實機執行的結果。( IAP 的購買功能只能在實機測試)</p><pre name="7848" id="7848" class="graf graf--pre graf-after--p">IAPManager.shared.getProducts()</pre><p name="1ed5" id="1ed5" class="graf graf--p graf-after--pre">以下為 App 執行後 Console 印出的三個 IAP 商品資訊。由於我們登入的測試帳號是美國帳號，所以金額顯示的單位為美金。</p><figure name="f153" id="f153" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*yaVisq94FkCvRirXfZItwg.jpeg" data-width="1018" data-height="296" src="https://cdn-images-1.medium.com/max/800/1*yaVisq94FkCvRirXfZItwg.jpeg"></figure><h3 name="3d97" id="3d97" class="graf graf--h3 graf-after--figure">顯示商品資訊，比方名稱，簡介和價錢</h3><p name="70b4" id="70b4" class="graf graf--p graf-after--h3">透過 Apple 回傳的商品資訊，我們可以設計類似以下的商城頁品誘惑使用者購買。</p><figure name="466a" id="466a" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*wxyUQ7T23nqezFXV1KiHzg.png" data-width="1125" data-height="2436" src="https://cdn-images-1.medium.com/max/800/1*wxyUQ7T23nqezFXV1KiHzg.png"><figcaption class="imageCaption">遊戲 Slidey App 的商城畫面</figcaption></figure><p name="8688" id="8688" class="graf graf--p graf-after--figure">在顯示商品資訊時，最麻煩的是語言問題，針對不同國家最好能顯示不同的語言和金額，比方美國顯示英文 &amp; 美金，台灣顯示中文和新台幣。</p><p name="adc6" id="adc6" class="graf graf--p graf-after--p">感謝 App Store Connect 網站提供多語言的 App Store Information 設定，因此我們可利用 SKProduct 的 localizedTitle &amp; localizedDescription 顯示使用者熟悉的語言。</p><p name="e84b" id="e84b" class="graf graf--p graf-after--p">那要如何顯示正確的金額呢 ? 難道要查詢匯率手動計算嗎 ? 別擔心，Apple 將依據使用者帳號所在的國家回傳正確的金額給我們，因此我們可利用以下 Apple 官方的範例程式產生金額字串。</p><pre name="9407" id="9407" class="graf graf--pre graf-after--p">extension SKProduct {<br>    var regularPrice: String? {<br>        let formatter = NumberFormatter()<br>        formatter.numberStyle = .currency<br>        formatter.locale = self.priceLocale<br>        return formatter.string(from: self.price)<br>    }<br>}</pre><div name="810c" id="810c" class="graf graf--mixtapeEmbed graf-after--pre"><a href="https://developer.apple.com/documentation/storekit/skproduct/1506094-price" data-href="https://developer.apple.com/documentation/storekit/skproduct/1506094-price" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://developer.apple.com/documentation/storekit/skproduct/1506094-price"><strong class="markup--strong markup--mixtapeEmbed-strong">price</strong><br><em class="markup--em markup--mixtapeEmbed-em">NSNumberFormatter *numberFormatter = [[NSNumberFormatter alloc] init]; [numberFormatter…</em>developer.apple.com</a><a href="https://developer.apple.com/documentation/storekit/skproduct/1506094-price" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="a3d1727e14a80768b5ce2ef9e0fe7cdc"></a></div><h3 name="e1b2" id="e1b2" class="graf graf--h3 graf-after--mixtapeEmbed">測試 App: 商品價錢</h3><p name="9f2b" id="9f2b" class="graf graf--p graf-after--h3">美國帳號顯示的金額</p><figure name="ca6a" id="ca6a" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*_fEFEdkbDA6bBa19Uj17tw.jpeg" data-width="1058" data-height="274" src="https://cdn-images-1.medium.com/max/800/1*_fEFEdkbDA6bBa19Uj17tw.jpeg"></figure><p name="d010" id="d010" class="graf graf--p graf-after--figure">台灣帳號顯示的金額</p><figure name="34f7" id="34f7" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*KRA9cHdANUJkqHitI1TekQ.jpeg" data-width="1048" data-height="272" src="https://cdn-images-1.medium.com/max/800/1*KRA9cHdANUJkqHitI1TekQ.jpeg"></figure><h3 name="e727" id="e727" class="graf graf--h3 graf-after--figure">產生代表交易的 SKPayment 進行購買</h3><div name="5c65" id="5c65" class="graf graf--mixtapeEmbed graf-after--h3"><a href="https://developer.apple.com/documentation/storekit/in-app_purchase/requesting_a_payment_from_the_app_store" data-href="https://developer.apple.com/documentation/storekit/in-app_purchase/requesting_a_payment_from_the_app_store" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://developer.apple.com/documentation/storekit/in-app_purchase/requesting_a_payment_from_the_app_store"><strong class="markup--strong markup--mixtapeEmbed-strong">Requesting a Payment from the App Store</strong><br><em class="markup--em markup--mixtapeEmbed-em">After you present your app&#39;s store UI, users can make purchases from within your app. When the user chooses a product…</em>developer.apple.com</a><a href="https://developer.apple.com/documentation/storekit/in-app_purchase/requesting_a_payment_from_the_app_store" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="2a10e55f9990328c1bcda18f278b908d"></a></div><p name="457b" id="457b" class="graf graf--p graf-after--mixtapeEmbed">購買商品的程式其實只有兩行，從 SKProduct 產生 SKPayment，然後將它加到 SKPaymentQueue 裡。</p><pre name="21a2" id="21a2" class="graf graf--pre graf-after--p">func buy(product: SKProduct) {<br>        if SKPaymentQueue.canMakePayments() {<br>            <strong class="markup--strong markup--pre-strong">let payment = SKPayment(product: product)<br>            SKPaymentQueue.default().add(payment)</strong><br>        } else {<br>            // show error <br>        }<br>}</pre><p name="11d2" id="11d2" class="graf graf--p graf-after--pre">值得注意的，使用者的 iPhone 有可能 IAP 功能被限制，比方父母將小孩 iPhone 的購買功能關閉，因此我們最好先用 <code class="markup--code markup--p-code">SKPaymentQueue.canMakePayments()</code> 檢查使用者是否可以買東西。</p><div name="77ad" id="77ad" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://support.apple.com/en-us/HT201304" data-href="https://support.apple.com/en-us/HT201304" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://support.apple.com/en-us/HT201304"><strong class="markup--strong markup--mixtapeEmbed-strong">Use parental controls on your child&#39;s iPhone, iPad, and iPod touch</strong><br><em class="markup--em markup--mixtapeEmbed-em">With Content &amp; Privacy Restrictions in Screen Time, you can block or limit specific apps and features on your child&#39;s…</em>support.apple.com</a><a href="https://support.apple.com/en-us/HT201304" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="98cc4c419838b9132f278761a28f5031" data-thumbnail-img-id="0*mjbeL5aoQKUXRgU0" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*mjbeL5aoQKUXRgU0);"></a></div><figure name="6f7e" id="6f7e" class="graf graf--figure graf-after--mixtapeEmbed"><img class="graf-image" data-image-id="1*bOlQYs4AJhcM1DVOoy46cA.jpeg" data-width="640" data-height="1286" src="https://cdn-images-1.medium.com/max/800/1*bOlQYs4AJhcM1DVOoy46cA.jpeg"></figure><p name="a14e" id="a14e" class="graf graf--p graf-after--figure">以上的程式已經能讓使用者購買商品，出現下圖的購買視窗，而且使用者已經可以成功購買。不過有個很重要的問題需要解決，我們必須知道購買是否成功。</p><figure name="f62c" id="f62c" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*g6rIUaBWcHXZUqJ8oad9yQ.png" data-width="1125" data-height="2436" src="https://cdn-images-1.medium.com/max/800/1*g6rIUaBWcHXZUqJ8oad9yQ.png"></figure><p name="8dbd" id="8dbd" class="graf graf--p graf-after--figure">ps: 我們也可生成 SKMutablePayment，設定它的 quantity 控制商品購買的數量。比方購買我們在 App Store Connect 建立的 Consumable 商品聆聽音樂一小時，quantity 設為 100 表示想一次購買 100 小時。</p><pre name="d121" id="d121" class="graf graf--pre graf-after--p">let payment = SKMutablePayment(product: product)<br>payment.quantity = 100</pre><h3 name="744d" id="744d" class="graf graf--h3 graf-after--pre">從 SKPaymentTransactionObserver 的 function 判斷交易的結果</h3><div name="a99c" id="a99c" class="graf graf--mixtapeEmbed graf-after--h3"><a href="https://developer.apple.com/documentation/storekit/in-app_purchase/processing_a_transaction" data-href="https://developer.apple.com/documentation/storekit/in-app_purchase/processing_a_transaction" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://developer.apple.com/documentation/storekit/in-app_purchase/processing_a_transaction"><strong class="markup--strong markup--mixtapeEmbed-strong">Processing a Transaction</strong><br><em class="markup--em markup--mixtapeEmbed-em">Implementing an in-app purchase flow can be divided into three stages. You first retrieve the product information, then…</em>developer.apple.com</a><a href="https://developer.apple.com/documentation/storekit/in-app_purchase/processing_a_transaction" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="b0c9a6b52a9e721b202347d8e7ef8c9a"></a></div><p name="33d6" id="33d6" class="graf graf--p graf-after--mixtapeEmbed">當交易成功，失敗或狀態改變時，它會觸發 protocol SKPaymentTransactionObserver 的 function。因此我們讓 IAPManager 遵從 protocol SKPaymentTransactionObserver，然後將 IAPManager 設為 SKPaymentQueue 的 observer，如此即可在交易狀態改變時收到通知。</p><ul class="postList"><li name="f0af" id="f0af" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">IAPManager 遵從 SKPaymentTransactionObserver，定義交易狀態改變時觸發的 function paymentQueue(_:updatedTransactions:)。</strong></li></ul><pre name="ad76" id="ad76" class="graf graf--pre graf-after--li">extension IAPManager: SKPaymentTransactionObserver {</pre><pre name="2630" id="2630" class="graf graf--pre graf-after--pre">    func paymentQueue(_ queue: SKPaymentQueue, updatedTransactions transactions: [SKPaymentTransaction]) {<br>        <br>        <br>    }<br>   <br>}</pre><ul class="postList"><li name="30c2" id="30c2" class="graf graf--li graf-after--pre"><strong class="markup--strong markup--li-strong">在 App 啟動時將 IAPManager 設為 SKPaymentQueue 的 observer。</strong></li></ul><p name="6a27" id="6a27" class="graf graf--p graf-after--li">使用者買東西時有可能突然沒有網路，造成交易無法順序完成。因此若我們在 App 啟動時將 IAPManager 設為 SKPaymentQueue 的 observer，下次使用者啟動 App 時 IAPManager 將可馬上收到通知，觸發 SKPaymentTransactionObserver 的 function，順利完成之前未完的交易。</p><pre name="8f5f" id="8f5f" class="graf graf--pre graf-after--p">import UIKit<br>import StoreKit</pre><pre name="f670" id="f670" class="graf graf--pre graf-after--pre"><a href="http://twitter.com/UIApplicationMain" data-href="http://twitter.com/UIApplicationMain" class="markup--anchor markup--pre-anchor" title="Twitter profile for @UIApplicationMain" rel="noopener" target="_blank">@UIApplicationMain</a><br>class AppDelegate: UIResponder, UIApplicationDelegate {</pre><pre name="bfae" id="bfae" class="graf graf--pre graf-after--pre">    func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -&gt; Bool {<br>        <br><strong class="markup--strong markup--pre-strong">        SKPaymentQueue.default().add(IAPManager.shared)</strong></pre><pre name="d451" id="d451" class="graf graf--pre graf-after--pre">        return true<br>    }</pre><ul class="postList"><li name="96b5" id="96b5" class="graf graf--li graf-after--pre"><strong class="markup--strong markup--li-strong">判斷交易的結果。</strong></li></ul><p name="5842" id="5842" class="graf graf--p graf-after--li">交易狀態改變時將觸發 function <code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">paymentQueue(_:updatedTransactions:)</strong></code>，我們可從參數 <code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">transactions</strong></code> 得知交易的結果。</p><pre name="d46b" id="d46b" class="graf graf--pre graf-after--p">extension IAPManager: SKPaymentTransactionObserver {<br>    func paymentQueue(_ queue: SKPaymentQueue, updatedTransactions transactions: [SKPaymentTransaction]) {<br>        <br>        transactions.forEach {<br>           <strong class="markup--strong markup--pre-strong"> print($0.payment.productIdentifier, $0.transactionState.rawValue)</strong><br><strong class="markup--strong markup--pre-strong">            switch $0.transactionState {</strong></pre><pre name="6ae9" id="6ae9" class="graf graf--pre graf-after--pre">           <strong class="markup--strong markup--pre-strong"> case .purchased:<br>              SKPaymentQueue.default().finishTransaction($0)</strong></pre><pre name="0af8" id="0af8" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">            case .failed:<br>                print($0.error ?? &quot;&quot;)<br>                if ($0.error as? SKError)?.code != .paymentCancelled {<br>                    // show error<br>                }<br>              SKPaymentQueue.default().finishTransaction($0)</strong></pre><pre name="ad4a" id="ad4a" class="graf graf--pre graf-after--pre">            case .restored:<br>              SKPaymentQueue.default().finishTransaction($0)</pre><pre name="519a" id="519a" class="graf graf--pre graf-after--pre">            case .purchasing, .deferred:<br>                break</pre><pre name="8760" id="8760" class="graf graf--pre graf-after--pre">            <a href="http://twitter.com/unknown" data-href="http://twitter.com/unknown" class="markup--anchor markup--pre-anchor" title="Twitter profile for @unknown" rel="noopener" target="_blank">@unknown</a> default:<br>                break<br>            }<br>            <br>        }<br>    }<br>    <br>}</pre><p name="5d77" id="5d77" class="graf graf--p graf-after--pre">我們可從 <code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">SKPaymentTransaction</strong></code> 的 <code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">payment.productIdentifier</strong></code> 知道購買的商品，從 <code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">transactionState</strong></code> 知道交易的狀態，目前有 purchased，failed，restored，purchasing &amp; deferred 5 種狀態。<code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">purchased</strong></code> 代表交易成功，因此我們可判斷 transactionState 等於 purchased 時增加使用者可聆聽音樂的時間或開始下載購買的歌曲。</p><p name="c0be" id="c0be" class="graf graf--p graf-after--p">值得注意的，當狀態為代表成功的 purchased &amp; restored(待會說明)和代表失敗的 failed 時，記得要呼叫 <code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">finishTransaction</strong></code> 完成交易，否則 iOS 會以為交易還未完成，下次打開 App 時會再觸發 <code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">paymentQueue(_:updatedTransactions:)</strong></code>。</p><p name="c88c" id="c88c" class="graf graf--p graf-after--p">讓我們舉個例子說明。比方使用者購買了 Taylor Swift 的 love story，App 程式開始下載音樂，當歌曲下載成功後再呼叫 <code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">finishTransaction</strong></code> 完成交易。若是網路突然斷線造成下載失敗，由於我們尚未呼叫 <code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">finishTransaction</strong></code>，因此 App 下次啟動時會再觸發 <code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">paymentQueue(_:updatedTransactions:)</strong></code>，讓我們知道使用者購買了 love story，重新進行 love story 的下載，直到下載成功後才呼叫 <code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">finishTransaction</strong></code>完成交易。</p><p name="1c69" id="1c69" class="graf graf--p graf-after--p">另外交易失敗時應該要在 App 畫面上顯示錯誤訊息，不過如果使用者自己取消購買則不用，因此以下程式只在 error code 不等於 paymentCancelled 時顯示錯誤。</p><pre name="5bbf" id="5bbf" class="graf graf--pre graf-after--p">if ($0.error as? SKError)?.code != .paymentCancelled {<br>   // show error<br>}</pre><h3 name="431c" id="431c" class="graf graf--h3 graf-after--pre">以 SwiftUI App 測試 IAP</h3><p name="7bb9" id="7bb9" class="graf graf--p graf-after--h3">現在我們已可實際測試 IAP 商品的購買，以下彼得潘將剛剛的程式整理成一個簡單的 SwiftUI App 實驗。</p><pre name="a9ca" id="a9ca" class="graf graf--pre graf-after--p">struct ProductList: View {<br>    <br>    <a href="http://twitter.com/ObservedObject" data-href="http://twitter.com/ObservedObject" class="markup--anchor markup--pre-anchor" title="Twitter profile for @ObservedObject" rel="noopener" target="_blank">@ObservedObject</a> var iapManager = IAPManager.shared<br>    <br>    var body: some View {<br>        <br>        List(iapManager.products, id: \.productIdentifier) { (product)  in<br>            Button(action: {<br>                self.iapManager.buy(product: product)</pre><pre name="22d5" id="22d5" class="graf graf--pre graf-after--pre">}) {<br>                HStack {<br>                    Text(product.localizedTitle)<br>                    Spacer()<br>                    Text(product.regularPrice ?? &quot;&quot;)</pre><pre name="24fa" id="24fa" class="graf graf--pre graf-after--pre">                }<br>            }<br>        }<br>        .onAppear {<br>            self.iapManager.getProducts()<br>        }<br>    }<br>}</pre><p name="8a3a" id="8a3a" class="graf graf--p graf-after--pre">當我們抓取到商品資料時， products 內容改變將通知 ProductList 更新畫面。不過畫面的更新必須在 main thread 執行，因此我們切換到 main thread 設定 products。</p><pre name="1e22" id="1e22" class="graf graf--pre graf-after--p">extension IAPManager: SKProductsRequestDelegate {<br>    func productsRequest(_ request: SKProductsRequest, didReceive response: SKProductsResponse) {<br>        response.products.forEach {<br>            print($0.localizedTitle, $0.price, $0.localizedDescription)<br>        }<br>      <strong class="markup--strong markup--pre-strong">  DispatchQueue.main.async {<br>            self.products = response.products</strong></pre><pre name="e427" id="e427" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">        }</strong><br>    }<br>    <br>}</pre><p name="f096" id="f096" class="graf graf--p graf-after--pre">App 畫面</p><figure name="4a84" id="4a84" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*2ya74LULZdylzWFejO4DiQ.png" data-width="1125" data-height="2436" src="https://cdn-images-1.medium.com/max/800/1*2ya74LULZdylzWFejO4DiQ.png"></figure><p name="ab2a" id="ab2a" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">測試各種商品的購買</strong></p><ul class="postList"><li name="fc7c" id="fc7c" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">購買 Consumable 的聽一小時。</strong></li></ul><p name="91d3" id="91d3" class="graf graf--p graf-after--li">聽一小時屬於可重覆購買的 Consumable 商品，所以我們可重覆購買，比方買十次獲得 10 小時的音樂聆聽時間。成功購買時，Apple 的購買視窗將顯示 You’re all set，Your purchase was successful。</p></div><div class="section-inner sectionLayout--outsetRow" data-paragraph-count="2"><figure name="f173" id="f173" class="graf graf--figure graf--layoutOutsetRow is-partialWidth graf-after--p" style="width: 50%;"><img class="graf-image" data-image-id="1*UKGpH3bwueXOdwEZKQ_HLA.png" data-width="1125" data-height="2436" src="https://cdn-images-1.medium.com/max/600/1*UKGpH3bwueXOdwEZKQ_HLA.png"></figure><figure name="80aa" id="80aa" class="graf graf--figure graf--layoutOutsetRowContinue is-partialWidth graf-after--figure" style="width: 50%;"><img class="graf-image" data-image-id="1*MYDGw-Pfp-09fS7VxcAp-g.png" data-width="1125" data-height="2436" src="https://cdn-images-1.medium.com/max/600/1*MYDGw-Pfp-09fS7VxcAp-g.png"></figure></div><div class="section-inner sectionLayout--insetColumn"><ul class="postList"><li name="1847" id="1847" class="graf graf--li graf-after--figure"><strong class="markup--strong markup--li-strong">購買 Non-Consumable 的愛的故事。</strong></li></div><div class="section-inner sectionLayout--outsetRow" data-paragraph-count="2"></ul><figure name="fbad" id="fbad" class="graf graf--figure graf--layoutOutsetRow is-partialWidth graf-after--li" style="width: 50%;"><img class="graf-image" data-image-id="1*rZknx_z-yOLdW23HxtQcsQ.png" data-width="1125" data-height="2436" src="https://cdn-images-1.medium.com/max/600/1*rZknx_z-yOLdW23HxtQcsQ.png"></figure><figure name="a05e" id="a05e" class="graf graf--figure graf--layoutOutsetRowContinue is-partialWidth graf-after--figure" style="width: 50%;"><img class="graf-image" data-image-id="1*dholQj7RSgb3ZstupzGoLw.png" data-width="1125" data-height="2436" src="https://cdn-images-1.medium.com/max/600/1*dholQj7RSgb3ZstupzGoLw.png"></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="3689" id="3689" class="graf graf--p graf-after--figure">愛的故事是不可重覆購買的 Non-Consumable 商品，理想上 App 應該先做判斷，若使用者已買過則不給他購買。不過就算讓使用者不小心購買，Apple 也是不會扣錢的，他會告訴使用者 You’ve already purchased this，使用者可以免費購買。</p><figure name="6cdd" id="6cdd" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*GrmQUDYGlf6V8gkETn0LVA.png" data-width="1125" data-height="2436" src="https://cdn-images-1.medium.com/max/800/1*GrmQUDYGlf6V8gkETn0LVA.png"></figure><h3 name="ce7a" id="ce7a" class="graf graf--h3 graf-after--figure">成功購買時提供商品給使用者(Content Delivery)</h3><p name="e70d" id="e70d" class="graf graf--p graf-after--h3">當使用者成功購買時，我們必須提供商品給使用者，可能是解鎖某個功能，也可能是下載某個檔案(ps: 檔案也可以放在 Apple 的後台)。有興趣的朋友可參考以下連結 Content Delivery 的相關說明。</p><div name="1a6f" id="1a6f" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://developer.apple.com/documentation/storekit/in-app_purchase" data-href="https://developer.apple.com/documentation/storekit/in-app_purchase" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://developer.apple.com/documentation/storekit/in-app_purchase"><strong class="markup--strong markup--mixtapeEmbed-strong">In-App Purchase</strong><br><em class="markup--em markup--mixtapeEmbed-em">In-App Purchase allows you to offer users the opportunity to purchase in-app content and features. Customers can make…</em>developer.apple.com</a><a href="https://developer.apple.com/documentation/storekit/in-app_purchase" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="266c318d40ef360f25200daa67c9fca8"></a></div><figure name="9aa0" id="9aa0" class="graf graf--figure graf-after--mixtapeEmbed"><img class="graf-image" data-image-id="1*HBAv-LVg5_h1-aM-KpHuRg.jpeg" data-width="1950" data-height="726" src="https://cdn-images-1.medium.com/max/800/1*HBAv-LVg5_h1-aM-KpHuRg.jpeg"></figure><div name="4ddc" id="4ddc" class="graf graf--mixtapeEmbed graf-after--figure"><a href="https://developer.apple.com/documentation/storekit/in-app_purchase/unlocking_purchased_content" data-href="https://developer.apple.com/documentation/storekit/in-app_purchase/unlocking_purchased_content" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://developer.apple.com/documentation/storekit/in-app_purchase/unlocking_purchased_content"><strong class="markup--strong markup--mixtapeEmbed-strong">Unlocking Purchased Content</strong><br><em class="markup--em markup--mixtapeEmbed-em">Once a purchase is completed, it&#39;s your responsibility to make sure that you programmatically make the content…</em>developer.apple.com</a><a href="https://developer.apple.com/documentation/storekit/in-app_purchase/unlocking_purchased_content" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="30993afd93d142a8fefcf9935acb8007"></a></div><div name="632d" id="632d" class="graf graf--mixtapeEmbed graf-after--mixtapeEmbed"><a href="https://developer.apple.com/documentation/storekit/in-app_purchase/persisting_a_purchase" data-href="https://developer.apple.com/documentation/storekit/in-app_purchase/persisting_a_purchase" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://developer.apple.com/documentation/storekit/in-app_purchase/persisting_a_purchase"><strong class="markup--strong markup--mixtapeEmbed-strong">Persisting a Purchase</strong><br><em class="markup--em markup--mixtapeEmbed-em">After making a product available, your app should make a persistent record of the purchase. Your app uses that…</em>developer.apple.com</a><a href="https://developer.apple.com/documentation/storekit/in-app_purchase/persisting_a_purchase" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="1144fa546810f36adf7c5445170e8dcf"></a></div><h3 name="2970" id="2970" class="graf graf--h3 graf-after--mixtapeEmbed">restore 買過的商品</h3><div name="81b0" id="81b0" class="graf graf--mixtapeEmbed graf-after--h3"><a href="https://developer.apple.com/documentation/storekit/in-app_purchase/restoring_purchased_products" data-href="https://developer.apple.com/documentation/storekit/in-app_purchase/restoring_purchased_products" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://developer.apple.com/documentation/storekit/in-app_purchase/restoring_purchased_products"><strong class="markup--strong markup--mixtapeEmbed-strong">Restoring Purchased Products</strong><br><em class="markup--em markup--mixtapeEmbed-em">Users sometimes need to restore purchased content, such as when they upgrade to a new phone. Include some mechanism in…</em>developer.apple.com</a><a href="https://developer.apple.com/documentation/storekit/in-app_purchase/restoring_purchased_products" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="918d5a214a52e7a7596e2eac3520d982"></a></div><p name="6fa2" id="6fa2" class="graf graf--p graf-after--mixtapeEmbed">若商品屬於 non-consumable &amp; auto-renewable subscriptions，Apple 還要求 App 必須實作一個功能才能上架，也就是我們現在要介紹的 restore 功能。</p><p name="4fdc" id="4fdc" class="graf graf--p graf-after--p">restore 功能可以回復使用者之前買過的商品。比方使用者在 iPhone 11 買了 Taylor Swift 的 love story，後來他用同樣的 Apple ID 登入 iPad Pro，在 iPad Pro 使用 App 時他應該能直接下載聆聽 love story，不用再買一次。因此 App 裡必須提供 restore button，方便使用者點選回復他買過的商品。</p><p name="e3d0" id="e3d0" class="graf graf--p graf-after--p">實現 restore 功能主要透過以下程式，呼叫 <code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">SKPaymentQueue</strong></code> 的 <code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">restoreCompletedTransactions</strong></code>。</p><pre name="8073" id="8073" class="graf graf--pre graf-after--p">SKPaymentQueue.default().restoreCompletedTransactions()</pre><p name="cec5" id="cec5" class="graf graf--p graf-after--pre">當 restore 成功時，我們可從 paymentQueue(_:updatedTransactions:) 讀取到 transactionState 為 restored，然後開始將商品提供給使用者，比方下載 Taylor Swift 的 love story。</p><h3 name="dbf0" id="dbf0" class="graf graf--h3 graf-after--p">證明使用者購買的 receipt (收據)</h3><p name="0e27" id="0e27" class="graf graf--p graf-after--h3">如果想要更安全，確認使用者真的有花錢購買，Apple 還提供了幫助我們檢查的 receipt 。我們可從 Bundle.main.appStoreReceiptURL 讀取購買的 receipt。</p><pre name="39a8" id="39a8" class="graf graf--pre graf-after--p">guard let receiptURL = Bundle.main.appStoreReceiptURL,  let data = try? Data(contentsOf: receiptURL)  else {<br>    return                 <br>}<br>print(data)</pre><p name="3792" id="3792" class="graf graf--p graf-after--pre">不過 receipt 是加密過的檔案，所以解讀有點麻煩，有興趣的朋友可參考以下連結的說明。</p><div name="22b6" id="22b6" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://www.raywenderlich.com/9257-in-app-purchases-receipt-validation-tutorial" data-href="https://www.raywenderlich.com/9257-in-app-purchases-receipt-validation-tutorial" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://www.raywenderlich.com/9257-in-app-purchases-receipt-validation-tutorial"><strong class="markup--strong markup--mixtapeEmbed-strong">In-App Purchases: Receipt Validation Tutorial</strong><br><em class="markup--em markup--mixtapeEmbed-em">In this tutorial, you’ll learn how receipts for In-App Purchases work and how to validate them to ensure your users…</em>www.raywenderlich.com</a><a href="https://www.raywenderlich.com/9257-in-app-purchases-receipt-validation-tutorial" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="a18b7b176fbc1b520ea644a6cf40456c" data-thumbnail-img-id="0*M-7BWHgF4gCzEHYc" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*M-7BWHgF4gCzEHYc);"></a></div><div name="7ede" id="7ede" class="graf graf--mixtapeEmbed graf-after--mixtapeEmbed"><a href="https://developer.apple.com/documentation/storekit/in-app_purchase/validating_receipts_with_the_app_store" data-href="https://developer.apple.com/documentation/storekit/in-app_purchase/validating_receipts_with_the_app_store" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://developer.apple.com/documentation/storekit/in-app_purchase/validating_receipts_with_the_app_store"><strong class="markup--strong markup--mixtapeEmbed-strong">Validating Receipts with the App Store</strong><br><em class="markup--em markup--mixtapeEmbed-em">An App Store receipt is a binary encrypted file signed with an Apple certificate. In order to read the contents of the…</em>developer.apple.com</a><a href="https://developer.apple.com/documentation/storekit/in-app_purchase/validating_receipts_with_the_app_store" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="690ae5a60ffc447c4fd4933dc3e903ac"></a></div><h3 name="b3eb" id="b3eb" class="graf graf--h3 graf-after--mixtapeEmbed">App 上架前提供 IAP 的 Review 照片</h3><p name="92cf" id="92cf" class="graf graf--p graf-after--h3">雖然我們已經可以在測試時購買商品，但是它還是假的，不會讓我們賺到一毛錢。為了讓商品能真正銷售，IAP 還要經過 Apple 的審核。</p><p name="0f29" id="0f29" class="graf graf--p graf-after--p">回到 App Store Connect 的 IAP 頁面，此時商品的 Status 是 Missing Metadata，表示我們還有資訊未提供。</p><figure name="b833" id="b833" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*qj5zT6WHkI3oMpBzLRDURg.jpeg" data-width="2528" data-height="1124" src="https://cdn-images-1.medium.com/max/800/1*qj5zT6WHkI3oMpBzLRDURg.jpeg"></figure><p name="d3de" id="d3de" class="graf graf--p graf-after--figure">因此在審核前記得要在 Review Information 提供商品在 App 裡銷售的畫面，讓商品的狀態變成 Ready to Submit。</p><figure name="1910" id="1910" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*7_akSVkuDT7nx2GuVDDUVw.jpeg" data-width="2544" data-height="1152" src="https://cdn-images-1.medium.com/max/800/1*7_akSVkuDT7nx2GuVDDUVw.jpeg"></figure><figure name="d0e4" id="d0e4" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*XQZV5yeAzm0y40wBtcJvEA.jpeg" data-width="2038" data-height="464" src="https://cdn-images-1.medium.com/max/800/1*XQZV5yeAzm0y40wBtcJvEA.jpeg"></figure><p name="81ee" id="81ee" class="graf graf--p graf-after--figure">為了送審 IAP 的商品，最後我們還要回到 App Store 的 Prepare for Submission 頁面，點選 In-App Purchase 的 + 加入送審的商品。</p><figure name="9466" id="9466" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*jaHZ5ePq5AFQqds2ggH81A.jpeg" data-width="2506" data-height="854" src="https://cdn-images-1.medium.com/max/800/1*jaHZ5ePq5AFQqds2ggH81A.jpeg"></figure><figure name="9e60" id="9e60" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*xD7uPXYFYetFhQVlmlCVig.jpeg" data-width="1566" data-height="738" src="https://cdn-images-1.medium.com/max/800/1*xD7uPXYFYetFhQVlmlCVig.jpeg"></figure><figure name="dc7b" id="dc7b" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*xExKpzFoN-ez3QgTf2jofg.jpeg" data-width="2222" data-height="902" src="https://cdn-images-1.medium.com/max/800/1*xExKpzFoN-ez3QgTf2jofg.jpeg"></figure><h3 name="f017" id="f017" class="graf graf--h3 graf-after--figure">Apple 官方範例 (UIKit App)</h3><p name="a5c2" id="a5c2" class="graf graf--p graf-after--h3">Apple 官方提供完整的 IAP App 範例和說明，有興趣的朋友也可以下載研究。</p><div name="2f91" id="2f91" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://developer.apple.com/documentation/storekit/in-app_purchase/offering_completing_and_restoring_in-app_purchases" data-href="https://developer.apple.com/documentation/storekit/in-app_purchase/offering_completing_and_restoring_in-app_purchases" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://developer.apple.com/documentation/storekit/in-app_purchase/offering_completing_and_restoring_in-app_purchases"><strong class="markup--strong markup--mixtapeEmbed-strong">Offering, Completing, and Restoring In-App Purchases</strong><br><em class="markup--em markup--mixtapeEmbed-em">In-App Purchase allows users to purchase virtual goods within your app or directly from the App Store using the…</em>developer.apple.com</a><a href="https://developer.apple.com/documentation/storekit/in-app_purchase/offering_completing_and_restoring_in-app_purchases" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="30ad36a943f62159fcda82e8d27d7def"></a></div></div><div class="section-inner sectionLayout--outsetRow" data-paragraph-count="3"><figure name="4704" id="4704" class="graf graf--figure graf--layoutOutsetRow is-partialWidth graf-after--mixtapeEmbed" style="width: 33.333%;"><img class="graf-image" data-image-id="1*H-RonZiBvJFnOWPlMap6LA.png" data-width="1125" data-height="2436" src="https://cdn-images-1.medium.com/max/400/1*H-RonZiBvJFnOWPlMap6LA.png"></figure><figure name="91d6" id="91d6" class="graf graf--figure graf--layoutOutsetRowContinue is-partialWidth graf-after--figure" style="width: 33.333%;"><img class="graf-image" data-image-id="1*1hsTgmhy-v8C27bAE8COTg.png" data-width="1125" data-height="2436" src="https://cdn-images-1.medium.com/max/400/1*1hsTgmhy-v8C27bAE8COTg.png"></figure><figure name="cdec" id="cdec" class="graf graf--figure graf--layoutOutsetRowContinue is-partialWidth graf-after--figure" style="width: 33.333%;"><img class="graf-image" data-image-id="1*L3SLbW__lEnqkRENHvRDcg.png" data-width="1125" data-height="2436" src="https://cdn-images-1.medium.com/max/400/1*L3SLbW__lEnqkRENHvRDcg.png"></figure></div><div class="section-inner sectionLayout--insetColumn"><h3 name="0e40" id="0e40" class="graf graf--h3 graf-after--figure">測試 IAP 範例</h3><p name="fc38" id="fc38" class="graf graf--p graf-after--h3">若想測試彼得潘的 SwiftUI 範例或 Apple 官方範例，可參考以下三個步驟進行:</p><ul class="postList"><li name="8c08" id="8c08" class="graf graf--li graf-after--p">完成下圖寫程式前的準備。</li></ul><figure name="099c" id="099c" class="graf graf--figure graf-after--li"><img class="graf-image" data-image-id="1*KwHnIWwBhg0CUkanV5xGgQ.jpeg" data-width="1400" data-height="1078" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*KwHnIWwBhg0CUkanV5xGgQ.jpeg"></figure><ul class="postList"><li name="6ba8" id="6ba8" class="graf graf--li graf-after--figure">修改範例的 Bundle ID。</li></ul><figure name="d337" id="d337" class="graf graf--figure graf-after--li"><img class="graf-image" data-image-id="1*_DCWEB17TBaG1DMKfBBM9A.jpeg" data-width="1776" data-height="460" src="https://cdn-images-1.medium.com/max/800/1*_DCWEB17TBaG1DMKfBBM9A.jpeg"></figure><ul class="postList"><li name="d9f6" id="d9f6" class="graf graf--li graf-after--figure">設定 product ID。</li></ul><p name="8b2a" id="8b2a" class="graf graf--p graf-after--li">修改 Apple 範例的 ProductIds.plist 或 SwiftUI 範例的 getProductIDs。</p><figure name="6dad" id="6dad" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*TxTM0WOlrp_n3-ihGGajMQ.jpeg" data-width="1794" data-height="550" src="https://cdn-images-1.medium.com/max/800/1*TxTM0WOlrp_n3-ihGGajMQ.jpeg"></figure><h3 name="0001" id="0001" class="graf graf--h3 graf-after--figure">SwiftUI IAP 範例下載</h3><div name="9add" id="9add" class="graf graf--mixtapeEmbed graf-after--h3 graf--trailing"><a href="https://github.com/AppPeterPan/IAPDemo" data-href="https://github.com/AppPeterPan/IAPDemo" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://github.com/AppPeterPan/IAPDemo"><strong class="markup--strong markup--mixtapeEmbed-strong">AppPeterPan/IAPDemo</strong><br><em class="markup--em markup--mixtapeEmbed-em">Contribute to AppPeterPan/IAPDemo development by creating an account on GitHub.</em>github.com</a><a href="https://github.com/AppPeterPan/IAPDemo" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="757c174047910845b0193691828cd309" data-thumbnail-img-id="0*QByIT1xBMgbRi0zG" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*QByIT1xBMgbRi0zG);"></a></div></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@apppeterpan" class="p-author h-card">彼得潘的 iOS App Neverland</a> on <a href="https://medium.com/p/45250cf2174"><time class="dt-published" datetime="2020-05-01T07:45:44.104Z">May 1, 2020</time></a>.</p><p><a href="https://medium.com/@apppeterpan/%E5%BE%9E%E9%9B%B6%E9%96%8B%E5%A7%8B%E9%96%8B%E7%99%BC-ios-app-%E7%9A%84-in-app-purchase-iap-45250cf2174" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on November 16, 2025.</p></footer></article></body></html>