<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>使用套件 json_serializable 生成將 JSON 轉換成自訂型別的程式</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">使用套件 json_serializable 生成將 JSON 轉換成自訂型別的程式</h1>
</header>
<section data-field="subtitle" class="p-summary">
當我們串接 API 抓到 JSON 資料時，通常會將 JSON 資料轉換成方便 App 使用的自訂型別。不過當遇到較複雜的 JSON 時，自己撰寫轉換的程式要花許多時間，而且因為要手動輸入 key 的字串，所以極容易寫錯。
</section>
<section data-field="body" class="e-content">
<section name="365c" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="eee5" id="eee5" class="graf graf--h3 graf--leading graf--title">使用套件 <strong class="markup--strong markup--h3-strong">json_serializable 生成將 JSON 轉換成自訂型別的程式</strong></h3><figure name="539d" id="539d" class="graf graf--figure graf-after--h3"><img class="graf-image" data-image-id="1*0pM5uGk94S4Gm4ArXoW0DQ.png" data-width="1732" data-height="1056" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*0pM5uGk94S4Gm4ArXoW0DQ.png"></figure><p name="c306" id="c306" class="graf graf--p graf-after--figure">當我們串接 API 抓到 JSON 資料時，通常會將 JSON 資料轉換成方便 App 使用的自訂型別。不過當遇到較複雜的 JSON 時，自己撰寫轉換的程式要花許多時間，而且因為要手動輸入 key 的字串，所以極容易寫錯。</p><p name="da5b" id="da5b" class="graf graf--p graf-after--p">將 JSON 轉換成自訂型別的程式往往有固定的規則和寫法，現在已經有許多自動化工具可以幫我們代勞。以下我們將介紹解析 JSON 時常使用的套件 json_serializable，透過它自動生成將 JSON 轉換成自訂型別的程式。</p><div name="94ee" id="94ee" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://pub.dev/packages/json_serializable" data-href="https://pub.dev/packages/json_serializable" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://pub.dev/packages/json_serializable"><strong class="markup--strong markup--mixtapeEmbed-strong">json_serializable | Dart package</strong><br><em class="markup--em markup--mixtapeEmbed-em">Automatically generate code for converting to and from JSON by annotating Dart classes.</em>pub.dev</a><a href="https://pub.dev/packages/json_serializable" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="8109ddd156ed37bda2a4aae02bc43a21" data-thumbnail-img-id="0*Hy_CD7J3eUYevYN1" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*Hy_CD7J3eUYevYN1);"></a></div><div name="1371" id="1371" class="graf graf--mixtapeEmbed graf-after--mixtapeEmbed"><a href="https://docs.flutter.dev/data-and-backend/serialization/json" data-href="https://docs.flutter.dev/data-and-backend/serialization/json" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://docs.flutter.dev/data-and-backend/serialization/json"><strong class="markup--strong markup--mixtapeEmbed-strong">JSON and serialization</strong><br><em class="markup--em markup--mixtapeEmbed-em">How to use JSON with Flutter.</em>docs.flutter.dev</a><a href="https://docs.flutter.dev/data-and-backend/serialization/json" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="8294b6660d3ff245f2945476b789d6ea" data-thumbnail-img-id="0*tNny74FcKzGIZMw2" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*tNny74FcKzGIZMw2);"></a></div><h3 name="ebe1" id="ebe1" class="graf graf--h3 graf-after--mixtapeEmbed">安裝套件</h3><pre data-code-block-mode="0" spellcheck="false" name="a7f8" id="a7f8" class="graf graf--pre graf-after--h3 graf--preV2"><span class="pre--content">flutter pub add json_annotation dev:build_runner dev:json_serializable</span></pre><h3 name="94ab" id="94ab" class="graf graf--h3 graf-after--pre">定義資料型別</h3><p name="64fc" id="64fc" class="graf graf--p graf-after--h3">以歌詞 API <code class="markup--code markup--p-code u-paddingRight0 u-marginRight0"><a href="https://some-random-api.com/others/lyrics?title=how" data-href="https://some-random-api.com/others/lyrics?title=how" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">https://some-random-api.com/others/lyrics?title=how</a> long will i love you</code> 為例，它的 JSON 資料如下。</p><figure name="fa6b" id="fa6b" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*CyugVK4FU7JSCtnQkJgpKw.png" data-width="1318" data-height="1312" src="https://cdn-images-1.medium.com/max/800/1*CyugVK4FU7JSCtnQkJgpKw.png"></figure><p name="5f0d" id="5f0d" class="graf graf--p graf-after--figure">將 JSON 裡以 { } 描述的 object 變成自訂型別，object 的 key 將成為 property 的名字， 而 property 的型別則由 key 對應的 value 型別決定。</p><p name="d368" id="d368" class="graf graf--p graf-after--p">以下為 JSON 對應的 class Song，class 裡只要宣告會用到的資訊，不需要將 JSON 的 key 都宣告成 property。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="dart" name="a2c5" id="a2c5" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Song</span> </span>{<br />  Song(<span class="hljs-keyword">this</span>.title, <span class="hljs-keyword">this</span>.lyrics);<br /><br />  <span class="hljs-built_in">String</span> title;<br />  <span class="hljs-built_in">String</span> lyrics;<br />}</span></pre><p name="325d" id="325d" class="graf graf--p graf-after--pre">import json_annotation.dart，在 class 前加上<code class="markup--code markup--p-code"> @JsonSerializable()</code>，表示此類別要加上 JSON 資料轉換的相關程式。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="dart" name="712f" id="712f" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:json_annotation/json_annotation.dart&#x27;</span>;<br /><br /><span class="hljs-meta">@JsonSerializable</span>()<br /><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Song</span> </span>{<br />  Song(<span class="hljs-keyword">this</span>.title, <span class="hljs-keyword">this</span>.lyrics);<br /><br />  <span class="hljs-built_in">String</span> title;<br />  <span class="hljs-built_in">String</span> lyrics;<br />}</span></pre><p name="c35d" id="c35d" class="graf graf--p graf-after--pre">使用 part 加入 song.g.dart，定義從 Map 轉成 Song 的 Song.fromJson。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="dart" name="dba9" id="dba9" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:json_annotation/json_annotation.dart&#x27;</span>;<br /><span class="hljs-keyword">part</span> <span class="hljs-string">&#x27;song.g.dart&#x27;</span>;<br /><br /><span class="hljs-meta">@JsonSerializable</span>()<br /><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Song</span> </span>{<br />  Song(<span class="hljs-keyword">this</span>.title, <span class="hljs-keyword">this</span>.lyrics);<br /><br />  <span class="hljs-built_in">String</span> title;<br />  <span class="hljs-built_in">String</span> lyrics;<br /><br />  <span class="hljs-keyword">factory</span> Song.fromJson(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json) =&gt; _$SongFromJson(json);<br />}</span></pre><p name="5279" id="5279" class="graf graf--p graf-after--pre">此時會出現兩個明顯的錯誤，找不到 song.g.dart 跟 _$SongFromJson。</p><figure name="f6f0" id="f6f0" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*94--YJTg3Iw4TtN2bmpDMQ.png" data-width="1588" data-height="474" src="https://cdn-images-1.medium.com/max/800/1*94--YJTg3Iw4TtN2bmpDMQ.png"></figure><figure name="c8b3" id="c8b3" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*f9c-vBigTptnjh0rqpy_ug.png" data-width="1776" data-height="506" src="https://cdn-images-1.medium.com/max/800/1*f9c-vBigTptnjh0rqpy_ug.png"></figure><p name="70dc" id="70dc" class="graf graf--p graf-after--figure">song.g.dart 定義資料轉換的 function _$SongFromJson，我們現在尚未生成 song.g.dart，因此會有錯誤。接下來我們將透過套件 json_serializable 的幫忙下指令生成 song.g.dart。</p><h3 name="7463" id="7463" class="graf graf--h3 graf-after--p">產生 song.g.dart 檔</h3><p name="efa7" id="efa7" class="graf graf--p graf-after--h3">在 IDE 的 terminal 輸入以下指令執行 build_runner，加上 delete-conflicting-outputs 的目的是為了避免衝突，它會刪除與新生成的檔案發生衝突的舊檔，然後重新生成新的檔案</p><pre data-code-block-mode="0" spellcheck="false" name="62dd" id="62dd" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">dart run build_runner build --delete-conflicting-outputs</span></pre><p name="1bd9" id="1bd9" class="graf graf--p graf-after--pre">ps: 另一種執行 build_runner 的指令是 flutter pub run build_runner build，同樣也可以加上 — delete-conflicting-outputs。</p><p name="45d5" id="45d5" class="graf graf--p graf-after--p">由於我們在 class Song 前加上 <code class="markup--code markup--p-code">@JsonSerializable()</code>，它將產生 song.g.dart，幫 Song 產生 JSON 轉換的相關程式。</p><p name="36f2" id="36f2" class="graf graf--p graf-after--p">產生的 song.g.dart 內容如下，包含從 Map 轉成 Song 和從 Song 轉成 Map 的 function。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="dart" name="a59b" id="a59b" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-comment">// GENERATED CODE - DO NOT MODIFY BY HAND</span><br /><br /><span class="hljs-keyword">part</span> of <span class="hljs-string">&#x27;song.dart&#x27;</span>;<br /><br /><span class="hljs-comment">// **************************************************************************</span><br /><span class="hljs-comment">// JsonSerializableGenerator</span><br /><span class="hljs-comment">// **************************************************************************</span><br /><br />Song _$SongFromJson(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json) =&gt; Song(<br />      json[<span class="hljs-string">&#x27;title&#x27;</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">String</span>,<br />      json[<span class="hljs-string">&#x27;lyrics&#x27;</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">String</span>,<br />    );<br /><br /><span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; _$SongToJson(Song instance) =&gt; &lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;{<br />      <span class="hljs-string">&#x27;title&#x27;</span>: instance.title,<br />      <span class="hljs-string">&#x27;lyrics&#x27;</span>: instance.lyrics,<br />    };</span></pre><p name="af79" id="af79" class="graf graf--p graf-after--pre">ps: 不熟 part ＆part of 語法的朋友可參考以下連結。</p><div name="0262" id="0262" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-flutter-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E4%BD%BF%E7%94%A8-dart-%E7%9A%84-part-%E5%92%8C-part-of-%E5%B0%87%E5%A4%A7%E6%AA%94%E6%8B%86%E8%A7%A3%E6%88%90%E6%96%B9%E4%BE%BF%E7%AE%A1%E7%90%86%E7%9A%84%E5%B0%8F%E6%AA%94-431971819a8d" data-href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-flutter-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E4%BD%BF%E7%94%A8-dart-%E7%9A%84-part-%E5%92%8C-part-of-%E5%B0%87%E5%A4%A7%E6%AA%94%E6%8B%86%E8%A7%A3%E6%88%90%E6%96%B9%E4%BE%BF%E7%AE%A1%E7%90%86%E7%9A%84%E5%B0%8F%E6%AA%94-431971819a8d" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-flutter-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E4%BD%BF%E7%94%A8-dart-%E7%9A%84-part-%E5%92%8C-part-of-%E5%B0%87%E5%A4%A7%E6%AA%94%E6%8B%86%E8%A7%A3%E6%88%90%E6%96%B9%E4%BE%BF%E7%AE%A1%E7%90%86%E7%9A%84%E5%B0%8F%E6%AA%94-431971819a8d"><strong class="markup--strong markup--mixtapeEmbed-strong">使用 Dart 的 part 和 part of 將大檔拆解成方便管理的小檔</strong><br><em class="markup--em markup--mixtapeEmbed-em">開發程式時，我們常常會在不知不覺間加入愈來愈多的功能，造成一個檔案包含大量的程式，因此影響程式的可讀性和維護性。</em>medium.com</a><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-flutter-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E4%BD%BF%E7%94%A8-dart-%E7%9A%84-part-%E5%92%8C-part-of-%E5%B0%87%E5%A4%A7%E6%AA%94%E6%8B%86%E8%A7%A3%E6%88%90%E6%96%B9%E4%BE%BF%E7%AE%A1%E7%90%86%E7%9A%84%E5%B0%8F%E6%AA%94-431971819a8d" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="dd24c3eed7bff22b84ffebeb1669effe" data-thumbnail-img-id="1*8FCrjn-bxjhxh6qsT4GI2Q.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*8FCrjn-bxjhxh6qsT4GI2Q.png);"></a></div><p name="6415" id="6415" class="graf graf--p graf-after--mixtapeEmbed">產生 song.g.dart 後，剛剛找不到 song.g.dart 跟 _$SongFromJson 的錯誤也消失了，之後我們用 jsonDecode 解碼歌詞 API 抓到的 JSON 後，使用 Song.fromJson 即可將它轉換成 Song。</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="dart" name="c8c1" id="c8c1" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;dart:convert&#x27;</span>;<br /><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:http/http.dart&#x27;</span> <span class="hljs-keyword">as</span> http; <br /><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;song.dart&#x27;</span>;<br /><br /><span class="hljs-keyword">void</span> main() <span class="hljs-keyword">async</span> {<br />  <span class="hljs-keyword">var</span> response = <span class="hljs-keyword">await</span> http.<span class="hljs-keyword">get</span>(<span class="hljs-built_in">Uri</span>.parse(<br />      <span class="hljs-string">&#x27;https://some-random-api.com/others/lyrics?title=how long will i love you&#x27;</span>));<br />  <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; songMap = jsonDecode(response.body);<br />  <span class="hljs-keyword">var</span> song = Song.fromJson(songMap);<br />  <span class="hljs-built_in">print</span>(song.title);<br />  <span class="hljs-built_in">print</span>(song.lyrics);<br />}</span></pre><h3 name="6cd4" id="6cd4" class="graf graf--h3 graf-after--pre">更新資料型別</h3><p name="0e76" id="0e76" class="graf graf--p graf-after--h3">開發的過程中我們時常會更新資料型別的定義，比方在 Song 裡加上新欄位 author。</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="dart" name="0949" id="0949" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><br /><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:json_annotation/json_annotation.dart&#x27;</span>;<br /><span class="hljs-keyword">part</span> <span class="hljs-string">&#x27;song.g.dart&#x27;</span>;<br /><br /><span class="hljs-meta">@JsonSerializable</span>()<br /><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Song</span> </span>{<br />  Song(<span class="hljs-keyword">this</span>.title, <span class="hljs-keyword">this</span>.lyrics, <span class="hljs-keyword">this</span>.author);<br /><br />  <span class="hljs-built_in">String</span> title;<br />  <span class="hljs-built_in">String</span> lyrics;<br />  <span class="hljs-built_in">String</span> author;<br /><br />  <span class="hljs-keyword">factory</span> Song.fromJson(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json) =&gt; _$SongFromJson(json);<br />}</span></pre><p name="5a6c" id="5a6c" class="graf graf--p graf-after--pre">此時 song.g.dart 也要更新才能處理變動的欄位。</p><figure name="7b99" id="7b99" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*dwZetWPK3ia07wdK4LqDig.png" data-width="1814" data-height="436" src="https://cdn-images-1.medium.com/max/800/1*dwZetWPK3ia07wdK4LqDig.png"></figure><p name="772a" id="772a" class="graf graf--p graf-after--figure">在 IDE 的 terminal 輸入以下指令重新生成 song.g.dart。</p><pre data-code-block-mode="0" spellcheck="false" name="177d" id="177d" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">dart run build_runner build --delete-conflicting-outputs</span></pre><p name="20ea" id="20ea" class="graf graf--p graf-after--pre">學會套件 json_serializable 的用法後，以下我們再多看幾個應用的例子。</p><h3 name="f585" id="f585" class="graf graf--h3 graf-after--p">當 JSON 的內容是 object 包 array</h3><p name="3f63" id="3f63" class="graf graf--p graf-after--h3">以 iTunes API <code class="markup--code markup--p-code">https://itunes.apple.com/search?term=swift&amp;media=music</code>為例，它的 JSON 內容如下。</p><figure name="bd6e" id="bd6e" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*TYjOaXxCuKb6whAzJ-VCQg.png" data-width="894" data-height="1098" src="https://cdn-images-1.medium.com/max/800/1*TYjOaXxCuKb6whAzJ-VCQg.png"></figure><p name="88df" id="88df" class="graf graf--p graf-after--figure">定義 JSON object 對應的 Item &amp; SearchResponse。</p><ul class="postList"><li name="832a" id="832a" class="graf graf--li graf-after--p">item.dart。</li></ul><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="dart" name="53bc" id="53bc" class="graf graf--pre graf-after--li graf--preV2"><span class="pre--content"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:json_annotation/json_annotation.dart&#x27;</span>;<br /><span class="hljs-keyword">part</span> <span class="hljs-string">&#x27;item.g.dart&#x27;</span>;<br /><br /><span class="hljs-meta">@JsonSerializable</span>()<br /><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Item</span> </span>{<br />  Item(<span class="hljs-keyword">this</span>.trackName, <span class="hljs-keyword">this</span>.artistName);<br /><br />  <span class="hljs-built_in">String</span> trackName;<br />  <span class="hljs-built_in">String</span> artistName;<br /><br />  <span class="hljs-keyword">factory</span> Item.fromJson(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json) =&gt; _$ItemFromJson(json);<br />}</span></pre><ul class="postList"><li name="764d" id="764d" class="graf graf--li graf-after--pre">search_response.dart。</li></ul><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="dart" name="2b15" id="2b15" class="graf graf--pre graf-after--li graf--preV2"><span class="pre--content"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:json_annotation/json_annotation.dart&#x27;</span>;<br /><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;item.dart&#x27;</span>;<br /><span class="hljs-keyword">part</span> <span class="hljs-string">&#x27;search_response.g.dart&#x27;</span>;<br /><br /><span class="hljs-meta">@JsonSerializable</span>()<br /><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SearchResponse</span> </span>{<br />  SearchResponse(<span class="hljs-keyword">this</span>.results);<br />  <span class="hljs-built_in">List</span>&lt;Item&gt; results;<br /><br />  <span class="hljs-keyword">factory</span> SearchResponse.fromJson(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json) =&gt; _$SearchResponseFromJson(json);<br />}</span></pre><p name="bb24" id="bb24" class="graf graf--p graf-after--pre">執行 <code class="markup--code markup--p-code">dart run build_runner build — delete-conflicting-outputs</code> 產生 item.g.dart 和 search_response.g.dart。</p><ul class="postList"><li name="6ced" id="6ced" class="graf graf--li graf-after--p">item.g.dart。</li></ul><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="dart" name="ef95" id="ef95" class="graf graf--pre graf-after--li graf--preV2"><span class="pre--content"><span class="hljs-comment">// GENERATED CODE - DO NOT MODIFY BY HAND</span><br /><br /><span class="hljs-keyword">part</span> of <span class="hljs-string">&#x27;item.dart&#x27;</span>;<br /><br /><span class="hljs-comment">// **************************************************************************</span><br /><span class="hljs-comment">// JsonSerializableGenerator</span><br /><span class="hljs-comment">// **************************************************************************</span><br /><br />Item _$ItemFromJson(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json) =&gt; Item(<br />      json[<span class="hljs-string">&#x27;trackName&#x27;</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">String</span>,<br />      json[<span class="hljs-string">&#x27;artistName&#x27;</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">String</span>,<br />    );<br /><br /><span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; _$ItemToJson(Item instance) =&gt; &lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;{<br />      <span class="hljs-string">&#x27;trackName&#x27;</span>: instance.trackName,<br />      <span class="hljs-string">&#x27;artistName&#x27;</span>: instance.artistName,<br />    };</span></pre><ul class="postList"><li name="0fdf" id="0fdf" class="graf graf--li graf-after--pre">search_response.g.dart。</li></ul><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="dart" name="9163" id="9163" class="graf graf--pre graf-after--li graf--preV2"><span class="pre--content"><span class="hljs-comment">// GENERATED CODE - DO NOT MODIFY BY HAND</span><br /><br /><span class="hljs-keyword">part</span> of <span class="hljs-string">&#x27;search_response.dart&#x27;</span>;<br /><br /><span class="hljs-comment">// **************************************************************************</span><br /><span class="hljs-comment">// JsonSerializableGenerator</span><br /><span class="hljs-comment">// **************************************************************************</span><br /><br />SearchResponse _$SearchResponseFromJson(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json) =&gt;<br />    SearchResponse(<br />      (json[<span class="hljs-string">&#x27;results&#x27;</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">dynamic</span>&gt;)<br />          .map((e) =&gt; Item.fromJson(e <span class="hljs-keyword">as</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;))<br />          .toList(),<br />    );<br /><br /><span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; _$SearchResponseToJson(SearchResponse instance) =&gt;<br />    &lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;{<br />      <span class="hljs-string">&#x27;results&#x27;</span>: instance.results,<br />    };</span></pre><p name="a005" id="a005" class="graf graf--p graf-after--pre">用 jsonDecode 解碼 iTunes API 抓到的 JSON 後，使用 SearchResponse.fromJson 將它轉換成 SearchResponse。</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="dart" name="a1fc" id="a1fc" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">void</span> main() <span class="hljs-keyword">async</span> {<br />  <span class="hljs-keyword">var</span> response = <span class="hljs-keyword">await</span> http.<span class="hljs-keyword">get</span>(<span class="hljs-built_in">Uri</span>.parse(<br />      <span class="hljs-string">&#x27;https://itunes.apple.com/search?term=swift&amp;media=music&#x27;</span>));<br />  <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; map = jsonDecode(response.body);<br />  <span class="hljs-keyword">var</span> searchResponse = SearchResponse.fromJson(map);<br />  <span class="hljs-built_in">print</span>(searchResponse.results.length);<br />  <span class="hljs-built_in">print</span>(searchResponse.results[<span class="hljs-number">0</span>].trackName);<br />}</span></pre><h3 name="3b73" id="3b73" class="graf graf--h3 graf-after--pre">當 JSON 的第一層是 array，array 的成員是 object</h3><p name="cb36" id="cb36" class="graf graf--p graf-after--h3">以 GitHub API <code class="markup--code markup--p-code">https://api.github.com/users/twostraws/followers</code>為例。</p><figure name="7312" id="7312" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*OzZyTv-qcZgeJ8U9j9TW1w.png" data-width="902" data-height="978" src="https://cdn-images-1.medium.com/max/800/1*OzZyTv-qcZgeJ8U9j9TW1w.png"></figure><p name="cbc0" id="cbc0" class="graf graf--p graf-after--figure">定義 JSON object 對應的 Follower。</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="dart" name="6d17" id="6d17" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:json_annotation/json_annotation.dart&#x27;</span>;<br /><span class="hljs-keyword">part</span> <span class="hljs-string">&#x27;follower.g.dart&#x27;</span>;<br /><br /><span class="hljs-meta">@JsonSerializable</span>()<br /><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Follower</span> </span>{<br />  Follower(<span class="hljs-keyword">this</span>.login, <span class="hljs-keyword">this</span>.id);<br /><br />  <span class="hljs-built_in">String</span> login;<br />  <span class="hljs-built_in">int</span> id;<br /><br />  <span class="hljs-keyword">factory</span> Follower.fromJson(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json) =&gt; _$FollowerFromJson(json);<br />}</span></pre><p name="95d8" id="95d8" class="graf graf--p graf-after--pre">執行 <code class="markup--code markup--p-code">dart run build_runner build — delete-conflicting-outputs</code> 產生 follow.g.dart。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="dart" name="889a" id="889a" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-comment">// GENERATED CODE - DO NOT MODIFY BY HAND</span><br /><br /><span class="hljs-keyword">part</span> of <span class="hljs-string">&#x27;follower.dart&#x27;</span>;<br /><br /><span class="hljs-comment">// **************************************************************************</span><br /><span class="hljs-comment">// JsonSerializableGenerator</span><br /><span class="hljs-comment">// **************************************************************************</span><br /><br />Follower _$FollowerFromJson(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json) =&gt; Follower(<br />      json[<span class="hljs-string">&#x27;login&#x27;</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">String</span>,<br />      json[<span class="hljs-string">&#x27;id&#x27;</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">int</span>,<br />    );<br /><br /><span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; _$FollowerToJson(Follower instance) =&gt; &lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;{<br />      <span class="hljs-string">&#x27;login&#x27;</span>: instance.login,<br />      <span class="hljs-string">&#x27;id&#x27;</span>: instance.id,<br />    };</span></pre><p name="e811" id="e811" class="graf graf--p graf-after--pre">用 jsonDecode 解碼 GitHub API 抓到的 JSON 後，使用 map 和 Follower.fromJson 將 List 的成員轉換成 Follower。</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="dart" name="ae56" id="ae56" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">void</span> main() <span class="hljs-keyword">async</span> {<br />  <span class="hljs-keyword">var</span> response = <span class="hljs-keyword">await</span> http<br />      .<span class="hljs-keyword">get</span>(<span class="hljs-built_in">Uri</span>.parse(<span class="hljs-string">&#x27;https://api.github.com/users/twostraws/followers&#x27;</span>));<br />  <span class="hljs-built_in">List</span> followerMaps = jsonDecode(response.body);<br />  <span class="hljs-keyword">var</span> followers = [...followerMaps.map((e) =&gt; Follower.fromJson(e))];<br />  <span class="hljs-built_in">print</span>(followers.length);<br />  <span class="hljs-built_in">print</span>(followers[<span class="hljs-number">0</span>].login);<br />}</span></pre><h3 name="6ef2" id="6ef2" class="graf graf--h3 graf-after--pre">當 JSON 的 key 不一定存在時</h3><p name="64aa" id="64aa" class="graf graf--p graf-after--h3">有時候 JSON 的 key 不是必要欄位，以剛剛的 iTunes API 為例，它回傳的資料不一定會有 collectionArtistName。</p><p name="bad2" id="bad2" class="graf graf--p graf-after--p">若我們在 class Item 加上 String collectionArtistName，程式將 JSON 轉換成 Item 時會出現錯誤。</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="dart" name="a030" id="a030" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:json_annotation/json_annotation.dart&#x27;</span>;<br /><span class="hljs-keyword">part</span> <span class="hljs-string">&#x27;item.g.dart&#x27;</span>;<br /><br /><span class="hljs-meta">@JsonSerializable</span>()<br /><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Item</span> </span>{<br />  Item(<span class="hljs-keyword">this</span>.trackName, <span class="hljs-keyword">this</span>.artistName, <span class="hljs-keyword">this</span>.collectionArtistName);<br /><br />  <span class="hljs-built_in">String</span> trackName;<br />  <span class="hljs-built_in">String</span> artistName;<br />  <span class="hljs-built_in">String</span> collectionArtistName;<br /><br />  <span class="hljs-keyword">factory</span> Item.fromJson(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json) =&gt; _$ItemFromJson(json);<br />}</span></pre><p name="2d30" id="2d30" class="graf graf--p graf-after--pre">當 key collectionArtistName 不存在時，item.g.dart 裡使用 as String 轉型成字串的地方會產生 exception。</p><figure name="786f" id="786f" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*LXkHZOQ_3jdreAeyKek6vg.png" data-width="1896" data-height="992" src="https://cdn-images-1.medium.com/max/800/1*LXkHZOQ_3jdreAeyKek6vg.png"></figure><p name="a9b0" id="a9b0" class="graf graf--p graf-after--figure">因此遇到可能不存在的 key，宣告時要加上問號，改成 <code class="markup--code markup--p-code">String? collectionArtistName</code>。</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="dart" name="4b5f" id="4b5f" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:json_annotation/json_annotation.dart&#x27;</span>;<br /><span class="hljs-keyword">part</span> <span class="hljs-string">&#x27;item.g.dart&#x27;</span>;<br /><br /><span class="hljs-meta">@JsonSerializable</span>()<br /><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Item</span> </span>{<br />  Item(<span class="hljs-keyword">this</span>.trackName, <span class="hljs-keyword">this</span>.artistName, <span class="hljs-keyword">this</span>.collectionArtistName);<br /><br />  <span class="hljs-built_in">String</span> trackName;<br />  <span class="hljs-built_in">String</span> artistName;<br />  <span class="hljs-built_in">String?</span> collectionArtistName;<br /><br />  <span class="hljs-keyword">factory</span> Item.fromJson(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json) =&gt; _$ItemFromJson(json);<br />}</span></pre><p name="a791" id="a791" class="graf graf--p graf-after--pre">如此 item.g.dart 轉型的程式將變成 <code class="markup--code markup--p-code">as String?</code>，當 key collectionArtistName 不存在時也不會造成 exception。</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="dart" name="f2bc" id="f2bc" class="graf graf--pre graf-after--p graf--trailing graf--preV2"><span class="pre--content">Item _$ItemFromJson(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json) =&gt; Item(<br />      json[<span class="hljs-string">&#x27;trackName&#x27;</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">String</span>,<br />      json[<span class="hljs-string">&#x27;artistName&#x27;</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">String</span>,<br />      json[<span class="hljs-string">&#x27;collectionArtistName&#x27;</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">String?</span>,<br />    );</span></pre></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@apppeterpan" class="p-author h-card">彼得潘的 iOS App Neverland</a> on <a href="https://medium.com/p/6dbaaa4109ec"><time class="dt-published" datetime="2024-08-22T08:32:20.872Z">August 22, 2024</time></a>.</p><p><a href="https://medium.com/@apppeterpan/%E4%BD%BF%E7%94%A8%E5%A5%97%E4%BB%B6-json-serializable-%E7%94%9F%E6%88%90%E5%B0%87-json-%E8%BD%89%E6%8F%9B%E6%88%90%E8%87%AA%E8%A8%82%E5%9E%8B%E5%88%A5%E7%9A%84%E7%A8%8B%E5%BC%8F-6dbaaa4109ec" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on September 17, 2025.</p></footer></article></body></html>