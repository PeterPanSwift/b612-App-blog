<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>使用 Compositional Layout 的 visibleItemsInvalidationHandler 更新 page control &amp; 實現無限循環的分頁</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">使用 Compositional Layout 的 visibleItemsInvalidationHandler 更新 page control &amp; 實現無限循環的分頁</h1>
</header>
<section data-field="subtitle" class="p-summary">
利用 Compositional Layout collection view 搭配 orthogonalScrollingBehavior groupPagingCentered，我們可以快速實現下圖的效果，整個頁面上下捲動，裡面的某些 section…
</section>
<section data-field="body" class="e-content">
<section name="4b6b" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="4a9a" id="4a9a" class="graf graf--h3 graf--leading graf--title">使用 Compositional Layout 的 visibleItemsInvalidationHandler 更新 page control &amp; 實現無限循環的分頁</h3><p name="474e" id="474e" class="graf graf--p graf-after--h3">利用 Compositional Layout collection view 搭配 orthogonalScrollingBehavior groupPagingCentered，我們可以快速實現下圖的效果，整個頁面上下捲動，裡面的某些 section 可水平分頁捲動，而且還能看到上一個 / 下一個項目的部分內容。</p><figure name="984a" id="984a" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*ObLwuTPbDtg7OWKbrlg1vA.png" data-width="1054" data-height="1118" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*ObLwuTPbDtg7OWKbrlg1vA.png"></figure><p name="64ef" id="64ef" class="graf graf--p graf-after--figure">不過若想加入小圓點 page control 跟無限循環的分頁效果，卻不是那麼容易，因為當 section 因 orthogonalScrollingBehavior 變成水平捲動時，section 裡的水平捲動並不會觸發 scroll view delegate 的 scrollViewDidScroll(_:) 或 scrollViewDidEndDecelerating(_:)。</p><p name="4b7e" id="4b7e" class="graf graf--p graf-after--p">那我們要怎麼偵測它的捲動呢? 關鍵在 section 的 visibleItemsInvalidationHandler。以下我們先完成基本的 Compositional Layout 畫面，然後再說明如何利用 visibleItemsInvalidationHandler 更新 page control &amp; 實現無限循環。</p><p name="ad96" id="ad96" class="graf graf--p graf-after--p">ps: 對 Compositional Layout 不熟的朋友可先參考以下連結。以下做法請在 iOS 15(包含 15) 之後的版本測試，在 iOS 14 測試會有問題。</p><div name="99e6" id="99e6" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E6%96%B9%E4%BE%BF%E6%8E%92%E7%89%88%E7%9A%84-uicollectionviewcompositionallayout-%E5%88%9D%E9%AB%94%E9%A9%97-ab0c81ffecf6" data-href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E6%96%B9%E4%BE%BF%E6%8E%92%E7%89%88%E7%9A%84-uicollectionviewcompositionallayout-%E5%88%9D%E9%AB%94%E9%A9%97-ab0c81ffecf6" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E6%96%B9%E4%BE%BF%E6%8E%92%E7%89%88%E7%9A%84-uicollectionviewcompositionallayout-%E5%88%9D%E9%AB%94%E9%A9%97-ab0c81ffecf6"><strong class="markup--strong markup--mixtapeEmbed-strong">方便排版的 UICollectionViewCompositionalLayout 初體驗</strong><br><em class="markup--em markup--mixtapeEmbed-em">從 iOS 13 開始，iOS SDK 推出了 UICollectionViewCompositionalLayout，幫助我們更方便排版 collection view 的內容。從前在 collection view…</em>medium.com</a><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E6%96%B9%E4%BE%BF%E6%8E%92%E7%89%88%E7%9A%84-uicollectionviewcompositionallayout-%E5%88%9D%E9%AB%94%E9%A9%97-ab0c81ffecf6" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="657ce4c60bdcbb5624188243fff81105" data-thumbnail-img-id="1*mojzsw0mWBBSBz170jVk9Q.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*mojzsw0mWBBSBz170jVk9Q.png);"></a></div><h3 name="4942" id="4942" class="graf graf--h3 graf-after--mixtapeEmbed">實作某些 section 可水平分頁捲動，而且還能看到上一個 / 下一個項目的部分內容</h3><ul class="postList"><li name="7c1d" id="7c1d" class="graf graf--li graf-after--h3">安裝顯示網路圖片的套件 Kingfisher</li></ul><div name="8324" id="8324" class="graf graf--mixtapeEmbed graf-after--li"><a href="https://github.com/onevcat/Kingfisher" data-href="https://github.com/onevcat/Kingfisher" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://github.com/onevcat/Kingfisher"><strong class="markup--strong markup--mixtapeEmbed-strong">GitHub - onevcat/Kingfisher: A lightweight, pure-Swift library for downloading and caching images…</strong><br><em class="markup--em markup--mixtapeEmbed-em">Kingfisher is a powerful, pure-Swift library for downloading and caching images from the web. It provides you a chance…</em>github.com</a><a href="https://github.com/onevcat/Kingfisher" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="ac7df29d878719cf1e60deab10917239" data-thumbnail-img-id="0*jjIJEEMLkyEhh3Vj" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*jjIJEEMLkyEhh3Vj);"></a></div><ul class="postList"><li name="926b" id="926b" class="graf graf--li graf-after--mixtapeEmbed">定義產生 reuseIdentifier 的 extension</li></ul><pre name="6ddb" id="6ddb" class="graf graf--pre graf-after--li">extension UICollectionReusableView {<br>    static var reuseIdentifier: String { &quot;\(Self.self)&quot; }<br>}</pre><ul class="postList"><li name="6578" id="6578" class="graf graf--li graf-after--pre">CatCollectionViewController</li></ul><p name="1333" id="1333" class="graf graf--p graf-after--li">分成兩個 section 顯示可愛貓咪的圖片，圖片來自 CATAAS API。</p><p name="454b" id="454b" class="graf graf--p graf-after--p"><a href="https://cataas.com" data-href="https://cataas.com" class="markup--anchor markup--p-anchor" rel="noopener ugc nofollow noopener noopener" target="_blank">https://cataas.com</a></p><p name="17ff" id="17ff" class="graf graf--p graf-after--p">第一個 section 利用 orthogonalScrollingBehavior = .groupPagingCentered 實現水平滑動 &amp; 露出上一個 / 下一個項目的分頁效果。為了模擬網路抓資料的效果，我們設定一秒鐘後才填入 array 的資料。</p><pre name="1bd1" id="1bd1" class="graf graf--pre graf-after--p">import UIKit<br>import Kingfisher</pre><pre name="3cb3" id="3cb3" class="graf graf--pre graf-after--pre">class CatCollectionViewController: UICollectionViewController {<br>    <br>    var orangeCatIds = [String]()<br>    var hatCatIds = [String]()<br>    var catSections = [[String]]()<br>        <br>    override func viewDidLoad() {<br>        super.viewDidLoad()<br>        <br>        collectionView.collectionViewLayout = generateLayout()<br>        fetchCats()<br>        <br>    }<br>    <br>    func fetchCats() {<br>        <strong class="markup--strong markup--pre-strong">DispatchQueue.main.asyncAfter(deadline: .now()+1)</strong> { [self] in<br>            orangeCatIds = [<br>                &quot;595f280f557291a9750ebfb7&quot;,<br>                &quot;595f2809557291a9750ebf31&quot;,<br>                &quot;595f2810557291a9750ebfd7&quot;<br>            ]<br>            hatCatIds = [<br>                &quot;6010b5cb47d128001b7bbb7c&quot;,<br>                &quot;595f280e557291a9750ebfa6&quot;,<br>                &quot;595f2809557291a9750ebf35&quot;<br>            ]<br>            catSections = [orangeCatIds, hatCatIds]<br>            collectionView.reloadData()<br>        }<br>       <br>    }<br>    <br>    <br>    func generateLayout() -&gt; UICollectionViewLayout {<br>        <br>        UICollectionViewCompositionalLayout { [unowned self] section, environment in<br>            if section == 0 {<br>                return horizontalScrollLayoutSection<br>            } else {<br>                return verticalScrollLayoutSection<br>            }<br>        }<br>    }<br>    <br>    <br>     var horizontalScrollLayoutSection: NSCollectionLayoutSection {<br>        let sectionMargin = 15.0<br>        let itemInset = 5.0<br>        let pageWidth = collectionView.bounds.width - sectionMargin * 2<br>        let itemSize = NSCollectionLayoutSize(widthDimension: .fractionalWidth(1), heightDimension: .fractionalWidth(1))<br>        let item = NSCollectionLayoutItem(layoutSize: itemSize)<br>        item.contentInsets = NSDirectionalEdgeInsets(top: 0, leading: itemInset, bottom: 0, trailing: itemInset)<br>        let groupSize = NSCollectionLayoutSize(widthDimension: .absolute(pageWidth), heightDimension: .estimated(100))<br>        let group = NSCollectionLayoutGroup.horizontal(layoutSize: groupSize, subitems: [item])<br>        let section = NSCollectionLayoutSection(group: group)<br>        section.orthogonalScrollingBehavior = .groupPagingCentered<br>        section.contentInsets = NSDirectionalEdgeInsets(top: 0, leading: 0, bottom: 10, trailing: 0)</pre><pre name="c076" id="c076" class="graf graf--pre graf-after--pre">　　　　　return section<br>    }<br>    <br>    var verticalScrollLayoutSection: NSCollectionLayoutSection {<br>        let itemSize = NSCollectionLayoutSize(widthDimension: .fractionalWidth(1), heightDimension: .fractionalHeight(1))<br>        let item = NSCollectionLayoutItem(layoutSize: itemSize)<br>        let groupSize = NSCollectionLayoutSize(widthDimension: .fractionalWidth(1), heightDimension: .absolute(200))<br>        let group = NSCollectionLayoutGroup.horizontal(layoutSize: groupSize, subitems: [item])<br>        let section = NSCollectionLayoutSection(group: group)<br>        return section<br>    }<br>    <br>    <br>    // MARK: UICollectionViewDataSource<br>    <br>    override func numberOfSections(in collectionView: UICollectionView) -&gt; Int {<br>        return catSections.count<br>    }<br>    <br>    override func collectionView(_ collectionView: UICollectionView, numberOfItemsInSection section: Int) -&gt; Int {<br>        return catSections[section].count<br>    }<br>    <br>    override func collectionView(_ collectionView: UICollectionView, cellForItemAt indexPath: IndexPath) -&gt; UICollectionViewCell {<br>        let cell = collectionView.dequeueReusableCell(withReuseIdentifier: CatCollectionViewCell.reuseIdentifier, for: indexPath) as! CatCollectionViewCell<br>        <br>        let catId = catSections[indexPath.section][indexPath.item]<br>        let url = URL(string: &quot;<a href="https://cataas.com/cat/%5C%28catId%29" data-href="https://cataas.com/cat/\(catId)" class="markup--anchor markup--pre-anchor" rel="nofollow noopener" target="_blank">https://cataas.com/cat/\(catId)</a>&quot;)<br>        cell.imageView.kf.setImage(with: url)<br>        <br>        <br>        return cell<br>    }<br>    <br>    <br>}</pre><ul class="postList"><li name="7b5c" id="7b5c" class="graf graf--li graf-after--pre">CatCollectionViewCell</li></ul><pre name="c47c" id="c47c" class="graf graf--pre graf-after--li">class CatCollectionViewCell: UICollectionViewCell {<br>    <a href="http://twitter.com/IBOutlet" data-href="http://twitter.com/IBOutlet" class="markup--anchor markup--pre-anchor" title="Twitter profile for @IBOutlet" rel="noopener" target="_blank">@IBOutlet</a> weak var imageView: UIImageView!<br>    <br>}</pre><ul class="postList"><li name="addd" id="addd" class="graf graf--li graf-after--pre">Main.storyboard</li></ul><figure name="ac69" id="ac69" class="graf graf--figure graf-after--li"><img class="graf-image" data-image-id="1*7DP49oSX6Aa0gOIJDlqoWQ.png" data-width="1786" data-height="1202" src="https://cdn-images-1.medium.com/max/800/1*7DP49oSX6Aa0gOIJDlqoWQ.png"></figure><p name="a972" id="a972" class="graf graf--p graf-after--figure">將 cell 的 reuse id 設為 CatCollectionViewCell。</p><figure name="5c3e" id="5c3e" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*bP3jD-KbSWkDESvpZjvsKg.png" data-width="2800" data-height="448" src="https://cdn-images-1.medium.com/max/800/1*bP3jD-KbSWkDESvpZjvsKg.png"></figure><p name="5dfc" id="5dfc" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">結果</strong></p><figure name="d2d7" id="d2d7" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*ObLwuTPbDtg7OWKbrlg1vA.png" data-width="1054" data-height="1118" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*ObLwuTPbDtg7OWKbrlg1vA.png"></figure><h3 name="a363" id="a363" class="graf graf--h3 graf-after--figure">顯示分頁小圓點(page control)</h3><ul class="postList"><li name="c54d" id="c54d" class="graf graf--li graf-after--h3">宣告 UIPageControl 的 property。</li></ul><pre name="656f" id="656f" class="graf graf--pre graf-after--li">let pageControl = UIPageControl()</pre><ul class="postList"><li name="a36e" id="a36e" class="graf graf--li graf-after--pre">定義加入 page control 的 function</li></ul><pre name="5858" id="5858" class="graf graf--pre graf-after--li">func addPageControl() {<br>      <strong class="markup--strong markup--pre-strong">  guard let layoutAttributes = collectionView.layoutAttributesForItem(at: IndexPath(item: 0, section: 0)) else { return }</strong><br>        pageControl.translatesAutoresizingMaskIntoConstraints = false<br><strong class="markup--strong markup--pre-strong">        pageControl.layer.zPosition = 1<br></strong>        pageControl.numberOfPages = orangeCatIds.count<br>        pageControl.pageIndicatorTintColor = .gray<br>        pageControl.currentPageIndicatorTintColor = .orange<br>        collectionView.addSubview(pageControl)<br>        pageControl.centerXAnchor.constraint(equalTo: collectionView.frameLayoutGuide.centerXAnchor).isActive = true<br><strong class="markup--strong markup--pre-strong">        let constant = layoutAttributes.frame.maxY<br>        pageControl.bottomAnchor.constraint(equalTo: collectionView.contentLayoutGuide.topAnchor, constant: constant).isActive = true<br></strong>        pageControl.addTarget(self, action: #selector(changePage(_:)), for: .valueChanged)</pre><pre name="629e" id="629e" class="graf graf--pre graf-after--pre">}</pre><p name="c888" id="c888" class="graf graf--p graf-after--pre">說明</p><pre name="05d0" id="05d0" class="graf graf--pre graf-after--p">pageControl.layer.zPosition = 1</pre><p name="3a89" id="3a89" class="graf graf--p graf-after--pre">讓 page control 保持在最上層。若是沒有加這行，compositional layout 設定 orthogonalScrollingBehavior 的 section 將會蓋住 page control，比方下圖是 page control 被UICollectionViewOrthogonalScrollerEmbeddedScrollView 蓋住的情況。</p><figure name="6bb6" id="6bb6" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*-r9zVroXddUTIY_uhfzSyQ.png" data-width="940" data-height="488" src="https://cdn-images-1.medium.com/max/800/1*-r9zVroXddUTIY_uhfzSyQ.png"></figure><pre name="3c0d" id="3c0d" class="graf graf--pre graf-after--figure">let constant = layoutAttributes.frame.maxY<br>pageControl.bottomAnchor.constraint(equalTo: collectionView.contentLayoutGuide.topAnchor, constant: constant).isActive = true</pre><p name="7800" id="7800" class="graf graf--p graf-after--pre">如下圖所示，我們希望 page control 出現在第一個 section cell 底部的上方，因此我們利用 layoutAttributesForItem(at:) 取得第一個 cell 的位置資訊，從 layoutAttributes.frame.maxY 取得 cell 的下邊界數字，然後再設定 page control 的下邊界等於 collectionView.contentLayoutGuide 的上邊界 + cell 的下邊界數字。</p><figure name="c9cf" id="c9cf" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*3Xo0VfYRJWwpkdyL3Pw8bA.png" data-width="1170" data-height="2532" src="https://cdn-images-1.medium.com/max/800/1*3Xo0VfYRJWwpkdyL3Pw8bA.png"></figure><p name="12e7" id="12e7" class="graf graf--p graf-after--figure">ps: function changePage(_:) 等下會定義，它將在點選小圓點時觸發，我們將在 changePage 裡切換圖片。</p><ul class="postList"><li name="201f" id="201f" class="graf graf--li graf-after--p">設定貓的資料後加入 page control</li></ul><pre name="91e9" id="91e9" class="graf graf--pre graf-after--li">func fetchCats() {<br>        DispatchQueue.main.asyncAfter(deadline: .now()+1) { [self] in<br>            orangeCatIds = [<br>                &quot;595f280f557291a9750ebfb7&quot;,<br>                &quot;595f2809557291a9750ebf31&quot;,<br>                &quot;595f2810557291a9750ebfd7&quot;<br>            ]<br>            hatCatIds = [<br>                &quot;6010b5cb47d128001b7bbb7c&quot;,<br>                &quot;595f280e557291a9750ebfa6&quot;,<br>                &quot;595f2809557291a9750ebf35&quot;<br>            ]<br>            catSections = [orangeCatIds, hatCatIds]<br>            collectionView.reloadData()<br><strong class="markup--strong markup--pre-strong">            addPageControl()                <br>            </strong><br>        }<br>        <br>    }</pre><ul class="postList"><li name="233b" id="233b" class="graf graf--li graf-after--pre">設定水平捲動時更新 page control</li></ul><pre name="cba3" id="cba3" class="graf graf--pre graf-after--li">var horizontalScrollLayoutSection: NSCollectionLayoutSection {<br>        let sectionMargin = 15.0<br>        let itemInset = 5.0<br>        let pageWidth = collectionView.bounds.width - sectionMargin * 2<br>        let itemSize = NSCollectionLayoutSize(widthDimension: .fractionalWidth(1), heightDimension: .fractionalWidth(1))<br>        let item = NSCollectionLayoutItem(layoutSize: itemSize)<br>        item.contentInsets = NSDirectionalEdgeInsets(top: 0, leading: itemInset, bottom: 0, trailing: itemInset)<br>        let groupSize = NSCollectionLayoutSize(widthDimension: .absolute(pageWidth), heightDimension: .estimated(100))<br>        let group = NSCollectionLayoutGroup.horizontal(layoutSize: groupSize, subitems: [item])<br>        let section = NSCollectionLayoutSection(group: group)<br>        section.orthogonalScrollingBehavior = .groupPagingCentered<br>        section.contentInsets = NSDirectionalEdgeInsets(top: 0, leading: 0, bottom: 10, trailing: 0)<br>        <br>       <strong class="markup--strong markup--pre-strong"> section.visibleItemsInvalidationHandler = { [unowned self] visibleItems, point, environment in<br>            if let page = Int(exactly: (point.x + sectionMargin) / pageWidth) {<br>                pageControl.currentPage = page<br>            }<br>        }</strong><br>        <br>        return section<br>}</pre><p name="56a4" id="56a4" class="graf graf--p graf-after--pre">說明</p><ol class="postList"><li name="2a3c" id="2a3c" class="graf graf--li graf-after--p">偵測水平捲動</li></ol><p name="1dc5" id="1dc5" class="graf graf--p graf-after--li">當 section 因 orthogonalScrollingBehavior 變成水平捲動時，section 裡的水平捲動並不會觸發 scroll view delegate 的 scrollViewDidScroll(_:) 或 scrollViewDidEndDecelerating(_:)。</p><p name="5369" id="5369" class="graf graf--p graf-after--p">那我們要怎麼偵測它的捲動呢? 關鍵在 section 的 visibleItemsInvalidationHandler。當使用者水平捲動 section 時，將觸發 visibleItemsInvalidationHandler。closure 的參數 point 可告知我們捲動的位置，我們利用它計算目前在第幾個分頁，然後更新 page control。</p><p name="3114" id="3114" class="graf graf--p graf-after--p">2. 計算目前在第幾頁</p><p name="2657" id="2657" class="graf graf--p graf-after--p">顯示第一個 cell 時，point.x 為 -sectionMargin，而每次滑動分頁的寬度為 pageWidth，因此公式為<code class="markup--code markup--p-code"> (point.x + sectionMargin) / pageWidth</code>。</p><p name="630f" id="630f" class="graf graf--p graf-after--p">3. Int(exactly:)</p><p name="35b6" id="35b6" class="graf graf--p graf-after--p">為了確保只在分頁停在正確位置時更新 page control 的 currentPage，我們利用 Int(exactly:) 做判斷。Int(exactly:) 只在參數 exactly 為整數時會成功，否則會得到 nil，因此我們只在剛剛算出的數字為整數時會更新。</p><ul class="postList"><li name="9359" id="9359" class="graf graf--li graf-after--p">定義點選小圓點切換頁面的 changePage。</li></ul><pre name="b037" id="b037" class="graf graf--pre graf-after--li"><a href="http://twitter.com/objc" data-href="http://twitter.com/objc" class="markup--anchor markup--pre-anchor" title="Twitter profile for @objc" rel="noopener" target="_blank">@objc</a> func changePage(_ sender: UIPageControl) {<br>     collectionView.scrollToItem(at: IndexPath(item: sender.currentPage, section: 0), at: .centeredHorizontally, animated: true)<br>}</pre><p name="df15" id="df15" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">結果</strong></p><figure name="9acc" id="9acc" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*KLMKeWKP4bRSUmOTA1znkw.png" data-width="1060" data-height="1108" src="https://cdn-images-1.medium.com/max/800/1*KLMKeWKP4bRSUmOTA1znkw.png"></figure><h3 name="7bee" id="7bee" class="graf graf--h3 graf-after--figure">無限循環的分頁(infinite scroll)</h3><ul class="postList"><li name="84fa" id="84fa" class="graf graf--li graf-after--h3">無限循環的原理</li></ul><p name="bd8f" id="bd8f" class="graf graf--p graf-after--li">無限循環代表我們從第一張圖往右滑會滑到最後一張圖，從最後一張圖往左滑會滑到第一張圖。</p><p name="890e" id="890e" class="graf graf--p graf-after--p">為了實現無限循環，我們可在原本的資料 array 額外加入兩筆資料，在開頭加入原本的最後一筆資料，在結尾加入原本的第一筆資料。</p><p name="71c5" id="71c5" class="graf graf--p graf-after--p">為什麼這樣能實現無限循環呢 ? 讓我們用以下例子說明。</p><ol class="postList"><li name="2f68" id="2f68" class="graf graf--li graf-after--p">假設原本的三隻小貓如下</li></ol><p name="0ca6" id="0ca6" class="graf graf--p graf-after--li">圖片下為小貓的名字跟 cell 的 IndexPath item 數字。</p><figure name="eba6" id="eba6" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*UDalY-oY1ZCg5_i7e1wSug.png" data-width="1106" data-height="530" src="https://cdn-images-1.medium.com/max/800/1*UDalY-oY1ZCg5_i7e1wSug.png"></figure><p name="5baf" id="5baf" class="graf graf--p graf-after--figure">2. 在開頭加入原本的最後一筆資料，在結尾加入原本的第一筆資料。</p><figure name="d78c" id="d78c" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*2FMZiPEpnSE9F7aB1jJrBA.png" data-width="1656" data-height="508" src="https://cdn-images-1.medium.com/max/800/1*2FMZiPEpnSE9F7aB1jJrBA.png"></figure><p name="fa9a" id="fa9a" class="graf graf--p graf-after--figure">此時第一隻貓小貓 Ａ變成在 item 1，因此畫面出現後，我們要顯示的其實是第二個 cell。此時使用者往左滑可看到小貓 B，往右滑可看到小貓 C (原本的最後一隻貓)。</p><figure name="35c5" id="35c5" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*2Fp3WFQmYIRtJYhRJ20oUw.png" data-width="1684" data-height="536" src="https://cdn-images-1.medium.com/max/800/1*2Fp3WFQmYIRtJYhRJ20oUw.png"></figure><p name="d81b" id="d81b" class="graf graf--p graf-after--figure">3. 顯示最後一隻貓。</p><p name="f2d9" id="f2d9" class="graf graf--p graf-after--p">小貓 C 是原本的最後一隻貓。當我們從 item 1 往右滑到 item 0 時會顯示小貓 C。慘了，看來這時不能再往右滑了。</p><p name="fd35" id="fd35" class="graf graf--p graf-after--p">沒關係，我們可以作弊，偷偷切換到 item 3(倒數第二筆資料)，因為它顯示的也是小貓 C，所以使用者不會發現，而且他還可以繼續往右滑。</p><figure name="9727" id="9727" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*7CFQKNXksGMNMZBv2-lu2Q.png" data-width="1206" data-height="1202" src="https://cdn-images-1.medium.com/max/800/1*7CFQKNXksGMNMZBv2-lu2Q.png"></figure><p name="84b5" id="84b5" class="graf graf--p graf-after--figure">4. 顯示第一隻貓。</p><p name="c269" id="c269" class="graf graf--p graf-after--p">小貓 A 是原本的第一隻貓。當我們從 item 3 往左滑到 item 4 時會顯示小貓 A。慘了，看來這時不能再往左滑了。</p><p name="ec28" id="ec28" class="graf graf--p graf-after--p">沒關係，我們可以作弊，偷偷切換到 item 1 (第二筆資料)，因為它顯示的也是小貓 A，所以使用者不會發現，而且他還可以繼續往左滑。</p><figure name="8597" id="8597" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*PAu3FjsXnWnIb8LD8K7KvQ.png" data-width="1322" data-height="1258" src="https://cdn-images-1.medium.com/max/800/1*PAu3FjsXnWnIb8LD8K7KvQ.png"></figure><p name="dd77" id="dd77" class="graf graf--p graf-after--figure">因此利用頭尾新增的資料跟偷偷切換顯示的 cell，我們將可實現無限循環的效果。接下來讓我們修改剛剛的程式，實現無限循環的分頁效果。</p><ul class="postList"><li name="c4d9" id="c4d9" class="graf graf--li graf-after--p">定義 function addDataForInfiniteScroll，在 array 的頭尾新增資料。</li></ul><p name="c758" id="c758" class="graf graf--p graf-after--li">在 array 的開頭加入原本的最後一筆資料，在結尾加入原本的第一筆資料。</p><pre name="19c7" id="19c7" class="graf graf--pre graf-after--p">func addDataForInfiniteScroll() {<br>        guard !orangeCatIds.isEmpty else { return }<br>        let firstId = orangeCatIds.first!<br>        let lastId = orangeCatIds.last!<br>        orangeCatIds.insert(lastId, at: 0)<br>        orangeCatIds.append(firstId)<br>}</pre><ul class="postList"><li name="cd8f" id="cd8f" class="graf graf--li graf-after--pre">呼叫 addDataForInfiniteScroll &amp; 顯示第二個 cell。</li></ul><p name="9865" id="9865" class="graf graf--p graf-after--li">抓到貓咪資料後，呼叫 addDataForInfiniteScroll 新增兩筆資料。此時原本的第一貓變成在 IndexPath(item: 1, section: 0)，因此我們呼叫 scrollToItem，讓畫面一開始顯示第二個 cell。</p><pre name="3b42" id="3b42" class="graf graf--pre graf-after--p">func fetchCats() {<br>        DispatchQueue.main.asyncAfter(deadline: .now()+1) { [self] in<br>            orangeCatIds = [<br>                &quot;595f280f557291a9750ebfb7&quot;,<br>                &quot;595f2809557291a9750ebf31&quot;,<br>                &quot;595f2810557291a9750ebfd7&quot;<br>            ]<br>            hatCatIds = [<br>                &quot;6010b5cb47d128001b7bbb7c&quot;,<br>                &quot;595f280e557291a9750ebfa6&quot;,<br>                &quot;595f2809557291a9750ebf35&quot;<br>            ]<br>            addDataForInfiniteScroll()<br>            catSections = [orangeCatIds, hatCatIds]<br>            collectionView.reloadData()<br>            collectionView.scrollToItem(at: IndexPath(item: 1, section: 0), at: .centeredHorizontally, animated: false)<br>            addPageControl()</pre><pre name="c755" id="c755" class="graf graf--pre graf-after--pre">        }<br>}</pre><ul class="postList"><li name="0bed" id="0bed" class="graf graf--li graf-after--pre">更新小圓點的數量</li></ul><p name="aaef" id="aaef" class="graf graf--p graf-after--li">將小圓點的數量 numberOfPages 設成 array 成員的數量減 2，因為它才是貓咪真正的數量。</p><pre name="8c6f" id="8c6f" class="graf graf--pre graf-after--p">func addPageControl() {<br>        guard let layoutAttributes = collectionView.layoutAttributesForItem(at: IndexPath(item: 0, section: 0)) else { return }<br>        pageControl.translatesAutoresizingMaskIntoConstraints = false<br><strong class="markup--strong markup--pre-strong">        pageControl.numberOfPages = orangeCatIds.count - 2<br></strong>        pageControl.pageIndicatorTintColor = .gray<br>        pageControl.currentPageIndicatorTintColor = .orange<br>        collectionView.addSubview(pageControl)<br>        pageControl.centerXAnchor.constraint(equalTo: collectionView.centerXAnchor).isActive = true<br>        let constant = layoutAttributes.frame.maxY<br>        pageControl.bottomAnchor.constraint(equalTo: collectionView.contentLayoutGuide.topAnchor, constant: constant).isActive = true<br>}</pre><ul class="postList"><li name="1c3b" id="1c3b" class="graf graf--li graf-after--pre">水平滑動時視情況切換顯示的 cell。</li></ul><pre name="af21" id="af21" class="graf graf--pre graf-after--li">section.visibleItemsInvalidationHandler = { [unowned self] visibleItems, point, environment in<br>            if var page = Int(exactly: (point.x + sectionMargin) / pageWidth) {<br>                let maxIndex = orangeCatIds.indices.max()!<br>                if page == maxIndex {<br>                    page = 1<br>                } else if page == 0 {<br>                    page = maxIndex - 1<br>                }<br>                let realPage = page - 1<br>                if pageControl.currentPage != realPage {<br>                    pageControl.currentPage = realPage<br>                    collectionView.scrollToItem(at: IndexPath(item: page, section: 0), at: .centeredHorizontally, animated: false)<br>                }<br>            }<br>}</pre><p name="d87c" id="d87c" class="graf graf--p graf-after--pre">說明</p><pre name="f642" id="f642" class="graf graf--pre graf-after--p">if page == maxIndex {<br>    page = 1<br>} else if page == 0 {<br>    page = maxIndex - 1<br>}</pre><p name="2f17" id="2f17" class="graf graf--p graf-after--pre">滑到最後一個 cell 時，表示要顯示第一筆資料，因此切換到第二個 cell， page 設為 1。滑到第一個 cell 時，表示要顯示最後一筆資料，因此切換到倒數第二個 cell，page 設為 maxIndex 減 1。</p><pre name="b8fc" id="b8fc" class="graf graf--pre graf-after--p">let realPage = page - 1</pre><p name="fbc4" id="fbc4" class="graf graf--p graf-after--pre">由於 array 的開頭額外加了一筆資料，第一筆資料變成在第二個 cell，因此 page 減 1 才是真正 page 的數字。</p><pre name="a32d" id="a32d" class="graf graf--pre graf-after--p">if pageControl.currentPage != realPage {<br>    pageControl.currentPage = realPage<br>    collectionView.scrollToItem(at: IndexPath(item: page, section: 0), at: .centeredHorizontally, animated: false)<br>}</pre><p name="877f" id="877f" class="graf graf--p graf-after--pre">只有在 page 有變動時需更改 currentPage &amp; 更新顯示的 cell。</p><p name="f8f8" id="f8f8" class="graf graf--p graf-after--p">ps: 值得注意的，當我們上下滑動時，也可能觸發 section 的 visibleItemsInvalidationHandler。剛剛的程式若沒有加上 if 檢查是否須更新 page，在上下 scroll 時可能會造成 App 閃退。</p><ul class="postList"><li name="57ab" id="57ab" class="graf graf--li graf-after--p">更新點選小圓點切換頁面的 changePage。</li></ul><p name="5407" id="5407" class="graf graf--p graf-after--li">由於 array 的開頭額外加了一筆資料，sender.currentPage+1 才是我們要顯示的 cell。</p><pre name="69d5" id="69d5" class="graf graf--pre graf-after--p"><a href="http://twitter.com/objc" data-href="http://twitter.com/objc" class="markup--anchor markup--pre-anchor" title="Twitter profile for @objc" rel="noopener" target="_blank">@objc</a> func changePage(_ sender: UIPageControl) {<br>     collectionView.scrollToItem(at: IndexPath(item: <strong class="markup--strong markup--pre-strong">sender.currentPage+1</strong>, section: 0), at: .centeredHorizontally, animated: true)<br>}</pre><p name="a26a" id="a26a" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">結果</strong></p><figure name="93fa" id="93fa" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*CBpBpkDFXCxBwxn_CfqHng.png" data-width="1170" data-height="2532" src="https://cdn-images-1.medium.com/max/800/1*CBpBpkDFXCxBwxn_CfqHng.png"></figure><h3 name="06b7" id="06b7" class="graf graf--h3 graf-after--figure">範例程式連結</h3><div name="6751" id="6751" class="graf graf--mixtapeEmbed graf-after--h3 graf--trailing"><a href="https://github.com/AppPeterPan/CompositionalLayoutWithPageControlAndInfiniteScroll2" data-href="https://github.com/AppPeterPan/CompositionalLayoutWithPageControlAndInfiniteScroll2" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://github.com/AppPeterPan/CompositionalLayoutWithPageControlAndInfiniteScroll2"><strong class="markup--strong markup--mixtapeEmbed-strong">GitHub - AppPeterPan/CompositionalLayoutWithPageControlAndInfiniteScroll2</strong><br><em class="markup--em markup--mixtapeEmbed-em">You can&#39;t perform that action at this time. You signed in with another tab or window. You signed out in another tab or…</em>github.com</a><a href="https://github.com/AppPeterPan/CompositionalLayoutWithPageControlAndInfiniteScroll2" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="4781f13e046f309d6853be78a3446b0c" data-thumbnail-img-id="0*SqLhdss5x9s4Hbdk" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*SqLhdss5x9s4Hbdk);"></a></div></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@apppeterpan" class="p-author h-card">彼得潘的 iOS App Neverland</a> on <a href="https://medium.com/p/a3049ab9c1aa"><time class="dt-published" datetime="2022-02-17T09:21:30.498Z">February 17, 2022</time></a>.</p><p><a href="https://medium.com/@apppeterpan/%E4%BD%BF%E7%94%A8-compositional-layout-%E7%9A%84-visibleitemsinvalidationhandler-%E6%9B%B4%E6%96%B0-page-control-%E5%AF%A6%E7%8F%BE%E7%84%A1%E9%99%90%E5%BE%AA%E7%92%B0%E7%9A%84%E5%88%86%E9%A0%81-a3049ab9c1aa" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on November 16, 2025.</p></footer></article></body></html>