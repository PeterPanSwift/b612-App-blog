<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>透過 encode(to:) 將  JSON 裡的 array 或物件變成字串上傳</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">透過 encode(to:) 將  JSON 裡的 array 或物件變成字串上傳</h1>
</header>
<section data-field="subtitle" class="p-summary">
透過 JSONEncoder 的幫忙，我們可以將自訂型別的資料轉換成 Data 型別，上傳 JSON 格式的資料到後台。例如以下例子:
</section>
<section data-field="body" class="e-content">
<section name="6eb8" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="67aa" id="67aa" class="graf graf--h3 graf--leading graf--title">透過 encode(to:) 將 JSON 裡的 array 或物件變成字串上傳</h3><p name="d744" id="d744" class="graf graf--p graf-after--h3">透過 JSONEncoder 的幫忙，我們可以將自訂型別的資料轉換成 Data 型別，上傳 JSON 格式的資料到後台。例如以下例子:</p><pre name="697b" id="697b" class="graf graf--pre graf-after--p">struct Profile: Codable {<br>    let name: String<br>    let gender: String<br>    let healthInfo: HealthInfo<br>}</pre><pre name="49c7" id="49c7" class="graf graf--pre graf-after--pre">struct HealthInfo: Codable {<br>    let weight: Double<br>    let height: Double<br>}<br>let healthInfo = HealthInfo(weight: 60, height: 171)<br>let profile = Profile(name: &quot;peter&quot;, gender: &quot;man&quot;, healthInfo: healthInfo)<br>if let data = try? JSONEncoder().encode(profile),<br>   let content = String(data: data, encoding: .utf8) {<br>    print(content)<br>}</pre><p name="735f" id="735f" class="graf graf--p graf-after--pre">若我們將上傳的 Data 型別資料變成字串印出，可看到 JSON 的內容如下:</p><pre name="7d02" id="7d02" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">{&quot;name&quot;:&quot;peter&quot;,&quot;healthInfo&quot;:{&quot;height&quot;:171,&quot;weight&quot;:60},&quot;gender&quot;:&quot;man&quot;}</strong></pre><p name="6395" id="6395" class="graf graf--p graf-after--pre">然而有些時候後台會要求包在多層 JSON 裡的物件或 array 包裝成字串，比方剛剛例子 JSON 裡的 healthInfo 內容變成以字串包裝的物件。</p><pre name="4307" id="4307" class="graf graf--pre graf-after--p">{&quot;name&quot;:&quot;peter&quot;,&quot;healthInfo&quot;:<strong class="markup--strong markup--pre-strong">&quot;{\&quot;height\&quot;:171,\&quot;weight\&quot;:60}&quot;</strong>,&quot;gender&quot;:&quot;man&quot;}</pre><h3 name="cecd" id="cecd" class="graf graf--h3 graf-after--pre">將物件包裝成字串</h3><p name="1e0e" id="1e0e" class="graf graf--p graf-after--h3">此時我們還是能透過 JSONEncoder 轉換，只是會麻煩點，得自己寫程式將 healthInfo 的內容變成字串，程式如下:</p><pre name="5363" id="5363" class="graf graf--pre graf-after--p">struct Profile: Codable {<br>    let name: String<br>    let gender: String<br>    let healthInfo: HealthInfo<br>    <br>  <strong class="markup--strong markup--pre-strong">  func encode(to encoder: Encoder) throws {<br>        var container = encoder.container(keyedBy: CodingKeys.self)<br>        try container.encode(name, forKey: .name)<br>        try container.encode(gender, forKey: .gender)<br>        if let healthInfo = try? JSONEncoder().encode(healthInfo),<br>           let healthInfoString = String(data: healthInfo, encoding: .utf8) {<br>            try container.encode(healthInfoString, forKey: .healthInfo)<br>        }<br>    }</strong><br>}</pre><pre name="ff70" id="ff70" class="graf graf--pre graf-after--pre">struct HealthInfo: Codable {<br>    let weight: Double<br>    let height: Double<br>}<br>let healthInfo = HealthInfo(weight: 60, height: 171)<br>let profile = Profile(name: &quot;peter&quot;, gender: &quot;man&quot;, healthInfo: healthInfo)<br>if let data = try? JSONEncoder().encode(profile),<br>   let content = String(data: data, encoding: .utf8) {<br>    print(content)<br>}</pre><p name="d818" id="d818" class="graf graf--p graf-after--pre">說明:</p><p name="51f3" id="51f3" class="graf graf--p graf-after--p"><code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">func encode(to encoder: Encoder) throws {</strong></code></p><p name="07c5" id="07c5" class="graf graf--p graf-after--p">為了自己控制自訂型別如何編碼成 Data，我們需要定義 function encode(to:)。</p><p name="b149" id="b149" class="graf graf--p graf-after--p"><code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">var container = encoder.container(keyedBy: CodingKeys.self)</strong></code></p><p name="88fb" id="88fb" class="graf graf--p graf-after--p">從 encoder 呼叫 container(keyedBy:)，取得包含 JSON 資料的 container。之後我們將利用 key 設定 container 的內容。</p><p name="031d" id="031d" class="graf graf--p graf-after--p"><code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">try container.encode(name, forKey: .name)</strong></code></p><p name="957b" id="957b" class="graf graf--p graf-after--p">呼叫 encode(_:forKey:)，將 key name 對應的內容 name 編碼存入 container。</p><p name="fba5" id="fba5" class="graf graf--p graf-after--p"><code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">try container.encode(gender, forKey: .gender)</strong></code></p><p name="b7b8" id="b7b8" class="graf graf--p graf-after--p">呼叫 encode(_:forKey:)，將 key gender 對應的內容 gender 編碼存入 container。</p><p name="945e" id="945e" class="graf graf--p graf-after--p"><code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">if let healthInfo = try? JSONEncoder().encode(healthInfo), <br> let healthInfoString = String(data: healthInfo, encoding: .utf8) {<br> try container.encode(healthInfoString, forKey: .healthInfo)<br> }</strong></code></p><p name="3697" id="3697" class="graf graf--p graf-after--p">將型別 HealthInfo 的 healthInfo 編碼成 Data，然後將它變成字串 healthInfoString，然後再呼叫 encode(_:forKey:)，將 key healthInfo 對應的內容 healthInfoString 編碼存入 container。</p><figure name="22bc" id="22bc" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*aD06ncgwZIuXKktpWkUnFA.jpeg" data-width="1586" data-height="404" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*aD06ncgwZIuXKktpWkUnFA.jpeg"></figure><h3 name="770f" id="770f" class="graf graf--h3 graf-after--figure">array 的例子</h3><p name="f425" id="f425" class="graf graf--p graf-after--h3">接著讓我們看另一個 array 的例子，以下程式將產生常見的 JSON 格式上傳。</p><pre name="5d9e" id="5d9e" class="graf graf--pre graf-after--p">struct Profile: Encodable {<br>    let name: String<br>    let gender: String<br>    let books: [Book]</pre><pre name="2861" id="2861" class="graf graf--pre graf-after--pre">}<br>struct Book: Encodable {<br>    let name: String<br>    let price: Int<br>}<br>let books = [<br>    Book(name: &quot;火車怪客&quot;, price: 250),<br>    Book(name: &quot;天才雷普利&quot;, price: 300)<br>]<br>let profile = Profile(name: &quot;peter&quot;, gender: &quot;man&quot;, books: books)<br>if let data = try? JSONEncoder().encode(profile),<br>   let content = String(data: data, encoding: .utf8) {<br>    print(content)<br>}</pre><p name="c59e" id="c59e" class="graf graf--p graf-after--pre">結果</p><pre name="8a66" id="8a66" class="graf graf--pre graf-after--p">{&quot;name&quot;:&quot;peter&quot;,&quot;books&quot;:[{&quot;name&quot;:&quot;火車怪客&quot;,&quot;price&quot;:250},{&quot;name&quot;:&quot;天才雷普利&quot;,&quot;price&quot;:300}],&quot;gender&quot;:&quot;man&quot;}</pre><p name="5cbe" id="5cbe" class="graf graf--p graf-after--pre">當後台要求 JSON 裡 books 的內容為字串包裝的 array 時，我們得辛苦點，自訂編碼的 function encode(to:)。</p><pre name="abc3" id="abc3" class="graf graf--pre graf-after--p">{&quot;name&quot;:&quot;peter&quot;,&quot;books&quot;:<strong class="markup--strong markup--pre-strong">&quot;[{\&quot;name\&quot;:\&quot;火車怪客\&quot;,\&quot;price\&quot;:250},{\&quot;name\&quot;:\&quot;天才雷普利\&quot;,\&quot;price\&quot;:300}]&quot;</strong>,&quot;gender&quot;:&quot;man&quot;}</pre><h3 name="3124" id="3124" class="graf graf--h3 graf-after--pre">將 array 包裝成字串</h3><pre name="b057" id="b057" class="graf graf--pre graf-after--h3">struct Profile: Encodable {<br>    let name: String<br>    let gender: String<br>    let books: [Book]<strong class="markup--strong markup--pre-strong"><br>        <br>    func encode(to encoder: Encoder) throws {<br>            var container = encoder.container(keyedBy: CodingKeys.self)<br>            try container.encode(name, forKey: .name)<br>            try container.encode(gender, forKey: .gender)<br>            if let books = try? JSONEncoder().encode(books),  <br>               let booksString = String(data: books, encoding: .utf8) {<br>                try container.encode(booksString, forKey: .books)<br>            }<br>    }</strong></pre><pre name="86bd" id="86bd" class="graf graf--pre graf-after--pre">}<br>struct Book: Encodable {<br>    let name: String<br>    let price: Int<br>}<br>let books = [<br>    Book(name: &quot;火車怪客&quot;, price: 250),<br>    Book(name: &quot;天才雷普利&quot;, price: 300)<br>]<br>let profile = Profile(name: &quot;peter&quot;, gender: &quot;man&quot;, books: books)<br>if let data = try? JSONEncoder().encode(profile),<br>   let content = String(data: data, encoding: .utf8) {<br>    print(content)<br>}</pre><figure name="c992" id="c992" class="graf graf--figure graf-after--pre"><img class="graf-image" data-image-id="1*o670QE4FqB02gnzapsNpaA.jpeg" data-width="1522" data-height="346" src="https://cdn-images-1.medium.com/max/800/1*o670QE4FqB02gnzapsNpaA.jpeg"></figure><h3 name="4b96" id="4b96" class="graf graf--h3 graf-after--figure">補充: 另一個寫法，搭配 JSONSerialization</h3><pre name="1ad7" id="1ad7" class="graf graf--pre graf-after--h3">struct HealthInfo: Codable {<br>    let weight: Double<br>    let height: Double<br>}</pre><pre name="3381" id="3381" class="graf graf--pre graf-after--pre graf--trailing">var postDic = [String: Any]()<br>postDic[&quot;name&quot;] = &quot;peter&quot;<br>postDic[&quot;gender&quot;] = &quot;man&quot;<br>let healthInfo = HealthInfo(weight: 60, height: 171)<br>if let healthInfoString = try? String(data: JSONEncoder().encode(healthInfo), encoding: .utf8) {<br>    postDic[&quot;healthInfo&quot;] = healthInfoString<br>}<br>print(postDic)<br>let postData = try? JSONSerialization.data(withJSONObject: postDic)</pre></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@apppeterpan" class="p-author h-card">彼得潘的 iOS App Neverland</a> on <a href="https://medium.com/p/40e3118de1b0"><time class="dt-published" datetime="2020-09-07T16:05:55.364Z">September 7, 2020</time></a>.</p><p><a href="https://medium.com/@apppeterpan/%E9%80%8F%E9%81%8E-encode-to-%E5%B0%87-json-%E8%A3%A1%E7%9A%84-array-%E6%88%96%E7%89%A9%E4%BB%B6%E8%AE%8A%E6%88%90%E5%AD%97%E4%B8%B2%E4%B8%8A%E5%82%B3-40e3118de1b0" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on November 16, 2025.</p></footer></article></body></html>