<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>找出 JSONDecoder 的 decode 錯誤</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">找出 JSONDecoder 的 decode 錯誤</h1>
</header>
<section data-field="subtitle" class="p-summary">
利用 JSONDecoder，我們可以很方便地將 API 回傳的 JSON 資料轉成遵從 Decodable 的自訂型別，例如以下結合 Dog API，抓取可愛小狗圖片的例子。
</section>
<section data-field="body" class="e-content">
<section name="c4d0" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="c967" id="c967" class="graf graf--h3 graf--leading graf--title">找出 JSONDecoder 的 decode 錯誤</h3><p name="d777" id="d777" class="graf graf--p graf-after--h3">利用 JSONDecoder，我們可以很方便地將 API 回傳的 JSON 資料轉成遵從 Decodable 的自訂型別，例如以下結合 Dog API，抓取可愛小狗圖片的例子。</p><div name="3c53" id="3c53" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://dog.ceo/dog-api/" data-href="https://dog.ceo/dog-api/" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://dog.ceo/dog-api/"><strong class="markup--strong markup--mixtapeEmbed-strong">Dog API</strong><br><em class="markup--em markup--mixtapeEmbed-em">Dog API - The internet&#39;s biggest collection of open source dog pictures. Fetching you over 20,000 dog images accessible…</em>dog.ceo</a><a href="https://dog.ceo/dog-api/" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="5f10517053f5592ebb4d5679822559d4" data-thumbnail-img-id="0*JBAhlTl1_AJ7ZCI4" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*JBAhlTl1_AJ7ZCI4);"></a></div><figure name="8561" id="8561" class="graf graf--figure graf-after--mixtapeEmbed"><img class="graf-image" data-image-id="1*VGvuY1ViIdR7xAtXBliy1Q.jpeg" data-width="1014" data-height="568" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*VGvuY1ViIdR7xAtXBliy1Q.jpeg"></figure><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="8d0c" id="8d0c" class="graf graf--pre graf-after--figure graf--preV2"><span class="pre--content"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Dog</span>: <span class="hljs-title class_">Decodable</span> {<br />    <span class="hljs-keyword">var</span> status: <span class="hljs-type">String</span><br />    <span class="hljs-keyword">var</span> message: <span class="hljs-type">URL</span><br />}</span></pre><ul class="postList"><li name="e5e9" id="e5e9" class="graf graf--li graf-after--pre"><strong class="markup--strong markup--li-strong">寫法 1: 使用 async &amp; await。</strong></li></ul><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="5708" id="5708" class="graf graf--pre graf-after--li graf--preV2"><span class="pre--content"><span class="hljs-keyword">func</span> <span class="hljs-title function_">fetch</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> {<br />    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">&quot;https://dog.ceo/api/breeds/image/random&quot;</span>) {<br />        <span class="hljs-keyword">let</span> (data, <span class="hljs-keyword">_</span>) <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">URLSession</span>.shared .data(from: url)<br />        <span class="hljs-keyword">let</span> dog <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-type">JSONDecoder</span>().decode(<span class="hljs-type">Dog</span>.<span class="hljs-keyword">self</span>, from: data)<br />        <span class="hljs-built_in">print</span>(dog)<br />    }<br />}<br /><br /><span class="hljs-type">Task</span> {<br />    <span class="hljs-keyword">do</span> {<br />        <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> fetch()<br />    } <span class="hljs-keyword">catch</span> {<br />        <span class="hljs-built_in">print</span>(error)<br />    }<br />}</span></pre><ul class="postList"><li name="69b6" id="69b6" class="graf graf--li graf-after--pre"><strong class="markup--strong markup--li-strong">寫法 2: 使用 completion handler。</strong></li></ul><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="f35d" id="f35d" class="graf graf--pre graf-after--li graf--preV2"><span class="pre--content"><span class="hljs-keyword">func</span> <span class="hljs-title function_">fetch</span>() {<br />    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">&quot;https://dog.ceo/api/breeds/image/random&quot;</span>) {<br />        <span class="hljs-type">URLSession</span>.shared.dataTask(with: url) { data, response, error <span class="hljs-keyword">in</span><br />            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> data {<br />                <span class="hljs-keyword">do</span> {<br />                    <span class="hljs-keyword">let</span> dog <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-type">JSONDecoder</span>().decode(<span class="hljs-type">Dog</span>.<span class="hljs-keyword">self</span>, from: data)<br />                    <span class="hljs-built_in">print</span>(dog)<br />                } <span class="hljs-keyword">catch</span>  {<br />                    <span class="hljs-built_in">print</span>(error)<br />                }<br />            }<br />        }.resume()<br />    }<br />}<br /><br />fetch()</span></pre><p name="2572" id="2572" class="graf graf--p graf-after--pre">結果</p><figure name="fca4" id="fca4" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*uMfG8Gb3ynTi2MhbMPac8g.jpeg" data-width="1870" data-height="204" src="https://cdn-images-1.medium.com/max/800/1*uMfG8Gb3ynTi2MhbMPac8g.jpeg"></figure><p name="dda8" id="dda8" class="graf graf--p graf-after--figure">此方法的關鍵在於遵從 Decodable 的自訂型別和 JSON 資料對應，如果不小心犯了某些小錯誤，比方把 message 拼成 massage，將讓 JSONDecoder 的 decode 解碼失敗。不過這種小錯誤有時很難發現，所謂旁觀者清，不如讓 Swift 主動告訴我們錯在哪吧。</p><p name="bf96" id="bf96" class="graf graf--p graf-after--p">在研究解碼錯誤前，最好先將抓到的 data 變成字串印出，檢查得到的資料是否正確。有時用 PostMan 可以抓到資料，不代表程式可以抓到，而且程式抓到的資料也可能跟 PostMan 不一樣。因此有問題時可在程式印出 JSON，檢查抓到的資料長什麼樣子</p><h3 name="6428" id="6428" class="graf graf--h3 graf-after--p">印出 JSON，檢查 JSON 的內容</h3><ul class="postList"><li name="6119" id="6119" class="graf graf--li graf-after--h3"><strong class="markup--strong markup--li-strong">寫法 1: 使用 async &amp; await。</strong></li></ul><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="d687" id="d687" class="graf graf--pre graf-after--li graf--preV2"><span class="pre--content"><span class="hljs-keyword">func</span> <span class="hljs-title function_">fetch</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> {<br />    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">&quot;https://dog.ceo/api/breeds/image/random&quot;</span>) {<br />        <span class="hljs-keyword">let</span> (data, <span class="hljs-keyword">_</span>) <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">URLSession</span>.shared .data(from: url)<br />        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> content <span class="hljs-operator">=</span> <span class="hljs-type">String</span>(data: data, encoding: .utf8) {<br />            <span class="hljs-built_in">print</span>(content)<br />        }<br />    }<br />}</span></pre><ul class="postList"><li name="62ce" id="62ce" class="graf graf--li graf-after--pre"><strong class="markup--strong markup--li-strong">寫法 2: 使用 completion handler。</strong></li></ul><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="3c8a" id="3c8a" class="graf graf--pre graf-after--li graf--preV2"><span class="pre--content"><span class="hljs-keyword">func</span> <span class="hljs-title function_">fetch</span>() {<br />    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">&quot;https://dog.ceo/api/breeds/image/random&quot;</span>) {<br />        <span class="hljs-type">URLSession</span>.shared.dataTask(with: url) { data, response, error <span class="hljs-keyword">in</span><br />            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> data,<br />               <span class="hljs-keyword">let</span> content <span class="hljs-operator">=</span> <span class="hljs-type">String</span>(data: data, encoding: .utf8) {<br />                <span class="hljs-built_in">print</span>(content)<br />            }<br />        }.resume()<br />    }<br />}</span></pre><p name="962d" id="962d" class="graf graf--p graf-after--pre">確定抓到的 JSON 資料沒問題後，我們有以下三種找出解碼錯誤的方法 :</p><h3 name="362b" id="362b" class="graf graf--h3 graf-after--p">解法1: 利用 do catch 搭配 try</h3><ul class="postList"><li name="7c18" id="7c18" class="graf graf--li graf-after--h3"><strong class="markup--strong markup--li-strong">寫法 1: 使用 async &amp; await。</strong></li></ul><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="9eac" id="9eac" class="graf graf--pre graf-after--li graf--preV2"><span class="pre--content"><span class="hljs-keyword">func</span> <span class="hljs-title function_">fetch</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> {<br />    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">&quot;https://dog.ceo/api/breeds/image/random&quot;</span>) {<br />        <span class="hljs-keyword">let</span> (data, <span class="hljs-keyword">_</span>) <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">URLSession</span>.shared .data(from: url)<br />        <span class="hljs-keyword">let</span> dog <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-type">JSONDecoder</span>().decode(<span class="hljs-type">Dog</span>.<span class="hljs-keyword">self</span>, from: data)<br />        <span class="hljs-built_in">print</span>(dog)<br />    }<br />}<br /><br /><span class="hljs-type">Task</span> {<br />    <span class="hljs-keyword">do</span> {<br />        <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> fetch()<br />    } <span class="hljs-keyword">catch</span> {<br />        <span class="hljs-built_in">print</span>(error)<br />    }<br />}</span></pre><ul class="postList"><li name="04a0" id="04a0" class="graf graf--li graf-after--pre"><strong class="markup--strong markup--li-strong">寫法 2: 使用 completion handler。</strong></li></ul><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="7e19" id="7e19" class="graf graf--pre graf-after--li graf--preV2"><span class="pre--content"><span class="hljs-keyword">func</span> <span class="hljs-title function_">fetch</span>() {<br />    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">&quot;https://dog.ceo/api/breeds/image/random&quot;</span>) {<br />        <span class="hljs-type">URLSession</span>.shared.dataTask(with: url) { data, response, error <span class="hljs-keyword">in</span><br />            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> data {<br />                <span class="hljs-keyword">do</span> {<br />                    <span class="hljs-keyword">let</span> dog <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-type">JSONDecoder</span>().decode(<span class="hljs-type">Dog</span>.<span class="hljs-keyword">self</span>, from: data)<br />                    <span class="hljs-built_in">print</span>(dog)<br />                } <span class="hljs-keyword">catch</span>  {<br />                    <span class="hljs-built_in">print</span>(error)<br />                }<br />            }<br />        }.resume()<br />    }<br />}<br /><br />fetch()</span></pre><p name="0446" id="0446" class="graf graf--p graf-after--pre">當 try 後呼叫的 function 丟出錯誤時，我們可在 catch 的 { } 裡利用自動生成的常數 error 得到錯誤資訊。接下來就讓我們故意犯錯，親眼見證幾種常見的錯誤吧。</p><blockquote name="402b" id="402b" class="graf graf--blockquote graf-after--p"><strong class="markup--strong markup--blockquote-strong">1 property 的名字拼錯，和 JSON dictionary 的 key 不一樣</strong></blockquote><p name="6a69" id="6a69" class="graf graf--p graf-after--blockquote">比方 JSON 裡是 message，我們拼成 massage。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="a179" id="a179" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Dog</span>: <span class="hljs-title class_">Decodable</span> {<br />   <span class="hljs-keyword">var</span> status: <span class="hljs-type">String</span><br />   <span class="hljs-keyword">var</span> massage: <span class="hljs-type">URL</span><br />}</span></pre><p name="6256" id="6256" class="graf graf--p graf-after--pre">錯誤訊息 keyNotFound。</p><pre name="530c" id="530c" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">keyNotFound</strong>(CodingKeys(stringValue: &quot;massage&quot;, intValue: nil), Swift.DecodingError.Context(codingPath: [], debugDescription: &quot;No value associated with key CodingKeys(stringValue: \&quot;massage\&quot;, intValue: nil) (\&quot;massage\&quot;).&quot;, underlyingError: nil))</pre><p name="90ca" id="90ca" class="graf graf--p graf-after--pre">keyNotFound 表示 JSONDecoder 在 JSON 資料裡找不到某個 key 對應的內容，CodingKeys 後的文字說明找不到的 key 叫做 massage，因此造成問題的凶手是 property massage。</p><blockquote name="bbce" id="bbce" class="graf graf--blockquote graf-after--p"><strong class="markup--strong markup--blockquote-strong">2 property 的型別不對。</strong></blockquote><p name="7e04" id="7e04" class="graf graf--p graf-after--blockquote">比方 status 應該是 String，我們卻宣告成 Int。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="fcb5" id="fcb5" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Dog</span>: <span class="hljs-title class_">Decodable</span> {<br />   <span class="hljs-keyword">var</span> status: <span class="hljs-type">Int</span><br />   <span class="hljs-keyword">var</span> message: <span class="hljs-type">URL</span><br />}</span></pre><p name="956c" id="956c" class="graf graf--p graf-after--pre">錯誤訊息 typeMismatch。</p><pre name="2fe4" id="2fe4" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">typeMismatch</strong>(Swift.Int, Swift.DecodingError.Context(codingPath: [CodingKeys(stringValue: &quot;status&quot;, intValue: nil)], debugDescription: &quot;Expected to decode Int but found a string/data instead.&quot;, underlyingError: nil))</pre><p name="47c3" id="47c3" class="graf graf--p graf-after--pre">typeMismatch 表示 property 的型別有問題，CodingKeys 後的文字說明有問題的 property 是 status，而 debugDescription 更進一步說明型別不合的原因，<code class="markup--code markup--p-code">Expected to decode Int but found a string/data instead</code>，原來我們宣告成 Int，但 JSON 裡的資料是 String。</p><blockquote name="092b" id="092b" class="graf graf--blockquote graf-after--p"><strong class="markup--strong markup--blockquote-strong">3 JSON 某些 key 不一定存在，宣告成 property 時沒有宣告為 Optional</strong></blockquote><p name="0372" id="0372" class="graf graf--p graf-after--blockquote">JSON 裡某些 key 不一定存在， 它們宣告成 property 時必須是 optional，否則找不到 key 時將出現 keyNotFound 錯誤。</p><p name="2cf4" id="2cf4" class="graf graf--p graf-after--p">範例</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="3685" id="3685" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;&quot;<br />[<br />  {<br />    &quot;name&quot;: &quot;最高學以致用法&quot;,<br />    &quot;author&quot;: &quot;樺澤紫苑&quot;,<br />    &quot;price&quot;: 370<br />  },<br />  {<br />    &quot;name&quot;: &quot;銀河系邊緣的小異常&quot;,<br />    &quot;author&quot;: &quot;艾加．凱磊&quot;<br />  }<br />]<br />&quot;&quot;&quot;</span>.data(using: .utf8)<span class="hljs-operator">!</span><br /><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Book</span>: <span class="hljs-title class_">Decodable</span> {<br />    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span><br />    <span class="hljs-keyword">let</span> author: <span class="hljs-type">String</span><br />    <span class="hljs-keyword">let</span> price: <span class="hljs-type">Int</span><br />}<br /><span class="hljs-keyword">let</span> decoder <span class="hljs-operator">=</span> <span class="hljs-type">JSONDecoder</span>()<br /><span class="hljs-keyword">do</span> {<br />    <span class="hljs-keyword">let</span> books <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> decoder.decode([<span class="hljs-type">Book</span>].<span class="hljs-keyword">self</span>, from: data)<br />    <span class="hljs-built_in">print</span>(books)<br />} <span class="hljs-keyword">catch</span>  {<br />    <span class="hljs-built_in">print</span>(error)<br />}</span></pre><p name="3f12" id="3f12" class="graf graf--p graf-after--pre">銀河系邊緣的小異常沒有 price，因此 price 找不到造成錯誤，出現錯誤訊息 keyNotFound。</p><pre name="10da" id="10da" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">keyNotFound</strong>(CodingKeys(stringValue: &quot;price&quot;, intValue: nil), Swift.DecodingError.Context(codingPath: [_JSONKey(stringValue: &quot;Index 1&quot;, intValue: 1)], debugDescription: &quot;No value associated with key CodingKeys(stringValue: \&quot;price\&quot;, intValue: nil) (\&quot;price\&quot;).&quot;, underlyingError: nil))</pre><p name="ed47" id="ed47" class="graf graf--p graf-after--pre">值得注意的，當有問題的資料是 array 裡的某一筆資料時，我們還可以從 印出的 error 找出它是第幾筆。比方剛剛的錯誤訊息提到 Index 1，表示它是第二筆資料。</p><blockquote name="eb64" id="eb64" class="graf graf--blockquote graf-after--p"><strong class="markup--strong markup--blockquote-strong">4 JSON 裡 key 的 value 可能是 null，宣告成 property 時沒有宣告為 Optional</strong></blockquote><p name="f548" id="f548" class="graf graf--p graf-after--blockquote">當 JSON 裡 key 的 value 可能是 null 時，宣告的 property 必須是 optional，否則找不到 value 時將出現 valueNotFound 錯誤。</p><p name="a368" id="a368" class="graf graf--p graf-after--p">比方 JSON 如下，第二本書的 price 是 null。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="b00f" id="b00f" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;&quot;<br />[<br />  {<br />    &quot;name&quot;: &quot;最高學以致用法&quot;,<br />    &quot;author&quot;: &quot;樺澤紫苑&quot;,<br />    &quot;price&quot;: 370<br />  },<br />  {<br />    &quot;name&quot;: &quot;銀河系邊緣的小異常&quot;,<br />    &quot;author&quot;: &quot;艾加．凱磊&quot;,<br />    &quot;price&quot;: null<br />}<br />]<br />&quot;&quot;&quot;</span>.data(using: .utf8)<span class="hljs-operator">!</span></span></pre><p name="e061" id="e061" class="graf graf--p graf-after--pre">JSON 對應的 Book 定義如下。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="f4d6" id="f4d6" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Book</span>: <span class="hljs-title class_">Decodable</span> {<br />    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span><br />    <span class="hljs-keyword">let</span> author: <span class="hljs-type">String</span><br />    <span class="hljs-keyword">let</span> price: <span class="hljs-type">Int</span><br />}</span></pre><p name="b553" id="b553" class="graf graf--p graf-after--pre">price 應該要是 optional，若是忘了加問號，錯誤訊息將顯示 valueNotFound。</p><pre name="b7cd" id="b7cd" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">valueNotFound</strong>(Swift.Int, Swift.DecodingError.Context(codingPath: [_JSONKey(stringValue: &quot;Index 1&quot;, intValue: 1), CodingKeys(stringValue: &quot;price&quot;, intValue: nil)], debugDescription: &quot;Expected Int value but found null instead.&quot;, underlyingError: nil))</pre><blockquote name="4826" id="4826" class="graf graf--blockquote graf-after--pre"><strong class="markup--strong markup--blockquote-strong">5 URL 有問題 (ps: 此問題在 iOS 17 已修正)</strong></blockquote><p name="2610" id="2610" class="graf graf--p graf-after--blockquote">JSON 裡包含的網址可能包含特別字元，在 iOS 17 之前的版本需要特別處理才能轉成 URL，比方以下例子第二個 link 的網址包含中文。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="c6f1" id="c6f1" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;&quot;<br />[<br />   {&quot;name&quot;: &quot;SwiftUI - How to setup a project&quot;,<br />    &quot;link&quot;: &quot;https://medium.com/flawless-app-stories/swiftui-getting-started-372389fff423&quot;},<br />    { &quot;name&quot;: &quot;iOS SDK 選東西的 view controller &amp; delegate 範例&quot;,<br />    &quot;link&quot;: &quot;https://medium.com/彼得潘的-swift-ios-app-開發問題解答集/ios-sdk-選東西的-view-controller-delegate-範例-c3f0b5238933&quot;}<br />]<br />&quot;&quot;&quot;</span>.data(using: .utf8)<span class="hljs-operator">!</span><br /><br /><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Webpage</span>: <span class="hljs-title class_">Decodable</span> {<br />    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span><br />    <span class="hljs-keyword">let</span> link: <span class="hljs-type">URL</span><br />}<br /><br /><span class="hljs-keyword">let</span> decoder <span class="hljs-operator">=</span> <span class="hljs-type">JSONDecoder</span>()<br /><span class="hljs-keyword">do</span> {<br />    <span class="hljs-keyword">let</span> webpages <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> decoder.decode([<span class="hljs-type">Webpage</span>].<span class="hljs-keyword">self</span>, from: data)<br />    <span class="hljs-built_in">print</span>(webpages)<br />} <span class="hljs-keyword">catch</span>  {<br />    <span class="hljs-built_in">print</span>(error)<br />}</span></pre><p name="5155" id="5155" class="graf graf--p graf-after--pre">印出的錯誤訊息將告訴我們 Invalid URL string。</p><pre name="d76b" id="d76b" class="graf graf--pre graf-after--p">dataCorrupted(Swift.DecodingError.Context(codingPath: [_JSONKey(stringValue: &quot;Index 1&quot;, intValue: 1), CodingKeys(stringValue: &quot;link&quot;, intValue: nil)], debugDescription: &quot;Invalid URL string.&quot;, underlyingError: nil))</pre><p name="32df" id="32df" class="graf graf--p graf-after--pre">此問題的解法是將 property 的型別宣告成 String，然後再自己將它轉成 URL。因此剛剛的範例可以改成以下寫法:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="2b0a" id="2b0a" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Webpage</span>: <span class="hljs-title class_">Decodable</span> {<br />    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span><br />    <span class="hljs-keyword">let</span> link: <span class="hljs-type">String</span><br />    <span class="hljs-keyword">var</span> url: <span class="hljs-type">URL</span>? {<br />        link.addingPercentEncoding(withAllowedCharacters: .urlQueryAllowed).flatMap { <span class="hljs-type">URL</span>(string: <span class="hljs-variable">$0</span>) }<br />    }<br />}<br /><br /><span class="hljs-keyword">let</span> decoder <span class="hljs-operator">=</span> <span class="hljs-type">JSONDecoder</span>()<br /><span class="hljs-keyword">do</span> {<br />    <span class="hljs-keyword">let</span> webpages <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> decoder.decode([<span class="hljs-type">Webpage</span>].<span class="hljs-keyword">self</span>, from: data)<br />    <span class="hljs-built_in">print</span>(webpages)<br />} <span class="hljs-keyword">catch</span>  {<br />    <span class="hljs-built_in">print</span>(error)<br />}</span></pre><h3 name="0bd0" id="0bd0" class="graf graf--h3 graf-after--pre">利用 catch 辨別每一種錯誤</h3><p name="081d" id="081d" class="graf graf--p graf-after--h3">若想辨別每一種解析 JSON 的錯誤，我們也可以在 catch 後搭配 DecodingError 的各種 case。</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="ed0e" id="ed0e" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">let</span> decoder <span class="hljs-operator">=</span> <span class="hljs-type">JSONDecoder</span>()<br /><span class="hljs-keyword">do</span> {<br />    <span class="hljs-keyword">let</span> dog <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> decoder.decode(<span class="hljs-type">Dog</span>.<span class="hljs-keyword">self</span>, from: data)<br />    <span class="hljs-built_in">print</span>(dog)<br />} <span class="hljs-keyword">catch</span> <span class="hljs-type">DecodingError</span>.keyNotFound(<span class="hljs-keyword">let</span> key, <span class="hljs-keyword">let</span> context) {<br />    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;keyNotFound&quot;</span>, key, context)<br />} <span class="hljs-keyword">catch</span> <span class="hljs-type">DecodingError</span>.typeMismatch(<span class="hljs-keyword">let</span> type, <span class="hljs-keyword">let</span> context) {<br />    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;typeMismatch&quot;</span>, type, context)<br />} <span class="hljs-keyword">catch</span> <span class="hljs-type">DecodingError</span>.valueNotFound(<span class="hljs-keyword">let</span> value, <span class="hljs-keyword">let</span> context) {<br />    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;valueNotFound&quot;</span>, value, context)<br />} <span class="hljs-keyword">catch</span> <span class="hljs-type">DecodingError</span>.dataCorrupted(<span class="hljs-keyword">let</span> context) {<br />    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;dataCorrupted&quot;</span>, context)<br />} <span class="hljs-keyword">catch</span>  {<br />    <span class="hljs-built_in">print</span>(error)<br />}</span></pre><h3 name="0f8e" id="0f8e" class="graf graf--h3 graf-after--pre">解法2: 使用 try? 時，利用 Swift Error Breakpoint 找錯誤</h3><div name="18ae" id="18ae" class="graf graf--mixtapeEmbed graf-after--h3"><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%88%A9%E7%94%A8-swift-error-breakpoint-%E6%AA%A2%E6%9F%A5-error-handling-%E4%B8%9F%E5%87%BA%E7%9A%84%E9%8C%AF%E8%AA%A4-7a5fbf6c7303" data-href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%88%A9%E7%94%A8-swift-error-breakpoint-%E6%AA%A2%E6%9F%A5-error-handling-%E4%B8%9F%E5%87%BA%E7%9A%84%E9%8C%AF%E8%AA%A4-7a5fbf6c7303" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%88%A9%E7%94%A8-swift-error-breakpoint-%E6%AA%A2%E6%9F%A5-error-handling-%E4%B8%9F%E5%87%BA%E7%9A%84%E9%8C%AF%E8%AA%A4-7a5fbf6c7303"><strong class="markup--strong markup--mixtapeEmbed-strong">利用 Swift Error Breakpoint 檢查 error handling 丟出的錯誤</strong><br><em class="markup--em markup--mixtapeEmbed-em">開發 iOS App 時，我們有時會遇到一些丟出錯誤的程式。當我們使用 do catch 或 try! 時，可以馬上看到錯誤的相關資訊，比方以下程式 JSONDecoder 因解析 JSON 失敗丟出錯誤。</em>medium.com</a><a href="https://medium.com/%E5%BD%BC%E5%BE%97%E6%BD%98%E7%9A%84-swift-ios-app-%E9%96%8B%E7%99%BC%E5%95%8F%E9%A1%8C%E8%A7%A3%E7%AD%94%E9%9B%86/%E5%88%A9%E7%94%A8-swift-error-breakpoint-%E6%AA%A2%E6%9F%A5-error-handling-%E4%B8%9F%E5%87%BA%E7%9A%84%E9%8C%AF%E8%AA%A4-7a5fbf6c7303" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="b27b246a22d7ed351f4913f0c26876a5" data-thumbnail-img-id="1*Ql6vZYil7C-mDGKyPBhWVg.jpeg" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*Ql6vZYil7C-mDGKyPBhWVg.jpeg);"></a></div><h3 name="13a3" id="13a3" class="graf graf--h3 graf-after--mixtapeEmbed">解法3: 利用 try!</h3><ul class="postList"><li name="fefa" id="fefa" class="graf graf--li graf-after--h3"><strong class="markup--strong markup--li-strong">寫法 1: 使用 async &amp; await。</strong></li></ul><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="csharp" name="7485" id="7485" class="graf graf--pre graf-after--li graf--preV2"><span class="pre--content"><span class="hljs-keyword">struct</span> Dog: Decodable {<br />    <span class="hljs-keyword">var</span> status: String<br />    <span class="hljs-keyword">var</span> massage: URL<br />}<br /><br /><span class="hljs-function">func <span class="hljs-title">fetch</span>() <span class="hljs-keyword">async</span> throws</span> {<br />    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> url = URL(<span class="hljs-built_in">string</span>: <span class="hljs-string">&quot;https://dog.ceo/api/breeds/image/random&quot;</span>) {<br />        <span class="hljs-keyword">let</span> (data, _) = <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> URLSession.shared .data(<span class="hljs-keyword">from</span>: url)<br />        <span class="hljs-keyword">let</span> dog = <span class="hljs-function"><span class="hljs-keyword">try</span> <span class="hljs-title">JSONDecoder</span>().<span class="hljs-title">decode</span>(<span class="hljs-params">Dog.self, <span class="hljs-keyword">from</span>: data</span>)<br />        <span class="hljs-title">print</span>(<span class="hljs-params">dog</span>)<br />    }<br />}<br /><br />Task</span> {<br />    <span class="hljs-keyword">try</span>! <span class="hljs-keyword">await</span> fetch()<br />}</span></pre><ul class="postList"><li name="9c94" id="9c94" class="graf graf--li graf-after--pre"><strong class="markup--strong markup--li-strong">寫法 2: 使用 completion handler。</strong></li></ul><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="0ec1" id="0ec1" class="graf graf--pre graf-after--li graf--preV2"><span class="pre--content"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Dog</span>: <span class="hljs-title class_">Decodable</span> {<br />    <span class="hljs-keyword">var</span> status: <span class="hljs-type">String</span><br />    <span class="hljs-keyword">var</span> massage: <span class="hljs-type">URL</span><br />}<br /><br /><span class="hljs-keyword">func</span> <span class="hljs-title function_">fetch</span>() {<br />    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">&quot;https://dog.ceo/api/breeds/image/random&quot;</span>) {<br />        <span class="hljs-type">URLSession</span>.shared.dataTask(with: url) { data, response, error <span class="hljs-keyword">in</span><br />            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> data {<br />                <span class="hljs-keyword">let</span> dog <span class="hljs-operator">=</span> <span class="hljs-keyword">try!</span> <span class="hljs-type">JSONDecoder</span>().decode(<span class="hljs-type">Dog</span>.<span class="hljs-keyword">self</span>, from: data)<br />                <span class="hljs-built_in">print</span>(dog)<br />            }<br />        }.resume()<br />    }<br />}<br /><br />fetch()</span></pre><p name="2b4c" id="2b4c" class="graf graf--p graf-after--pre">利用 try!，當 JSON 解析失敗時，程式將馬上閃退，然後在 Console 好心地告訴我們閃退的原因。</p><pre name="d180" id="d180" class="graf graf--pre graf-after--p">Fatal error: &#39;try!&#39; expression unexpectedly raised an error: Swift.DecodingError.keyNotFound(CodingKeys(stringValue: &quot;massage&quot;, intValue: nil), Swift.DecodingError.Context(codingPath: [], debugDescription: &quot;No value associated with key CodingKeys(stringValue: \&quot;massage\&quot;, intValue: nil) (\&quot;massage\&quot;).&quot;, underlyingError: nil)): file MyPlayground.playground, line 11</pre><p name="e337" id="e337" class="graf graf--p graf-after--pre graf--trailing">不過 try! 的寫法比較危險，它會讓程式閃退，因此修正問題後，最好再改用 do catch 或 try? 的寫法解析 JSON。</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@apppeterpan" class="p-author h-card">彼得潘的 iOS App Neverland</a> on <a href="https://medium.com/p/c9c6deae297"><time class="dt-published" datetime="2019-01-10T08:52:15.977Z">January 10, 2019</time></a>.</p><p><a href="https://medium.com/@apppeterpan/%E6%89%BE%E5%87%BA-jsondecoder-%E7%9A%84-decode-%E9%8C%AF%E8%AA%A4-c9c6deae297" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on November 16, 2025.</p></footer></article></body></html>